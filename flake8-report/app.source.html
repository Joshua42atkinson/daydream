<!DOCTYPE html>
<html>
   <head>
      <title>app.py - flake8 annotated source</title>
      <meta http-equiv="Content-Type" value="text/html; charset=UTF-8">
      <link rel="stylesheet" href="styles.css">
   </head>
   <body>
      <div id="masthead" class="sev-1"></div>
      <div id="page">
         <h1>
            <a href="app.report.html">
               <img src="back.svg" alt="&#x2B05;">
               app.py source
            </a>
         </h1>

         <div id="doc">
            <div id="l1"
               class="code sev- "><tt><i>1</i> <span class="c1"># /home/user/daydream_project/app.py</span></tt>
            </div>
            <div id="l2"
               class="code sev- "><tt><i>2</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l3"
               class="code sev- "><tt><i>3</i> <span class="c1"># app.py - Flask Web Application for Daydream</span></tt>
            </div>
            <div id="l4"
               class="code sev- "><tt><i>4</i> <span class="c1"># Version: 5.3 (Added Introduction Logic) # &lt;&lt;&lt; VERSION UPDATE &gt;&gt;&gt;</span></tt>
            </div>
            <div id="l5"
               class="code sev- "><tt><i>5</i> <span class="c1"># Description: Main Flask application handling routing, game logic,</span></tt>
            </div>
            <div id="l6"
               class="code sev- "><tt><i>6</i> <span class="c1">#              AI interaction, database operations, and session management.</span></tt>
            </div>
            <div id="l7"
               class="code sev- "><tt><i>7</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l8"
               class="code sev- "><tt><i>8</i> &nbsp;</tt>
            </div>
            <div id="l9"
               class="code sev- "><tt><i>9</i> <span class="c1"># --- Standard Library Imports ---</span></tt>
            </div>
            <div id="l10"
               class="code sev- "><tt><i>10</i> <span class="kn">import</span><span class="w"> </span><span class="nn">os</span></tt>
            </div>
            <div id="l11"
               class="code sev- "><tt><i>11</i> <span class="kn">import</span><span class="w"> </span><span class="nn">time</span></tt>
            </div>
            <div id="l12"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>12</i> <span class="kn">import</span><span class="w"> </span><span class="nn">re</span> <span class="c1"># Ensure re is imported</span></tt>
            </div>
            <div id="l13"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F401
                     </span>
                     'random' imported but unused</li>

               </ul><tt><i>13</i> <span class="kn">import</span><span class="w"> </span><span class="nn">random</span></tt>
            </div>
            <div id="l14"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>14</i> <span class="kn">import</span><span class="w"> </span><span class="nn">json</span> <span class="c1"># Ensure json is imported</span></tt>
            </div>
            <div id="l15"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F401
                     </span>
                     'math' imported but unused</li>

               </ul><tt><i>15</i> <span class="kn">import</span><span class="w"> </span><span class="nn">math</span></tt>
            </div>
            <div id="l16"
               class="code sev- "><tt><i>16</i> <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span></tt>
            </div>
            <div id="l17"
               class="code sev- "><tt><i>17</i> <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span></tt>
            </div>
            <div id="l18"
               class="code sev- "><tt><i>18</i> <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span></tt>
            </div>
            <div id="l19"
               class="code sev- "><tt><i>19</i> &nbsp;</tt>
            </div>
            <div id="l20"
               class="code sev- "><tt><i>20</i> <span class="c1"># --- Third-Party Imports ---</span></tt>
            </div>
            <div id="l21"
               class="code sev- "><tt><i>21</i> <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span></tt>
            </div>
            <div id="l22"
               class="code sev- "><tt><i>22</i>     <span class="n">Flask</span><span class="p">,</span></tt>
            </div>
            <div id="l23"
               class="code sev- "><tt><i>23</i>     <span class="n">render_template</span><span class="p">,</span></tt>
            </div>
            <div id="l24"
               class="code sev- "><tt><i>24</i>     <span class="n">request</span><span class="p">,</span></tt>
            </div>
            <div id="l25"
               class="code sev- "><tt><i>25</i>     <span class="n">redirect</span><span class="p">,</span></tt>
            </div>
            <div id="l26"
               class="code sev- "><tt><i>26</i>     <span class="n">url_for</span><span class="p">,</span></tt>
            </div>
            <div id="l27"
               class="code sev- "><tt><i>27</i>     <span class="n">session</span><span class="p">,</span></tt>
            </div>
            <div id="l28"
               class="code sev- "><tt><i>28</i>     <span class="n">jsonify</span><span class="p">,</span></tt>
            </div>
            <div id="l29"
               class="code sev- "><tt><i>29</i>     <span class="n">flash</span></tt>
            </div>
            <div id="l30"
               class="code sev- "><tt><i>30</i> <span class="p">)</span></tt>
            </div>
            <div id="l31"
               class="code sev- "><tt><i>31</i> <span class="kn">import</span><span class="w"> </span><span class="nn">firebase_admin</span></tt>
            </div>
            <div id="l32"
               class="code sev- "><tt><i>32</i> <span class="kn">from</span><span class="w"> </span><span class="nn">firebase_admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">firestore</span><span class="p">,</span> <span class="n">auth</span></tt>
            </div>
            <div id="l33"
               class="code sev- "><tt><i>33</i> &nbsp;</tt>
            </div>
            <div id="l34"
               class="code sev- "><tt><i>34</i> <span class="c1"># Import FieldFilter for fixing warnings</span></tt>
            </div>
            <div id="l35"
               class="code sev- "><tt><i>35</i> <span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud.firestore_v1.base_query</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldFilter</span></tt>
            </div>
            <div id="l36"
               class="code sev- "><tt><i>36</i> &nbsp;</tt>
            </div>
            <div id="l37"
               class="code sev- "><tt><i>37</i> &nbsp;</tt>
            </div>
            <div id="l38"
               class="code sev- "><tt><i>38</i> <span class="c1"># --- Application-Specific Imports ---</span></tt>
            </div>
            <div id="l39"
               class="code sev- "><tt><i>39</i> &nbsp;</tt>
            </div>
            <div id="l40"
               class="code sev- "><tt><i>40</i> <span class="c1"># Initialize fallbacks outside try block</span></tt>
            </div>
            <div id="l41"
               class="code sev- "><tt><i>41</i> <span class="n">AWL_WORDS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l42"
               class="code sev- "><tt><i>42</i> <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l43"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 0</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>43</i> <span class="k">def</span><span class="w"> </span><span class="nf">_fallback_calculate_xp</span><span class="p">(</span><span class="n">text_input</span><span class="p">,</span> <span class="n">learned_set</span><span class="p">):</span> <span class="c1"># Removed unused custom_vocab arg</span></tt>
            </div>
            <div id="l44"
               class="code sev- "><tt><i>44</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Fallback calculate_xp function.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l45"
               class="code sev- "><tt><i>45</i>     <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span></tt>
            </div>
            <div id="l46"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E305
                     </span>
                     Expected 2 blank lines after class or function definition, found 0</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>46</i> <span class="n">calculate_xp</span> <span class="o">=</span> <span class="n">_fallback_calculate_xp</span> <span class="c1"># Assign fallback initially</span></tt>
            </div>
            <div id="l47"
               class="code sev- "><tt><i>47</i> &nbsp;</tt>
            </div>
            <div id="l48"
               class="code sev- "><tt><i>48</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l49"
               class="code sev- "><tt><i>49</i>     <span class="c1"># Step 1: Import only what&#39;s actually IN vocabulary.py</span></tt>
            </div>
            <div id="l50"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>50</i>     <span class="kn">from</span><span class="w"> </span><span class="nn">vocabulary</span><span class="w"> </span><span class="kn">import</span> <span class="n">AWL_WORDS</span> <span class="k">as</span> <span class="n">imported_awl_words</span><span class="p">,</span> <span class="n">calculate_xp</span> <span class="k">as</span> <span class="n">imported_calculate_xp</span></tt>
            </div>
            <div id="l51"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>51</i>     <span class="n">AWL_WORDS</span> <span class="o">=</span> <span class="n">imported_awl_words</span> <span class="c1"># Overwrite fallback if import succeeds</span></tt>
            </div>
            <div id="l52"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>52</i>     <span class="n">calculate_xp</span> <span class="o">=</span> <span class="n">imported_calculate_xp</span> <span class="c1"># Overwrite fallback if import succeeds</span></tt>
            </div>
            <div id="l53"
               class="code sev- "><tt><i>53</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Imported AWL_WORDS and calculate_xp from vocabulary.py.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l54"
               class="code sev- "><tt><i>54</i> &nbsp;</tt>
            </div>
            <div id="l55"
               class="code sev- "><tt><i>55</i>     <span class="c1"># Step 2: Try to load definitions from the JSON file</span></tt>
            </div>
            <div id="l56"
               class="code sev- "><tt><i>56</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l57"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>57</i>         <span class="n">AWL_DEFINITIONS_PATH</span> <span class="o">=</span> <span class="s1">&#39;awl_definitions.json&#39;</span> <span class="c1"># The specific filename</span></tt>
            </div>
            <div id="l58"
               class="code sev- "><tt><i>58</i>         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="p">):</span></tt>
            </div>
            <div id="l59"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>59</i>             <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># Added encoding</span></tt>
            </div>
            <div id="l60"
               class="code sev- "><tt><i>60</i>                 <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></tt>
            </div>
            <div id="l61"
               class="code sev- "><tt><i>61</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">AWL_DEFINITIONS</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span></tt>
            </div>
            <div id="l62"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>62</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded AWL definitions from </span><span class="si">{</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l63"
               class="code sev- "><tt><i>63</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l64"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (124 > 79 characters)</li>

               </ul><tt><i>64</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="si">}</span><span class="s2"> did not contain a valid JSON dictionary. Using empty definitions.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l65"
               class="code sev- "><tt><i>65</i>                 <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l66"
               class="code sev- "><tt><i>66</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l67"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>67</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="si">}</span><span class="s2"> not found. Word definitions will be unavailable.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l68"
               class="code sev- "><tt><i>68</i>             <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l69"
               class="code sev- "><tt><i>69</i>     <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">json_err</span><span class="p">:</span></tt>
            </div>
            <div id="l70"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>70</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON from </span><span class="si">{</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json_err</span><span class="si">}</span><span class="s2">. Word definitions unavailable.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l71"
               class="code sev- "><tt><i>71</i>         <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l72"
               class="code sev- "><tt><i>72</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">file_err</span><span class="p">:</span></tt>
            </div>
            <div id="l73"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>73</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading </span><span class="si">{</span><span class="n">AWL_DEFINITIONS_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">file_err</span><span class="si">}</span><span class="s2">. Word definitions unavailable.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l74"
               class="code sev- "><tt><i>74</i>         <span class="n">AWL_DEFINITIONS</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l75"
               class="code sev- "><tt><i>75</i> &nbsp;</tt>
            </div>
            <div id="l76"
               class="code sev- "><tt><i>76</i> <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l77"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (155 > 79 characters)</li>

               </ul><tt><i>77</i>     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not import from vocabulary.py: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using fallbacks for AWL_WORDS and calculate_xp. Word definitions may also be unavailable.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l78"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>78</i>     <span class="k">pass</span> <span class="c1"># Keep fallbacks if import fails</span></tt>
            </div>
            <div id="l79"
               class="code sev- "><tt><i>79</i> &nbsp;</tt>
            </div>
            <div id="l80"
               class="code sev- "><tt><i>80</i> &nbsp;</tt>
            </div>
            <div id="l81"
               class="code sev- "><tt><i>81</i> <span class="c1"># --- Import quests ---</span></tt>
            </div>
            <div id="l82"
               class="code sev- "><tt><i>82</i> <span class="n">QUEST_DATA</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l83"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 0</li>

               </ul><tt><i>83</i> <span class="k">def</span><span class="w"> </span><span class="nf">_fallback_get_quest</span><span class="p">(</span><span class="n">quest_id</span><span class="p">):</span></tt>
            </div>
            <div id="l84"
               class="code sev- "><tt><i>84</i>     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback get_quest for quest_id: </span><span class="si">{</span><span class="n">quest_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l85"
               class="code sev- "><tt><i>85</i>     <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l86"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 0</li>

               </ul><tt><i>86</i> <span class="k">def</span><span class="w"> </span><span class="nf">_fallback_get_quest_step</span><span class="p">(</span><span class="n">quest_id</span><span class="p">,</span> <span class="n">step_id</span><span class="p">):</span></tt>
            </div>
            <div id="l87"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>87</i>     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback get_quest_step for quest_id: </span><span class="si">{</span><span class="n">quest_id</span><span class="si">}</span><span class="s2">, step_id: </span><span class="si">{</span><span class="n">step_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l88"
               class="code sev- "><tt><i>88</i>     <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l89"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E305
                     </span>
                     Expected 2 blank lines after class or function definition, found 0</li>

               </ul><tt><i>89</i> <span class="n">get_quest</span> <span class="o">=</span> <span class="n">_fallback_get_quest</span></tt>
            </div>
            <div id="l90"
               class="code sev- "><tt><i>90</i> <span class="n">get_quest_step</span> <span class="o">=</span> <span class="n">_fallback_get_quest_step</span></tt>
            </div>
            <div id="l91"
               class="code sev- "><tt><i>91</i> &nbsp;</tt>
            </div>
            <div id="l92"
               class="code sev- "><tt><i>92</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l93"
               class="code sev- "><tt><i>93</i>     <span class="c1"># Assuming quests.py v4.2 or later is used now</span></tt>
            </div>
            <div id="l94"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (132 > 79 characters)</li>

               </ul><tt><i>94</i>     <span class="kn">from</span><span class="w"> </span><span class="nn">quests</span><span class="w"> </span><span class="kn">import</span> <span class="n">QUEST_DATA</span> <span class="k">as</span> <span class="n">imported_quest_data</span><span class="p">,</span> <span class="n">get_quest</span> <span class="k">as</span> <span class="n">imported_get_quest</span><span class="p">,</span> <span class="n">get_quest_step</span> <span class="k">as</span> <span class="n">imported_get_quest_step</span></tt>
            </div>
            <div id="l95"
               class="code sev- "><tt><i>95</i>     <span class="n">QUEST_DATA</span> <span class="o">=</span> <span class="n">imported_quest_data</span></tt>
            </div>
            <div id="l96"
               class="code sev- "><tt><i>96</i>     <span class="n">get_quest</span> <span class="o">=</span> <span class="n">imported_get_quest</span></tt>
            </div>
            <div id="l97"
               class="code sev- "><tt><i>97</i>     <span class="n">get_quest_step</span> <span class="o">=</span> <span class="n">imported_get_quest_step</span></tt>
            </div>
            <div id="l98"
               class="code sev- "><tt><i>98</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Quest data loaded from quests.py.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l99"
               class="code sev- "><tt><i>99</i> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l100"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>100</i>     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;quests.py not found or error during import: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using fallbacks.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l101"
               class="code sev- "><tt><i>101</i>     <span class="k">pass</span></tt>
            </div>
            <div id="l102"
               class="code sev- "><tt><i>102</i> &nbsp;</tt>
            </div>
            <div id="l103"
               class="code sev- "><tt><i>103</i> <span class="c1"># --- Import lore ---</span></tt>
            </div>
            <div id="l104"
               class="code sev- "><tt><i>104</i> <span class="n">thetopia_lore</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l105"
               class="code sev- "><tt><i>105</i> <span class="n">world_map</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l106"
               class="code sev- "><tt><i>106</i> <span class="n">ABILITY_NAME_MAP</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l107"
               class="code sev- "><tt><i>107</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l108"
               class="code sev- "><tt><i>108</i>     <span class="c1"># Assuming lore.py is available</span></tt>
            </div>
            <div id="l109"
               class="code sev- "><tt><i>109</i>     <span class="kn">from</span><span class="w"> </span><span class="nn">lore</span><span class="w"> </span><span class="kn">import</span> <span class="n">thetopia_lore</span> <span class="k">as</span> <span class="n">imported_thetopia_lore</span></tt>
            </div>
            <div id="l110"
               class="code sev- "><tt><i>110</i>     <span class="n">thetopia_lore</span> <span class="o">=</span> <span class="n">imported_thetopia_lore</span></tt>
            </div>
            <div id="l111"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>111</i>     <span class="n">world_map</span> <span class="o">=</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># Use locations as the world map source</span></tt>
            </div>
            <div id="l112"
               class="code sev- "><tt><i>112</i>     <span class="n">ABILITY_NAME_MAP</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l113"
               class="code sev- "><tt><i>113</i>         <span class="c1"># Map lowercase input to proper name for consistency</span></tt>
            </div>
            <div id="l114"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>114</i>         <span class="s2">&quot;natural armor&quot;</span><span class="p">:</span> <span class="s2">&quot;Natural Armor&quot;</span><span class="p">,</span> <span class="s2">&quot;cannot wear armor&quot;</span><span class="p">:</span> <span class="s2">&quot;Cannot Wear Armor&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l115"
               class="code sev- "><tt><i>115</i>         <span class="s2">&quot;fortunate find&quot;</span><span class="p">:</span> <span class="s2">&quot;Fortunate Find&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l116"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>116</i>         <span class="s2">&quot;integrated systems&quot;</span><span class="p">:</span> <span class="s2">&quot;Integrated Systems&quot;</span><span class="p">,</span> <span class="s2">&quot;memory limit&quot;</span><span class="p">:</span> <span class="s2">&quot;Memory Limit&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l117"
               class="code sev- "><tt><i>117</i>         <span class="s2">&quot;pack tactics&quot;</span><span class="p">:</span> <span class="s2">&quot;Pack Tactics&quot;</span><span class="p">,</span> <span class="s2">&quot;fierce loyalty&quot;</span><span class="p">:</span> <span class="s2">&quot;Fierce Loyalty&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l118"
               class="code sev- "><tt><i>118</i>         <span class="s2">&quot;artistic shell&quot;</span><span class="p">:</span> <span class="s2">&quot;Artistic Shell&quot;</span><span class="p">,</span> <span class="s2">&quot;second brain&quot;</span><span class="p">:</span> <span class="s2">&quot;Second Brain&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l119"
               class="code sev- "><tt><i>119</i>         <span class="s2">&quot;absorb magic&quot;</span><span class="p">:</span> <span class="s2">&quot;Absorb Magic&quot;</span><span class="p">,</span> <span class="s2">&quot;shapechange&quot;</span><span class="p">:</span> <span class="s2">&quot;Shapechange&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l120"
               class="code sev- "><tt><i>120</i>         <span class="s2">&quot;tinker&quot;</span><span class="p">:</span> <span class="s2">&quot;Tinker&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l121"
               class="code sev- "><tt><i>121</i>         <span class="s2">&quot;arcane affinity&quot;</span><span class="p">:</span> <span class="s2">&quot;Arcane Affinity&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l122"
               class="code sev- "><tt><i>122</i>         <span class="s2">&quot;combat ready&quot;</span><span class="p">:</span> <span class="s2">&quot;Combat Ready&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l123"
               class="code sev- "><tt><i>123</i>         <span class="s2">&quot;empathic&quot;</span><span class="p">:</span> <span class="s2">&quot;Empathic&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l124"
               class="code sev- "><tt><i>124</i>         <span class="s2">&quot;quick wits&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick Wits&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l125"
               class="code sev- "><tt><i>125</i>         <span class="s2">&quot;becoming awesome boost&quot;</span><span class="p">:</span> <span class="s2">&quot;Becoming Awesome Boost&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l126"
               class="code sev- "><tt><i>126</i>         <span class="s2">&quot;law and order gain&quot;</span><span class="p">:</span> <span class="s2">&quot;Law and Order Gain&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l127"
               class="code sev- "><tt><i>127</i>         <span class="s2">&quot;pointlessnesses reroll&quot;</span><span class="p">:</span> <span class="s2">&quot;Pointlessnesses Reroll&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l128"
               class="code sev- "><tt><i>128</i>     <span class="p">}</span></tt>
            </div>
            <div id="l129"
               class="code sev- "><tt><i>129</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lore data loaded from lore.py.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l130"
               class="code sev- "><tt><i>130</i> <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span></tt>
            </div>
            <div id="l131"
               class="code sev- "><tt><i>131</i>     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;lore.py not found. Using fallback data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l132"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>132</i>     <span class="k">pass</span> <span class="c1"># Keep fallbacks</span></tt>
            </div>
            <div id="l133"
               class="code sev- "><tt><i>133</i> &nbsp;</tt>
            </div>
            <div id="l134"
               class="code sev- "><tt><i>134</i> <span class="c1"># --- Load Lore Vocabulary ---</span></tt>
            </div>
            <div id="l135"
               class="code sev- "><tt><i>135</i> <span class="n">lore_vocabulary</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l136"
               class="code sev- "><tt><i>136</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l137"
               class="code sev- "><tt><i>137</i>     <span class="n">LORE_VOCAB_PATH</span> <span class="o">=</span> <span class="s1">&#39;lore_vocabulary.json&#39;</span></tt>
            </div>
            <div id="l138"
               class="code sev- "><tt><i>138</i>     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">LORE_VOCAB_PATH</span><span class="p">):</span></tt>
            </div>
            <div id="l139"
               class="code sev- "><tt><i>139</i>         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LORE_VOCAB_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span></tt>
            </div>
            <div id="l140"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>140</i>              <span class="n">lore_vocabulary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></tt>
            </div>
            <div id="l141"
               class="code sev- "><tt><i>141</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lore vocabulary loaded from </span><span class="si">{</span><span class="n">LORE_VOCAB_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l142"
               class="code sev- "><tt><i>142</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l143"
               class="code sev- "><tt><i>143</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LORE_VOCAB_PATH</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l144"
               class="code sev- "><tt><i>144</i> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l145"
               class="code sev- "><tt><i>145</i>     <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading </span><span class="si">{</span><span class="n">LORE_VOCAB_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l146"
               class="code sev- "><tt><i>146</i> &nbsp;</tt>
            </div>
            <div id="l147"
               class="code sev- "><tt><i>147</i> <span class="c1"># --- Load Pre-made Character Templates ---</span></tt>
            </div>
            <div id="l148"
               class="code sev- "><tt><i>148</i> <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l149"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>149</i> <span class="n">PREMADE_CHARS_PATH</span> <span class="o">=</span> <span class="s1">&#39;premade_characters.json&#39;</span> <span class="c1"># Define path outside try block</span></tt>
            </div>
            <div id="l150"
               class="code sev- "><tt><i>150</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l151"
               class="code sev- "><tt><i>151</i>     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PREMADE_CHARS_PATH</span><span class="p">):</span></tt>
            </div>
            <div id="l152"
               class="code sev- "><tt><i>152</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l153"
               class="code sev- "><tt><i>153</i>             <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PREMADE_CHARS_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span></tt>
            </div>
            <div id="l154"
               class="code sev- "><tt><i>154</i>                 <span class="n">raw_templates</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></tt>
            </div>
            <div id="l155"
               class="code sev- "><tt><i>155</i>             <span class="c1"># Remove base_attributes during loading</span></tt>
            </div>
            <div id="l156"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>156</i>             <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;base_attributes&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_templates</span><span class="p">]</span></tt>
            </div>
            <div id="l157"
               class="code sev- "><tt><i>157</i>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">premade_character_templates</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span></tt>
            </div>
            <div id="l158"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (126 > 79 characters)</li>

               </ul><tt><i>158</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;premade_chars.json contained data, but it was not in the expected list format after cleaning.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l159"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>159</i>                 <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Reset to empty list</span></tt>
            </div>
            <div id="l160"
               class="code sev- "><tt><i>160</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l161"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>161</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-made characters loaded and cleaned from </span><span class="si">{</span><span class="n">PREMADE_CHARS_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l162"
               class="code sev- "><tt><i>162</i>         <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">json_err</span><span class="p">:</span></tt>
            </div>
            <div id="l163"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>163</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON from </span><span class="si">{</span><span class="n">PREMADE_CHARS_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l164"
               class="code sev- "><tt><i>164</i>             <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l165"
               class="code sev- "><tt><i>165</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">read_err</span><span class="p">:</span></tt>
            </div>
            <div id="l166"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>166</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading or processing </span><span class="si">{</span><span class="n">PREMADE_CHARS_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">read_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l167"
               class="code sev- "><tt><i>167</i>             <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l168"
               class="code sev- "><tt><i>168</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l169"
               class="code sev- "><tt><i>169</i>         <span class="c1"># This is the path that logs the warning we&#39;ve been seeing</span></tt>
            </div>
            <div id="l170"
               class="code sev- "><tt><i>170</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREMADE_CHARS_PATH</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l171"
               class="code sev- "><tt><i>171</i> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">outer_e</span><span class="p">:</span></tt>
            </div>
            <div id="l172"
               class="code sev- "><tt><i>172</i>     <span class="c1"># Catch any other unexpected errors during the check/load process</span></tt>
            </div>
            <div id="l173"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (129 > 79 characters)</li>

               </ul><tt><i>173</i>     <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during pre-made character loading setup for </span><span class="si">{</span><span class="n">PREMADE_CHARS_PATH</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">outer_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l174"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>174</i>     <span class="n">premade_character_templates</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Ensure it&#39;s empty on any error</span></tt>
            </div>
            <div id="l175"
               class="code sev- "><tt><i>175</i> &nbsp;</tt>
            </div>
            <div id="l176"
               class="code sev- "><tt><i>176</i> &nbsp;</tt>
            </div>
            <div id="l177"
               class="code sev- "><tt><i>177</i> <span class="c1"># --- Merged Character Data Definitions ---</span></tt>
            </div>
            <div id="l178"
               class="code sev- "><tt><i>178</i> <span class="n">RACE_DATA</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l179"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>179</i>     <span class="s2">&quot;Sasquatch&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Natural Armor&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot Wear Armor&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span></tt>
            </div>
            <div id="l180"
               class="code sev- "><tt><i>180</i>     <span class="s2">&quot;Leprechaun&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Fortunate Find&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span></tt>
            </div>
            <div id="l181"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>181</i>     <span class="s2">&quot;Android&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Integrated Systems&quot;</span><span class="p">,</span> <span class="s2">&quot;Memory Limit&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span></tt>
            </div>
            <div id="l182"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>182</i>     <span class="s2">&quot;Opossuman&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Pack Tactics&quot;</span><span class="p">,</span> <span class="s2">&quot;Fierce Loyalty&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span></tt>
            </div>
            <div id="l183"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>183</i>     <span class="s2">&quot;Tortisian&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Artistic Shell&quot;</span><span class="p">,</span> <span class="s2">&quot;Second Brain&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span></tt>
            </div>
            <div id="l184"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>184</i>     <span class="s2">&quot;Slime&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;abilities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Absorb Magic&quot;</span><span class="p">,</span> <span class="s2">&quot;Shapechange&quot;</span><span class="p">],</span> <span class="s2">&quot;fate_point_mod&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span></tt>
            </div>
            <div id="l185"
               class="code sev- "><tt><i>185</i> <span class="p">}</span></tt>
            </div>
            <div id="l186"
               class="code sev- "><tt><i>186</i> <span class="n">CLASS_DATA</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l187"
               class="code sev- "><tt><i>187</i>     <span class="s2">&quot;Inventor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;focus&quot;</span><span class="p">:</span> <span class="s2">&quot;My First Gadget&quot;</span><span class="p">,</span> <span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Tinker&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l188"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>188</i>     <span class="s2">&quot;Archanist&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;focus&quot;</span><span class="p">:</span> <span class="s2">&quot;Favorite Incantation&quot;</span><span class="p">,</span> <span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Arcane Affinity&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l189"
               class="code sev- "><tt><i>189</i>     <span class="s2">&quot;Soldier&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;focus&quot;</span><span class="p">:</span> <span class="s2">&quot;Weapon of Choice&quot;</span><span class="p">,</span> <span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Combat Ready&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l190"
               class="code sev- "><tt><i>190</i>     <span class="s2">&quot;Counselor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;focus&quot;</span><span class="p">:</span> <span class="s2">&quot;Trusted Confidante&quot;</span><span class="p">,</span> <span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Empathic&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l191"
               class="code sev- "><tt><i>191</i>     <span class="s2">&quot;Rascal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;focus&quot;</span><span class="p">:</span> <span class="s2">&quot;Useful Acquaintance&quot;</span><span class="p">,</span> <span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick Wits&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l192"
               class="code sev- "><tt><i>192</i> <span class="p">}</span></tt>
            </div>
            <div id="l193"
               class="code sev- "><tt><i>193</i> <span class="n">PHILOSOPHY_DATA</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l194"
               class="code sev- "><tt><i>194</i>     <span class="s2">&quot;Becoming Awesome&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Becoming Awesome Boost&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l195"
               class="code sev- "><tt><i>195</i>     <span class="s2">&quot;Law and Order&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Law and Order Gain&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l196"
               class="code sev- "><tt><i>196</i>     <span class="s2">&quot;Pointlessnesses&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="s2">&quot;Pointlessnesses Reroll&quot;</span><span class="p">},</span></tt>
            </div>
            <div id="l197"
               class="code sev- "><tt><i>197</i> <span class="p">}</span></tt>
            </div>
            <div id="l198"
               class="code sev- "><tt><i>198</i> <span class="c1"># --- End Merged Character Data ---</span></tt>
            </div>
            <div id="l199"
               class="code sev- "><tt><i>199</i> &nbsp;</tt>
            </div>
            <div id="l200"
               class="code sev- "><tt><i>200</i> &nbsp;</tt>
            </div>
            <div id="l201"
               class="code sev- "><tt><i>201</i> <span class="c1"># --- Constants and Configuration ---</span></tt>
            </div>
            <div id="l202"
               class="code sev- "><tt><i>202</i> <span class="n">MAX_INPUT_LENGTH</span> <span class="o">=</span> <span class="mi">500</span></tt>
            </div>
            <div id="l203"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>203</i> <span class="n">MAX_CONVO_LINES</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Max lines of conversation log saved to Firestore</span></tt>
            </div>
            <div id="l204"
               class="code sev- "><tt><i>204</i> <span class="n">STARTING_LOCATION</span> <span class="o">=</span> <span class="s2">&quot;Thetopia - Town Square&quot;</span></tt>
            </div>
            <div id="l205"
               class="code sev- "><tt><i>205</i> <span class="n">BASE_FATE_POINTS</span> <span class="o">=</span> <span class="mi">1</span></tt>
            </div>
            <div id="l206"
               class="code sev- "><tt><i>206</i> <span class="n">FIREBASE_APP_NAME</span> <span class="o">=</span> <span class="s1">&#39;daydream-firebase-app&#39;</span></tt>
            </div>
            <div id="l207"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>207</i> <span class="n">DEFAULT_SERVICE_ACCOUNT_KEY_FILE</span> <span class="o">=</span> <span class="s2">&quot;daydream-455317-e701a4533dc0.json&quot;</span> <span class="c1"># !! REPLACE !!</span></tt>
            </div>
            <div id="l208"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>208</i> <span class="n">DEFAULT_VOCAB_LIST_COLOR</span> <span class="o">=</span> <span class="s2">&quot;#ADD8E6&quot;</span> <span class="c1"># Example color</span></tt>
            </div>
            <div id="l209"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>209</i> <span class="n">DEFAULT_AWL_COLOR</span> <span class="o">=</span> <span class="s2">&quot;#FFC0CB&quot;</span> <span class="c1"># Example color</span></tt>
            </div>
            <div id="l210"
               class="code sev- "><tt><i>210</i> &nbsp;</tt>
            </div>
            <div id="l211"
               class="code sev- "><tt><i>211</i> <span class="c1"># Session Keys</span></tt>
            </div>
            <div id="l212"
               class="code sev- "><tt><i>212</i> <span class="n">SESSION_USER_ID</span> <span class="o">=</span> <span class="s1">&#39;user_id&#39;</span></tt>
            </div>
            <div id="l213"
               class="code sev- "><tt><i>213</i> <span class="n">SESSION_USER_EMAIL</span> <span class="o">=</span> <span class="s1">&#39;user_email&#39;</span></tt>
            </div>
            <div id="l214"
               class="code sev- "><tt><i>214</i> <span class="n">SESSION_CHARACTER_ID</span> <span class="o">=</span> <span class="s1">&#39;character_id&#39;</span></tt>
            </div>
            <div id="l215"
               class="code sev- "><tt><i>215</i> <span class="n">SESSION_CONVERSATION</span> <span class="o">=</span> <span class="s1">&#39;conversation&#39;</span></tt>
            </div>
            <div id="l216"
               class="code sev- "><tt><i>216</i> <span class="n">SESSION_LOCATION</span> <span class="o">=</span> <span class="s1">&#39;location&#39;</span></tt>
            </div>
            <div id="l217"
               class="code sev- "><tt><i>217</i> <span class="n">SESSION_LAST_AI_OUTPUT</span> <span class="o">=</span> <span class="s1">&#39;last_ai_output&#39;</span></tt>
            </div>
            <div id="l218"
               class="code sev- "><tt><i>218</i> <span class="n">SESSION_CHAPTER_INPUTS</span> <span class="o">=</span> <span class="s1">&#39;chapter_player_inputs&#39;</span></tt>
            </div>
            <div id="l219"
               class="code sev- "><tt><i>219</i> <span class="n">SESSION_EOC_STATE</span> <span class="o">=</span> <span class="s1">&#39;eoc_state&#39;</span></tt>
            </div>
            <div id="l220"
               class="code sev- "><tt><i>220</i> <span class="n">SESSION_EOC_QUESTIONS</span> <span class="o">=</span> <span class="s1">&#39;eoc_comp_questions&#39;</span></tt>
            </div>
            <div id="l221"
               class="code sev- "><tt><i>221</i> <span class="n">SESSION_EOC_SUMMARY</span> <span class="o">=</span> <span class="s1">&#39;eoc_report_summary&#39;</span></tt>
            </div>
            <div id="l222"
               class="code sev- "><tt><i>222</i> <span class="n">SESSION_EOC_PROMPTED</span> <span class="o">=</span> <span class="s1">&#39;eoc_prompted_this_turn&#39;</span></tt>
            </div>
            <div id="l223"
               class="code sev- "><tt><i>223</i> <span class="n">SESSION_NEW_CHAR_DETAILS</span> <span class="o">=</span> <span class="s1">&#39;new_char_details&#39;</span></tt>
            </div>
            <div id="l224"
               class="code sev- "><tt><i>224</i> <span class="n">SESSION_AI_RECOMMENDATIONS</span> <span class="o">=</span> <span class="s1">&#39;ai_recommendations&#39;</span></tt>
            </div>
            <div id="l225"
               class="code sev- "><tt><i>225</i> <span class="n">SESSION_SIDE_QUEST_ACTIVE</span> <span class="o">=</span> <span class="s1">&#39;side_quest_active&#39;</span></tt>
            </div>
            <div id="l226"
               class="code sev- "><tt><i>226</i> <span class="n">SESSION_SIDE_QUEST_DESC</span> <span class="o">=</span> <span class="s1">&#39;side_quest_description&#39;</span></tt>
            </div>
            <div id="l227"
               class="code sev- "><tt><i>227</i> <span class="n">SESSION_SIDE_QUEST_TURNS</span> <span class="o">=</span> <span class="s1">&#39;side_quest_turns&#39;</span></tt>
            </div>
            <div id="l228"
               class="code sev- "><tt><i>228</i> &nbsp;</tt>
            </div>
            <div id="l229"
               class="code sev- "><tt><i>229</i> <span class="c1"># Firestore Field Names</span></tt>
            </div>
            <div id="l230"
               class="code sev- "><tt><i>230</i> <span class="n">FS_CONVERSATION</span> <span class="o">=</span> <span class="s1">&#39;conversation_log&#39;</span></tt>
            </div>
            <div id="l231"
               class="code sev- "><tt><i>231</i> <span class="n">FS_CHAPTER_INPUTS</span> <span class="o">=</span> <span class="s1">&#39;current_chapter_inputs&#39;</span></tt>
            </div>
            <div id="l232"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>232</i> <span class="n">FS_QUEST_FLAGS</span> <span class="o">=</span> <span class="s1">&#39;quest_flags&#39;</span> <span class="c1"># Dictionary to store flags like {&#39;fountain_analyzed&#39;: True}</span></tt>
            </div>
            <div id="l233"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>233</i> <span class="n">FS_INVENTORY</span> <span class="o">=</span> <span class="s1">&#39;inventory&#39;</span> <span class="c1"># List to store item names like [&#39;Cogwheel&#39;, &#39;Hydro-Spanner&#39;]</span></tt>
            </div>
            <div id="l234"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>234</i> <span class="n">FS_PLAYER_HAS_SEEN_INTRO</span> <span class="o">=</span> <span class="s1">&#39;has_seen_intro&#39;</span> <span class="c1"># &lt;&lt;&lt; NEW &gt;&gt;&gt; Firestore field name constant</span></tt>
            </div>
            <div id="l235"
               class="code sev- "><tt><i>235</i> &nbsp;</tt>
            </div>
            <div id="l236"
               class="code sev- "><tt><i>236</i> <span class="c1"># Game Logic Constants</span></tt>
            </div>
            <div id="l237"
               class="code sev- "><tt><i>237</i> <span class="n">EOC_CHECK_START_TURN</span> <span class="o">=</span> <span class="mi">10</span></tt>
            </div>
            <div id="l238"
               class="code sev- "><tt><i>238</i> <span class="n">EOC_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mi">4</span></tt>
            </div>
            <div id="l239"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>239</i> <span class="n">MIN_INPUTS_FOR_EOC</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Example minimum inputs before EOC can trigger</span></tt>
            </div>
            <div id="l240"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>240</i> <span class="n">HERO_JOURNEY_STAGES</span> <span class="o">=</span> <span class="p">[</span> <span class="c1"># Simple stage progression based on chapter number</span></tt>
            </div>
            <div id="l241"
               class="code sev- "><tt><i>241</i>     <span class="s2">&quot;The Ordinary World&quot;</span><span class="p">,</span> <span class="s2">&quot;The Call to Adventure&quot;</span><span class="p">,</span> <span class="s2">&quot;Refusal of the Call&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l242"
               class="code sev- "><tt><i>242</i>     <span class="s2">&quot;Meeting the Mentor&quot;</span><span class="p">,</span> <span class="s2">&quot;Crossing the Threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;Tests, Allies, Enemies&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l243"
               class="code sev- "><tt><i>243</i>     <span class="s2">&quot;Approach to the Inmost Cave&quot;</span><span class="p">,</span> <span class="s2">&quot;The Ordeal&quot;</span><span class="p">,</span> <span class="s2">&quot;Reward (Seizing the Sword)&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l244"
               class="code sev- "><tt><i>244</i>     <span class="s2">&quot;The Road Back&quot;</span><span class="p">,</span> <span class="s2">&quot;Resurrection&quot;</span><span class="p">,</span> <span class="s2">&quot;Return with the Elixir&quot;</span></tt>
            </div>
            <div id="l245"
               class="code sev- "><tt><i>245</i> <span class="p">]</span></tt>
            </div>
            <div id="l246"
               class="code sev- "><tt><i>246</i> &nbsp;</tt>
            </div>
            <div id="l247"
               class="code sev- "><tt><i>247</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l248"
               class="code sev- "><tt><i>248</i> <span class="c1"># Flask App Initialization &amp; Logging Setup</span></tt>
            </div>
            <div id="l249"
               class="code sev- "><tt><i>249</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l250"
               class="code sev- "><tt><i>250</i> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></tt>
            </div>
            <div id="l251"
               class="code sev- "><tt><i>251</i> <span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_SECRET_KEY&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span></tt>
            </div>
            <div id="l252"
               class="code sev- "><tt><i>252</i> <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WERKZEUG_RUN_MAIN&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l253"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (127 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>253</i>     <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Changed default level to INFO</span></tt>
            </div>
            <div id="l254"
               class="code sev- "><tt><i>254</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Flask application initialized and logging configured.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l255"
               class="code sev- "><tt><i>255</i> &nbsp;</tt>
            </div>
            <div id="l256"
               class="code sev- "><tt><i>256</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l257"
               class="code sev- "><tt><i>257</i> <span class="c1"># Firebase Initialization</span></tt>
            </div>
            <div id="l258"
               class="code sev- "><tt><i>258</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l259"
               class="code sev- "><tt><i>259</i> <span class="n">firebase_app</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l260"
               class="code sev- "><tt><i>260</i> <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l261"
               class="code sev- "><tt><i>261</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l262"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

               </ul><tt><i>262</i>     <span class="n">SERVICE_ACCOUNT_KEY_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FIREBASE_SERVICE_ACCOUNT_KEY&quot;</span><span class="p">,</span> <span class="n">DEFAULT_SERVICE_ACCOUNT_KEY_FILE</span><span class="p">)</span></tt>
            </div>
            <div id="l263"
               class="code sev- "><tt><i>263</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SERVICE_ACCOUNT_KEY_PATH</span><span class="p">):</span></tt>
            </div>
            <div id="l264"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>264</i>         <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Firebase key not found: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">SERVICE_ACCOUNT_KEY_PATH</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l265"
               class="code sev- "><tt><i>265</i>         <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l266"
               class="code sev- "><tt><i>266</i>     <span class="n">cred</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">Certificate</span><span class="p">(</span><span class="n">SERVICE_ACCOUNT_KEY_PATH</span><span class="p">)</span></tt>
            </div>
            <div id="l267"
               class="code sev- "><tt><i>267</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l268"
               class="code sev- "><tt><i>268</i>         <span class="n">firebase_app</span> <span class="o">=</span> <span class="n">firebase_admin</span><span class="o">.</span><span class="n">get_app</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">FIREBASE_APP_NAME</span><span class="p">)</span></tt>
            </div>
            <div id="l269"
               class="code sev- "><tt><i>269</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using existing Firebase app: &#39;</span><span class="si">{</span><span class="n">FIREBASE_APP_NAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l270"
               class="code sev- "><tt><i>270</i>     <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span></tt>
            </div>
            <div id="l271"
               class="code sev- "><tt><i>271</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Firebase app: &#39;</span><span class="si">{</span><span class="n">FIREBASE_APP_NAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l272"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>272</i>         <span class="n">firebase_app</span> <span class="o">=</span> <span class="n">firebase_admin</span><span class="o">.</span><span class="n">initialize_app</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">FIREBASE_APP_NAME</span><span class="p">)</span></tt>
            </div>
            <div id="l273"
               class="code sev- "><tt><i>273</i>     <span class="n">db</span> <span class="o">=</span> <span class="n">firestore</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">firebase_app</span><span class="p">)</span></tt>
            </div>
            <div id="l274"
               class="code sev- "><tt><i>274</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Firebase Admin SDK initialized.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l275"
               class="code sev- "><tt><i>275</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l276"
               class="code sev- "><tt><i>276</i>         <span class="c1"># Test connection with a short timeout</span></tt>
            </div>
            <div id="l277"
               class="code sev- "><tt><i>277</i>         <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;_test_connection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="s1">&#39;_doc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></tt>
            </div>
            <div id="l278"
               class="code sev- "><tt><i>278</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Firestore connection test successful.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l279"
               class="code sev- "><tt><i>279</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">db_test_err</span><span class="p">:</span></tt>
            </div>
            <div id="l280"
               class="code sev- "><tt><i>280</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Firestore connection test failed: </span><span class="si">{</span><span class="n">db_test_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l281"
               class="code sev- "><tt><i>281</i> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l282"
               class="code sev- "><tt><i>282</i>     <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FATAL ERROR: Could not initialize Firebase: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l283"
               class="code sev- "><tt><i>283</i>     <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l284"
               class="code sev- "><tt><i>284</i> &nbsp;</tt>
            </div>
            <div id="l285"
               class="code sev- "><tt><i>285</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l286"
               class="code sev- "><tt><i>286</i> <span class="c1"># Google AI (Gemini) Initialization</span></tt>
            </div>
            <div id="l287"
               class="code sev- "><tt><i>287</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l288"
               class="code sev- "><tt><i>288</i> <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l289"
               class="code sev- "><tt><i>289</i> <span class="n">safety_settings</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l290"
               class="code sev- "><tt><i>290</i> <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l291"
               class="code sev- "><tt><i>291</i>     <span class="c1"># --- Get the API key from environment variables for security ---</span></tt>
            </div>
            <div id="l292"
               class="code sev- "><tt><i>292</i>     <span class="n">GEMINI_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l293"
               class="code sev- "><tt><i>293</i> &nbsp;</tt>
            </div>
            <div id="l294"
               class="code sev- "><tt><i>294</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">GEMINI_API_KEY</span> <span class="ow">or</span> <span class="n">GEMINI_API_KEY</span> <span class="o">==</span> <span class="s2">&quot;PASTE_YOUR_NEW_API_KEY_HERE&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l295"
               class="code sev- "><tt><i>295</i>         <span class="c1"># Added a check for the placeholder value as well</span></tt>
            </div>
            <div id="l296"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (107 > 79 characters)</li>

               </ul><tt><i>296</i>         <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;FATAL: GEMINI_API_KEY environment variable not set or is still the placeholder.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l297"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>297</i>         <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Please set the GEMINI_API_KEY environment variable to your actual Google AI API key.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l298"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>298</i>         <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Exit if the key is not configured</span></tt>
            </div>
            <div id="l299"
               class="code sev- "><tt><i>299</i> &nbsp;</tt>
            </div>
            <div id="l300"
               class="code sev- "><tt><i>300</i>     <span class="c1"># --- Configure the new library with your key ---</span></tt>
            </div>
            <div id="l301"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>301</i>     <span class="kn">import</span><span class="w"> </span><span class="nn">google.generativeai</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">genai</span> <span class="c1"># &lt;&lt;&lt; NEW IMPORT</span></tt>
            </div>
            <div id="l302"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>302</i>     <span class="kn">from</span><span class="w"> </span><span class="nn">google.generativeai.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">HarmCategory</span><span class="p">,</span> <span class="n">HarmBlockThreshold</span> <span class="c1"># &lt;&lt;&lt; ADDED IMPORT</span></tt>
            </div>
            <div id="l303"
               class="code sev- "><tt><i>303</i>     <span class="n">genai</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">GEMINI_API_KEY</span><span class="p">)</span></tt>
            </div>
            <div id="l304"
               class="code sev- "><tt><i>304</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Google AI SDK configured.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l305"
               class="code sev- "><tt><i>305</i> &nbsp;</tt>
            </div>
            <div id="l306"
               class="code sev- "><tt><i>306</i>     <span class="c1"># --- Initialize the generative model ---</span></tt>
            </div>
            <div id="l307"
               class="code sev- "><tt><i>307</i>     <span class="c1"># The model name is slightly different in this new library</span></tt>
            </div>
            <div id="l308"
               class="code sev- "><tt><i>308</i>     <span class="n">model</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">GenerativeModel</span><span class="p">(</span><span class="s2">&quot;gemini-1.5-flash-latest&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l309"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>309</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Google AI Model &#39;gemini-1.5-flash-latest&#39; initialized.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l310"
               class="code sev- "><tt><i>310</i> &nbsp;</tt>
            </div>
            <div id="l311"
               class="code sev- "><tt><i>311</i>     <span class="c1"># Configure safety settings (the names are the same)</span></tt>
            </div>
            <div id="l312"
               class="code sev- "><tt><i>312</i>     <span class="n">safety_settings</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l313"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>313</i>         <span class="n">HarmCategory</span><span class="o">.</span><span class="n">HARM_CATEGORY_HARASSMENT</span><span class="p">:</span> <span class="n">HarmBlockThreshold</span><span class="o">.</span><span class="n">BLOCK_MEDIUM_AND_ABOVE</span><span class="p">,</span></tt>
            </div>
            <div id="l314"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>314</i>         <span class="n">HarmCategory</span><span class="o">.</span><span class="n">HARM_CATEGORY_HATE_SPEECH</span><span class="p">:</span> <span class="n">HarmBlockThreshold</span><span class="o">.</span><span class="n">BLOCK_MEDIUM_AND_ABOVE</span><span class="p">,</span></tt>
            </div>
            <div id="l315"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>315</i>         <span class="n">HarmCategory</span><span class="o">.</span><span class="n">HARM_CATEGORY_SEXUALLY_EXPLICIT</span><span class="p">:</span> <span class="n">HarmBlockThreshold</span><span class="o">.</span><span class="n">BLOCK_MEDIUM_AND_ABOVE</span><span class="p">,</span></tt>
            </div>
            <div id="l316"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>316</i>         <span class="n">HarmCategory</span><span class="o">.</span><span class="n">HARM_CATEGORY_DANGEROUS_CONTENT</span><span class="p">:</span> <span class="n">HarmBlockThreshold</span><span class="o">.</span><span class="n">BLOCK_MEDIUM_AND_ABOVE</span><span class="p">,</span></tt>
            </div>
            <div id="l317"
               class="code sev- "><tt><i>317</i>     <span class="p">}</span></tt>
            </div>
            <div id="l318"
               class="code sev- "><tt><i>318</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Google AI safety settings configured.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l319"
               class="code sev- "><tt><i>319</i> &nbsp;</tt>
            </div>
            <div id="l320"
               class="code sev- "><tt><i>320</i> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l321"
               class="code sev- "><tt><i>321</i>     <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FATAL ERROR: Could not initialize Google AI: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l322"
               class="code sev- "><tt><i>322</i>     <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l323"
               class="code sev- "><tt><i>323</i> &nbsp;</tt>
            </div>
            <div id="l324"
               class="code sev- "><tt><i>324</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l325"
               class="code sev- "><tt><i>325</i> <span class="c1"># Application Helper Functions</span></tt>
            </div>
            <div id="l326"
               class="code sev- "><tt><i>326</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l327"
               class="code sev- "><tt><i>327</i> &nbsp;</tt>
            </div>
            <div id="l328"
               class="code sev- "><tt><i>328</i> <span class="c1"># --- Text Processing for Highlighting ---</span></tt>
            </div>
            <div id="l329"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>329</i> <span class="k">def</span><span class="w"> </span><span class="nf">find_terms_in_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">terms_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span></tt>
            </div>
            <div id="l330"
               class="code sev- "><tt><i>330</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic function to find terms in text based on a dictionary.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l331"
               class="code sev- "><tt><i>331</i>     <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l332"
               class="code sev- "><tt><i>332</i>     <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">terms_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span></tt>
            </div>
            <div id="l333"
               class="code sev- "><tt><i>333</i>         <span class="k">return</span> <span class="n">found</span></tt>
            </div>
            <div id="l334"
               class="code sev- "><tt><i>334</i> &nbsp;</tt>
            </div>
            <div id="l335"
               class="code sev- "><tt><i>335</i>     <span class="c1"># Build a map where keys are transformed (e.g., lowercased)</span></tt>
            </div>
            <div id="l336"
               class="code sev- "><tt><i>336</i>     <span class="n">transformed_map</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l337"
               class="code sev- "><tt><i>337</i>     <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">terms_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l338"
               class="code sev- "><tt><i>338</i>         <span class="n">transformed_key</span> <span class="o">=</span> <span class="n">key_transform</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span></tt>
            </div>
            <div id="l339"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>339</i>         <span class="k">if</span> <span class="n">transformed_key</span><span class="p">:</span> <span class="c1"># Avoid empty keys</span></tt>
            </div>
            <div id="l340"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>340</i>             <span class="n">transformed_map</span><span class="p">[</span><span class="n">transformed_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="n">keyword</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span></tt>
            </div>
            <div id="l341"
               class="code sev- "><tt><i>341</i> &nbsp;</tt>
            </div>
            <div id="l342"
               class="code sev- "><tt><i>342</i>     <span class="c1"># Sort keys by length (longest first) to prioritize longer matches</span></tt>
            </div>
            <div id="l343"
               class="code sev- "><tt><i>343</i>     <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transformed_map</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l344"
               class="code sev- "><tt><i>344</i> &nbsp;</tt>
            </div>
            <div id="l345"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>345</i>     <span class="n">processed_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># Track indices already part of a found term</span></tt>
            </div>
            <div id="l346"
               class="code sev- "><tt><i>346</i> &nbsp;</tt>
            </div>
            <div id="l347"
               class="code sev- "><tt><i>347</i>     <span class="k">for</span> <span class="n">term_key</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">:</span></tt>
            </div>
            <div id="l348"
               class="code sev- "><tt><i>348</i>         <span class="n">term_info</span> <span class="o">=</span> <span class="n">transformed_map</span><span class="p">[</span><span class="n">term_key</span><span class="p">]</span></tt>
            </div>
            <div id="l349"
               class="code sev- "><tt><i>349</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l350"
               class="code sev- "><tt><i>350</i>             <span class="c1"># Match whole words only, case-insensitive</span></tt>
            </div>
            <div id="l351"
               class="code sev- "><tt><i>351</i>             <span class="c1"># Use word boundaries (\b) to avoid matching parts of words</span></tt>
            </div>
            <div id="l352"
               class="code sev- "><tt><i>352</i>             <span class="n">escaped_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">term_key</span><span class="p">)</span></tt>
            </div>
            <div id="l353"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>353</i>             <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">escaped_key</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span></tt>
            </div>
            <div id="l354"
               class="code sev- "><tt><i>354</i>                 <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span></tt>
            </div>
            <div id="l355"
               class="code sev- "><tt><i>355</i> &nbsp;</tt>
            </div>
            <div id="l356"
               class="code sev- "><tt><i>356</i>                 <span class="c1"># Check for overlap with already processed indices</span></tt>
            </div>
            <div id="l357"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>357</i>                 <span class="n">is_overlap</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">processed_indices</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">))</span></tt>
            </div>
            <div id="l358"
               class="code sev- "><tt><i>358</i> &nbsp;</tt>
            </div>
            <div id="l359"
               class="code sev- "><tt><i>359</i>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">is_overlap</span><span class="p">:</span></tt>
            </div>
            <div id="l360"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>360</i>                     <span class="c1"># Store the start, end, original keyword (for display), and associated data</span></tt>
            </div>
            <div id="l361"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>361</i>                     <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">,</span> <span class="n">term_info</span><span class="p">[</span><span class="s2">&quot;original&quot;</span><span class="p">],</span> <span class="n">term_info</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]))</span></tt>
            </div>
            <div id="l362"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>362</i>                     <span class="c1"># Mark indices as processed to prevent nested/overlapping highlights</span></tt>
            </div>
            <div id="l363"
               class="code sev- "><tt><i>363</i>                     <span class="n">processed_indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">))</span></tt>
            </div>
            <div id="l364"
               class="code sev- "><tt><i>364</i> &nbsp;</tt>
            </div>
            <div id="l365"
               class="code sev- "><tt><i>365</i>         <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">regex_err</span><span class="p">:</span></tt>
            </div>
            <div id="l366"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>366</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regex error processing term &#39;</span><span class="si">{</span><span class="n">term_key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">regex_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l367"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>367</i>             <span class="k">continue</span> <span class="c1"># Skip problematic terms</span></tt>
            </div>
            <div id="l368"
               class="code sev- "><tt><i>368</i> &nbsp;</tt>
            </div>
            <div id="l369"
               class="code sev- "><tt><i>369</i>     <span class="c1"># Sort findings by their starting position in the text</span></tt>
            </div>
            <div id="l370"
               class="code sev- "><tt><i>370</i>     <span class="n">found</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></tt>
            </div>
            <div id="l371"
               class="code sev- "><tt><i>371</i>     <span class="k">return</span> <span class="n">found</span></tt>
            </div>
            <div id="l372"
               class="code sev- "><tt><i>372</i> &nbsp;</tt>
            </div>
            <div id="l373"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (338 > 79 characters)</li>

               </ul><tt><i>373</i> <span class="k">def</span><span class="w"> </span><span class="nf">process_text_for_highlighting</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]],</span> <span class="n">span_class</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_attribute_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;#39;&quot;</span><span class="p">),</span> <span class="n">title_formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">display_formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">original_keyword</span><span class="p">,</span> <span class="n">matched_text</span><span class="p">,</span> <span class="n">term_data</span><span class="p">:</span> <span class="n">matched_text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span></tt>
            </div>
            <div id="l374"
               class="code sev- "><tt><i>374</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies highlighting spans to text based on pre-found terms.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l375"
               class="code sev- "><tt><i>375</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">terms</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span></tt>
            </div>
            <div id="l376"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>376</i>         <span class="k">return</span> <span class="n">text</span> <span class="c1"># Return original text if no terms found or text is empty</span></tt>
            </div>
            <div id="l377"
               class="code sev- "><tt><i>377</i> &nbsp;</tt>
            </div>
            <div id="l378"
               class="code sev- "><tt><i>378</i>     <span class="n">result_parts</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l379"
               class="code sev- "><tt><i>379</i>     <span class="n">last_end_index</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l380"
               class="code sev- "><tt><i>380</i> &nbsp;</tt>
            </div>
            <div id="l381"
               class="code sev- "><tt><i>381</i>     <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">original_keyword</span><span class="p">,</span> <span class="n">term_data</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span></tt>
            </div>
            <div id="l382"
               class="code sev- "><tt><i>382</i>         <span class="c1"># Append text segment before the current term</span></tt>
            </div>
            <div id="l383"
               class="code sev- "><tt><i>383</i>         <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_end_index</span><span class="p">:</span><span class="n">start</span><span class="p">])</span></tt>
            </div>
            <div id="l384"
               class="code sev- "><tt><i>384</i> &nbsp;</tt>
            </div>
            <div id="l385"
               class="code sev- "><tt><i>385</i>         <span class="c1"># Prepare attributes for the span</span></tt>
            </div>
            <div id="l386"
               class="code sev- "><tt><i>386</i>         <span class="n">current_class</span> <span class="o">=</span> <span class="n">span_class</span></tt>
            </div>
            <div id="l387"
               class="code sev- "><tt><i>387</i>         <span class="n">attributes</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;class=&quot;</span><span class="si">{</span><span class="n">current_class</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="n">current_class</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l388"
               class="code sev- "><tt><i>388</i> &nbsp;</tt>
            </div>
            <div id="l389"
               class="code sev- "><tt><i>389</i>         <span class="c1"># Add title attribute (for hover tooltips)</span></tt>
            </div>
            <div id="l390"
               class="code sev- "><tt><i>390</i>         <span class="n">title</span> <span class="o">=</span> <span class="n">title_formatter</span><span class="p">(</span><span class="n">term_data</span><span class="p">)</span></tt>
            </div>
            <div id="l391"
               class="code sev- "><tt><i>391</i>         <span class="k">if</span> <span class="n">title</span><span class="p">:</span></tt>
            </div>
            <div id="l392"
               class="code sev- "><tt><i>392</i>             <span class="c1"># Ensure title attribute is properly escaped for HTML</span></tt>
            </div>
            <div id="l393"
               class="code sev- "><tt><i>393</i>             <span class="n">attributes</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; title=&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span></tt>
            </div>
            <div id="l394"
               class="code sev- "><tt><i>394</i> &nbsp;</tt>
            </div>
            <div id="l395"
               class="code sev- "><tt><i>395</i>         <span class="c1"># Add custom data attribute if specified</span></tt>
            </div>
            <div id="l396"
               class="code sev- "><tt><i>396</i>         <span class="k">if</span> <span class="n">data_attribute_name</span><span class="p">:</span></tt>
            </div>
            <div id="l397"
               class="code sev- "><tt><i>397</i>             <span class="n">data_value</span> <span class="o">=</span> <span class="n">data_formatter</span><span class="p">(</span><span class="n">term_data</span><span class="p">)</span></tt>
            </div>
            <div id="l398"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>398</i>             <span class="c1"># Use single quotes for data attribute to avoid issues if data contains quotes</span></tt>
            </div>
            <div id="l399"
               class="code sev- "><tt><i>399</i>             <span class="n">attributes</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">data_attribute_name</span><span class="si">}</span><span class="s1">=</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">data_value</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span></tt>
            </div>
            <div id="l400"
               class="code sev- "><tt><i>400</i> &nbsp;</tt>
            </div>
            <div id="l401"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>401</i>         <span class="c1"># Get the matched text and format display text (usually just the matched text)</span></tt>
            </div>
            <div id="l402"
               class="code sev- "><tt><i>402</i>         <span class="n">matched_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span></tt>
            </div>
            <div id="l403"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>403</i>         <span class="n">display_text</span> <span class="o">=</span> <span class="n">display_formatter</span><span class="p">(</span><span class="n">original_keyword</span><span class="p">,</span> <span class="n">matched_text</span><span class="p">,</span> <span class="n">term_data</span><span class="p">)</span></tt>
            </div>
            <div id="l404"
               class="code sev- "><tt><i>404</i> &nbsp;</tt>
            </div>
            <div id="l405"
               class="code sev- "><tt><i>405</i>         <span class="c1"># Construct the span tag</span></tt>
            </div>
            <div id="l406"
               class="code sev- "><tt><i>406</i>         <span class="n">span</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;span </span><span class="si">{</span><span class="n">attributes</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">display_text</span><span class="si">}</span><span class="s1">&lt;/span&gt;&#39;</span></tt>
            </div>
            <div id="l407"
               class="code sev- "><tt><i>407</i>         <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span</span><span class="p">)</span></tt>
            </div>
            <div id="l408"
               class="code sev- "><tt><i>408</i> &nbsp;</tt>
            </div>
            <div id="l409"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>409</i>         <span class="n">last_end_index</span> <span class="o">=</span> <span class="n">end</span> <span class="c1"># Update position for next iteration</span></tt>
            </div>
            <div id="l410"
               class="code sev- "><tt><i>410</i> &nbsp;</tt>
            </div>
            <div id="l411"
               class="code sev- "><tt><i>411</i>     <span class="c1"># Append the remaining text after the last term</span></tt>
            </div>
            <div id="l412"
               class="code sev- "><tt><i>412</i>     <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_end_index</span><span class="p">:])</span></tt>
            </div>
            <div id="l413"
               class="code sev- "><tt><i>413</i> &nbsp;</tt>
            </div>
            <div id="l414"
               class="code sev- "><tt><i>414</i>     <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_parts</span><span class="p">)</span></tt>
            </div>
            <div id="l415"
               class="code sev- "><tt><i>415</i> &nbsp;</tt>
            </div>
            <div id="l416"
               class="code sev- "><tt><i>416</i> &nbsp;</tt>
            </div>
            <div id="l417"
               class="code sev- "><tt><i>417</i> <span class="c1"># --- Vocabulary Highlighting ---</span></tt>
            </div>
            <div id="l418"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>418</i> <span class="k">def</span><span class="w"> </span><span class="nf">apply_vocab_highlighting_python</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocab_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">color_prefs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span></tt>
            </div>
            <div id="l419"
               class="code sev- "><tt><i>419</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l420"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>420</i> <span class="sd">    Applies highlighting spans for vocabulary terms using user color preferences.</span></tt>
            </div>
            <div id="l421"
               class="code sev- "><tt><i>421</i> <span class="sd">    Applies colors via inline styles, fetched from color_prefs dictionary.</span></tt>
            </div>
            <div id="l422"
               class="code sev- "><tt><i>422</i> <span class="sd">    &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l423"
               class="code sev- "><tt><i>423</i>     <span class="c1"># Define default fallback colors directly matching CSS variables initially</span></tt>
            </div>
            <div id="l424"
               class="code sev- "><tt><i>424</i>     <span class="n">DEFAULT_AWL_BG</span> <span class="o">=</span> <span class="s1">&#39;#FFE6EB&#39;</span></tt>
            </div>
            <div id="l425"
               class="code sev- "><tt><i>425</i>     <span class="n">DEFAULT_AWL_TEXT</span> <span class="o">=</span> <span class="s1">&#39;#6b0016&#39;</span></tt>
            </div>
            <div id="l426"
               class="code sev- "><tt><i>426</i>     <span class="n">DEFAULT_AI_BG</span> <span class="o">=</span> <span class="s1">&#39;#E1F0FF&#39;</span></tt>
            </div>
            <div id="l427"
               class="code sev- "><tt><i>427</i>     <span class="n">DEFAULT_AI_TEXT</span> <span class="o">=</span> <span class="s1">&#39;#003b4f&#39;</span></tt>
            </div>
            <div id="l428"
               class="code sev- "><tt><i>428</i> &nbsp;</tt>
            </div>
            <div id="l429"
               class="code sev- "><tt><i>429</i>     <span class="c1"># Ensure color_prefs is a dict, even if empty</span></tt>
            </div>
            <div id="l430"
               class="code sev- "><tt><i>430</i>     <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color_prefs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span></tt>
            </div>
            <div id="l431"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>431</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;apply_vocab_highlighting_python received invalid color_prefs, using defaults.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l432"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>432</i>         <span class="n">color_prefs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Use empty dict to allow .get() with defaults</span></tt>
            </div>
            <div id="l433"
               class="code sev- "><tt><i>433</i> &nbsp;</tt>
            </div>
            <div id="l434"
               class="code sev- "><tt><i>434</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">vocab_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span></tt>
            </div>
            <div id="l435"
               class="code sev- "><tt><i>435</i>         <span class="c1"># Return text if no vocab data or text provided</span></tt>
            </div>
            <div id="l436"
               class="code sev- "><tt><i>436</i>         <span class="k">return</span> <span class="n">text</span></tt>
            </div>
            <div id="l437"
               class="code sev- "><tt><i>437</i> &nbsp;</tt>
            </div>
            <div id="l438"
               class="code sev- "><tt><i>438</i>     <span class="c1"># Get user colors from prefs, falling back to defaults if missing/invalid</span></tt>
            </div>
            <div id="l439"
               class="code sev- "><tt><i>439</i>     <span class="n">awl_bg_color</span> <span class="o">=</span> <span class="n">color_prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">,</span> <span class="n">DEFAULT_AWL_BG</span><span class="p">)</span></tt>
            </div>
            <div id="l440"
               class="code sev- "><tt><i>440</i>     <span class="n">ai_bg_color</span> <span class="o">=</span> <span class="n">color_prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">,</span> <span class="n">DEFAULT_AI_BG</span><span class="p">)</span></tt>
            </div>
            <div id="l441"
               class="code sev- "><tt><i>441</i>     <span class="c1"># Basic validation for fetched colors (hex format)</span></tt>
            </div>
            <div id="l442"
               class="code sev- "><tt><i>442</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">awl_bg_color</span><span class="p">):</span></tt>
            </div>
            <div id="l443"
               class="code sev- "><tt><i>443</i>         <span class="n">awl_bg_color</span> <span class="o">=</span> <span class="n">DEFAULT_AWL_BG</span></tt>
            </div>
            <div id="l444"
               class="code sev- "><tt><i>444</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">ai_bg_color</span><span class="p">):</span></tt>
            </div>
            <div id="l445"
               class="code sev- "><tt><i>445</i>         <span class="n">ai_bg_color</span> <span class="o">=</span> <span class="n">DEFAULT_AI_BG</span></tt>
            </div>
            <div id="l446"
               class="code sev- "><tt><i>446</i> &nbsp;</tt>
            </div>
            <div id="l447"
               class="code sev- "><tt><i>447</i>     <span class="c1"># Using default text colors defined above for now</span></tt>
            </div>
            <div id="l448"
               class="code sev- "><tt><i>448</i>     <span class="n">awl_text_color</span> <span class="o">=</span> <span class="n">DEFAULT_AWL_TEXT</span></tt>
            </div>
            <div id="l449"
               class="code sev- "><tt><i>449</i>     <span class="n">ai_text_color</span> <span class="o">=</span> <span class="n">DEFAULT_AI_TEXT</span></tt>
            </div>
            <div id="l450"
               class="code sev- "><tt><i>450</i> &nbsp;</tt>
            </div>
            <div id="l451"
               class="code sev- "><tt><i>451</i>     <span class="c1"># Find terms in text (reusing the generic helper)</span></tt>
            </div>
            <div id="l452"
               class="code sev- "><tt><i>452</i>     <span class="c1"># Lowercase keys in vocab_data for case-insensitive matching</span></tt>
            </div>
            <div id="l453"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>453</i>     <span class="n">found_terms</span> <span class="o">=</span> <span class="n">find_terms_in_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab_data</span><span class="p">,</span> <span class="n">key_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span></tt>
            </div>
            <div id="l454"
               class="code sev- "><tt><i>454</i> &nbsp;</tt>
            </div>
            <div id="l455"
               class="code sev- "><tt><i>455</i>     <span class="c1"># Helper to format the title attribute (tooltip)</span></tt>
            </div>
            <div id="l456"
               class="code sev- "><tt><i>456</i>     <span class="k">def</span><span class="w"> </span><span class="nf">format_vocab_title</span><span class="p">(</span><span class="n">data</span><span class="p">):</span></tt>
            </div>
            <div id="l457"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>457</i>         <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> (Source: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span></tt>
            </div>
            <div id="l458"
               class="code sev- "><tt><i>458</i> &nbsp;</tt>
            </div>
            <div id="l459"
               class="code sev- "><tt><i>459</i>     <span class="c1"># Build the highlighted string part by part</span></tt>
            </div>
            <div id="l460"
               class="code sev- "><tt><i>460</i>     <span class="n">result_parts</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l461"
               class="code sev- "><tt><i>461</i>     <span class="n">last_end_index</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l462"
               class="code sev- "><tt><i>462</i>     <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">original_keyword</span><span class="p">,</span> <span class="n">term_data</span> <span class="ow">in</span> <span class="n">found_terms</span><span class="p">:</span></tt>
            </div>
            <div id="l463"
               class="code sev- "><tt><i>463</i>         <span class="c1"># Append text segment before the current term</span></tt>
            </div>
            <div id="l464"
               class="code sev- "><tt><i>464</i>         <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_end_index</span><span class="p">:</span><span class="n">start</span><span class="p">])</span></tt>
            </div>
            <div id="l465"
               class="code sev- "><tt><i>465</i> &nbsp;</tt>
            </div>
            <div id="l466"
               class="code sev- "><tt><i>466</i>         <span class="c1"># Determine if it&#39;s AWL or AI based on source</span></tt>
            </div>
            <div id="l467"
               class="code sev- "><tt><i>467</i>         <span class="n">is_ai_list</span> <span class="o">=</span> <span class="n">term_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;AWL&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;AWL&quot;</span></tt>
            </div>
            <div id="l468"
               class="code sev- "><tt><i>468</i> &nbsp;</tt>
            </div>
            <div id="l469"
               class="code sev- "><tt><i>469</i>         <span class="c1"># Select the appropriate background and text colors</span></tt>
            </div>
            <div id="l470"
               class="code sev- "><tt><i>470</i>         <span class="n">bg_color</span> <span class="o">=</span> <span class="n">ai_bg_color</span> <span class="k">if</span> <span class="n">is_ai_list</span> <span class="k">else</span> <span class="n">awl_bg_color</span></tt>
            </div>
            <div id="l471"
               class="code sev- "><tt><i>471</i>         <span class="n">text_color</span> <span class="o">=</span> <span class="n">ai_text_color</span> <span class="k">if</span> <span class="n">is_ai_list</span> <span class="k">else</span> <span class="n">awl_text_color</span></tt>
            </div>
            <div id="l472"
               class="code sev- "><tt><i>472</i>         <span class="n">source_class</span> <span class="o">=</span> <span class="s1">&#39;vocab-ai&#39;</span> <span class="k">if</span> <span class="n">is_ai_list</span> <span class="k">else</span> <span class="s1">&#39;vocab-awl&#39;</span></tt>
            </div>
            <div id="l473"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>473</i>         <span class="n">css_class</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;highlighted-vocab </span><span class="si">{</span><span class="n">source_class</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Keep class for potential generic styles</span></tt>
            </div>
            <div id="l474"
               class="code sev- "><tt><i>474</i> &nbsp;</tt>
            </div>
            <div id="l475"
               class="code sev- "><tt><i>475</i>         <span class="c1"># Construct the inline style attribute</span></tt>
            </div>
            <div id="l476"
               class="code sev- "><tt><i>476</i>         <span class="n">style_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;background-color: </span><span class="si">{</span><span class="n">bg_color</span><span class="si">}</span><span class="s1">; color: </span><span class="si">{</span><span class="n">text_color</span><span class="si">}</span><span class="s1">;&#39;</span></tt>
            </div>
            <div id="l477"
               class="code sev- "><tt><i>477</i> &nbsp;</tt>
            </div>
            <div id="l478"
               class="code sev- "><tt><i>478</i>         <span class="c1"># Construct the title attribute</span></tt>
            </div>
            <div id="l479"
               class="code sev- "><tt><i>479</i>         <span class="n">title_attr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l480"
               class="code sev- "><tt><i>480</i>         <span class="n">title</span> <span class="o">=</span> <span class="n">format_vocab_title</span><span class="p">(</span><span class="n">term_data</span><span class="p">)</span></tt>
            </div>
            <div id="l481"
               class="code sev- "><tt><i>481</i>         <span class="k">if</span> <span class="n">title</span><span class="p">:</span></tt>
            </div>
            <div id="l482"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>482</i>             <span class="n">safe_title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;quot;&quot;</span><span class="p">)</span> <span class="c1"># Escape quotes for HTML attribute</span></tt>
            </div>
            <div id="l483"
               class="code sev- "><tt><i>483</i>             <span class="n">title_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; title=&quot;</span><span class="si">{</span><span class="n">safe_title</span><span class="si">}</span><span class="s1">&quot;&#39;</span></tt>
            </div>
            <div id="l484"
               class="code sev- "><tt><i>484</i> &nbsp;</tt>
            </div>
            <div id="l485"
               class="code sev- "><tt><i>485</i>         <span class="c1"># Build the full span tag</span></tt>
            </div>
            <div id="l486"
               class="code sev- "><tt><i>486</i>         <span class="n">attributes</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;class=&quot;</span><span class="si">{</span><span class="n">css_class</span><span class="si">}</span><span class="s1">&quot; style=&quot;</span><span class="si">{</span><span class="n">style_attr</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">title_attr</span><span class="si">}</span><span class="s1">&#39;</span></tt>
            </div>
            <div id="l487"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>487</i>         <span class="n">matched_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="c1"># Get the exact text matched</span></tt>
            </div>
            <div id="l488"
               class="code sev- "><tt><i>488</i>         <span class="n">span</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;span </span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">matched_text</span><span class="si">}</span><span class="s1">&lt;/span&gt;&#39;</span></tt>
            </div>
            <div id="l489"
               class="code sev- "><tt><i>489</i>         <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span</span><span class="p">)</span></tt>
            </div>
            <div id="l490"
               class="code sev- "><tt><i>490</i> &nbsp;</tt>
            </div>
            <div id="l491"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>491</i>         <span class="n">last_end_index</span> <span class="o">=</span> <span class="n">end</span> <span class="c1"># Update position for next iteration</span></tt>
            </div>
            <div id="l492"
               class="code sev- "><tt><i>492</i> &nbsp;</tt>
            </div>
            <div id="l493"
               class="code sev- "><tt><i>493</i>     <span class="c1"># Append the remaining text after the last term</span></tt>
            </div>
            <div id="l494"
               class="code sev- "><tt><i>494</i>     <span class="n">result_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_end_index</span><span class="p">:])</span></tt>
            </div>
            <div id="l495"
               class="code sev- "><tt><i>495</i> &nbsp;</tt>
            </div>
            <div id="l496"
               class="code sev- "><tt><i>496</i>     <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_parts</span><span class="p">)</span></tt>
            </div>
            <div id="l497"
               class="code sev- "><tt><i>497</i> &nbsp;</tt>
            </div>
            <div id="l498"
               class="code sev- "><tt><i>498</i> <span class="c1"># --- Lore Highlighting ---</span></tt>
            </div>
            <div id="l499"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>499</i> <span class="k">def</span><span class="w"> </span><span class="nf">apply_lore_highlighting_python</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lore_vocab</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span></tt>
            </div>
            <div id="l500"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>500</i> <span class="w">     </span><span class="sd">&quot;&quot;&quot;Applies highlighting spans for lore terms in Python.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l501"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>501</i>      <span class="k">if</span> <span class="ow">not</span> <span class="n">lore_vocab</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span></tt>
            </div>
            <div id="l502"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>502</i>          <span class="k">return</span> <span class="n">text</span></tt>
            </div>
            <div id="l503"
               class="code sev- "><tt><i>503</i> &nbsp;</tt>
            </div>
            <div id="l504"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>504</i>      <span class="c1"># Pre-process lore terms to include display data needed by the formatter</span></tt>
            </div>
            <div id="l505"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>505</i>      <span class="n">processed_lore_terms</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l506"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>506</i>      <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">lore_vocab</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l507"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>507</i>          <span class="n">processed_lore_terms</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l508"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>508</i>              <span class="s2">&quot;display_term&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_term&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()),</span> <span class="c1"># How the term should look</span></tt>
            </div>
            <div id="l509"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>509</i>              <span class="s2">&quot;lore_path&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lore_path&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Path for JS lookup</span></tt>
            </div>
            <div id="l510"
               class="code sev- "><tt><i>510</i>          <span class="p">}</span></tt>
            </div>
            <div id="l511"
               class="code sev- "><tt><i>511</i> &nbsp;</tt>
            </div>
            <div id="l512"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>512</i>      <span class="c1"># Find terms using the original key case for lore terms (can be proper nouns)</span></tt>
            </div>
            <div id="l513"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>513</i>      <span class="n">found_terms</span> <span class="o">=</span> <span class="n">find_terms_in_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">processed_lore_terms</span><span class="p">,</span> <span class="n">key_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">)</span></tt>
            </div>
            <div id="l514"
               class="code sev- "><tt><i>514</i> &nbsp;</tt>
            </div>
            <div id="l515"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>515</i>      <span class="c1"># Define formatters specific to lore</span></tt>
            </div>
            <div id="l516"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>516</i>      <span class="k">def</span><span class="w"> </span><span class="nf">format_lore_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span></tt>
            </div>
            <div id="l517"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>517</i>          <span class="c1"># Format the lore path as a JSON string for the data attribute</span></tt>
            </div>
            <div id="l518"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>518</i>          <span class="n">path</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lore_path&quot;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l519"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>519</i>          <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;#39;&quot;</span><span class="p">)</span> <span class="c1"># Use HTML entity for single quote</span></tt>
            </div>
            <div id="l520"
               class="code sev- "><tt><i>520</i> &nbsp;</tt>
            </div>
            <div id="l521"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>521</i>      <span class="k">def</span><span class="w"> </span><span class="nf">format_lore_title</span><span class="p">(</span><span class="n">data</span><span class="p">):</span></tt>
            </div>
            <div id="l522"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>522</i>          <span class="c1"># Simple title using the display term</span></tt>
            </div>
            <div id="l523"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>523</i>          <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Lore: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_term&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l524"
               class="code sev- "><tt><i>524</i> &nbsp;</tt>
            </div>
            <div id="l525"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>525</i>      <span class="k">def</span><span class="w"> </span><span class="nf">format_lore_display</span><span class="p">(</span><span class="n">original_keyword</span><span class="p">,</span> <span class="n">matched_text</span><span class="p">,</span> <span class="n">term_data</span><span class="p">):</span></tt>
            </div>
            <div id="l526"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>526</i>          <span class="c1"># Display the term using its proper capitalization from lore data</span></tt>
            </div>
            <div id="l527"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>527</i>          <span class="k">return</span> <span class="n">term_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_term&quot;</span><span class="p">,</span> <span class="n">matched_text</span><span class="p">)</span></tt>
            </div>
            <div id="l528"
               class="code sev- "><tt><i>528</i> &nbsp;</tt>
            </div>
            <div id="l529"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>529</i>      <span class="c1"># Use the generic highlighting function</span></tt>
            </div>
            <div id="l530"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>530</i>      <span class="n">highlighted_text</span> <span class="o">=</span> <span class="n">process_text_for_highlighting</span><span class="p">(</span></tt>
            </div>
            <div id="l531"
               class="code sev- "><tt><i>531</i>          <span class="n">text</span><span class="p">,</span></tt>
            </div>
            <div id="l532"
               class="code sev- "><tt><i>532</i>          <span class="n">found_terms</span><span class="p">,</span></tt>
            </div>
            <div id="l533"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>533</i>          <span class="n">span_class</span><span class="o">=</span><span class="s2">&quot;lore-term&quot;</span><span class="p">,</span> <span class="c1"># CSS class for styling</span></tt>
            </div>
            <div id="l534"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>534</i>          <span class="n">data_attribute_name</span><span class="o">=</span><span class="s2">&quot;data-lore-path&quot;</span><span class="p">,</span> <span class="c1"># Attribute JS will use for lookups</span></tt>
            </div>
            <div id="l535"
               class="code sev- "><tt><i>535</i>          <span class="n">data_formatter</span><span class="o">=</span><span class="n">format_lore_data</span><span class="p">,</span></tt>
            </div>
            <div id="l536"
               class="code sev- "><tt><i>536</i>          <span class="n">title_formatter</span><span class="o">=</span><span class="n">format_lore_title</span><span class="p">,</span></tt>
            </div>
            <div id="l537"
               class="code sev- "><tt><i>537</i>          <span class="n">display_formatter</span><span class="o">=</span><span class="n">format_lore_display</span></tt>
            </div>
            <div id="l538"
               class="code sev- "><tt><i>538</i>      <span class="p">)</span></tt>
            </div>
            <div id="l539"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>539</i>      <span class="k">return</span> <span class="n">highlighted_text</span></tt>
            </div>
            <div id="l540"
               class="code sev- "><tt><i>540</i> &nbsp;</tt>
            </div>
            <div id="l541"
               class="code sev- "><tt><i>541</i> &nbsp;</tt>
            </div>
            <div id="l542"
               class="code sev- "><tt><i>542</i> <span class="c1"># --- AI Interaction ---</span></tt>
            </div>
            <div id="l543"
               class="code sev- "><tt><i>543</i> <span class="k">def</span><span class="w"> </span><span class="nf">get_ai_response</span><span class="p">(</span><span class="n">prompt_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span></tt>
            </div>
            <div id="l544"
               class="code sev- "><tt><i>544</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a constructed prompt to Vertex AI and returns the response.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l545"
               class="code sev- "><tt><i>545</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span></tt>
            </div>
            <div id="l546"
               class="code sev- "><tt><i>546</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;AI model unavailable during get_ai_response.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l547"
               class="code sev- "><tt><i>547</i>         <span class="n">is_json_output</span> <span class="o">=</span> <span class="n">prompt_type</span> <span class="ow">in</span> <span class="p">[</span></tt>
            </div>
            <div id="l548"
               class="code sev- "><tt><i>548</i>             <span class="s2">&quot;ANALYZE_PLAYER_WRITING&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE_CHAPTER_COMPREHENSION&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l549"
               class="code sev- "><tt><i>549</i>             <span class="s2">&quot;GENERATE_NEXT_QUEST&quot;</span><span class="p">,</span> <span class="s2">&quot;REVIEW_CHARACTER_SHEET&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l550"
               class="code sev- "><tt><i>550</i>             <span class="s2">&quot;GENERATE_CONTEXTUAL_VOCAB&quot;</span><span class="p">,</span> <span class="s2">&quot;PROCESS_PLAYER_SIDEQUEST_IDEA&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l551"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>551</i>             <span class="s2">&quot;EVALUATE_STEP_COMPLETION&quot;</span><span class="p">,</span> <span class="c1"># Used by ai_check trigger</span></tt>
            </div>
            <div id="l552"
               class="code sev- "><tt><i>552</i>             <span class="s2">&quot;EVALUATE_SIDEQUEST_COMPLETION&quot;</span></tt>
            </div>
            <div id="l553"
               class="code sev- "><tt><i>553</i>         <span class="p">]</span></tt>
            </div>
            <div id="l554"
               class="code sev- "><tt><i>554</i>         <span class="c1"># Return error in expected format (dict for JSON, str for text)</span></tt>
            </div>
            <div id="l555"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (150 > 79 characters)</li>

               </ul><tt><i>555</i>         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span><span class="s2">&quot;AI model not initialized&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">is_json_output</span> <span class="k">else</span> <span class="s2">&quot;Error: The Storyteller AI is currently unavailable.&quot;</span></tt>
            </div>
            <div id="l556"
               class="code sev- "><tt><i>556</i> &nbsp;</tt>
            </div>
            <div id="l557"
               class="code sev- "><tt><i>557</i>     <span class="c1"># --- Build Base Context String ---</span></tt>
            </div>
            <div id="l558"
               class="code sev- "><tt><i>558</i>     <span class="n">p_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Player&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l559"
               class="code sev- "><tt><i>559</i>     <span class="n">loc_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;The Void&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l560"
               class="code sev- "><tt><i>560</i>     <span class="n">q_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l561"
               class="code sev- "><tt><i>561</i>     <span class="n">s_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l562"
               class="code sev- "><tt><i>562</i>     <span class="n">p_race</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_race&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l563"
               class="code sev- "><tt><i>563</i>     <span class="n">p_class</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_class&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l564"
               class="code sev- "><tt><i>564</i>     <span class="n">p_philosophy</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_philosophy&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l565"
               class="code sev- "><tt><i>565</i> &nbsp;</tt>
            </div>
            <div id="l566"
               class="code sev- "><tt><i>566</i>     <span class="c1"># Construct Quest Context String</span></tt>
            </div>
            <div id="l567"
               class="code sev- "><tt><i>567</i>     <span class="n">q_ctx</span> <span class="o">=</span> <span class="s2">&quot;Currently exploring freely.&quot;</span></tt>
            </div>
            <div id="l568"
               class="code sev- "><tt><i>568</i>     <span class="k">if</span> <span class="n">q_id</span> <span class="ow">and</span> <span class="n">s_id</span><span class="p">:</span></tt>
            </div>
            <div id="l569"
               class="code sev- "><tt><i>569</i>         <span class="n">q_t</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l570"
               class="code sev- "><tt><i>570</i>         <span class="n">s_d</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l571"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>571</i>         <span class="c1"># Attempt to fetch title/desc if not provided in context (should usually be there)</span></tt>
            </div>
            <div id="l572"
               class="code sev- "><tt><i>572</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">q_t</span><span class="p">:</span></tt>
            </div>
            <div id="l573"
               class="code sev- "><tt><i>573</i>             <span class="n">q_data</span> <span class="o">=</span> <span class="n">get_quest</span><span class="p">(</span><span class="n">q_id</span><span class="p">)</span></tt>
            </div>
            <div id="l574"
               class="code sev- "><tt><i>574</i>             <span class="n">q_t</span> <span class="o">=</span> <span class="n">q_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">q_data</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span></tt>
            </div>
            <div id="l575"
               class="code sev- "><tt><i>575</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">s_d</span><span class="p">:</span></tt>
            </div>
            <div id="l576"
               class="code sev- "><tt><i>576</i>             <span class="n">s_data</span> <span class="o">=</span> <span class="n">get_quest_step</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="n">s_id</span><span class="p">)</span></tt>
            </div>
            <div id="l577"
               class="code sev- "><tt><i>577</i>             <span class="n">s_d</span> <span class="o">=</span> <span class="n">s_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s_data</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span></tt>
            </div>
            <div id="l578"
               class="code sev- "><tt><i>578</i>         <span class="n">q_ctx</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Current Quest: &#39;</span><span class="si">{</span><span class="n">q_t</span><span class="si">}</span><span class="s2">&#39;. Objective: &#39;</span><span class="si">{</span><span class="n">s_d</span><span class="si">}</span><span class="s2">&#39;.&quot;</span></tt>
            </div>
            <div id="l579"
               class="code sev- "><tt><i>579</i> &nbsp;</tt>
            </div>
            <div id="l580"
               class="code sev- "><tt><i>580</i>     <span class="c1"># --- Enhanced Base Instruction ---</span></tt>
            </div>
            <div id="l581"
               class="code sev- "><tt><i>581</i>     <span class="n">char_profile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;P=</span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_class</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_philosophy</span><span class="si">}</span><span class="s2">)&quot;</span></tt>
            </div>
            <div id="l582"
               class="code sev- "><tt><i>582</i>     <span class="n">fate_pts</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_fate_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l583"
               class="code sev- "><tt><i>583</i>     <span class="n">base_instruct</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l584"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (205 > 79 characters)</li>

               </ul><tt><i>584</i>         <span class="sa">f</span><span class="s2">&quot;Act as the AI Storyteller for &#39;Daydream&#39;. Setting: Dumpster Planet (a chaotic realm of discarded ideas). Current Location: </span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2">. Player Character: </span><span class="si">{</span><span class="n">char_profile</span><span class="si">}</span><span class="s2">. Fate Points: </span><span class="si">{</span><span class="n">fate_pts</span><span class="si">}</span><span class="s2">. &quot;</span></tt>
            </div>
            <div id="l585"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (159 > 79 characters)</li>

               </ul><tt><i>585</i>         <span class="sa">f</span><span class="s2">&quot;Your goal is to create an engaging, descriptive narrative experience. Use sensory details (sight, sound, smell, feel) based on the location&#39;s lore. &quot;</span></tt>
            </div>
            <div id="l586"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (145 > 79 characters)</li>

               </ul><tt><i>586</i>         <span class="sa">f</span><span class="s2">&quot;Interpret player actions creatively, considering their character profile. Narrate outcomes by *showing* the results and consequences. &quot;</span></tt>
            </div>
            <div id="l587"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>587</i>         <span class="sa">f</span><span class="s2">&quot;Encourage thoughtful player input. Keep responses concise but evocative, suitable for Grades 8-12. &quot;</span></tt>
            </div>
            <div id="l588"
               class="code sev- "><tt><i>588</i>         <span class="sa">f</span><span class="s2">&quot;Current Situation: </span><span class="si">{</span><span class="n">q_ctx</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l589"
               class="code sev- "><tt><i>589</i>     <span class="p">)</span></tt>
            </div>
            <div id="l590"
               class="code sev- "><tt><i>590</i> &nbsp;</tt>
            </div>
            <div id="l591"
               class="code sev- "><tt><i>591</i>     <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l592"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>592</i>     <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="c1"># Default output format</span></tt>
            </div>
            <div id="l593"
               class="code sev- "><tt><i>593</i> &nbsp;</tt>
            </div>
            <div id="l594"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>594</i>     <span class="c1"># --- Prompt Construction based on Type (Keep existing prompts from v5.2) ---</span></tt>
            </div>
            <div id="l595"
               class="code sev- "><tt><i>595</i>     <span class="c1"># (No changes to individual prompt structures needed for intro logic)</span></tt>
            </div>
            <div id="l596"
               class="code sev- "><tt><i>596</i>     <span class="k">if</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;INITIAL_SETUP&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l597"
               class="code sev- "><tt><i>597</i>         <span class="n">loc_lore</span> <span class="o">=</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc_name</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l598"
               class="code sev- "><tt><i>598</i>         <span class="n">npcs_here</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;present_npcs&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l599"
               class="code sev- "><tt><i>599</i>         <span class="n">lore_desc</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;A place beyond description.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l600"
               class="code sev- "><tt><i>600</i>         <span class="n">mood</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mood&#39;</span><span class="p">,</span> <span class="s1">&#39;chaotic but functional&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l601"
               class="code sev- "><tt><i>601</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l602"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>602</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Welcome </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2">. &quot;</span></tt>
            </div>
            <div id="l603"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (162 > 79 characters)</li>

               </ul><tt><i>603</i>              <span class="sa">f</span><span class="s2">&quot;Describe the scene vividly using sensory details (sight, sound, smell). Convey the location&#39;s mood (&#39;</span><span class="si">{</span><span class="n">mood</span><span class="si">}</span><span class="s2">&#39;). Mention present NPCs: </span><span class="si">{</span><span class="n">npcs_here</span><span class="si">}</span><span class="s2">. &quot;</span></tt>
            </div>
            <div id="l604"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (141 > 79 characters)</li>

               </ul><tt><i>604</i>              <span class="sa">f</span><span class="s2">&quot;Consider </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">&#39;s perspective as a </span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_class</span><span class="si">}</span><span class="s2">. End with an open-ended question inviting description or reflection. &quot;</span></tt>
            </div>
            <div id="l605"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (152 > 79 characters)</li>

               </ul><tt><i>605</i>              <span class="sa">f</span><span class="s2">&quot;Example ending: &#39;What aspect of this scene captures your attention first?&#39; or &#39;How does your </span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2"> nature react to this environment?&#39;&quot;</span></tt>
            </div>
            <div id="l606"
               class="code sev- "><tt><i>606</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Relevant Lore: </span><span class="si">{</span><span class="n">lore_desc</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l607"
               class="code sev- "><tt><i>607</i>          <span class="p">)</span></tt>
            </div>
            <div id="l608"
               class="code sev- "><tt><i>608</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;GET_DESCRIPTION&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l609"
               class="code sev- "><tt><i>609</i>         <span class="n">loc_lore</span> <span class="o">=</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc_name</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l610"
               class="code sev- "><tt><i>610</i>         <span class="n">npcs_here</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;present_npcs&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l611"
               class="code sev- "><tt><i>611</i>         <span class="n">exits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exits&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></tt>
            </div>
            <div id="l612"
               class="code sev- "><tt><i>612</i>         <span class="n">lore_desc</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;A place beyond description.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l613"
               class="code sev- "><tt><i>613</i>         <span class="n">mood</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mood&#39;</span><span class="p">,</span> <span class="s1">&#39;chaotic but functional&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l614"
               class="code sev- "><tt><i>614</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l615"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (174 > 79 characters)</li>

               </ul><tt><i>615</i>             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Describe </span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2"> in response to &#39;look around&#39;. Use rich sensory details (sight, sound, smell, feel) and evoke the mood (&#39;</span><span class="si">{</span><span class="n">mood</span><span class="si">}</span><span class="s2">&#39;). &quot;</span></tt>
            </div>
            <div id="l616"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (128 > 79 characters)</li>

               </ul><tt><i>616</i>             <span class="sa">f</span><span class="s2">&quot;Describe key features and NPCs (</span><span class="si">{</span><span class="n">npcs_here</span><span class="si">}</span><span class="s2">) based on the lore (</span><span class="si">{</span><span class="n">lore_desc</span><span class="si">}</span><span class="s2">). Mention available exits (</span><span class="si">{</span><span class="n">exits</span><span class="si">}</span><span class="s2">). &quot;</span></tt>
            </div>
            <div id="l617"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (170 > 79 characters)</li>

               </ul><tt><i>617</i>             <span class="sa">f</span><span class="s2">&quot;Frame the description from </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">&#39;s perspective (</span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_class</span><span class="si">}</span><span class="s2">). Ask what specific detail draws their focus or what they intend to investigate next.&quot;</span></tt>
            </div>
            <div id="l618"
               class="code sev- "><tt><i>618</i>         <span class="p">)</span></tt>
            </div>
            <div id="l619"
               class="code sev- "><tt><i>619</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;PROCESS_ABILITY_USE&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l620"
               class="code sev- "><tt><i>620</i>         <span class="n">ability</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l621"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>621</i>         <span class="n">current_npcs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thetopia_location_lore&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;present_npcs&#39;</span><span class="p">,[])</span></tt>
            </div>
            <div id="l622"
               class="code sev- "><tt><i>622</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l623"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>623</i>             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Narrate </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2"> using the ability &#39;</span><span class="si">{</span><span class="n">ability</span><span class="si">}</span><span class="s2">&#39;. &quot;</span></tt>
            </div>
            <div id="l624"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (141 > 79 characters)</li>

               </ul><tt><i>624</i>             <span class="sa">f</span><span class="s2">&quot;Describe the *process* and *sensory effects* of the ability activating, using flavorful language appropriate for &#39;</span><span class="si">{</span><span class="n">ability</span><span class="si">}</span><span class="s2">&#39;. &quot;</span></tt>
            </div>
            <div id="l625"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (276 > 79 characters)</li>

               </ul><tt><i>625</i>             <span class="sa">f</span><span class="s2">&quot;Show the outcome through narrative description (success, partial success, failure, unexpected consequence) based *only* on the ability concept, current situation (location=</span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2">, NPCs=</span><span class="si">{</span><span class="n">current_npcs</span><span class="si">}</span><span class="s2">), player&#39;s goal (</span><span class="si">{</span><span class="n">q_ctx</span><span class="si">}</span><span class="s2">), and Fate Points (</span><span class="si">{</span><span class="n">fate_pts</span><span class="si">}</span><span class="s2">). &quot;</span></tt>
            </div>
            <div id="l626"
               class="code sev- "><tt><i>626</i>             <span class="sa">f</span><span class="s2">&quot;Describe plausible narrative consequences. NO DICE ROLLS.&quot;</span></tt>
            </div>
            <div id="l627"
               class="code sev- "><tt><i>627</i>          <span class="p">)</span></tt>
            </div>
            <div id="l628"
               class="code sev- "><tt><i>628</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;INVALID_DIRECTION&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l629"
               class="code sev- "><tt><i>629</i>         <span class="n">direction</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;that way&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l630"
               class="code sev- "><tt><i>630</i>         <span class="n">exits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exits&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></tt>
            </div>
            <div id="l631"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (195 > 79 characters)</li>

               </ul><tt><i>631</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Explain *narratively* why </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2"> cannot &#39;go </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2">. Describe the obstacle or reason vividly. Mention available exits: </span><span class="si">{</span><span class="n">exits</span><span class="si">}</span><span class="s2">.&quot;</span></tt>
            </div>
            <div id="l632"
               class="code sev- "><tt><i>632</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;INVALID_ABILITY&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l633"
               class="code sev- "><tt><i>633</i>         <span class="n">ability</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">,</span> <span class="s1">&#39;that ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l634"
               class="code sev- "><tt><i>634</i>         <span class="n">reason</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;it cannot be used now&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l635"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (207 > 79 characters)</li>

               </ul><tt><i>635</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Explain *narratively* why </span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2"> couldn&#39;t use &#39;</span><span class="si">{</span><span class="n">ability</span><span class="si">}</span><span class="s2">&#39;. Reason provided: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">. Gently clarify the situation or ability&#39;s limitations through description.&quot;</span></tt>
            </div>
            <div id="l636"
               class="code sev- "><tt><i>636</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;INTERPRET_COMMAND&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l637"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F841
                     </span>
                     Local variable 'cmd' is assigned to but never used</li>

               </ul><tt><i>637</i>         <span class="n">cmd</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l638"
               class="code sev- "><tt><i>638</i>         <span class="n">loc_lore</span> <span class="o">=</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc_name</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l639"
               class="code sev- "><tt><i>639</i>         <span class="n">npcs_here</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;present_npcs&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l640"
               class="code sev- "><tt><i>640</i>         <span class="n">abilities</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_abilities&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l641"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>641</i>         <span class="n">lore_desc</span> <span class="o">=</span> <span class="n">loc_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;A place beyond description.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l642"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>642</i>         <span class="n">player_input</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># Use variable name consistently</span></tt>
            </div>
            <div id="l643"
               class="code sev- "><tt><i>643</i> &nbsp;</tt>
            </div>
            <div id="l644"
               class="code sev- "><tt><i>644</i>         <span class="c1"># Base prompt for interpretation</span></tt>
            </div>
            <div id="l645"
               class="code sev- "><tt><i>645</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l646"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (167 > 79 characters)</li>

               </ul><tt><i>646</i>             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Interpret player command &#39;</span><span class="si">{</span><span class="n">player_input</span><span class="si">}</span><span class="s2">&#39; and narrate the outcome. This command is NOT a move, look, or explicit ability use.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l647"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

               </ul><tt><i>647</i>             <span class="sa">f</span><span class="s2">&quot;Context: </span><span class="si">{</span><span class="n">char_profile</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">fate_pts</span><span class="si">}</span><span class="s2"> Fate Points. Player Abilities: </span><span class="si">{</span><span class="n">abilities</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l648"
               class="code sev- "><tt><i>648</i>             <span class="sa">f</span><span class="s2">&quot;Location Details: </span><span class="si">{</span><span class="n">lore_desc</span><span class="si">}</span><span class="s2">. Present NPCs: </span><span class="si">{</span><span class="n">npcs_here</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l649"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (139 > 79 characters)</li>

               </ul><tt><i>649</i>             <span class="sa">f</span><span class="s2">&quot;Response Guidance: Determine player&#39;s intent. Consider how a </span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">p_class</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">p_philosophy</span><span class="si">}</span><span class="s2">) would perform this action. &quot;</span></tt>
            </div>
            <div id="l650"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (145 > 79 characters)</li>

               </ul><tt><i>650</i>             <span class="sa">f</span><span class="s2">&quot;*Show* the action unfolding and its immediate consequences through sensory details. Narrate a plausible outcome based on context. &quot;</span></tt>
            </div>
            <div id="l651"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (159 > 79 characters)</li>

               </ul><tt><i>651</i>             <span class="sa">f</span><span class="s2">&quot;If the command is very simple (e.g., &#39;open door&#39;), briefly ask for *how* they do it (e.g., &#39;How do you try the door? Cautiously? Forcefully?&#39;). &quot;</span></tt>
            </div>
            <div id="l652"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>652</i>             <span class="sa">f</span><span class="s2">&quot;If the command is vague, ask for clarification. If relevant, gently guide towards the quest: </span><span class="si">{</span><span class="n">q_ctx</span><span class="si">}</span><span class="s2">.&quot;</span></tt>
            </div>
            <div id="l653"
               class="code sev- "><tt><i>653</i>         <span class="p">)</span></tt>
            </div>
            <div id="l654"
               class="code sev- "><tt><i>654</i> &nbsp;</tt>
            </div>
            <div id="l655"
               class="code sev- "><tt><i>655</i>         <span class="c1"># Add specific NPC interaction context</span></tt>
            </div>
            <div id="l656"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>656</i>         <span class="n">interaction_verbs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;talk&quot;</span><span class="p">,</span> <span class="s2">&quot;ask&quot;</span><span class="p">,</span> <span class="s2">&quot;speak&quot;</span><span class="p">,</span> <span class="s2">&quot;say&quot;</span><span class="p">,</span> <span class="s2">&quot;greet&quot;</span><span class="p">,</span> <span class="s2">&quot;tell&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">]</span></tt>
            </div>
            <div id="l657"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>657</i>         <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">player_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">verb</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">verb</span> <span class="ow">in</span> <span class="n">interaction_verbs</span><span class="p">):</span></tt>
            </div>
            <div id="l658"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>658</i>             <span class="n">target_npc_input</span> <span class="o">=</span> <span class="n">player_input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Get text after the verb</span></tt>
            </div>
            <div id="l659"
               class="code sev- "><tt><i>659</i>             <span class="n">target_npc_found</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l660"
               class="code sev- "><tt><i>660</i>             <span class="n">npc_detail</span> <span class="o">=</span> <span class="s2">&quot;NPC not clearly specified or not present.&quot;</span></tt>
            </div>
            <div id="l661"
               class="code sev- "><tt><i>661</i>             <span class="n">best_match_score</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l662"
               class="code sev- "><tt><i>662</i> &nbsp;</tt>
            </div>
            <div id="l663"
               class="code sev- "><tt><i>663</i>             <span class="k">for</span> <span class="n">npc_name</span> <span class="ow">in</span> <span class="n">npcs_here</span><span class="p">:</span></tt>
            </div>
            <div id="l664"
               class="code sev- "><tt><i>664</i>                 <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l665"
               class="code sev- "><tt><i>665</i>                 <span class="k">if</span> <span class="n">npc_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">target_npc_input</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span></tt>
            </div>
            <div id="l666"
               class="code sev- "><tt><i>666</i>                     <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">npc_name</span><span class="p">)</span></tt>
            </div>
            <div id="l667"
               class="code sev- "><tt><i>667</i>                 <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_match_score</span><span class="p">:</span></tt>
            </div>
            <div id="l668"
               class="code sev- "><tt><i>668</i>                     <span class="n">best_match_score</span> <span class="o">=</span> <span class="n">score</span></tt>
            </div>
            <div id="l669"
               class="code sev- "><tt><i>669</i>                     <span class="n">target_npc_found</span> <span class="o">=</span> <span class="n">npc_name</span></tt>
            </div>
            <div id="l670"
               class="code sev- "><tt><i>670</i> &nbsp;</tt>
            </div>
            <div id="l671"
               class="code sev- "><tt><i>671</i>             <span class="k">if</span> <span class="n">target_npc_found</span><span class="p">:</span></tt>
            </div>
            <div id="l672"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>672</i>                 <span class="n">npc_data</span> <span class="o">=</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;npcs&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_npc_found</span><span class="p">,{})</span></tt>
            </div>
            <div id="l673"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>673</i>                 <span class="n">npc_desc</span> <span class="o">=</span> <span class="n">npc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;An individual.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l674"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>674</i>                 <span class="n">npc_pers</span> <span class="o">=</span> <span class="n">npc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;personality&#39;</span><span class="p">,[])</span></tt>
            </div>
            <div id="l675"
               class="code sev- "><tt><i>675</i>                 <span class="n">npc_hooks</span> <span class="o">=</span> <span class="n">npc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dialogue_hooks&#39;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l676"
               class="code sev- "><tt><i>676</i>                 <span class="n">npc_knowledge</span> <span class="o">=</span> <span class="n">npc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;knowledge&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l677"
               class="code sev- "><tt><i>677</i>                 <span class="n">npc_detail</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l678"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>678</i>                     <span class="sa">f</span><span class="s2">&quot;Target NPC (</span><span class="si">{</span><span class="n">target_npc_found</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">npc_desc</span><span class="si">}</span><span class="s2"> Personality: </span><span class="si">{</span><span class="n">npc_pers</span><span class="si">}</span><span class="s2">. &quot;</span></tt>
            </div>
            <div id="l679"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (107 > 79 characters)</li>

               </ul><tt><i>679</i>                     <span class="sa">f</span><span class="s2">&quot;Knowledge Areas: </span><span class="si">{</span><span class="n">npc_knowledge</span><span class="si">}</span><span class="s2">. Typical Greetings: </span><span class="si">{</span><span class="n">npc_hooks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greeting&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l680"
               class="code sev- "><tt><i>680</i>                  <span class="p">)</span></tt>
            </div>
            <div id="l681"
               class="code sev- "><tt><i>681</i>                 <span class="n">prompt</span> <span class="o">+=</span> <span class="p">(</span></tt>
            </div>
            <div id="l682"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (137 > 79 characters)</li>

               </ul><tt><i>682</i>                     <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Interaction Guidance: Respond as </span><span class="si">{</span><span class="n">target_npc_found</span><span class="si">}</span><span class="s2">, reflecting their personality (</span><span class="si">{</span><span class="n">npc_pers</span><span class="si">}</span><span class="s2">) and knowledge. &quot;</span></tt>
            </div>
            <div id="l683"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (137 > 79 characters)</li>

               </ul><tt><i>683</i>                     <span class="sa">f</span><span class="s2">&quot;Consider how they might react to a </span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2"> asking about the topic derived from &#39;</span><span class="si">{</span><span class="n">player_input</span><span class="si">}</span><span class="s2">&#39;. Use their voice.&quot;</span></tt>
            </div>
            <div id="l684"
               class="code sev- "><tt><i>684</i>                  <span class="p">)</span></tt>
            </div>
            <div id="l685"
               class="code sev- "><tt><i>685</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l686"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>686</i>                  <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interaction Note: </span><span class="si">{</span><span class="n">npc_detail</span><span class="si">}</span><span class="s2">. Ask player to clarify who they are talking to if ambiguous.&quot;</span></tt>
            </div>
            <div id="l687"
               class="code sev- "><tt><i>687</i> &nbsp;</tt>
            </div>
            <div id="l688"
               class="code sev- "><tt><i>688</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;ANALYZE_PLAYER_WRITING&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l689"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>689</i>          <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l690"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>690</i>          <span class="n">text_to_analyze</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chapter_player_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l691"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>691</i>          <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l692"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

               </ul><tt><i>692</i>              <span class="sa">f</span><span class="s2">&quot;Analyze the following player text responses from a single chapter. Evaluate on these metrics:</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l693"
               class="code sev- "><tt><i>693</i>              <span class="sa">f</span><span class="s2">&quot;1. Relevance/Coherence (Combined score, scale 1-5).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l694"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>694</i>              <span class="sa">f</span><span class="s2">&quot;2. List of AWL words used (Extract words from the standard Academic Word List).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l695"
               class="code sev- "><tt><i>695</i>              <span class="sa">f</span><span class="s2">&quot;3. General Style (Low/Medium/High effort/complexity).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l696"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

               </ul><tt><i>696</i>              <span class="sa">f</span><span class="s2">&quot;4. Critical Thinking evident (Low/Medium/High ability to strategize, infer, or make choices).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l697"
               class="code sev- "><tt><i>697</i>              <span class="sa">f</span><span class="s2">&quot;5. Average Response Length Category (Short/Medium/Long).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l698"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>698</i>              <span class="sa">f</span><span class="s2">&quot;6. Descriptive Language Use (Low/Medium/High use of sensory details and evocative language).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l699"
               class="code sev- "><tt><i>699</i>              <span class="sa">f</span><span class="s2">&quot;Respond ONLY with a JSON object matching this structure: </span><span class="se">{{</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l700"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>700</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">relevance_coherence_score</span><span class="se">\&quot;</span><span class="s2">:int, </span><span class="se">\&quot;</span><span class="s2">awl_words_used</span><span class="se">\&quot;</span><span class="s2">:[str], </span><span class="se">\&quot;</span><span class="s2">style_rating</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">L|M|H</span><span class="se">\&quot;</span><span class="s2">, &quot;</span></tt>
            </div>
            <div id="l701"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>701</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">thinking_rating</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">L|M|H</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">avg_length_category</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">S|M|L</span><span class="se">\&quot;</span><span class="s2">, &quot;</span></tt>
            </div>
            <div id="l702"
               class="code sev- "><tt><i>702</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">descriptive_language_rating</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">L|M|H</span><span class="se">\&quot;</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l703"
               class="code sev- "><tt><i>703</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">}}\n\n</span><span class="s2">Player Responses:</span><span class="se">\n</span><span class="si">{</span><span class="n">text_to_analyze</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l704"
               class="code sev- "><tt><i>704</i>          <span class="p">)</span></tt>
            </div>
            <div id="l705"
               class="code sev- "><tt><i>705</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;EVALUATE_CHAPTER_COMPREHENSION&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l706"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>706</i>          <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l707"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>707</i>          <span class="n">questions</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;questions&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l708"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>708</i>          <span class="n">answers</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;answers&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l709"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (453 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>709</i>          <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Evaluate the player&#39;s answers based on their understanding of the chapter events, relevance to the questions, and evidence of reasoning (scale 1-10 for each answer).</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Q</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="s2">A</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;(No Answer)&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">questions</span><span class="p">)])</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Provide an overall average comprehension score (float, 1-10).</span><span class="se">\n</span><span class="s2">Respond ONLY with JSON: </span><span class="se">{{\&quot;</span><span class="s2">overall_comprehension_score</span><span class="se">\&quot;</span><span class="s2">: float</span><span class="se">}}</span><span class="s2">.&quot;</span></tt>
            </div>
            <div id="l710"
               class="code sev- "><tt><i>710</i> &nbsp;</tt>
            </div>
            <div id="l711"
               class="code sev- "><tt><i>711</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;REVIEW_CHARACTER_SHEET&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l712"
               class="code sev- "><tt><i>712</i>         <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l713"
               class="code sev- "><tt><i>713</i>         <span class="n">sheet_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;character_sheet_data&#39;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l714"
               class="code sev- "><tt><i>714</i>         <span class="c1"># Only include narrative fields for review</span></tt>
            </div>
            <div id="l715"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (170 > 79 characters)</li>

               </ul><tt><i>715</i>         <span class="n">sheet_data_narrative</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sheet_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;boon&#39;</span><span class="p">,</span> <span class="s1">&#39;backstory&#39;</span><span class="p">,</span> <span class="s1">&#39;starting_quest&#39;</span><span class="p">]}</span></tt>
            </div>
            <div id="l716"
               class="code sev- "><tt><i>716</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l717"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (191 > 79 characters)</li>

               </ul><tt><i>717</i>             <span class="sa">f</span><span class="s2">&quot;Review the following player-created character sheet for narrative potential in the &#39;Daydream&#39; game (Dumpster Planet setting: chaotic realm of discarded ideas, hub: Thetopia).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l718"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (318 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 3 places)</li>

               </ul><tt><i>718</i>             <span class="sa">f</span><span class="s2">&quot;Check for clarity, interesting hooks based on lore (Races: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;races&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, Classes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, Philosophies: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophies&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">), internal consistency, and playability. Focus on narrative aspects only.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l719"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>719</i>             <span class="sa">f</span><span class="s2">&quot;Character Sheet:</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sheet_data_narrative</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l720"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (146 > 79 characters)</li>

               </ul><tt><i>720</i>             <span class="sa">f</span><span class="s2">&quot;Respond ONLY with a JSON object containing specific, constructive recommendations focused on enhancing narrative depth or clarity. &quot;</span></tt>
            </div>
            <div id="l721"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (243 > 79 characters)</li>

               </ul><tt><i>721</i>             <span class="sa">f</span><span class="s2">&quot;Structure: </span><span class="se">{{</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">recommendations</span><span class="se">\&quot;</span><span class="s2">: [ </span><span class="se">{{</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">field</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">field_name</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">type</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">clarify|enhance|issue|interesting</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">suggestion</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">text describing the suggestion...</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">}}</span><span class="s2"> ] </span><span class="se">}}</span><span class="s2"> or </span><span class="se">{{</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">recommendations</span><span class="se">\&quot;</span><span class="s2">: [] </span><span class="se">}}</span><span class="s2"> if it looks good.&quot;</span></tt>
            </div>
            <div id="l722"
               class="code sev- "><tt><i>722</i>         <span class="p">)</span></tt>
            </div>
            <div id="l723"
               class="code sev- "><tt><i>723</i> &nbsp;</tt>
            </div>
            <div id="l724"
               class="code sev- "><tt><i>724</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;GENERATE_NEXT_QUEST&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l725"
               class="code sev- "><tt><i>725</i>         <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l726"
               class="code sev- "><tt><i>726</i>         <span class="n">char_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;character_data&#39;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l727"
               class="code sev- "><tt><i>727</i>         <span class="n">summaries</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chapter_summaries&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l728"
               class="code sev- "><tt><i>728</i>         <span class="n">stage</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;next_hero_journey_stage&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Stage&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l729"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (172 > 79 characters)</li>

               </ul><tt><i>729</i>         <span class="n">char_data_narrative</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">char_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;boon&#39;</span><span class="p">,</span> <span class="s1">&#39;backstory&#39;</span><span class="p">,</span> <span class="s1">&#39;abilities&#39;</span><span class="p">,</span> <span class="s1">&#39;aspects&#39;</span><span class="p">]}</span></tt>
            </div>
            <div id="l730"
               class="code sev- "><tt><i>730</i>         <span class="n">chapter_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></tt>
            </div>
            <div id="l731"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>731</i>         <span class="n">last_summary_text</span> <span class="o">=</span> <span class="n">summaries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span><span class="s1">&#39;(No previous summary)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">summaries</span> <span class="k">else</span> <span class="s1">&#39;(First Chapter)&#39;</span></tt>
            </div>
            <div id="l732"
               class="code sev- "><tt><i>732</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l733"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (154 > 79 characters)</li>

               </ul><tt><i>733</i>             <span class="sa">f</span><span class="s2">&quot;Generate the *next* quest (Chapter </span><span class="si">{</span><span class="n">chapter_num</span><span class="si">}</span><span class="s2">) for the Daydream game.</span><span class="se">\n</span><span class="s2">Character Profile:</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">char_data_narrative</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l734"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>734</i>             <span class="sa">f</span><span class="s2">&quot;Most Recent Chapter Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">last_summary_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">Target Hero&#39;s Journey Stage: </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l735"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (158 > 79 characters)</li>

               </ul><tt><i>735</i>             <span class="sa">f</span><span class="s2">&quot;Requirements:</span><span class="se">\n</span><span class="s2">1. Create a conflict/goal that *directly follows from or reacts to* the character details and the MOST RECENT chapter summary.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l736"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>736</i>             <span class="sa">f</span><span class="s2">&quot;2. Ensure strong narrative continuity. The quest should feel like a consequence or next step.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l737"
               class="code sev- "><tt><i>737</i>             <span class="sa">f</span><span class="s2">&quot;3. Align theme with the target journey stage (</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l738"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>738</i>             <span class="sa">f</span><span class="s2">&quot;4. Provide an actionable starting step description that clearly guides the player.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l739"
               class="code sev- "><tt><i>739</i>             <span class="sa">f</span><span class="s2">&quot;5. Use unique IDs based on chapter and character.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l740"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (362 > 79 characters)</li>

               </ul><tt><i>740</i>             <span class="sa">f</span><span class="s2">&quot;Respond ONLY with JSON: </span><span class="se">{{\&quot;</span><span class="s2">quest_id</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">Q_CH</span><span class="si">{</span><span class="n">chapter_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;char&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">title</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">Chapter </span><span class="si">{</span><span class="n">chapter_num</span><span class="si">}</span><span class="s2">: [Concise Title]</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">description</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">[Brief overall quest description building on previous chapter]</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">starting_step_id</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">STEP_01</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">starting_step_description</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">[Clear, actionable first step description]</span><span class="se">\&quot;}}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l741"
               class="code sev- "><tt><i>741</i>          <span class="p">)</span></tt>
            </div>
            <div id="l742"
               class="code sev- "><tt><i>742</i> &nbsp;</tt>
            </div>
            <div id="l743"
               class="code sev- "><tt><i>743</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;GENERATE_CONTEXTUAL_VOCAB&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l744"
               class="code sev- "><tt><i>744</i>         <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l745"
               class="code sev- "><tt><i>745</i>         <span class="n">target_word</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_word&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l746"
               class="code sev- "><tt><i>746</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">target_word</span><span class="p">:</span></tt>
            </div>
            <div id="l747"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

               </ul><tt><i>747</i>             <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;Missing Input&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Target word for vocabulary generation is missing&quot;</span><span class="p">}</span></tt>
            </div>
            <div id="l748"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (566 > 79 characters)</li>

               </ul><tt><i>748</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Task: Generate a contextual vocabulary list related to the word &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">1. Provide a clear definition for &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39; suitable for grades 8-12.</span><span class="se">\n</span><span class="s2">2. List exactly 25 related words (synonyms, antonyms, conceptually linked terms).</span><span class="se">\n</span><span class="s2">3. Provide a clear definition for each of the 25 related words, suitable for grades 8-12.</span><span class="se">\n</span><span class="s2">Format ONLY JSON: </span><span class="se">{{\&quot;</span><span class="s2">target_word_info</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">{{\&quot;</span><span class="s2">word</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">definition</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;}}</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">related_words</span><span class="se">\&quot;</span><span class="s2">:[</span><span class="se">{{\&quot;</span><span class="s2">word</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">word1</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">definition</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;}}</span><span class="s2">,...,</span><span class="se">{{\&quot;</span><span class="s2">word</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">word25</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">definition</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;}}</span><span class="s2">]</span><span class="se">}}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l749"
               class="code sev- "><tt><i>749</i> &nbsp;</tt>
            </div>
            <div id="l750"
               class="code sev- "><tt><i>750</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;CHECK_CHAPTER_PROGRESS&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l751"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>751</i>         <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="c1"># Expecting YES / NO / SUGGEST_TASK</span></tt>
            </div>
            <div id="l752"
               class="code sev- "><tt><i>752</i>         <span class="n">char_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;P=</span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">p_race</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_class</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">p_philosophy</span><span class="si">}</span><span class="s2">)&quot;</span></tt>
            </div>
            <div id="l753"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (125 > 79 characters)</li>

               </ul><tt><i>753</i>         <span class="n">quest_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Quest:&#39;</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; Step:&#39;</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span></tt>
            </div>
            <div id="l754"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>754</i>         <span class="n">conversation_summary</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conversation_summary&#39;</span><span class="p">,</span> <span class="s1">&#39;(no recent conversation)&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l755"
               class="code sev- "><tt><i>755</i>         <span class="n">turn_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turn_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l756"
               class="code sev- "><tt><i>756</i>         <span class="n">inputs_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inputs_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l757"
               class="code sev- "><tt><i>757</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l758"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (223 > 79 characters)</li>

               </ul><tt><i>758</i>             <span class="sa">f</span><span class="s2">&quot;Analyze the current game state. Turn Count: </span><span class="si">{</span><span class="n">turn_count</span><span class="si">}</span><span class="s2">. Inputs this Chapter: </span><span class="si">{</span><span class="n">inputs_count</span><span class="si">}</span><span class="s2">. Character: </span><span class="si">{</span><span class="n">char_info</span><span class="si">}</span><span class="s2">. Current Objective: </span><span class="si">{</span><span class="n">quest_info</span><span class="si">}</span><span class="s2">. Recent Conversation Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">conversation_summary</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l759"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (230 > 79 characters)</li>

               </ul><tt><i>759</i>             <span class="sa">f</span><span class="s2">&quot;Task: Evaluate if the chapter has had sufficient narrative development and player interaction for a meaningful end-of-chapter evaluation (consider turns &gt; </span><span class="si">{</span><span class="n">EOC_CHECK_START_TURN</span><span class="si">}</span><span class="s2"> and inputs &gt; </span><span class="si">{</span><span class="n">MIN_INPUTS_FOR_EOC</span><span class="si">}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l760"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (199 > 79 characters)</li>

               </ul><tt><i>760</i>             <span class="sa">f</span><span class="s2">&quot;1. If significant progress on the objective OR substantial exploration/interaction has occurred, AND the chapter feels sufficiently developed for evaluation, respond ONLY with &#39;YES&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l761"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (197 > 79 characters)</li>

               </ul><tt><i>761</i>             <span class="sa">f</span><span class="s2">&quot;2. If a natural pause point seems reached (e.g., objective part met) BUT the chapter feels short or lacks interaction depth for a good evaluation, respond ONLY with &#39;SUGGEST_TASK&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l762"
               class="code sev- "><tt><i>762</i>             <span class="sa">f</span><span class="s2">&quot;3. Otherwise, respond ONLY with &#39;NO&#39;.&quot;</span></tt>
            </div>
            <div id="l763"
               class="code sev- "><tt><i>763</i>          <span class="p">)</span></tt>
            </div>
            <div id="l764"
               class="code sev- "><tt><i>764</i> &nbsp;</tt>
            </div>
            <div id="l765"
               class="code sev- "><tt><i>765</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;INITIATE_PLAYER_SIDEQUEST&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l766"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>766</i>          <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l767"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (256 > 79 characters)</li>

               </ul><tt><i>767</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Task: Inform the player they&#39;ve reached a natural pause point, but the current chapter could use a bit more activity for a full reflection. Offer them a chance to define a brief, personal side task for writing practice.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l768"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (158 > 79 characters)</li>

               </ul><tt><i>768</i>              <span class="sa">f</span><span class="s2">&quot;Ask them clearly: &#39;What small, immediate goal or observation would your character like to focus on right now before we conclude this chapter?&#39;&quot;</span></tt>
            </div>
            <div id="l769"
               class="code sev- "><tt><i>769</i>              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Keep the tone encouraging and focused on creative practice.&quot;</span></tt>
            </div>
            <div id="l770"
               class="code sev- "><tt><i>770</i>          <span class="p">)</span></tt>
            </div>
            <div id="l771"
               class="code sev- "><tt><i>771</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;PROCESS_PLAYER_SIDEQUEST_IDEA&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l772"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>772</i>          <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span> <span class="c1"># Expecting JSON objective back</span></tt>
            </div>
            <div id="l773"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>773</i>          <span class="n">player_idea</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_sidequest_idea&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l774"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>774</i>          <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l775"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>775</i>               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Player proposed side task: &#39;</span><span class="si">{</span><span class="n">player_idea</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l776"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (261 > 79 characters)</li>

               </ul><tt><i>776</i>               <span class="sa">f</span><span class="s2">&quot;Task: Interpret the player&#39;s idea. Formulate a concise, actionable mini-objective (1-2 steps max) based on their input. If the idea is too complex or vague, generate a simpler, related objective suitable for a short detour (approx 3-5 turns).</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l777"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>777</i>               <span class="sa">f</span><span class="s2">&quot;Respond ONLY with JSON: </span><span class="se">{{\&quot;</span><span class="s2">side_quest_objective</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">[Generated concise objective description]</span><span class="se">\&quot;}}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l778"
               class="code sev- "><tt><i>778</i>           <span class="p">)</span></tt>
            </div>
            <div id="l779"
               class="code sev- "><tt><i>779</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;EVALUATE_SIDEQUEST_COMPLETION&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l780"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>780</i>          <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="c1"># Expecting YES/NO</span></tt>
            </div>
            <div id="l781"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>781</i>          <span class="n">side_quest_obj</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;side_quest_objective&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l782"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>782</i>          <span class="n">recent_conv</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conversation_summary&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l783"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>783</i>          <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l784"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>784</i>               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instruct</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Side Quest Objective Was: &#39;</span><span class="si">{</span><span class="n">side_quest_obj</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">Recent Conversation:</span><span class="se">\n</span><span class="si">{</span><span class="n">recent_conv</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l785"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (244 > 79 characters)</li>

               </ul><tt><i>785</i>               <span class="sa">f</span><span class="s2">&quot;Task: Briefly assess if the player seems to have reasonably addressed or completed their self-defined side quest objective based ONLY on the recent conversation provided. Focus on effort/engagement rather than strict success.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l786"
               class="code sev- "><tt><i>786</i>               <span class="sa">f</span><span class="s2">&quot;Respond ONLY with &#39;YES&#39; or &#39;NO&#39;.&quot;</span></tt>
            </div>
            <div id="l787"
               class="code sev- "><tt><i>787</i>           <span class="p">)</span></tt>
            </div>
            <div id="l788"
               class="code sev- "><tt><i>788</i> &nbsp;</tt>
            </div>
            <div id="l789"
               class="code sev- "><tt><i>789</i>     <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s2">&quot;EVALUATE_STEP_COMPLETION&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l790"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>790</i>         <span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="c1"># Expecting YES/NO</span></tt>
            </div>
            <div id="l791"
               class="code sev- "><tt><i>791</i>         <span class="n">step_desc</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;step_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l792"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>792</i>         <span class="n">player_action</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_action&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># Last player input</span></tt>
            </div>
            <div id="l793"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>793</i>         <span class="n">ai_outcome</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_outcome&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># Last AI response narrating outcome</span></tt>
            </div>
            <div id="l794"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>794</i>         <span class="n">check_criteria</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_check_criteria&#39;</span><span class="p">,</span> <span class="s1">&#39;if the player performed the action&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l795"
               class="code sev- "><tt><i>795</i> &nbsp;</tt>
            </div>
            <div id="l796"
               class="code sev- "><tt><i>796</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l797"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (122 > 79 characters)</li>

               </ul><tt><i>797</i>             <span class="sa">f</span><span class="s2">&quot;Evaluate if the player&#39;s action likely completed the step based on the outcome and the specific criteria.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l798"
               class="code sev- "><tt><i>798</i>             <span class="sa">f</span><span class="s2">&quot;Step Objective Hint: &#39;</span><span class="si">{</span><span class="n">step_desc</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l799"
               class="code sev- "><tt><i>799</i>             <span class="sa">f</span><span class="s2">&quot;Player&#39;s Action This Turn: &#39;</span><span class="si">{</span><span class="n">player_action</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l800"
               class="code sev- "><tt><i>800</i>             <span class="sa">f</span><span class="s2">&quot;Narrated Outcome This Turn: &#39;</span><span class="si">{</span><span class="n">ai_outcome</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l801"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (131 > 79 characters)</li>

               </ul><tt><i>801</i>             <span class="sa">f</span><span class="s2">&quot;Criteria: Based *only* on the Player&#39;s Action and Narrated Outcome text provided above, determine </span><span class="si">{</span><span class="n">check_criteria</span><span class="si">}</span><span class="s2">. &quot;</span></tt>
            </div>
            <div id="l802"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>802</i>             <span class="sa">f</span><span class="s2">&quot;Focus on whether the described action or intent occurred this turn.</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l803"
               class="code sev- "><tt><i>803</i>             <span class="sa">f</span><span class="s2">&quot;Respond ONLY with &#39;YES&#39; or &#39;NO&#39;.&quot;</span></tt>
            </div>
            <div id="l804"
               class="code sev- "><tt><i>804</i>         <span class="p">)</span></tt>
            </div>
            <div id="l805"
               class="code sev- "><tt><i>805</i> &nbsp;</tt>
            </div>
            <div id="l806"
               class="code sev- "><tt><i>806</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l807"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>807</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prompt type requested: &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;. Using fallback.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l808"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>808</i>         <span class="n">prompt</span> <span class="o">=</span> <span class="n">base_instruct</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">My Task: Respond gracefully to an unclear request.&quot;</span></tt>
            </div>
            <div id="l809"
               class="code sev- "><tt><i>809</i> &nbsp;</tt>
            </div>
            <div id="l810"
               class="code sev- "><tt><i>810</i> &nbsp;</tt>
            </div>
            <div id="l811"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E303
                     </span>
                     Too many blank lines (2)</li>

               </ul><tt><i>811</i>     <span class="c1"># --- AI Call and Response Handling ---</span></tt>
            </div>
            <div id="l812"
               class="code sev- "><tt><i>812</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l813"
               class="code sev- "><tt><i>813</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending prompt type &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39; to Vertex AI...&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l814"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>814</i>         <span class="c1"># logging.debug(f&quot;Full Prompt for {prompt_type}: {prompt}&quot;) # Uncomment for deep debugging</span></tt>
            </div>
            <div id="l815"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>815</i>         <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">safety_settings</span><span class="o">=</span><span class="n">safety_settings</span><span class="p">)</span></tt>
            </div>
            <div id="l816"
               class="code sev- "><tt><i>816</i>         <span class="n">ai_text</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l817"
               class="code sev- "><tt><i>817</i> &nbsp;</tt>
            </div>
            <div id="l818"
               class="code sev- "><tt><i>818</i>         <span class="c1"># Check if response blocked</span></tt>
            </div>
            <div id="l819"
               class="code sev- "><tt><i>819</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">:</span></tt>
            </div>
            <div id="l820"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>820</i>              <span class="n">feedback</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;prompt_feedback&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l821"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>821</i>              <span class="n">block_reason</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">feedback</span><span class="p">,</span> <span class="s1">&#39;block_reason&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">feedback</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span></tt>
            </div>
            <div id="l822"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>822</i>              <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Blocked: </span><span class="si">{</span><span class="n">block_reason</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l823"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>823</i>              <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI response blocked for prompt type &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;. Reason: </span><span class="si">{</span><span class="n">block_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l824"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>824</i>              <span class="n">is_json</span> <span class="o">=</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l825"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (126 > 79 characters)</li>

               </ul><tt><i>825</i>              <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span> <span class="k">if</span> <span class="n">is_json</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Error: AI response blocked (</span><span class="si">{</span><span class="n">block_reason</span><span class="si">}</span><span class="s2">).&quot;</span></tt>
            </div>
            <div id="l826"
               class="code sev- "><tt><i>826</i> &nbsp;</tt>
            </div>
            <div id="l827"
               class="code sev- "><tt><i>827</i>         <span class="c1"># Check finish reason</span></tt>
            </div>
            <div id="l828"
               class="code sev- "><tt><i>828</i>         <span class="n">candidate</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></tt>
            </div>
            <div id="l829"
               class="code sev- "><tt><i>829</i>         <span class="n">finish_reason_name</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">finish_reason</span><span class="o">.</span><span class="n">name</span></tt>
            </div>
            <div id="l830"
               class="code sev- "><tt><i>830</i>         <span class="k">if</span> <span class="n">finish_reason_name</span> <span class="o">!=</span> <span class="s1">&#39;STOP&#39;</span> <span class="ow">and</span> <span class="n">finish_reason_name</span> <span class="o">!=</span> <span class="s1">&#39;MAX_TOKENS&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l831"
               class="code sev- "><tt><i>831</i>             <span class="n">is_safety</span> <span class="o">=</span> <span class="p">(</span><span class="n">finish_reason_name</span> <span class="o">==</span> <span class="s1">&#39;SAFETY&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l832"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>832</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI generation finished unexpectedly for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;. Reason: </span><span class="si">{</span><span class="n">finish_reason_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l833"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>833</i>             <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Blocked: Safety&quot;</span> <span class="k">if</span> <span class="n">is_safety</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;AI stopped: </span><span class="si">{</span><span class="n">finish_reason_name</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l834"
               class="code sev- "><tt><i>834</i>             <span class="n">safety_ratings_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l835"
               class="code sev- "><tt><i>835</i>             <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">safety_ratings</span><span class="p">:</span></tt>
            </div>
            <div id="l836"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (127 > 79 characters)</li>

               </ul><tt><i>836</i>                  <span class="n">ratings_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">candidate</span><span class="o">.</span><span class="n">safety_ratings</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">blocked</span><span class="p">]</span></tt>
            </div>
            <div id="l837"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>837</i>                  <span class="k">if</span> <span class="n">ratings_str_list</span><span class="p">:</span></tt>
            </div>
            <div id="l838"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>838</i>                      <span class="n">safety_ratings_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ratings_str_list</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span></tt>
            </div>
            <div id="l839"
               class="code sev- "><tt><i>839</i>             <span class="n">error_msg</span> <span class="o">+=</span> <span class="n">safety_ratings_str</span></tt>
            </div>
            <div id="l840"
               class="code sev- "><tt><i>840</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safety Ratings Details: </span><span class="si">{</span><span class="n">safety_ratings_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l841"
               class="code sev- "><tt><i>841</i>             <span class="n">is_json</span> <span class="o">=</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l842"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (124 > 79 characters)</li>

               </ul><tt><i>842</i>             <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span> <span class="k">if</span> <span class="n">is_json</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Error: AI generation stopped (</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">).&quot;</span></tt>
            </div>
            <div id="l843"
               class="code sev- "><tt><i>843</i> &nbsp;</tt>
            </div>
            <div id="l844"
               class="code sev- "><tt><i>844</i>         <span class="c1"># Extract text content</span></tt>
            </div>
            <div id="l845"
               class="code sev- "><tt><i>845</i>         <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span></tt>
            </div>
            <div id="l846"
               class="code sev- "><tt><i>846</i>             <span class="n">ai_text</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span></tt>
            </div>
            <div id="l847"
               class="code sev- "><tt><i>847</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l848"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>848</i>              <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI response content is empty for prompt type &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l849"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>849</i>              <span class="n">ai_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Use empty string if no text</span></tt>
            </div>
            <div id="l850"
               class="code sev- "><tt><i>850</i> &nbsp;</tt>
            </div>
            <div id="l851"
               class="code sev- "><tt><i>851</i>         <span class="c1"># Ensure text is string</span></tt>
            </div>
            <div id="l852"
               class="code sev- "><tt><i>852</i>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l853"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (128 > 79 characters)</li>

               </ul><tt><i>853</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI response was not a string for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39; (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ai_text</span><span class="p">)</span><span class="si">}</span><span class="s2">). Attempting conversion.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l854"
               class="code sev- "><tt><i>854</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l855"
               class="code sev- "><tt><i>855</i>                 <span class="n">ai_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ai_text</span><span class="p">)</span></tt>
            </div>
            <div id="l856"
               class="code sev- "><tt><i>856</i>             <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span></tt>
            </div>
            <div id="l857"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>857</i>                 <span class="n">ai_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Fallback to empty string on conversion failure</span></tt>
            </div>
            <div id="l858"
               class="code sev- "><tt><i>858</i> &nbsp;</tt>
            </div>
            <div id="l859"
               class="code sev- "><tt><i>859</i>         <span class="c1"># Process JSON or Text response</span></tt>
            </div>
            <div id="l860"
               class="code sev- "><tt><i>860</i>         <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l861"
               class="code sev- "><tt><i>861</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">ai_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span></tt>
            </div>
            <div id="l862"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

               </ul><tt><i>862</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI returned an empty string when JSON was expected for prompt type &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l863"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>863</i>                  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty JSON response&quot;</span><span class="p">}</span></tt>
            </div>
            <div id="l864"
               class="code sev- "><tt><i>864</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l865"
               class="code sev- "><tt><i>865</i>                 <span class="c1"># Remove markdown code block fences if present</span></tt>
            </div>
            <div id="l866"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E227
                     </span>
                     Missing whitespace around bitwise or shift operator</li>

               </ul><tt><i>866</i>                 <span class="n">clean_json_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^```json\s*|\s*```$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ai_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span></tt>
            </div>
            <div id="l867"
               class="code sev- "><tt><i>867</i>                 <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">clean_json_str</span><span class="p">)</span></tt>
            </div>
            <div id="l868"
               class="code sev- "><tt><i>868</i>             <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">json_err</span><span class="p">:</span></tt>
            </div>
            <div id="l869"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (133 > 79 characters)</li>

               </ul><tt><i>869</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode AI JSON response for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;. Error: </span><span class="si">{</span><span class="n">json_err</span><span class="si">}</span><span class="s2">. Raw text: &gt;&gt;&gt;</span><span class="si">{</span><span class="n">ai_text</span><span class="si">}</span><span class="s2">&lt;&lt;&lt;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l870"
               class="code sev- "><tt><i>870</i>                 <span class="c1"># Attempt recovery if possible</span></tt>
            </div>
            <div id="l871"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>871</i>                 <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{.*\}&#39;</span><span class="p">,</span> <span class="n">ai_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Find first JSON-like object</span></tt>
            </div>
            <div id="l872"
               class="code sev- "><tt><i>872</i>                 <span class="k">if</span> <span class="n">match</span><span class="p">:</span></tt>
            </div>
            <div id="l873"
               class="code sev- "><tt><i>873</i>                     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l874"
               class="code sev- "><tt><i>874</i>                         <span class="n">recovered_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></tt>
            </div>
            <div id="l875"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>875</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully recovered JSON object from malformed response for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l876"
               class="code sev- "><tt><i>876</i>                         <span class="k">return</span> <span class="n">recovered_json</span></tt>
            </div>
            <div id="l877"
               class="code sev- "><tt><i>877</i>                     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">recovery_err</span><span class="p">:</span></tt>
            </div>
            <div id="l878"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (124 > 79 characters)</li>

               </ul><tt><i>878</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempted JSON recovery failed for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;. Recovery error: </span><span class="si">{</span><span class="n">recovery_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l879"
               class="code sev- "><tt><i>879</i>                 <span class="c1"># Return error if decode/recovery fails</span></tt>
            </div>
            <div id="l880"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>880</i>                 <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON Parse Fail&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_err</span><span class="p">),</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">ai_text</span><span class="p">}</span></tt>
            </div>
            <div id="l881"
               class="code sev- "><tt><i>881</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l882"
               class="code sev- "><tt><i>882</i>                 <span class="c1"># Catch other potential errors during JSON processing</span></tt>
            </div>
            <div id="l883"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>883</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error processing JSON response for &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l884"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>884</i>                 <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON Processing Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">ai_text</span><span class="p">}</span></tt>
            </div>
            <div id="l885"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>885</i>         <span class="k">else</span><span class="p">:</span> <span class="c1"># Text output</span></tt>
            </div>
            <div id="l886"
               class="code sev- "><tt><i>886</i>             <span class="c1"># Clean up potential AI prefixes and strip whitespace</span></tt>
            </div>
            <div id="l887"
               class="code sev- "><tt><i>887</i>             <span class="n">cleaned</span> <span class="o">=</span> <span class="n">ai_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l888"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>888</i>             <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(AI|Storyteller|Assistant|Guide):\s*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span></tt>
            </div>
            <div id="l889"
               class="code sev- "><tt><i>889</i>             <span class="c1"># Return cleaned text or a fallback message</span></tt>
            </div>
            <div id="l890"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>890</i>             <span class="k">return</span> <span class="n">cleaned</span> <span class="k">if</span> <span class="n">cleaned</span> <span class="k">else</span> <span class="s2">&quot;(The Storyteller seems lost in thought...)&quot;</span></tt>
            </div>
            <div id="l891"
               class="code sev- "><tt><i>891</i> &nbsp;</tt>
            </div>
            <div id="l892"
               class="code sev- "><tt><i>892</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">api_err</span><span class="p">:</span></tt>
            </div>
            <div id="l893"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>893</i>          <span class="c1"># Catch errors during the API call itself</span></tt>
            </div>
            <div id="l894"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>894</i>          <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vertex AI API call failed for prompt type &#39;</span><span class="si">{</span><span class="n">prompt_type</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">api_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l895"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>895</i>          <span class="n">is_json</span> <span class="o">=</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span></tt>
            </div>
            <div id="l896"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>896</i>          <span class="c1"># Return error in the expected format</span></tt>
            </div>
            <div id="l897"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (155 > 79 characters)</li>

               </ul><tt><i>897</i>          <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI Error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;API Call Failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">api_err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">is_json</span> <span class="k">else</span> <span class="s2">&quot;Error: Could not communicate with the Storyteller AI.&quot;</span></tt>
            </div>
            <div id="l898"
               class="code sev- "><tt><i>898</i> &nbsp;</tt>
            </div>
            <div id="l899"
               class="code sev- "><tt><i>899</i> &nbsp;</tt>
            </div>
            <div id="l900"
               class="code sev- "><tt><i>900</i> <span class="c1"># --- Custom Vocabulary Helper ---</span></tt>
            </div>
            <div id="l901"
               class="code sev- "><tt><i>901</i> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_vocab_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span></tt>
            </div>
            <div id="l902"
               class="code sev- "><tt><i>902</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l903"
               class="code sev- "><tt><i>903</i> <span class="sd">    Fetches user&#39;s vocabulary settings (including custom colors) and</span></tt>
            </div>
            <div id="l904"
               class="code sev- "><tt><i>904</i> <span class="sd">    compiles active AWL/AI words. Returns a dictionary:</span></tt>
            </div>
            <div id="l905"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>905</i> <span class="sd">    { &quot;settings&quot;: { &quot;use_default_awl&quot;: bool, &quot;awl_color_bg&quot;: str, &quot;ai_color_bg&quot;: str },</span></tt>
            </div>
            <div id="l906"
               class="code sev- "><tt><i>906</i> <span class="sd">      &quot;vocab&quot;: { &quot;word&quot;: {&quot;definition&quot;: str, &quot;source&quot;: str} } }</span></tt>
            </div>
            <div id="l907"
               class="code sev- "><tt><i>907</i> <span class="sd">    &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l908"
               class="code sev- "><tt><i>908</i>     <span class="c1"># Define robust defaults, including colors</span></tt>
            </div>
            <div id="l909"
               class="code sev- "><tt><i>909</i>     <span class="n">default_settings</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l910"
               class="code sev- "><tt><i>910</i>         <span class="s2">&quot;use_default_awl&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span></tt>
            </div>
            <div id="l911"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>911</i>         <span class="s1">&#39;awl_color_bg&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFE6EB&#39;</span><span class="p">,</span> <span class="c1"># Default pinkish bg</span></tt>
            </div>
            <div id="l912"
               class="code sev- "><tt><i>912</i>         <span class="s1">&#39;ai_color_bg&#39;</span><span class="p">:</span> <span class="s1">&#39;#E1F0FF&#39;</span>   <span class="c1"># Default blueish bg</span></tt>
            </div>
            <div id="l913"
               class="code sev- "><tt><i>913</i>     <span class="p">}</span></tt>
            </div>
            <div id="l914"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>914</i>     <span class="n">fallback_return</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="n">default_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s2">&quot;vocab&quot;</span><span class="p">:</span> <span class="p">{}}</span> <span class="c1"># Use copy</span></tt>
            </div>
            <div id="l915"
               class="code sev- "><tt><i>915</i> &nbsp;</tt>
            </div>
            <div id="l916"
               class="code sev- "><tt><i>916</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l917"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>917</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;get_active_vocab_data called without user_id or DB connection.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l918"
               class="code sev- "><tt><i>918</i>         <span class="k">return</span> <span class="n">fallback_return</span></tt>
            </div>
            <div id="l919"
               class="code sev- "><tt><i>919</i> &nbsp;</tt>
            </div>
            <div id="l920"
               class="code sev- "><tt><i>920</i>     <span class="n">consolidated_vocab</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l921"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>921</i>     <span class="n">user_settings</span> <span class="o">=</span> <span class="n">default_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Start with defaults</span></tt>
            </div>
            <div id="l922"
               class="code sev- "><tt><i>922</i> &nbsp;</tt>
            </div>
            <div id="l923"
               class="code sev- "><tt><i>923</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l924"
               class="code sev- "><tt><i>924</i>         <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l925"
               class="code sev- "><tt><i>925</i>         <span class="c1"># Fetch the entire vocab_settings field</span></tt>
            </div>
            <div id="l926"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>926</i>         <span class="n">profile_doc</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">])</span> <span class="c1"># Only fetch the settings field</span></tt>
            </div>
            <div id="l927"
               class="code sev- "><tt><i>927</i> &nbsp;</tt>
            </div>
            <div id="l928"
               class="code sev- "><tt><i>928</i>         <span class="k">if</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l929"
               class="code sev- "><tt><i>929</i>             <span class="n">settings_data</span> <span class="o">=</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l930"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>930</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># Ensure it&#39;s a dictionary</span></tt>
            </div>
            <div id="l931"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>931</i>                 <span class="c1"># Update settings from Firestore, keeping defaults if keys are missing</span></tt>
            </div>
            <div id="l932"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>932</i>                 <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">,</span> <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l933"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>933</i>                 <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">,</span> <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l934"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>934</i>                 <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">,</span> <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l935"
               class="code sev- "><tt><i>935</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l936"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (142 > 79 characters)</li>

               </ul><tt><i>936</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Firestore &#39;vocab_settings&#39; for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> is not a dictionary (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">settings_data</span><span class="p">)</span><span class="si">}</span><span class="s2">). Using defaults.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l937"
               class="code sev- "><tt><i>937</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l938"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>938</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No profile document or vocab_settings found for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">. Using default settings.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l939"
               class="code sev- "><tt><i>939</i> &nbsp;</tt>
            </div>
            <div id="l940"
               class="code sev- "><tt><i>940</i> &nbsp;</tt>
            </div>
            <div id="l941"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E303
                     </span>
                     Too many blank lines (2)</li>

               </ul><tt><i>941</i>         <span class="c1"># --- Compile Vocabulary Words ---</span></tt>
            </div>
            <div id="l942"
               class="code sev- "><tt><i>942</i>         <span class="c1"># Add default AWL words if enabled in settings</span></tt>
            </div>
            <div id="l943"
               class="code sev- "><tt><i>943</i>         <span class="k">if</span> <span class="n">user_settings</span><span class="p">[</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">]:</span></tt>
            </div>
            <div id="l944"
               class="code sev- "><tt><i>944</i>             <span class="k">if</span> <span class="n">AWL_WORDS</span> <span class="ow">and</span> <span class="n">AWL_DEFINITIONS</span><span class="p">:</span></tt>
            </div>
            <div id="l945"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>945</i>                 <span class="c1"># We only need word, definition, and source here. Color applied later.</span></tt>
            </div>
            <div id="l946"
               class="code sev- "><tt><i>946</i>                 <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">AWL_WORDS</span><span class="p">:</span></tt>
            </div>
            <div id="l947"
               class="code sev- "><tt><i>947</i>                     <span class="n">lower_word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></tt>
            </div>
            <div id="l948"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>948</i>                     <span class="n">definition</span> <span class="o">=</span> <span class="n">AWL_DEFINITIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lower_word</span><span class="p">,</span> <span class="s2">&quot;Definition not found.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l949"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>949</i>                     <span class="k">if</span> <span class="n">lower_word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">consolidated_vocab</span><span class="p">:</span> <span class="c1"># Avoid overwriting AI list words if same</span></tt>
            </div>
            <div id="l950"
               class="code sev- "><tt><i>950</i>                         <span class="n">consolidated_vocab</span><span class="p">[</span><span class="n">lower_word</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l951"
               class="code sev- "><tt><i>951</i>                             <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">definition</span><span class="p">,</span></tt>
            </div>
            <div id="l952"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>952</i>                             <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;AWL&quot;</span> <span class="c1"># Mark source clearly</span></tt>
            </div>
            <div id="l953"
               class="code sev- "><tt><i>953</i>                         <span class="p">}</span></tt>
            </div>
            <div id="l954"
               class="code sev- "><tt><i>954</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l955"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (128 > 79 characters)</li>

               </ul><tt><i>955</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AWL vocabulary enabled for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, but AWL_WORDS or AWL_DEFINITIONS data is missing.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l956"
               class="code sev- "><tt><i>956</i> &nbsp;</tt>
            </div>
            <div id="l957"
               class="code sev- "><tt><i>957</i>         <span class="c1"># Add words from user&#39;s active, AI-generated lists</span></tt>
            </div>
            <div id="l958"
               class="code sev- "><tt><i>958</i>         <span class="n">custom_lists_ref</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;custom_vocab_lists&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l959"
               class="code sev- "><tt><i>959</i>         <span class="c1"># Query for lists that are both active and AI-generated</span></tt>
            </div>
            <div id="l960"
               class="code sev- "><tt><i>960</i>         <span class="c1"># Using FieldFilter for clarity and compatibility</span></tt>
            </div>
            <div id="l961"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (165 > 79 characters)</li>

               </ul><tt><i>961</i>         <span class="n">active_ai_lists_query</span> <span class="o">=</span> <span class="n">custom_lists_ref</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">FieldFilter</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">FieldFilter</span><span class="p">(</span><span class="s1">&#39;is_ai_generated&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">stream</span><span class="p">()</span></tt>
            </div>
            <div id="l962"
               class="code sev- "><tt><i>962</i> &nbsp;</tt>
            </div>
            <div id="l963"
               class="code sev- "><tt><i>963</i>         <span class="k">for</span> <span class="n">list_doc</span> <span class="ow">in</span> <span class="n">active_ai_lists_query</span><span class="p">:</span></tt>
            </div>
            <div id="l964"
               class="code sev- "><tt><i>964</i>             <span class="n">list_data</span> <span class="o">=</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l965"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>965</i>             <span class="n">list_name</span> <span class="o">=</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;AI List&#39;</span><span class="p">)</span> <span class="c1"># Use list name as source</span></tt>
            </div>
            <div id="l966"
               class="code sev- "><tt><i>966</i>             <span class="n">words_array</span> <span class="o">=</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;words&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l967"
               class="code sev- "><tt><i>967</i>             <span class="c1"># Iterate through words in the list</span></tt>
            </div>
            <div id="l968"
               class="code sev- "><tt><i>968</i>             <span class="k">for</span> <span class="n">word_entry</span> <span class="ow">in</span> <span class="n">words_array</span><span class="p">:</span></tt>
            </div>
            <div id="l969"
               class="code sev- "><tt><i>969</i>                 <span class="n">word</span> <span class="o">=</span> <span class="n">word_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l970"
               class="code sev- "><tt><i>970</i>                 <span class="n">definition</span> <span class="o">=</span> <span class="n">word_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l971"
               class="code sev- "><tt><i>971</i>                 <span class="k">if</span> <span class="n">word</span> <span class="ow">and</span> <span class="n">definition</span><span class="p">:</span></tt>
            </div>
            <div id="l972"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>972</i>                     <span class="c1"># Add word to consolidated list, overwriting AWL if same word</span></tt>
            </div>
            <div id="l973"
               class="code sev- "><tt><i>973</i>                     <span class="n">consolidated_vocab</span><span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l974"
               class="code sev- "><tt><i>974</i>                         <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">definition</span><span class="p">,</span></tt>
            </div>
            <div id="l975"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>975</i>                         <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">list_name</span> <span class="c1"># Use the AI list name as the source</span></tt>
            </div>
            <div id="l976"
               class="code sev- "><tt><i>976</i>                     <span class="p">}</span></tt>
            </div>
            <div id="l977"
               class="code sev- "><tt><i>977</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l978"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (122 > 79 characters)</li>

               </ul><tt><i>978</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping invalid word entry in list </span><span class="si">{</span><span class="n">list_doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">word_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l979"
               class="code sev- "><tt><i>979</i> &nbsp;</tt>
            </div>
            <div id="l980"
               class="code sev- "><tt><i>980</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l981"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>981</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching vocabulary data for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l982"
               class="code sev- "><tt><i>982</i>         <span class="c1"># Return default settings on error</span></tt>
            </div>
            <div id="l983"
               class="code sev- "><tt><i>983</i>         <span class="k">return</span> <span class="n">fallback_return</span></tt>
            </div>
            <div id="l984"
               class="code sev- "><tt><i>984</i> &nbsp;</tt>
            </div>
            <div id="l985"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>985</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compiled </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">consolidated_vocab</span><span class="p">)</span><span class="si">}</span><span class="s2"> active vocab words for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">. Settings: </span><span class="si">{</span><span class="n">user_settings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l986"
               class="code sev- "><tt><i>986</i>     <span class="c1"># Return the full settings dict (including colors) and the vocab data</span></tt>
            </div>
            <div id="l987"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E201
                     </span>
                     Whitespace after '{'</li>

                  <li>
                     <span class="count sev-2">
                        E202
                     </span>
                     Whitespace before '}'</li>

               </ul><tt><i>987</i>     <span class="k">return</span> <span class="p">{</span> <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="n">user_settings</span><span class="p">,</span> <span class="s2">&quot;vocab&quot;</span><span class="p">:</span> <span class="n">consolidated_vocab</span> <span class="p">}</span></tt>
            </div>
            <div id="l988"
               class="code sev- "><tt><i>988</i> &nbsp;</tt>
            </div>
            <div id="l989"
               class="code sev- "><tt><i>989</i> <span class="c1"># --- Data Management Helpers ---</span></tt>
            </div>
            <div id="l990"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>990</i> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_characters</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span></tt>
            </div>
            <div id="l991"
               class="code sev- "><tt><i>991</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves a list of character summaries for a given user.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l992"
               class="code sev- "><tt><i>992</i>     <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l993"
               class="code sev- "><tt><i>993</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l994"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>994</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database unavailable: cannot execute get_user_characters.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l995"
               class="code sev- "><tt><i>995</i>         <span class="k">return</span> <span class="n">chars</span></tt>
            </div>
            <div id="l996"
               class="code sev- "><tt><i>996</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span></tt>
            </div>
            <div id="l997"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>997</i>          <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;User ID not provided to get_user_characters.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l998"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>998</i>          <span class="k">return</span> <span class="n">chars</span></tt>
            </div>
            <div id="l999"
               class="code sev- "><tt><i>999</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1000"
               class="code sev- "><tt><i>1000</i>         <span class="c1"># Query characters collection for documents matching the user_id</span></tt>
            </div>
            <div id="l1001"
               class="code sev- "><tt><i>1001</i>         <span class="c1"># Using FieldFilter for clarity and compatibility</span></tt>
            </div>
            <div id="l1002"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>1002</i>         <span class="n">docs_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;characters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">FieldFilter</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span></tt>
            </div>
            <div id="l1003"
               class="code sev- "><tt><i>1003</i>         <span class="n">docs_stream</span> <span class="o">=</span> <span class="n">docs_query</span><span class="o">.</span><span class="n">stream</span><span class="p">()</span></tt>
            </div>
            <div id="l1004"
               class="code sev- "><tt><i>1004</i>         <span class="c1"># Iterate through found documents and extract summary data</span></tt>
            </div>
            <div id="l1005"
               class="code sev- "><tt><i>1005</i>         <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs_stream</span><span class="p">:</span></tt>
            </div>
            <div id="l1006"
               class="code sev- "><tt><i>1006</i>             <span class="n">d</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l1007"
               class="code sev- "><tt><i>1007</i>             <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">({</span></tt>
            </div>
            <div id="l1008"
               class="code sev- "><tt><i>1008</i>                 <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span></tt>
            </div>
            <div id="l1009"
               class="code sev- "><tt><i>1009</i>                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unnamed Character&quot;</span><span class="p">),</span></tt>
            </div>
            <div id="l1010"
               class="code sev- "><tt><i>1010</i>                 <span class="s2">&quot;race&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;race_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown Race&quot;</span><span class="p">),</span></tt>
            </div>
            <div id="l1011"
               class="code sev- "><tt><i>1011</i>                 <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown Class&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1012"
               class="code sev- "><tt><i>1012</i>             <span class="p">})</span></tt>
            </div>
            <div id="l1013"
               class="code sev- "><tt><i>1013</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1014"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>1014</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch characters for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1015"
               class="code sev- "><tt><i>1015</i>     <span class="c1"># Log how many characters were found</span></tt>
            </div>
            <div id="l1016"
               class="code sev- "><tt><i>1016</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span><span class="si">}</span><span class="s2"> characters for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1017"
               class="code sev- "><tt><i>1017</i>     <span class="k">return</span> <span class="n">chars</span></tt>
            </div>
            <div id="l1018"
               class="code sev- "><tt><i>1018</i> &nbsp;</tt>
            </div>
            <div id="l1019"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

               </ul><tt><i>1019</i> <span class="k">def</span><span class="w"> </span><span class="nf">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">char_id</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l1020"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>1020</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads full character data from Firestore, ensuring user ownership and initializing fields.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1021"
               class="code sev- "><tt><i>1021</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">char_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l1022"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

               </ul><tt><i>1022</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_character_data missing arguments or DB connection. User: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, Char: </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1023"
               class="code sev- "><tt><i>1023</i>         <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1024"
               class="code sev- "><tt><i>1024</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1025"
               class="code sev- "><tt><i>1025</i>         <span class="n">doc_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;characters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1026"
               class="code sev- "><tt><i>1026</i>         <span class="n">doc</span> <span class="o">=</span> <span class="n">doc_ref</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></tt>
            </div>
            <div id="l1027"
               class="code sev- "><tt><i>1027</i>         <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l1028"
               class="code sev- "><tt><i>1028</i>             <span class="n">data</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l1029"
               class="code sev- "><tt><i>1029</i>             <span class="c1"># --- Security Check ---</span></tt>
            </div>
            <div id="l1030"
               class="code sev- "><tt><i>1030</i>             <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1031"
               class="code sev- "><tt><i>1031</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Permission denied to load this character.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1032"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (136 > 79 characters)</li>

               </ul><tt><i>1032</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SECURITY ALERT: User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempted to load character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> owned by </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1033"
               class="code sev- "><tt><i>1033</i>                 <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1034"
               class="code sev- "><tt><i>1034</i> &nbsp;</tt>
            </div>
            <div id="l1035"
               class="code sev- "><tt><i>1035</i>             <span class="c1"># --- Initialize Core Fields with Defaults ---</span></tt>
            </div>
            <div id="l1036"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1036</i>             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">char_id</span> <span class="c1"># Add doc ID for reference</span></tt>
            </div>
            <div id="l1037"
               class="code sev- "><tt><i>1037</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unnamed Character&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1038"
               class="code sev- "><tt><i>1038</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1039"
               class="code sev- "><tt><i>1039</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1040"
               class="code sev- "><tt><i>1040</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1041"
               class="code sev- "><tt><i>1041</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;boon&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1042"
               class="code sev- "><tt><i>1042</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;backstory&#39;</span><span class="p">,</span> <span class="s1">&#39;A mystery.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1043"
               class="code sev- "><tt><i>1043</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1044"
               class="code sev- "><tt><i>1044</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;aspects&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1045"
               class="code sev- "><tt><i>1045</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;current_location&#39;</span><span class="p">,</span> <span class="n">STARTING_LOCATION</span><span class="p">)</span></tt>
            </div>
            <div id="l1046"
               class="code sev- "><tt><i>1046</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1047"
               class="code sev- "><tt><i>1047</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1048"
               class="code sev- "><tt><i>1048</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1049"
               class="code sev- "><tt><i>1049</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1050"
               class="code sev- "><tt><i>1050</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1051"
               class="code sev- "><tt><i>1051</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;turn_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l1052"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>1052</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># Use constant if defined, else string</span></tt>
            </div>
            <div id="l1053"
               class="code sev- "><tt><i>1053</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1054"
               class="code sev- "><tt><i>1054</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1055"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1055</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># Initialize as empty dict if missing</span></tt>
            </div>
            <div id="l1056"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1056</i>             <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Initialize as empty list if missing</span></tt>
            </div>
            <div id="l1057"
               class="code sev- "><tt><i>1057</i> &nbsp;</tt>
            </div>
            <div id="l1058"
               class="code sev- "><tt><i>1058</i>             <span class="c1"># Ensure learned_vocab is a set</span></tt>
            </div>
            <div id="l1059"
               class="code sev- "><tt><i>1059</i>             <span class="n">loaded_vocab</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1060"
               class="code sev- "><tt><i>1060</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded_vocab</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span></tt>
            </div>
            <div id="l1061"
               class="code sev- "><tt><i>1061</i>                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loaded_vocab</span><span class="p">)</span></tt>
            </div>
            <div id="l1062"
               class="code sev- "><tt><i>1062</i>             <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded_vocab</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span></tt>
            </div>
            <div id="l1063"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1063</i>                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_vocab</span> <span class="c1"># Already a set</span></tt>
            </div>
            <div id="l1064"
               class="code sev- "><tt><i>1064</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1065"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1065</i>                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># Fallback for unexpected types</span></tt>
            </div>
            <div id="l1066"
               class="code sev- "><tt><i>1066</i> &nbsp;</tt>
            </div>
            <div id="l1067"
               class="code sev- "><tt><i>1067</i>             <span class="c1"># Initialize fate points if missing</span></tt>
            </div>
            <div id="l1068"
               class="code sev- "><tt><i>1068</i>             <span class="k">if</span> <span class="s1">&#39;fate_points&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span></tt>
            </div>
            <div id="l1069"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>1069</i>                 <span class="n">race_mod</span> <span class="o">=</span> <span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_point_mod&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l1070"
               class="code sev- "><tt><i>1070</i>                 <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fate_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_FATE_POINTS</span> <span class="o">+</span> <span class="n">race_mod</span></tt>
            </div>
            <div id="l1071"
               class="code sev- "><tt><i>1071</i> &nbsp;</tt>
            </div>
            <div id="l1072"
               class="code sev- "><tt><i>1072</i>             <span class="c1"># Remove deprecated fields if they exist (optional cleanup)</span></tt>
            </div>
            <div id="l1073"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>1073</i>             <span class="n">deprecated_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;xp&#39;</span><span class="p">,</span> <span class="s1">&#39;xp_next_level&#39;</span><span class="p">,</span> <span class="s1">&#39;attribute_points_to_spend&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l1074"
               class="code sev- "><tt><i>1074</i>             <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">deprecated_keys</span><span class="p">:</span></tt>
            </div>
            <div id="l1075"
               class="code sev- "><tt><i>1075</i>                 <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1076"
               class="code sev- "><tt><i>1076</i> &nbsp;</tt>
            </div>
            <div id="l1077"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1077</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;) for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1078"
               class="code sev- "><tt><i>1078</i>             <span class="k">return</span> <span class="n">data</span></tt>
            </div>
            <div id="l1079"
               class="code sev- "><tt><i>1079</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1080"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1080</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Character document </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> not found for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1081"
               class="code sev- "><tt><i>1081</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Character not found.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1082"
               class="code sev- "><tt><i>1082</i>             <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1083"
               class="code sev- "><tt><i>1083</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1084"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1084</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1085"
               class="code sev- "><tt><i>1085</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An error occurred while loading the character.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1086"
               class="code sev- "><tt><i>1086</i>         <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1087"
               class="code sev- "><tt><i>1087</i> &nbsp;</tt>
            </div>
            <div id="l1088"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E227
                     </span>
                     Missing whitespace around bitwise or shift operator (in 2 places)</li>

               </ul><tt><i>1088</i> <span class="k">def</span><span class="w"> </span><span class="nf">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">character_data</span><span class="p">:</span><span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l1089"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1089</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves character data to Firestore, ensuring necessary fields exist and formatting lists.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1090"
               class="code sev- "><tt><i>1090</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">character_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l1091"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1091</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_character_data missing arguments or DB connection. User: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1092"
               class="code sev- "><tt><i>1092</i>         <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1093"
               class="code sev- "><tt><i>1093</i>     <span class="n">doc_id</span> <span class="o">=</span> <span class="n">character_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1094"
               class="code sev- "><tt><i>1094</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">doc_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1095"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1095</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;save_character_data called without &#39;id&#39; in character_data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1096"
               class="code sev- "><tt><i>1096</i>         <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1097"
               class="code sev- "><tt><i>1097</i> &nbsp;</tt>
            </div>
            <div id="l1098"
               class="code sev- "><tt><i>1098</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1099"
               class="code sev- "><tt><i>1099</i>         <span class="c1"># Create a copy to avoid modifying the original dict in memory</span></tt>
            </div>
            <div id="l1100"
               class="code sev- "><tt><i>1100</i>         <span class="n">save_data</span> <span class="o">=</span> <span class="n">character_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l1101"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1101</i>         <span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span> <span class="c1"># Ensure user_id is set</span></tt>
            </div>
            <div id="l1102"
               class="code sev- "><tt><i>1102</i> &nbsp;</tt>
            </div>
            <div id="l1103"
               class="code sev- "><tt><i>1103</i>         <span class="c1"># Convert learned_vocab set back to sorted list for Firestore</span></tt>
            </div>
            <div id="l1104"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>1104</i>         <span class="k">if</span> <span class="s1">&#39;learned_vocab&#39;</span> <span class="ow">in</span> <span class="n">save_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">):</span></tt>
            </div>
            <div id="l1105"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1105</i>             <span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]))</span></tt>
            </div>
            <div id="l1106"
               class="code sev- "><tt><i>1106</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1107"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1107</i>             <span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Ensure it&#39;s always a list</span></tt>
            </div>
            <div id="l1108"
               class="code sev- "><tt><i>1108</i> &nbsp;</tt>
            </div>
            <div id="l1109"
               class="code sev- "><tt><i>1109</i>         <span class="c1"># Ensure conversation log is a list and trim if necessary</span></tt>
            </div>
            <div id="l1110"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>1110</i>         <span class="n">save_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="p">[]))[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l1111"
               class="code sev- "><tt><i>1111</i>         <span class="c1"># Ensure chapter inputs is a list</span></tt>
            </div>
            <div id="l1112"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1112</i>         <span class="n">save_data</span><span class="p">[</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[]))</span></tt>
            </div>
            <div id="l1113"
               class="code sev- "><tt><i>1113</i>         <span class="c1"># Ensure quest flags and inventory are correct types</span></tt>
            </div>
            <div id="l1114"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>1114</i>         <span class="n">save_data</span><span class="p">[</span><span class="n">FS_QUEST_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{}))</span> <span class="c1"># Ensure it&#39;s a dict</span></tt>
            </div>
            <div id="l1115"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>1115</i>         <span class="n">save_data</span><span class="p">[</span><span class="n">FS_INVENTORY</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[]))</span> <span class="c1"># Ensure it&#39;s a list</span></tt>
            </div>
            <div id="l1116"
               class="code sev- "><tt><i>1116</i> &nbsp;</tt>
            </div>
            <div id="l1117"
               class="code sev- "><tt><i>1117</i>         <span class="c1"># Remove temporary session-related keys before saving</span></tt>
            </div>
            <div id="l1118"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1118</i>         <span class="n">save_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Don&#39;t save the ID within the document data itself</span></tt>
            </div>
            <div id="l1119"
               class="code sev- "><tt><i>1119</i>         <span class="n">session_keys_to_remove</span> <span class="o">=</span> <span class="p">[</span></tt>
            </div>
            <div id="l1120"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1120</i>              <span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span></tt>
            </div>
            <div id="l1121"
               class="code sev- "><tt><i>1121</i>              <span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">,</span></tt>
            </div>
            <div id="l1122"
               class="code sev- "><tt><i>1122</i>              <span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">,</span> <span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span></tt>
            </div>
            <div id="l1123"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1123</i>              <span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="n">SESSION_NEW_CHAR_DETAILS</span></tt>
            </div>
            <div id="l1124"
               class="code sev- "><tt><i>1124</i>          <span class="p">]</span></tt>
            </div>
            <div id="l1125"
               class="code sev- "><tt><i>1125</i>         <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">session_keys_to_remove</span><span class="p">:</span></tt>
            </div>
            <div id="l1126"
               class="code sev- "><tt><i>1126</i>             <span class="n">save_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1127"
               class="code sev- "><tt><i>1127</i> &nbsp;</tt>
            </div>
            <div id="l1128"
               class="code sev- "><tt><i>1128</i>         <span class="c1"># Remove deprecated fields explicitly (optional cleanup)</span></tt>
            </div>
            <div id="l1129"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>1129</i>         <span class="n">deprecated_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;xp&#39;</span><span class="p">,</span> <span class="s1">&#39;xp_next_level&#39;</span><span class="p">,</span> <span class="s1">&#39;attribute_points_to_spend&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l1130"
               class="code sev- "><tt><i>1130</i>         <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">deprecated_keys</span><span class="p">:</span></tt>
            </div>
            <div id="l1131"
               class="code sev- "><tt><i>1131</i>             <span class="n">save_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1132"
               class="code sev- "><tt><i>1132</i> &nbsp;</tt>
            </div>
            <div id="l1133"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1133</i>         <span class="c1"># Ensure core fields always exist before saving to prevent errors on load</span></tt>
            </div>
            <div id="l1134"
               class="code sev- "><tt><i>1134</i>         <span class="n">core_fields</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1135"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1135</i>             <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Unnamed Character&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1136"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1136</i>             <span class="s1">&#39;philosophy_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;boon&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;backstory&#39;</span><span class="p">:</span> <span class="s1">&#39;A mystery.&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1137"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>1137</i>             <span class="s1">&#39;abilities&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;aspects&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;current_location&#39;</span><span class="p">:</span> <span class="n">STARTING_LOCATION</span><span class="p">,</span></tt>
            </div>
            <div id="l1138"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1138</i>             <span class="s1">&#39;current_quest_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;current_step_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1139"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1139</i>             <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;turn_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SESSION_EOC_PROMPTED</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span></tt>
            </div>
            <div id="l1140"
               class="code sev- "><tt><i>1140</i>             <span class="s1">&#39;report_summaries&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;learned_vocab&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="n">FS_CONVERSATION</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1141"
               class="code sev- "><tt><i>1141</i>             <span class="n">FS_CHAPTER_INPUTS</span><span class="p">:</span> <span class="p">[],</span> <span class="n">FS_QUEST_FLAGS</span><span class="p">:</span> <span class="p">{},</span> <span class="n">FS_INVENTORY</span><span class="p">:</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1142"
               class="code sev- "><tt><i>1142</i>         <span class="p">}</span></tt>
            </div>
            <div id="l1143"
               class="code sev- "><tt><i>1143</i>         <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">core_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l1144"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1144</i>             <span class="n">save_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="c1"># Set default only if key is missing</span></tt>
            </div>
            <div id="l1145"
               class="code sev- "><tt><i>1145</i> &nbsp;</tt>
            </div>
            <div id="l1146"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1146</i>         <span class="c1"># Recalculate default fate points if missing (should have been set by load_character_data)</span></tt>
            </div>
            <div id="l1147"
               class="code sev- "><tt><i>1147</i>         <span class="k">if</span> <span class="s1">&#39;fate_points&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_data</span><span class="p">:</span></tt>
            </div>
            <div id="l1148"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1148</i>             <span class="n">race_mod</span> <span class="o">=</span> <span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_point_mod&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l1149"
               class="code sev- "><tt><i>1149</i>             <span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;fate_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_FATE_POINTS</span> <span class="o">+</span> <span class="n">race_mod</span></tt>
            </div>
            <div id="l1150"
               class="code sev- "><tt><i>1150</i> &nbsp;</tt>
            </div>
            <div id="l1151"
               class="code sev- "><tt><i>1151</i>         <span class="c1"># Save the cleaned data using merge=True for safety</span></tt>
            </div>
            <div id="l1152"
               class="code sev- "><tt><i>1152</i>         <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;characters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1153"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1153</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved character document </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1154"
               class="code sev- "><tt><i>1154</i>         <span class="k">return</span> <span class="n">doc_id</span></tt>
            </div>
            <div id="l1155"
               class="code sev- "><tt><i>1155</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1156"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1156</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save character </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1157"
               class="code sev- "><tt><i>1157</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;A critical error occurred while saving your progress.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1158"
               class="code sev- "><tt><i>1158</i>         <span class="k">return</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1159"
               class="code sev- "><tt><i>1159</i> &nbsp;</tt>
            </div>
            <div id="l1160"
               class="code sev- "><tt><i>1160</i> <span class="c1"># --- Premium Access Check ---</span></tt>
            </div>
            <div id="l1161"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>1161</i> <span class="k">def</span><span class="w"> </span><span class="nf">check_premium_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span></tt>
            </div>
            <div id="l1162"
               class="code sev- "><tt><i>1162</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the user has premium access via their profile.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1163"
               class="code sev- "><tt><i>1163</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l1164"
               class="code sev- "><tt><i>1164</i>         <span class="k">return</span> <span class="kc">False</span></tt>
            </div>
            <div id="l1165"
               class="code sev- "><tt><i>1165</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1166"
               class="code sev- "><tt><i>1166</i>         <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1167"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1167</i>         <span class="n">profile_doc</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;has_premium&#39;</span><span class="p">])</span> <span class="c1"># Only fetch necessary field</span></tt>
            </div>
            <div id="l1168"
               class="code sev- "><tt><i>1168</i>         <span class="k">if</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l1169"
               class="code sev- "><tt><i>1169</i>             <span class="k">return</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_premium&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l1170"
               class="code sev- "><tt><i>1170</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1171"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1171</i>             <span class="k">return</span> <span class="kc">False</span> <span class="c1"># Default to False if profile doesn&#39;t exist or lacks field</span></tt>
            </div>
            <div id="l1172"
               class="code sev- "><tt><i>1172</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1173"
               class="code sev- "><tt><i>1173</i>         <span class="c1"># Log error but default to False to prevent accidental premium access</span></tt>
            </div>
            <div id="l1174"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1174</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during premium access check for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1175"
               class="code sev- "><tt><i>1175</i>         <span class="k">return</span> <span class="kc">False</span></tt>
            </div>
            <div id="l1176"
               class="code sev- "><tt><i>1176</i> &nbsp;</tt>
            </div>
            <div id="l1177"
               class="code sev- "><tt><i>1177</i> <span class="c1"># --- Login Decorator ---</span></tt>
            </div>
            <div id="l1178"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>1178</i> <span class="k">def</span><span class="w"> </span><span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span></tt>
            </div>
            <div id="l1179"
               class="code sev- "><tt><i>1179</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to ensure user is logged in before accessing a route.&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1180"
               class="code sev- "><tt><i>1180</i>     <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></tt>
            </div>
            <div id="l1181"
               class="code sev- "><tt><i>1181</i>     <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></tt>
            </div>
            <div id="l1182"
               class="code sev- "><tt><i>1182</i>         <span class="k">if</span> <span class="n">SESSION_USER_ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span></tt>
            </div>
            <div id="l1183"
               class="code sev- "><tt><i>1183</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;You must be logged in to access this page.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1184"
               class="code sev- "><tt><i>1184</i>             <span class="c1"># Store the intended URL to redirect after login</span></tt>
            </div>
            <div id="l1185"
               class="code sev- "><tt><i>1185</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span></tt>
            </div>
            <div id="l1186"
               class="code sev- "><tt><i>1186</i>         <span class="c1"># User is logged in, proceed with the original function</span></tt>
            </div>
            <div id="l1187"
               class="code sev- "><tt><i>1187</i>         <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></tt>
            </div>
            <div id="l1188"
               class="code sev- "><tt><i>1188</i>     <span class="k">return</span> <span class="n">decorated_function</span></tt>
            </div>
            <div id="l1189"
               class="code sev- "><tt><i>1189</i> &nbsp;</tt>
            </div>
            <div id="l1190"
               class="code sev- "><tt><i>1190</i> &nbsp;</tt>
            </div>
            <div id="l1191"
               class="code sev- "><tt><i>1191</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1192"
               class="code sev- "><tt><i>1192</i> <span class="c1"># Quest Step Completion Logic Helper</span></tt>
            </div>
            <div id="l1193"
               class="code sev- "><tt><i>1193</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1194"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1194</i> <span class="k">def</span><span class="w"> </span><span class="nf">check_step_completion</span><span class="p">(</span><span class="n">p_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span></tt>
            </div>
            <div id="l1195"
               class="code sev- "><tt><i>1195</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1196"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>1196</i> <span class="sd">    Checks if the conditions for completing the current quest step are met based</span></tt>
            </div>
            <div id="l1197"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>1197</i> <span class="sd">    on player data (quest flags, inventory) or signals if an AI check is required.</span></tt>
            </div>
            <div id="l1198"
               class="code sev- "><tt><i>1198</i> &nbsp;</tt>
            </div>
            <div id="l1199"
               class="code sev- "><tt><i>1199</i> <span class="sd">    Returns a tuple: (completion_status: bool, ai_check_criteria: str | None)</span></tt>
            </div>
            <div id="l1200"
               class="code sev- "><tt><i>1200</i> <span class="sd">    ai_check_criteria is populated ONLY if the trigger is &#39;ai_check&#39;.</span></tt>
            </div>
            <div id="l1201"
               class="code sev- "><tt><i>1201</i> <span class="sd">    &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1202"
               class="code sev- "><tt><i>1202</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">step_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l1203"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1203</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;check_step_completion called with missing step_data or p_data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1204"
               class="code sev- "><tt><i>1204</i>         <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1205"
               class="code sev- "><tt><i>1205</i> &nbsp;</tt>
            </div>
            <div id="l1206"
               class="code sev- "><tt><i>1206</i>     <span class="n">trigger</span> <span class="o">=</span> <span class="n">step_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trigger_condition&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1207"
               class="code sev- "><tt><i>1207</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">trigger</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l1208"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

               </ul><tt><i>1208</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> is missing a valid trigger condition string.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1209"
               class="code sev- "><tt><i>1209</i>         <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1210"
               class="code sev- "><tt><i>1210</i> &nbsp;</tt>
            </div>
            <div id="l1211"
               class="code sev- "><tt><i>1211</i>     <span class="c1"># Use regex for more robust parsing, allowing optional spaces</span></tt>
            </div>
            <div id="l1212"
               class="code sev- "><tt><i>1212</i>     <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(\w+)\s*:\s*(.*)$&#39;</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span></tt>
            </div>
            <div id="l1213"
               class="code sev- "><tt><i>1213</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span></tt>
            </div>
            <div id="l1214"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1214</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid trigger format: &#39;</span><span class="si">{</span><span class="n">trigger</span><span class="si">}</span><span class="s2">&#39;. Expected &#39;type:condition&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1215"
               class="code sev- "><tt><i>1215</i>         <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1216"
               class="code sev- "><tt><i>1216</i> &nbsp;</tt>
            </div>
            <div id="l1217"
               class="code sev- "><tt><i>1217</i>     <span class="n">trigger_type</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></tt>
            </div>
            <div id="l1218"
               class="code sev- "><tt><i>1218</i>     <span class="n">condition</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l1219"
               class="code sev- "><tt><i>1219</i> &nbsp;</tt>
            </div>
            <div id="l1220"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (131 > 79 characters)</li>

               </ul><tt><i>1220</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking trigger: type=&#39;</span><span class="si">{</span><span class="n">trigger_type</span><span class="si">}</span><span class="s2">&#39;, condition=&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">&#39; for step </span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1221"
               class="code sev- "><tt><i>1221</i> &nbsp;</tt>
            </div>
            <div id="l1222"
               class="code sev- "><tt><i>1222</i>     <span class="c1"># --- State Variable Check ---</span></tt>
            </div>
            <div id="l1223"
               class="code sev- "><tt><i>1223</i>     <span class="k">if</span> <span class="n">trigger_type</span> <span class="o">==</span> <span class="s2">&quot;state_var&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1224"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>1224</i>         <span class="c1"># Expects format &quot;flag_name == True&quot; or &quot;flag_name == False&quot; (case-insensitive for True/False)</span></tt>
            </div>
            <div id="l1225"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1225</i>         <span class="n">state_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*([\w_]+)\s*==\s*(True|False)\s*$&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span></tt>
            </div>
            <div id="l1226"
               class="code sev- "><tt><i>1226</i>         <span class="k">if</span> <span class="n">state_match</span><span class="p">:</span></tt>
            </div>
            <div id="l1227"
               class="code sev- "><tt><i>1227</i>             <span class="n">flag_name</span> <span class="o">=</span> <span class="n">state_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l1228"
               class="code sev- "><tt><i>1228</i>             <span class="n">expected_value_str</span> <span class="o">=</span> <span class="n">state_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></tt>
            </div>
            <div id="l1229"
               class="code sev- "><tt><i>1229</i>             <span class="n">expected_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_value_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1230"
               class="code sev- "><tt><i>1230</i> &nbsp;</tt>
            </div>
            <div id="l1231"
               class="code sev- "><tt><i>1231</i>             <span class="n">quest_flags</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l1232"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>1232</i>             <span class="n">actual_value</span> <span class="o">=</span> <span class="n">quest_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># Default to False if flag not set</span></tt>
            </div>
            <div id="l1233"
               class="code sev- "><tt><i>1233</i> &nbsp;</tt>
            </div>
            <div id="l1234"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>1234</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State var check: Flag &#39;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">&#39;, Expected: </span><span class="si">{</span><span class="n">expected_value</span><span class="si">}</span><span class="s2">, Actual: </span><span class="si">{</span><span class="n">actual_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1235"
               class="code sev- "><tt><i>1235</i>             <span class="n">is_complete</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_value</span> <span class="o">==</span> <span class="n">expected_value</span><span class="p">)</span></tt>
            </div>
            <div id="l1236"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1236</i>             <span class="k">return</span> <span class="n">is_complete</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># No AI check needed</span></tt>
            </div>
            <div id="l1237"
               class="code sev- "><tt><i>1237</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1238"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (132 > 79 characters)</li>

               </ul><tt><i>1238</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid state_var trigger format: &#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">&#39;. Expected &#39;flag_name == True&#39; or &#39;flag_name == False&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1239"
               class="code sev- "><tt><i>1239</i>             <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1240"
               class="code sev- "><tt><i>1240</i> &nbsp;</tt>
            </div>
            <div id="l1241"
               class="code sev- "><tt><i>1241</i>     <span class="c1"># --- Inventory Check ---</span></tt>
            </div>
            <div id="l1242"
               class="code sev- "><tt><i>1242</i>     <span class="k">elif</span> <span class="n">trigger_type</span> <span class="o">==</span> <span class="s2">&quot;inventory_has&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1243"
               class="code sev- "><tt><i>1243</i>         <span class="c1"># Expects format &quot;item1 and item2 and ...&quot; (case-sensitive item names)</span></tt>
            </div>
            <div id="l1244"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>1244</i>         <span class="n">required_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span></tt>
            </div>
            <div id="l1245"
               class="code sev- "><tt><i>1245</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">required_items</span><span class="p">:</span></tt>
            </div>
            <div id="l1246"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1246</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid inventory_has trigger: No items specified in &#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1247"
               class="code sev- "><tt><i>1247</i>             <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1248"
               class="code sev- "><tt><i>1248</i> &nbsp;</tt>
            </div>
            <div id="l1249"
               class="code sev- "><tt><i>1249</i>         <span class="c1"># Ensure inventory is a list (or set for efficiency if large)</span></tt>
            </div>
            <div id="l1250"
               class="code sev- "><tt><i>1250</i>         <span class="n">inventory</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1251"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1251</i>         <span class="n">inventory_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span></tt>
            </div>
            <div id="l1252"
               class="code sev- "><tt><i>1252</i> &nbsp;</tt>
            </div>
            <div id="l1253"
               class="code sev- "><tt><i>1253</i>         <span class="n">all_items_present</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1254"
               class="code sev- "><tt><i>1254</i>         <span class="n">missing_items</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1255"
               class="code sev- "><tt><i>1255</i>         <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">required_items</span><span class="p">:</span></tt>
            </div>
            <div id="l1256"
               class="code sev- "><tt><i>1256</i>             <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inventory_set</span><span class="p">:</span></tt>
            </div>
            <div id="l1257"
               class="code sev- "><tt><i>1257</i>                 <span class="n">all_items_present</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l1258"
               class="code sev- "><tt><i>1258</i>                 <span class="n">missing_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></tt>
            </div>
            <div id="l1259"
               class="code sev- "><tt><i>1259</i> &nbsp;</tt>
            </div>
            <div id="l1260"
               class="code sev- "><tt><i>1260</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">all_items_present</span><span class="p">:</span></tt>
            </div>
            <div id="l1261"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (141 > 79 characters)</li>

               </ul><tt><i>1261</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inventory check failed: Missing item(s) </span><span class="si">{</span><span class="n">missing_items</span><span class="si">}</span><span class="s2">. Required: </span><span class="si">{</span><span class="n">required_items</span><span class="si">}</span><span class="s2">, Has: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">inventory_set</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1262"
               class="code sev- "><tt><i>1262</i> &nbsp;</tt>
            </div>
            <div id="l1263"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1263</i>         <span class="k">return</span> <span class="n">all_items_present</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># No AI check needed</span></tt>
            </div>
            <div id="l1264"
               class="code sev- "><tt><i>1264</i> &nbsp;</tt>
            </div>
            <div id="l1265"
               class="code sev- "><tt><i>1265</i>     <span class="c1"># --- AI Check Preparation ---</span></tt>
            </div>
            <div id="l1266"
               class="code sev- "><tt><i>1266</i>     <span class="k">elif</span> <span class="n">trigger_type</span> <span class="o">==</span> <span class="s2">&quot;ai_check&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1267"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1267</i>         <span class="c1"># Return False for completion status *for now*, but provide the criteria string</span></tt>
            </div>
            <div id="l1268"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1268</i>         <span class="c1"># The game loop will perform the check based on the player&#39;s action this turn.</span></tt>
            </div>
            <div id="l1269"
               class="code sev- "><tt><i>1269</i>         <span class="n">ai_check_criteria</span> <span class="o">=</span> <span class="n">condition</span></tt>
            </div>
            <div id="l1270"
               class="code sev- "><tt><i>1270</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">ai_check_criteria</span><span class="p">:</span></tt>
            </div>
            <div id="l1271"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (125 > 79 characters)</li>

               </ul><tt><i>1271</i>              <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Check trigger found for step </span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> but condition is empty.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1272"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1272</i>              <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># Treat as invalid trigger</span></tt>
            </div>
            <div id="l1273"
               class="code sev- "><tt><i>1273</i> &nbsp;</tt>
            </div>
            <div id="l1274"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>1274</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Check trigger identified. Criteria: &#39;</span><span class="si">{</span><span class="n">ai_check_criteria</span><span class="si">}</span><span class="s2">&#39;. Evaluation required in game loop.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1275"
               class="code sev- "><tt><i>1275</i>         <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ai_check_criteria</span></tt>
            </div>
            <div id="l1276"
               class="code sev- "><tt><i>1276</i> &nbsp;</tt>
            </div>
            <div id="l1277"
               class="code sev- "><tt><i>1277</i>     <span class="c1"># --- Unknown Trigger Type ---</span></tt>
            </div>
            <div id="l1278"
               class="code sev- "><tt><i>1278</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1279"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1279</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown trigger condition type: &#39;</span><span class="si">{</span><span class="n">trigger_type</span><span class="si">}</span><span class="s2">&#39; in trigger &#39;</span><span class="si">{</span><span class="n">trigger</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1280"
               class="code sev- "><tt><i>1280</i>         <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1281"
               class="code sev- "><tt><i>1281</i> &nbsp;</tt>
            </div>
            <div id="l1282"
               class="code sev- "><tt><i>1282</i> &nbsp;</tt>
            </div>
            <div id="l1283"
               class="code sev- "><tt><i>1283</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1284"
               class="code sev- "><tt><i>1284</i> <span class="c1"># Reward Handling Helper</span></tt>
            </div>
            <div id="l1285"
               class="code sev- "><tt><i>1285</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1286"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1286</i> <span class="k">def</span><span class="w"> </span><span class="nf">apply_reward</span><span class="p">(</span><span class="n">p_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">reward_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l1287"
               class="code sev- "><tt><i>1287</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1288"
               class="code sev- "><tt><i>1288</i> <span class="sd">    Applies a step or quest reward to the player data (p_data dictionary).</span></tt>
            </div>
            <div id="l1289"
               class="code sev- "><tt><i>1289</i> <span class="sd">    Handles rewards like: fate_points, info/set_flag, item, relationship.</span></tt>
            </div>
            <div id="l1290"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>1290</i> <span class="sd">    Returns announcement text (str) or None if silent/invalid. Modifies p_data directly.</span></tt>
            </div>
            <div id="l1291"
               class="code sev- "><tt><i>1291</i> <span class="sd">    &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l1292"
               class="code sev- "><tt><i>1292</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">reward_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reward_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l1293"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1293</i>         <span class="k">return</span> <span class="kc">None</span> <span class="c1"># No reward data or player data provided</span></tt>
            </div>
            <div id="l1294"
               class="code sev- "><tt><i>1294</i> &nbsp;</tt>
            </div>
            <div id="l1295"
               class="code sev- "><tt><i>1295</i>     <span class="n">reward_type</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1296"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1296</i>     <span class="n">value</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="c1"># Used by fate_points</span></tt>
            </div>
            <div id="l1297"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1297</i>     <span class="n">details</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">)</span> <span class="c1"># Used by info/relationship</span></tt>
            </div>
            <div id="l1298"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1298</i>     <span class="n">name</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="c1"># Used by item</span></tt>
            </div>
            <div id="l1299"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1299</i>     <span class="n">target</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="c1"># Used by relationship</span></tt>
            </div>
            <div id="l1300"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1300</i>     <span class="n">change</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">)</span> <span class="c1"># Used by relationship</span></tt>
            </div>
            <div id="l1301"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1301</i>     <span class="n">flag_to_set_data</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;set_flag&quot;</span><span class="p">)</span> <span class="c1"># Used by info</span></tt>
            </div>
            <div id="l1302"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1302</i>     <span class="n">silent</span> <span class="o">=</span> <span class="n">reward_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;silent&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># Check if reward announcement should be suppressed</span></tt>
            </div>
            <div id="l1303"
               class="code sev- "><tt><i>1303</i> &nbsp;</tt>
            </div>
            <div id="l1304"
               class="code sev- "><tt><i>1304</i>     <span class="n">announcement</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l1305"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1305</i>     <span class="n">char_id_log</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="c1"># For logging</span></tt>
            </div>
            <div id="l1306"
               class="code sev- "><tt><i>1306</i> &nbsp;</tt>
            </div>
            <div id="l1307"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1307</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying reward: </span><span class="si">{</span><span class="n">reward_data</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id_log</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1308"
               class="code sev- "><tt><i>1308</i> &nbsp;</tt>
            </div>
            <div id="l1309"
               class="code sev- "><tt><i>1309</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1310"
               class="code sev- "><tt><i>1310</i>         <span class="k">if</span> <span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;fate_points&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1311"
               class="code sev- "><tt><i>1311</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1312"
               class="code sev- "><tt><i>1312</i>                 <span class="n">fp_change</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></tt>
            </div>
            <div id="l1313"
               class="code sev- "><tt><i>1313</i>                 <span class="k">if</span> <span class="n">fp_change</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span></tt>
            </div>
            <div id="l1314"
               class="code sev- "><tt><i>1314</i>                     <span class="n">current_fp</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fate_points&quot;</span><span class="p">,</span> <span class="n">BASE_FATE_POINTS</span><span class="p">)</span></tt>
            </div>
            <div id="l1315"
               class="code sev- "><tt><i>1315</i>                     <span class="c1"># Ensure current value is numeric before adding</span></tt>
            </div>
            <div id="l1316"
               class="code sev- "><tt><i>1316</i>                     <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_fp</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span></tt>
            </div>
            <div id="l1317"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (165 > 79 characters)</li>

               </ul><tt><i>1317</i>                          <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Character </span><span class="si">{</span><span class="n">char_id_log</span><span class="si">}</span><span class="s2"> fate_points field is not numeric (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">current_fp</span><span class="p">)</span><span class="si">}</span><span class="s2">). Resetting to base before applying change.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1318"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1318</i>                          <span class="n">current_fp</span> <span class="o">=</span> <span class="n">BASE_FATE_POINTS</span></tt>
            </div>
            <div id="l1319"
               class="code sev- "><tt><i>1319</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s2">&quot;fate_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_fp</span> <span class="o">+</span> <span class="n">fp_change</span></tt>
            </div>
            <div id="l1320"
               class="code sev- "><tt><i>1320</i>                     <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span></tt>
            </div>
            <div id="l1321"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (143 > 79 characters)</li>

               </ul><tt><i>1321</i>                         <span class="n">announcement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You gain </span><span class="si">{</span><span class="n">fp_change</span><span class="si">}</span><span class="s2"> Fate Point(s).&quot;</span> <span class="k">if</span> <span class="n">fp_change</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;You lose </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">fp_change</span><span class="p">)</span><span class="si">}</span><span class="s2"> Fate Point(s).&quot;</span></tt>
            </div>
            <div id="l1322"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>1322</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Applied </span><span class="si">{</span><span class="n">fp_change</span><span class="si">}</span><span class="s2"> Fate Points reward. New total: </span><span class="si">{</span><span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;fate_points&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1323"
               class="code sev- "><tt><i>1323</i>             <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span></tt>
            </div>
            <div id="l1324"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1324</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Invalid &#39;value&#39; for fate_points reward: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1325"
               class="code sev- "><tt><i>1325</i> &nbsp;</tt>
            </div>
            <div id="l1326"
               class="code sev- "><tt><i>1326</i>         <span class="k">elif</span> <span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1327"
               class="code sev- "><tt><i>1327</i>             <span class="c1"># Primarily used for setting flags, but can have announcement text</span></tt>
            </div>
            <div id="l1328"
               class="code sev- "><tt><i>1328</i>             <span class="k">if</span> <span class="n">details</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span></tt>
            </div>
            <div id="l1329"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1329</i>                 <span class="n">announcement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Info: </span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Use details as the announcement</span></tt>
            </div>
            <div id="l1330"
               class="code sev- "><tt><i>1330</i> &nbsp;</tt>
            </div>
            <div id="l1331"
               class="code sev- "><tt><i>1331</i>             <span class="c1"># Handle setting quest flags via &#39;set_flag&#39; sub-dictionary</span></tt>
            </div>
            <div id="l1332"
               class="code sev- "><tt><i>1332</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_to_set_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span></tt>
            </div>
            <div id="l1333"
               class="code sev- "><tt><i>1333</i>                 <span class="c1"># Ensure quest_flags dictionary exists</span></tt>
            </div>
            <div id="l1334"
               class="code sev- "><tt><i>1334</i>                 <span class="n">quest_flags</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l1335"
               class="code sev- "><tt><i>1335</i>                 <span class="k">for</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">flag_value</span> <span class="ow">in</span> <span class="n">flag_to_set_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l1336"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1336</i>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag_value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span></tt>
            </div>
            <div id="l1337"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1337</i>                          <span class="n">quest_flags</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag_value</span> <span class="c1"># Set the flag</span></tt>
            </div>
            <div id="l1338"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (107 > 79 characters)</li>

               </ul><tt><i>1338</i>                          <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Set quest flag &#39;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">flag_value</span><span class="si">}</span><span class="s2">&#39; via info reward.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1339"
               class="code sev- "><tt><i>1339</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1340"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (186 > 79 characters)</li>

               </ul><tt><i>1340</i>                          <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Invalid flag name (&#39;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">&#39;) or value (&#39;</span><span class="si">{</span><span class="n">flag_value</span><span class="si">}</span><span class="s2">&#39;) in &#39;set_flag&#39; for info reward. Flag name must be string, value must be boolean.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1341"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1341</i>             <span class="k">elif</span> <span class="n">flag_to_set_data</span><span class="p">:</span> <span class="c1"># Log warning if format is wrong but it exists</span></tt>
            </div>
            <div id="l1342"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (151 > 79 characters)</li>

               </ul><tt><i>1342</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Invalid &#39;set_flag&#39; format in info reward: </span><span class="si">{</span><span class="n">flag_to_set_data</span><span class="si">}</span><span class="s2">. Expected a dictionary </span><span class="se">{{</span><span class="s2">&#39;flag_name&#39;: True/False</span><span class="se">}}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1343"
               class="code sev- "><tt><i>1343</i> &nbsp;</tt>
            </div>
            <div id="l1344"
               class="code sev- "><tt><i>1344</i>         <span class="k">elif</span> <span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1345"
               class="code sev- "><tt><i>1345</i>             <span class="c1"># Adds item name to inventory list</span></tt>
            </div>
            <div id="l1346"
               class="code sev- "><tt><i>1346</i>             <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l1347"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>1347</i>                  <span class="c1"># Ensure inventory list exists and append item</span></tt>
            </div>
            <div id="l1348"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>1348</i>                  <span class="n">inventory_list</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1349"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1349</i>                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inventory_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span></tt>
            </div>
            <div id="l1350"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1350</i>                      <span class="n">inventory_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l1351"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1351</i>                      <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span></tt>
            </div>
            <div id="l1352"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1352</i>                          <span class="n">announcement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You obtained: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span></tt>
            </div>
            <div id="l1353"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1353</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added item &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to inventory.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1354"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1354</i>                  <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1355"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>1355</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Character </span><span class="si">{</span><span class="n">char_id_log</span><span class="si">}</span><span class="s2"> inventory field is not a list. Cannot add item &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1356"
               class="code sev- "><tt><i>1356</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1357"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>1357</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Item reward specified but &#39;name&#39; is missing or not a string: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1358"
               class="code sev- "><tt><i>1358</i> &nbsp;</tt>
            </div>
            <div id="l1359"
               class="code sev- "><tt><i>1359</i>         <span class="k">elif</span> <span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;relationship&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l1360"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>1360</i>              <span class="c1"># Example: Store relationship points in FS_QUEST_FLAGS</span></tt>
            </div>
            <div id="l1361"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>1361</i>              <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l1362"
               class="code sev- "><tt><i>1362</i>                 <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1363"
               class="code sev- "><tt><i>1363</i>                     <span class="n">rel_change</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">change</span><span class="p">)</span></tt>
            </div>
            <div id="l1364"
               class="code sev- "><tt><i>1364</i>                     <span class="k">if</span> <span class="n">rel_change</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span></tt>
            </div>
            <div id="l1365"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1365</i>                         <span class="n">flag_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;relationship_</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Create a unique, clean flag name</span></tt>
            </div>
            <div id="l1366"
               class="code sev- "><tt><i>1366</i>                         <span class="n">quest_flags</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l1367"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1367</i>                         <span class="n">current_value</span> <span class="o">=</span> <span class="n">quest_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Default to 0</span></tt>
            </div>
            <div id="l1368"
               class="code sev- "><tt><i>1368</i>                         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span></tt>
            </div>
            <div id="l1369"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (167 > 79 characters)</li>

               </ul><tt><i>1369</i>                             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Relationship flag &#39;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">&#39; has non-numeric value (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">current_value</span><span class="p">)</span><span class="si">}</span><span class="s2">). Resetting to 0 before applying change.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1370"
               class="code sev- "><tt><i>1370</i>                             <span class="n">current_value</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l1371"
               class="code sev- "><tt><i>1371</i>                         <span class="n">new_value</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">+</span> <span class="n">rel_change</span></tt>
            </div>
            <div id="l1372"
               class="code sev- "><tt><i>1372</i>                         <span class="n">quest_flags</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span></tt>
            </div>
            <div id="l1373"
               class="code sev- "><tt><i>1373</i>                         <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span></tt>
            </div>
            <div id="l1374"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (127 > 79 characters)</li>

               </ul><tt><i>1374</i>                             <span class="n">announcement</span> <span class="o">=</span> <span class="n">details</span> <span class="k">if</span> <span class="n">details</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Your relationship with </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> changed (</span><span class="si">{</span><span class="n">rel_change</span><span class="si">:</span><span class="s2">+</span><span class="si">}</span><span class="s2">).&quot;</span></tt>
            </div>
            <div id="l1375"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (145 > 79 characters)</li>

               </ul><tt><i>1375</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Applied relationship change for &#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39; by </span><span class="si">{</span><span class="n">rel_change</span><span class="si">}</span><span class="s2">. New value: </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2"> (Flag: </span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1376"
               class="code sev- "><tt><i>1376</i>                 <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span></tt>
            </div>
            <div id="l1377"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1377</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Invalid &#39;change&#39; value for relationship reward: </span><span class="si">{</span><span class="n">change</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1378"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1378</i>              <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1379"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>1379</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Relationship reward specified but &#39;target&#39; is missing or not a string: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1380"
               class="code sev- "><tt><i>1380</i> &nbsp;</tt>
            </div>
            <div id="l1381"
               class="code sev- "><tt><i>1381</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1382"
               class="code sev- "><tt><i>1382</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown or invalid reward type &#39;</span><span class="si">{</span><span class="n">reward_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1383"
               class="code sev- "><tt><i>1383</i> &nbsp;</tt>
            </div>
            <div id="l1384"
               class="code sev- "><tt><i>1384</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1385"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>1385</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying reward </span><span class="si">{</span><span class="n">reward_data</span><span class="si">}</span><span class="s2"> for char </span><span class="si">{</span><span class="n">char_id_log</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1386"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>1386</i>         <span class="n">announcement</span> <span class="o">=</span> <span class="s2">&quot;An error occurred while processing a reward.&quot;</span> <span class="c1"># Generic error for user</span></tt>
            </div>
            <div id="l1387"
               class="code sev- "><tt><i>1387</i> &nbsp;</tt>
            </div>
            <div id="l1388"
               class="code sev- "><tt><i>1388</i>     <span class="k">return</span> <span class="n">announcement</span></tt>
            </div>
            <div id="l1389"
               class="code sev- "><tt><i>1389</i> &nbsp;</tt>
            </div>
            <div id="l1390"
               class="code sev- "><tt><i>1390</i> &nbsp;</tt>
            </div>
            <div id="l1391"
               class="code sev- "><tt><i>1391</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1392"
               class="code sev- "><tt><i>1392</i> <span class="c1"># Flask Routes</span></tt>
            </div>
            <div id="l1393"
               class="code sev- "><tt><i>1393</i> <span class="c1"># ==============================================================================</span></tt>
            </div>
            <div id="l1394"
               class="code sev- "><tt><i>1394</i> &nbsp;</tt>
            </div>
            <div id="l1395"
               class="code sev- "><tt><i>1395</i> <span class="c1"># --- Auth Routes ---</span></tt>
            </div>
            <div id="l1396"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1396</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1397"
               class="code sev- "><tt><i>1397</i> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span></tt>
            </div>
            <div id="l1398"
               class="code sev- "><tt><i>1398</i>     <span class="c1"># Redirect if user is already logged in</span></tt>
            </div>
            <div id="l1399"
               class="code sev- "><tt><i>1399</i>     <span class="k">if</span> <span class="n">SESSION_USER_ID</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span></tt>
            </div>
            <div id="l1400"
               class="code sev- "><tt><i>1400</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1401"
               class="code sev- "><tt><i>1401</i> &nbsp;</tt>
            </div>
            <div id="l1402"
               class="code sev- "><tt><i>1402</i>     <span class="c1"># Handle POST request (form submission)</span></tt>
            </div>
            <div id="l1403"
               class="code sev- "><tt><i>1403</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1404"
               class="code sev- "><tt><i>1404</i>         <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1405"
               class="code sev- "><tt><i>1405</i>         <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1406"
               class="code sev- "><tt><i>1406</i>         <span class="c1"># Basic validation</span></tt>
            </div>
            <div id="l1407"
               class="code sev- "><tt><i>1407</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span></tt>
            </div>
            <div id="l1408"
               class="code sev- "><tt><i>1408</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Please enter both email and password.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1409"
               class="code sev- "><tt><i>1409</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1410"
               class="code sev- "><tt><i>1410</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1411"
               class="code sev- "><tt><i>1411</i>             <span class="c1"># --- Secure Login Check ---</span></tt>
            </div>
            <div id="l1412"
               class="code sev- "><tt><i>1412</i>             <span class="c1"># This now attempts to verify the user by getting their record.</span></tt>
            </div>
            <div id="l1413"
               class="code sev- "><tt><i>1413</i>             <span class="c1"># For a real-world app, you would use a client-side SDK to sign in</span></tt>
            </div>
            <div id="l1414"
               class="code sev- "><tt><i>1414</i>             <span class="c1"># and send the ID token to the server to be verified.</span></tt>
            </div>
            <div id="l1415"
               class="code sev- "><tt><i>1415</i>             <span class="c1"># This server-side email check is a basic verification step.</span></tt>
            </div>
            <div id="l1416"
               class="code sev- "><tt><i>1416</i>             <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">firebase_app</span><span class="p">)</span></tt>
            </div>
            <div id="l1417"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1417</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> found, proceeding with login for UID: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1418"
               class="code sev- "><tt><i>1418</i> &nbsp;</tt>
            </div>
            <div id="l1419"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>1419</i>             <span class="c1"># Since the Admin SDK can&#39;t directly verify passwords, this remains a placeholder</span></tt>
            </div>
            <div id="l1420"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1420</i>             <span class="c1"># for a more secure flow (e.g., using a client-side library to sign in and</span></tt>
            </div>
            <div id="l1421"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>1421</i>             <span class="c1"># then sending the token to the backend). The warning is updated to reflect this.</span></tt>
            </div>
            <div id="l1422"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (158 > 79 characters)</li>

               </ul><tt><i>1422</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SECURITY-NOTE: Password for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> is NOT verified by this backend logic. A secure frontend-to-backend auth flow is required.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1423"
               class="code sev- "><tt><i>1423</i> &nbsp;</tt>
            </div>
            <div id="l1424"
               class="code sev- "><tt><i>1424</i>             <span class="c1"># Store user info in session</span></tt>
            </div>
            <div id="l1425"
               class="code sev- "><tt><i>1425</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">uid</span></tt>
            </div>
            <div id="l1426"
               class="code sev- "><tt><i>1426</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_EMAIL</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span></tt>
            </div>
            <div id="l1427"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1427</i>             <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Make session persistent</span></tt>
            </div>
            <div id="l1428"
               class="code sev- "><tt><i>1428</i> &nbsp;</tt>
            </div>
            <div id="l1429"
               class="code sev- "><tt><i>1429</i>             <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Welcome back, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1430"
               class="code sev- "><tt><i>1430</i>             <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1431"
               class="code sev- "><tt><i>1431</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">next_url</span> <span class="ow">or</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1432"
               class="code sev- "><tt><i>1432</i>         <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">UserNotFoundError</span><span class="p">:</span></tt>
            </div>
            <div id="l1433"
               class="code sev- "><tt><i>1433</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Login failed: The email address was not found.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1434"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1434</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Login attempt failed for non-existent user: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1435"
               class="code sev- "><tt><i>1435</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1436"
               class="code sev- "><tt><i>1436</i>             <span class="c1"># This will catch other Firebase-related errors during user lookup</span></tt>
            </div>
            <div id="l1437"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1437</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An unexpected error occurred during login. Please try again.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1438"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>1438</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during login for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1439"
               class="code sev- "><tt><i>1439</i> &nbsp;</tt>
            </div>
            <div id="l1440"
               class="code sev- "><tt><i>1440</i>     <span class="c1"># Handle GET request (display login page)</span></tt>
            </div>
            <div id="l1441"
               class="code sev- "><tt><i>1441</i>     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1442"
               class="code sev- "><tt><i>1442</i> &nbsp;</tt>
            </div>
            <div id="l1443"
               class="code sev- "><tt><i>1443</i> &nbsp;</tt>
            </div>
            <div id="l1444"
               class="code sev- "><tt><i>1444</i> <span class="c1"># --- &lt;&lt;&lt; REVISED &gt;&gt;&gt; Auth Routes (Signup - Adds has_seen_intro) ---</span></tt>
            </div>
            <div id="l1445"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1445</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1446"
               class="code sev- "><tt><i>1446</i> <span class="k">def</span><span class="w"> </span><span class="nf">signup</span><span class="p">():</span></tt>
            </div>
            <div id="l1447"
               class="code sev- "><tt><i>1447</i>     <span class="c1"># Redirect if user is already logged in</span></tt>
            </div>
            <div id="l1448"
               class="code sev- "><tt><i>1448</i>     <span class="k">if</span> <span class="n">SESSION_USER_ID</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span></tt>
            </div>
            <div id="l1449"
               class="code sev- "><tt><i>1449</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1450"
               class="code sev- "><tt><i>1450</i> &nbsp;</tt>
            </div>
            <div id="l1451"
               class="code sev- "><tt><i>1451</i>     <span class="c1"># Handle POST request (form submission)</span></tt>
            </div>
            <div id="l1452"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>

               </ul><tt><i>1452</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1453"
               class="code sev- "><tt><i>1453</i>         <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1454"
               class="code sev- "><tt><i>1454</i>         <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1455"
               class="code sev- "><tt><i>1455</i>         <span class="c1"># Basic validation</span></tt>
            </div>
            <div id="l1456"
               class="code sev- "><tt><i>1456</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span></tt>
            </div>
            <div id="l1457"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1457</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Please provide a valid email and a password (at least 6 characters).&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1458"
               class="code sev- "><tt><i>1458</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;signup.html&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1459"
               class="code sev- "><tt><i>1459</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1460"
               class="code sev- "><tt><i>1460</i>             <span class="c1"># Create user in Firebase Authentication</span></tt>
            </div>
            <div id="l1461"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1461</i>             <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">firebase_app</span><span class="p">)</span></tt>
            </div>
            <div id="l1462"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1462</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New Firebase Auth user created: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1463"
               class="code sev- "><tt><i>1463</i> &nbsp;</tt>
            </div>
            <div id="l1464"
               class="code sev- "><tt><i>1464</i>             <span class="c1"># --- Create corresponding profile in Firestore ---</span></tt>
            </div>
            <div id="l1465"
               class="code sev- "><tt><i>1465</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1466"
               class="code sev- "><tt><i>1466</i>                 <span class="n">profile_data</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1467"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1467</i>                     <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="c1"># Store email for reference</span></tt>
            </div>
            <div id="l1468"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1468</i>                     <span class="s1">&#39;player_level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># Initial player level</span></tt>
            </div>
            <div id="l1469"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1469</i>                     <span class="s1">&#39;total_player_xp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># Initial player XP</span></tt>
            </div>
            <div id="l1470"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1470</i>                     <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">firestore</span><span class="o">.</span><span class="n">SERVER_TIMESTAMP</span><span class="p">,</span> <span class="c1"># Record creation time</span></tt>
            </div>
            <div id="l1471"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1471</i>                     <span class="s1">&#39;has_premium&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># Default to non-premium</span></tt>
            </div>
            <div id="l1472"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>1472</i>                     <span class="s1">&#39;vocab_settings&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="c1"># Default vocab setting</span></tt>
            </div>
            <div id="l1473"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>1473</i>                     <span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="p">:</span> <span class="kc">False</span>  <span class="c1"># &lt;&lt;&lt; REVISED: Set intro flag to False &gt;&gt;&gt;</span></tt>
            </div>
            <div id="l1474"
               class="code sev- "><tt><i>1474</i>                 <span class="p">}</span></tt>
            </div>
            <div id="l1475"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1475</i>                 <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">profile_data</span><span class="p">)</span></tt>
            </div>
            <div id="l1476"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>1476</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Firestore player profile created for </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="si">}</span><span class="s2"> (with </span><span class="si">{</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="si">}</span><span class="s2">=False)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1477"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1477</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account created successfully! Please log in.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1478"
               class="code sev- "><tt><i>1478</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1479"
               class="code sev- "><tt><i>1479</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">db_err</span><span class="p">:</span></tt>
            </div>
            <div id="l1480"
               class="code sev- "><tt><i>1480</i>                 <span class="c1"># Log error but allow user to proceed to login</span></tt>
            </div>
            <div id="l1481"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>1481</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create Firestore profile for new user </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">db_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1482"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (129 > 79 characters)</li>

               </ul><tt><i>1482</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Account created, but profile initialization failed. Please contact support if issues persist.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1483"
               class="code sev- "><tt><i>1483</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1484"
               class="code sev- "><tt><i>1484</i> &nbsp;</tt>
            </div>
            <div id="l1485"
               class="code sev- "><tt><i>1485</i>         <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">EmailAlreadyExistsError</span><span class="p">:</span></tt>
            </div>
            <div id="l1486"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1486</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Signup failed: This email address is already registered.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1487"
               class="code sev- "><tt><i>1487</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1488"
               class="code sev- "><tt><i>1488</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An unexpected error occurred during signup.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1489"
               class="code sev- "><tt><i>1489</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signup Error for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1490"
               class="code sev- "><tt><i>1490</i> &nbsp;</tt>
            </div>
            <div id="l1491"
               class="code sev- "><tt><i>1491</i>     <span class="c1"># Handle GET request (display signup page)</span></tt>
            </div>
            <div id="l1492"
               class="code sev- "><tt><i>1492</i>     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;signup.html&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1493"
               class="code sev- "><tt><i>1493</i> &nbsp;</tt>
            </div>
            <div id="l1494"
               class="code sev- "><tt><i>1494</i> &nbsp;</tt>
            </div>
            <div id="l1495"
               class="code sev- "><tt><i>1495</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1496"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1496</i> <span class="nd">@login_required</span> <span class="c1"># Ensure user must be logged in to log out</span></tt>
            </div>
            <div id="l1497"
               class="code sev- "><tt><i>1497</i> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span></tt>
            </div>
            <div id="l1498"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1498</i>     <span class="n">user_email</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_USER_EMAIL</span><span class="p">,</span><span class="s1">&#39;Unknown User&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1499"
               class="code sev- "><tt><i>1499</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_USER_ID</span><span class="p">)</span></tt>
            </div>
            <div id="l1500"
               class="code sev- "><tt><i>1500</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging out user </span><span class="si">{</span><span class="n">user_email</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1501"
               class="code sev- "><tt><i>1501</i>     <span class="c1"># Clear all relevant session keys</span></tt>
            </div>
            <div id="l1502"
               class="code sev- "><tt><i>1502</i>     <span class="n">keys_to_clear</span> <span class="o">=</span> <span class="p">[</span></tt>
            </div>
            <div id="l1503"
               class="code sev- "><tt><i>1503</i>         <span class="n">SESSION_USER_ID</span><span class="p">,</span> <span class="n">SESSION_USER_EMAIL</span><span class="p">,</span> <span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span></tt>
            </div>
            <div id="l1504"
               class="code sev- "><tt><i>1504</i>         <span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="n">SESSION_LOCATION</span><span class="p">,</span> <span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">,</span></tt>
            </div>
            <div id="l1505"
               class="code sev- "><tt><i>1505</i>         <span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">,</span> <span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span></tt>
            </div>
            <div id="l1506"
               class="code sev- "><tt><i>1506</i>         <span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span></tt>
            </div>
            <div id="l1507"
               class="code sev- "><tt><i>1507</i>         <span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span></tt>
            </div>
            <div id="l1508"
               class="code sev- "><tt><i>1508</i>         <span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_TURNS</span></tt>
            </div>
            <div id="l1509"
               class="code sev- "><tt><i>1509</i>     <span class="p">]</span></tt>
            </div>
            <div id="l1510"
               class="code sev- "><tt><i>1510</i>     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_clear</span><span class="p">:</span></tt>
            </div>
            <div id="l1511"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1511</i>         <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Use pop with default None to avoid errors if key missing</span></tt>
            </div>
            <div id="l1512"
               class="code sev- "><tt><i>1512</i>     <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;You have been successfully logged out.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1513"
               class="code sev- "><tt><i>1513</i>     <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1514"
               class="code sev- "><tt><i>1514</i> &nbsp;</tt>
            </div>
            <div id="l1515"
               class="code sev- "><tt><i>1515</i> &nbsp;</tt>
            </div>
            <div id="l1516"
               class="code sev- "><tt><i>1516</i> <span class="c1"># --- Profile Route ---</span></tt>
            </div>
            <div id="l1517"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1517</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1518"
               class="code sev- "><tt><i>1518</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l1519"
               class="code sev- "><tt><i>1519</i> <span class="k">def</span><span class="w"> </span><span class="nf">profile</span><span class="p">():</span></tt>
            </div>
            <div id="l1520"
               class="code sev- "><tt><i>1520</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l1521"
               class="code sev- "><tt><i>1521</i>     <span class="n">user_email</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_USER_EMAIL</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1522"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1522</i>     <span class="n">characters</span> <span class="o">=</span> <span class="n">get_user_characters</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="c1"># Fetch user&#39;s characters</span></tt>
            </div>
            <div id="l1523"
               class="code sev- "><tt><i>1523</i> &nbsp;</tt>
            </div>
            <div id="l1524"
               class="code sev- "><tt><i>1524</i>     <span class="c1"># --- POST Request Handling (Actions from profile page) ---</span></tt>
            </div>
            <div id="l1525"
               class="code sev- "><tt><i>1525</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1526"
               class="code sev- "><tt><i>1526</i>         <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1527"
               class="code sev- "><tt><i>1527</i> &nbsp;</tt>
            </div>
            <div id="l1528"
               class="code sev- "><tt><i>1528</i>         <span class="c1"># --- Load Character Action ---</span></tt>
            </div>
            <div id="l1529"
               class="code sev- "><tt><i>1529</i>         <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;load_char&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1530"
               class="code sev- "><tt><i>1530</i>             <span class="n">char_id_to_load</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;char_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1531"
               class="code sev- "><tt><i>1531</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id_to_load</span><span class="p">:</span></tt>
            </div>
            <div id="l1532"
               class="code sev- "><tt><i>1532</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No character selected to load.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1533"
               class="code sev- "><tt><i>1533</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1534"
               class="code sev- "><tt><i>1534</i> &nbsp;</tt>
            </div>
            <div id="l1535"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>1535</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempting to load character: </span><span class="si">{</span><span class="n">char_id_to_load</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1536"
               class="code sev- "><tt><i>1536</i>             <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">char_id_to_load</span><span class="p">)</span></tt>
            </div>
            <div id="l1537"
               class="code sev- "><tt><i>1537</i> &nbsp;</tt>
            </div>
            <div id="l1538"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1538</i>             <span class="k">if</span> <span class="n">p_data</span><span class="p">:</span> <span class="c1"># Successfully loaded</span></tt>
            </div>
            <div id="l1539"
               class="code sev- "><tt><i>1539</i>                 <span class="c1"># Clear previous character&#39;s temporary session data</span></tt>
            </div>
            <div id="l1540"
               class="code sev- "><tt><i>1540</i>                 <span class="n">keys_to_clear</span> <span class="o">=</span> <span class="p">[</span></tt>
            </div>
            <div id="l1541"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1541</i>                     <span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">,</span> <span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span></tt>
            </div>
            <div id="l1542"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>1542</i>                     <span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span></tt>
            </div>
            <div id="l1543"
               class="code sev- "><tt><i>1543</i>                     <span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span></tt>
            </div>
            <div id="l1544"
               class="code sev- "><tt><i>1544</i>                     <span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_TURNS</span></tt>
            </div>
            <div id="l1545"
               class="code sev- "><tt><i>1545</i>                 <span class="p">]</span></tt>
            </div>
            <div id="l1546"
               class="code sev- "><tt><i>1546</i>                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_to_clear</span><span class="p">:</span></tt>
            </div>
            <div id="l1547"
               class="code sev- "><tt><i>1547</i>                     <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1548"
               class="code sev- "><tt><i>1548</i> &nbsp;</tt>
            </div>
            <div id="l1549"
               class="code sev- "><tt><i>1549</i>                 <span class="c1"># Load new character data into session</span></tt>
            </div>
            <div id="l1550"
               class="code sev- "><tt><i>1550</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">char_id_to_load</span></tt>
            </div>
            <div id="l1551"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>1551</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_location&#39;</span><span class="p">,</span> <span class="n">STARTING_LOCATION</span><span class="p">)</span></tt>
            </div>
            <div id="l1552"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1552</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Load convo log</span></tt>
            </div>
            <div id="l1553"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1553</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Load chapter inputs</span></tt>
            </div>
            <div id="l1554"
               class="code sev- "><tt><i>1554</i>                 <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1555"
               class="code sev- "><tt><i>1555</i> &nbsp;</tt>
            </div>
            <div id="l1556"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>1556</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Character &#39;</span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; loaded successfully.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1557"
               class="code sev- "><tt><i>1557</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1558"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1558</i>             <span class="k">else</span><span class="p">:</span> <span class="c1"># Load failed (error flashed in load_character_data)</span></tt>
            </div>
            <div id="l1559"
               class="code sev- "><tt><i>1559</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1560"
               class="code sev- "><tt><i>1560</i> &nbsp;</tt>
            </div>
            <div id="l1561"
               class="code sev- "><tt><i>1561</i>         <span class="c1"># --- Custom Character Creation Initiation ---</span></tt>
            </div>
            <div id="l1562"
               class="code sev- "><tt><i>1562</i>         <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;create_char&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1563"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1563</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> initiating custom character creation.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1564"
               class="code sev- "><tt><i>1564</i>             <span class="c1"># Clear any leftover creation data from session</span></tt>
            </div>
            <div id="l1565"
               class="code sev- "><tt><i>1565</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1566"
               class="code sev- "><tt><i>1566</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1567"
               class="code sev- "><tt><i>1567</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1568"
               class="code sev- "><tt><i>1568</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1569"
               class="code sev- "><tt><i>1569</i> &nbsp;</tt>
            </div>
            <div id="l1570"
               class="code sev- "><tt><i>1570</i>         <span class="c1"># --- Load Pre-made Character Action ---</span></tt>
            </div>
            <div id="l1571"
               class="code sev- "><tt><i>1571</i>         <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;load_premade&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1572"
               class="code sev- "><tt><i>1572</i>             <span class="n">premade_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;premade_char_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1573"
               class="code sev- "><tt><i>1573</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">premade_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1574"
               class="code sev- "><tt><i>1574</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No pre-made character template selected.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1575"
               class="code sev- "><tt><i>1575</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1576"
               class="code sev- "><tt><i>1576</i> &nbsp;</tt>
            </div>
            <div id="l1577"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>1577</i>             <span class="n">template</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">premade_character_templates</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">premade_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1578"
               class="code sev- "><tt><i>1578</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span><span class="p">:</span></tt>
            </div>
            <div id="l1579"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>1579</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> selected invalid pre-made template ID: </span><span class="si">{</span><span class="n">premade_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1580"
               class="code sev- "><tt><i>1580</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Invalid pre-made character selection.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1581"
               class="code sev- "><tt><i>1581</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1582"
               class="code sev- "><tt><i>1582</i> &nbsp;</tt>
            </div>
            <div id="l1583"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (131 > 79 characters)</li>

               </ul><tt><i>1583</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> creating character from pre-made template: </span><span class="si">{</span><span class="n">premade_id</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1584"
               class="code sev- "><tt><i>1584</i> &nbsp;</tt>
            </div>
            <div id="l1585"
               class="code sev- "><tt><i>1585</i>             <span class="c1"># Create new character data structure</span></tt>
            </div>
            <div id="l1586"
               class="code sev- "><tt><i>1586</i>             <span class="n">new_char_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">premade_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l1587"
               class="code sev- "><tt><i>1587</i>             <span class="c1"># Start with template data and add default fields</span></tt>
            </div>
            <div id="l1588"
               class="code sev- "><tt><i>1588</i>             <span class="n">new_char_data</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1589"
               class="code sev- "><tt><i>1589</i>                 <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">new_char_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1590"
               class="code sev- "><tt><i>1590</i>                 <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1591"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1591</i>                 <span class="o">**</span><span class="n">template</span><span class="p">,</span> <span class="c1"># Unpack template data</span></tt>
            </div>
            <div id="l1592"
               class="code sev- "><tt><i>1592</i>                 <span class="s1">&#39;current_location&#39;</span><span class="p">:</span> <span class="n">STARTING_LOCATION</span><span class="p">,</span></tt>
            </div>
            <div id="l1593"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1593</i>                 <span class="s1">&#39;learned_vocab&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="c1"># Initialize as set</span></tt>
            </div>
            <div id="l1594"
               class="code sev- "><tt><i>1594</i>                 <span class="s1">&#39;report_summaries&#39;</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1595"
               class="code sev- "><tt><i>1595</i>                 <span class="s1">&#39;turn_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span></tt>
            </div>
            <div id="l1596"
               class="code sev- "><tt><i>1596</i>                 <span class="n">SESSION_EOC_PROMPTED</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span></tt>
            </div>
            <div id="l1597"
               class="code sev- "><tt><i>1597</i>                 <span class="n">FS_CONVERSATION</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1598"
               class="code sev- "><tt><i>1598</i>                 <span class="n">FS_CHAPTER_INPUTS</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1599"
               class="code sev- "><tt><i>1599</i>                 <span class="n">FS_QUEST_FLAGS</span><span class="p">:</span> <span class="p">{},</span></tt>
            </div>
            <div id="l1600"
               class="code sev- "><tt><i>1600</i>                 <span class="n">FS_INVENTORY</span><span class="p">:</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1601"
               class="code sev- "><tt><i>1601</i>             <span class="p">}</span></tt>
            </div>
            <div id="l1602"
               class="code sev- "><tt><i>1602</i> &nbsp;</tt>
            </div>
            <div id="l1603"
               class="code sev- "><tt><i>1603</i>             <span class="c1"># Ensure required fields are present after merging template</span></tt>
            </div>
            <div id="l1604"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1604</i>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">new_char_data</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">]):</span></tt>
            </div>
            <div id="l1605"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

               </ul><tt><i>1605</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-made template &#39;</span><span class="si">{</span><span class="n">premade_id</span><span class="si">}</span><span class="s2">&#39; is missing required Race/Class/Philosophy name.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1606"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>1606</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Selected pre-made character template is incomplete. Please contact support.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1607"
               class="code sev- "><tt><i>1607</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1608"
               class="code sev- "><tt><i>1608</i> &nbsp;</tt>
            </div>
            <div id="l1609"
               class="code sev- "><tt><i>1609</i>             <span class="c1"># Calculate derived fields (abilities, aspects, fate points)</span></tt>
            </div>
            <div id="l1610"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>1610</i>             <span class="n">race_abilities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;race_name&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,</span> <span class="p">[]))</span></tt>
            </div>
            <div id="l1611"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>1611</i>             <span class="n">class_ability</span> <span class="o">=</span> <span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1612"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1612</i>             <span class="n">phil_ability</span> <span class="o">=</span> <span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1613"
               class="code sev- "><tt><i>1613</i>             <span class="n">all_abilities</span> <span class="o">=</span> <span class="n">race_abilities</span></tt>
            </div>
            <div id="l1614"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

               </ul><tt><i>1614</i>             <span class="k">if</span> <span class="n">class_ability</span><span class="p">:</span> <span class="n">all_abilities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_ability</span><span class="p">)</span></tt>
            </div>
            <div id="l1615"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

               </ul><tt><i>1615</i>             <span class="k">if</span> <span class="n">phil_ability</span><span class="p">:</span> <span class="n">all_abilities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phil_ability</span><span class="p">)</span></tt>
            </div>
            <div id="l1616"
               class="code sev- "><tt><i>1616</i>             <span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;abilities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_abilities</span><span class="p">))</span></tt>
            </div>
            <div id="l1617"
               class="code sev- "><tt><i>1617</i> &nbsp;</tt>
            </div>
            <div id="l1618"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1618</i>             <span class="n">class_focus</span> <span class="o">=</span> <span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;focus&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1619"
               class="code sev- "><tt><i>1619</i>             <span class="n">aspects</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_focus</span><span class="p">]</span> <span class="k">if</span> <span class="n">class_focus</span> <span class="k">else</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1620"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1620</i>             <span class="k">if</span> <span class="s2">&quot;Artistic Shell&quot;</span> <span class="ow">in</span> <span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;abilities&#39;</span><span class="p">]:</span> <span class="n">aspects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Shell Design: Undefined&quot;</span><span class="p">)</span> <span class="c1"># Example aspect</span></tt>
            </div>
            <div id="l1621"
               class="code sev- "><tt><i>1621</i>             <span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;aspects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aspects</span></tt>
            </div>
            <div id="l1622"
               class="code sev- "><tt><i>1622</i> &nbsp;</tt>
            </div>
            <div id="l1623"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>1623</i>             <span class="n">race_mod</span> <span class="o">=</span> <span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;race_name&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_point_mod&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l1624"
               class="code sev- "><tt><i>1624</i>             <span class="n">new_char_data</span><span class="p">[</span><span class="s1">&#39;fate_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_FATE_POINTS</span> <span class="o">+</span> <span class="n">race_mod</span></tt>
            </div>
            <div id="l1625"
               class="code sev- "><tt><i>1625</i> &nbsp;</tt>
            </div>
            <div id="l1626"
               class="code sev- "><tt><i>1626</i>             <span class="c1"># Assign starting quest from template or default</span></tt>
            </div>
            <div id="l1627"
               class="code sev- "><tt><i>1627</i>             <span class="n">start_q_id</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starting_quest_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1628"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1628</i>             <span class="n">start_s_id</span><span class="p">,</span> <span class="n">start_s_desc</span><span class="p">,</span> <span class="n">start_q_title</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Begin your journey.&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting Quest&quot;</span></tt>
            </div>
            <div id="l1629"
               class="code sev- "><tt><i>1629</i>             <span class="k">if</span> <span class="n">start_q_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1630"
               class="code sev- "><tt><i>1630</i>                 <span class="n">start_q_data</span> <span class="o">=</span> <span class="n">get_quest</span><span class="p">(</span><span class="n">start_q_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1631"
               class="code sev- "><tt><i>1631</i>                 <span class="k">if</span> <span class="n">start_q_data</span><span class="p">:</span></tt>
            </div>
            <div id="l1632"
               class="code sev- "><tt><i>1632</i>                     <span class="n">start_q_title</span> <span class="o">=</span> <span class="n">start_q_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Starting Quest&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1633"
               class="code sev- "><tt><i>1633</i>                     <span class="n">start_s_id</span> <span class="o">=</span> <span class="n">start_q_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starting_step&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1634"
               class="code sev- "><tt><i>1634</i>                     <span class="k">if</span> <span class="n">start_s_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1635"
               class="code sev- "><tt><i>1635</i>                         <span class="n">start_s_info</span> <span class="o">=</span> <span class="n">get_quest_step</span><span class="p">(</span><span class="n">start_q_id</span><span class="p">,</span> <span class="n">start_s_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1636"
               class="code sev- "><tt><i>1636</i>                         <span class="k">if</span> <span class="n">start_s_info</span><span class="p">:</span></tt>
            </div>
            <div id="l1637"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1637</i>                              <span class="n">start_s_desc</span> <span class="o">=</span> <span class="n">start_s_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Begin your journey.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1638"
               class="code sev- "><tt><i>1638</i>             <span class="n">new_char_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span></tt>
            </div>
            <div id="l1639"
               class="code sev- "><tt><i>1639</i>                 <span class="s1">&#39;current_quest_id&#39;</span><span class="p">:</span> <span class="n">start_q_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1640"
               class="code sev- "><tt><i>1640</i>                 <span class="s1">&#39;current_step_id&#39;</span><span class="p">:</span> <span class="n">start_s_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1641"
               class="code sev- "><tt><i>1641</i>                 <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="n">start_q_title</span><span class="p">,</span></tt>
            </div>
            <div id="l1642"
               class="code sev- "><tt><i>1642</i>                 <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="n">start_s_desc</span></tt>
            </div>
            <div id="l1643"
               class="code sev- "><tt><i>1643</i>             <span class="p">})</span></tt>
            </div>
            <div id="l1644"
               class="code sev- "><tt><i>1644</i> &nbsp;</tt>
            </div>
            <div id="l1645"
               class="code sev- "><tt><i>1645</i>             <span class="c1"># Save the new character</span></tt>
            </div>
            <div id="l1646"
               class="code sev- "><tt><i>1646</i>             <span class="n">saved_id</span> <span class="o">=</span> <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">new_char_data</span><span class="p">)</span></tt>
            </div>
            <div id="l1647"
               class="code sev- "><tt><i>1647</i>             <span class="k">if</span> <span class="n">saved_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1648"
               class="code sev- "><tt><i>1648</i>                 <span class="c1"># Load the newly saved character into session</span></tt>
            </div>
            <div id="l1649"
               class="code sev- "><tt><i>1649</i>                 <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">saved_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1650"
               class="code sev- "><tt><i>1650</i>                 <span class="k">if</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l1651"
               class="code sev- "><tt><i>1651</i>                     <span class="c1"># Clear any previous temp session data</span></tt>
            </div>
            <div id="l1652"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E201
                     </span>
                     Whitespace after '['</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (279 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E202
                     </span>
                     Whitespace before ']'</li>

               </ul><tt><i>1652</i>                     <span class="n">keys_to_clear</span> <span class="o">=</span> <span class="p">[</span> <span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">,</span> <span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_TURNS</span> <span class="p">]</span></tt>
            </div>
            <div id="l1653"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

               </ul><tt><i>1653</i>                     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_to_clear</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1654"
               class="code sev- "><tt><i>1654</i>                     <span class="c1"># Load essential data into session</span></tt>
            </div>
            <div id="l1655"
               class="code sev- "><tt><i>1655</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved_id</span></tt>
            </div>
            <div id="l1656"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>1656</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_location&#39;</span><span class="p">,</span> <span class="n">STARTING_LOCATION</span><span class="p">)</span></tt>
            </div>
            <div id="l1657"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1657</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1658"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1658</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1659"
               class="code sev- "><tt><i>1659</i>                     <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1660"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

               </ul><tt><i>1660</i>                     <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-made character &#39;</span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; created and loaded!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1661"
               class="code sev- "><tt><i>1661</i>                     <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1662"
               class="code sev- "><tt><i>1662</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1663"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>1663</i>                     <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Character created but failed to load. Please try loading from profile.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1664"
               class="code sev- "><tt><i>1664</i>                     <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1665"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1665</i>             <span class="k">else</span><span class="p">:</span> <span class="c1"># Save failed</span></tt>
            </div>
            <div id="l1666"
               class="code sev- "><tt><i>1666</i>                 <span class="c1"># Error should be flashed by save_character_data</span></tt>
            </div>
            <div id="l1667"
               class="code sev- "><tt><i>1667</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1668"
               class="code sev- "><tt><i>1668</i> &nbsp;</tt>
            </div>
            <div id="l1669"
               class="code sev- "><tt><i>1669</i>         <span class="c1"># --- Save Vocabulary Color Settings Action ---</span></tt>
            </div>
            <div id="l1670"
               class="code sev- "><tt><i>1670</i>         <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;save_settings&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1671"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1671</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempting to save vocabulary color settings.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1672"
               class="code sev- "><tt><i>1672</i>             <span class="n">awl_color</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFE6EB&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l1673"
               class="code sev- "><tt><i>1673</i>             <span class="n">ai_color</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">,</span> <span class="s1">&#39;#E1F0FF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l1674"
               class="code sev- "><tt><i>1674</i> &nbsp;</tt>
            </div>
            <div id="l1675"
               class="code sev- "><tt><i>1675</i>             <span class="c1"># Validate color format</span></tt>
            </div>
            <div id="l1676"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>1676</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">awl_color</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">ai_color</span><span class="p">):</span></tt>
            </div>
            <div id="l1677"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>1677</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Invalid color format submitted. Please use the color picker.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1678"
               class="code sev- "><tt><i>1678</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1679"
               class="code sev- "><tt><i>1679</i> &nbsp;</tt>
            </div>
            <div id="l1680"
               class="code sev- "><tt><i>1680</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1681"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>1681</i>                 <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1682"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1682</i>                 <span class="c1"># Use set with merge=True to update or add the vocab_settings field</span></tt>
            </div>
            <div id="l1683"
               class="code sev- "><tt><i>1683</i>                 <span class="c1"># This preserves other settings if they exist</span></tt>
            </div>
            <div id="l1684"
               class="code sev- "><tt><i>1684</i>                 <span class="n">profile_ref</span><span class="o">.</span><span class="n">set</span><span class="p">({</span></tt>
            </div>
            <div id="l1685"
               class="code sev- "><tt><i>1685</i>                     <span class="s1">&#39;vocab_settings&#39;</span><span class="p">:</span> <span class="p">{</span></tt>
            </div>
            <div id="l1686"
               class="code sev- "><tt><i>1686</i>                         <span class="s1">&#39;awl_color_bg&#39;</span><span class="p">:</span> <span class="n">awl_color</span><span class="p">,</span></tt>
            </div>
            <div id="l1687"
               class="code sev- "><tt><i>1687</i>                         <span class="s1">&#39;ai_color_bg&#39;</span><span class="p">:</span> <span class="n">ai_color</span></tt>
            </div>
            <div id="l1688"
               class="code sev- "><tt><i>1688</i>                         <span class="c1"># Note: This currently OVERWRITES use_default_awl.</span></tt>
            </div>
            <div id="l1689"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1689</i>                         <span class="c1"># If you add a toggle for that, fetch existing settings first.</span></tt>
            </div>
            <div id="l1690"
               class="code sev- "><tt><i>1690</i>                     <span class="p">}</span></tt>
            </div>
            <div id="l1691"
               class="code sev- "><tt><i>1691</i>                 <span class="p">},</span> <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1692"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>1692</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved vocab color settings for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: AWL=</span><span class="si">{</span><span class="n">awl_color</span><span class="si">}</span><span class="s2">, AI=</span><span class="si">{</span><span class="n">ai_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1693"
               class="code sev- "><tt><i>1693</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Vocabulary color settings saved!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1694"
               class="code sev- "><tt><i>1694</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1695"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>1695</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save vocab color settings for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1696"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>1696</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An error occurred while saving color settings.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1697"
               class="code sev- "><tt><i>1697</i> &nbsp;</tt>
            </div>
            <div id="l1698"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1698</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span> <span class="c1"># Redirect back to profile</span></tt>
            </div>
            <div id="l1699"
               class="code sev- "><tt><i>1699</i> &nbsp;</tt>
            </div>
            <div id="l1700"
               class="code sev- "><tt><i>1700</i>         <span class="c1"># --- Placeholder Action ---</span></tt>
            </div>
            <div id="l1701"
               class="code sev- "><tt><i>1701</i>         <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;request_report&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1702"
               class="code sev- "><tt><i>1702</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Detailed reports feature is not yet available.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1703"
               class="code sev- "><tt><i>1703</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1704"
               class="code sev- "><tt><i>1704</i> &nbsp;</tt>
            </div>
            <div id="l1705"
               class="code sev- "><tt><i>1705</i>         <span class="c1"># --- Unknown Action ---</span></tt>
            </div>
            <div id="l1706"
               class="code sev- "><tt><i>1706</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1707"
               class="code sev- "><tt><i>1707</i>             <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown profile action requested: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1708"
               class="code sev- "><tt><i>1708</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1709"
               class="code sev- "><tt><i>1709</i> &nbsp;</tt>
            </div>
            <div id="l1710"
               class="code sev- "><tt><i>1710</i>     <span class="c1"># --- GET Request Handling (Display Profile Page) ---</span></tt>
            </div>
            <div id="l1711"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1711</i>     <span class="k">else</span><span class="p">:</span> <span class="c1"># request.method == &#39;GET&#39;</span></tt>
            </div>
            <div id="l1712"
               class="code sev- "><tt><i>1712</i>         <span class="c1"># Fetch profile data including vocab settings</span></tt>
            </div>
            <div id="l1713"
               class="code sev- "><tt><i>1713</i>         <span class="n">profile_data</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1714"
               class="code sev- "><tt><i>1714</i>             <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user_email</span><span class="p">,</span></tt>
            </div>
            <div id="l1715"
               class="code sev- "><tt><i>1715</i>             <span class="s1">&#39;player_level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span></tt>
            </div>
            <div id="l1716"
               class="code sev- "><tt><i>1716</i>             <span class="s1">&#39;total_player_xp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span></tt>
            </div>
            <div id="l1717"
               class="code sev- "><tt><i>1717</i>             <span class="s1">&#39;has_premium&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span></tt>
            </div>
            <div id="l1718"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1718</i>             <span class="s1">&#39;vocab_settings&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Initialize with ALL defaults</span></tt>
            </div>
            <div id="l1719"
               class="code sev- "><tt><i>1719</i>                 <span class="s1">&#39;use_default_awl&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span></tt>
            </div>
            <div id="l1720"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1720</i>                 <span class="s1">&#39;awl_color_bg&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFE6EB&#39;</span><span class="p">,</span> <span class="c1"># Default pinkish</span></tt>
            </div>
            <div id="l1721"
               class="code sev- "><tt><i>1721</i>                 <span class="s1">&#39;ai_color_bg&#39;</span><span class="p">:</span> <span class="s1">&#39;#E1F0FF&#39;</span>   <span class="c1"># Default blueish</span></tt>
            </div>
            <div id="l1722"
               class="code sev- "><tt><i>1722</i>              <span class="p">}</span></tt>
            </div>
            <div id="l1723"
               class="code sev- "><tt><i>1723</i>         <span class="p">}</span></tt>
            </div>
            <div id="l1724"
               class="code sev- "><tt><i>1724</i>         <span class="k">if</span> <span class="n">db</span><span class="p">:</span></tt>
            </div>
            <div id="l1725"
               class="code sev- "><tt><i>1725</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1726"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1726</i>                 <span class="n">profile_doc_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l1727"
               class="code sev- "><tt><i>1727</i>                 <span class="c1"># Fetch all relevant fields</span></tt>
            </div>
            <div id="l1728"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (122 > 79 characters)</li>

               </ul><tt><i>1728</i>                 <span class="n">p_doc</span> <span class="o">=</span> <span class="n">profile_doc_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;player_level&#39;</span><span class="p">,</span> <span class="s1">&#39;total_player_xp&#39;</span><span class="p">,</span> <span class="s1">&#39;has_premium&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;vocab_settings&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1729"
               class="code sev- "><tt><i>1729</i>                 <span class="k">if</span> <span class="n">p_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l1730"
               class="code sev- "><tt><i>1730</i>                     <span class="n">fs_data</span> <span class="o">=</span> <span class="n">p_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l1731"
               class="code sev- "><tt><i>1731</i>                     <span class="c1"># Update basic fields safely</span></tt>
            </div>
            <div id="l1732"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>1732</i>                     <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;player_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_level&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;player_level&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1733"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>1733</i>                     <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1734"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>1734</i>                     <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;has_premium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_premium&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;has_premium&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1735"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1735</i>                     <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1736"
               class="code sev- "><tt><i>1736</i> &nbsp;</tt>
            </div>
            <div id="l1737"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>1737</i>                     <span class="c1"># Carefully update vocab_settings, preserving existing keys and adding defaults</span></tt>
            </div>
            <div id="l1738"
               class="code sev- "><tt><i>1738</i>                     <span class="n">saved_settings</span> <span class="o">=</span> <span class="n">fs_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l1739"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1739</i>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saved_settings</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># Check if it&#39;s a dict</span></tt>
            </div>
            <div id="l1740"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (164 > 79 characters)</li>

               </ul><tt><i>1740</i>                         <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;use_default_awl&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1741"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (155 > 79 characters)</li>

               </ul><tt><i>1741</i>                         <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;awl_color_bg&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1742"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (152 > 79 characters)</li>

               </ul><tt><i>1742</i>                         <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">,</span> <span class="n">profile_data</span><span class="p">[</span><span class="s1">&#39;vocab_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ai_color_bg&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1743"
               class="code sev- "><tt><i>1743</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1744"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (146 > 79 characters)</li>

               </ul><tt><i>1744</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocab settings for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> in Firestore is not a dict (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">saved_settings</span><span class="p">)</span><span class="si">}</span><span class="s2">). Using defaults.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1745"
               class="code sev- "><tt><i>1745</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1746"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>1746</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player profile document not found for logged-in user: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1747"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1747</i>                     <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Could not load your player profile details.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1748"
               class="code sev- "><tt><i>1748</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1749"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>1749</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch player profile for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1750"
               class="code sev- "><tt><i>1750</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An error occurred loading your profile data.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1751"
               class="code sev- "><tt><i>1751</i> &nbsp;</tt>
            </div>
            <div id="l1752"
               class="code sev- "><tt><i>1752</i>         <span class="c1"># Render the profile template</span></tt>
            </div>
            <div id="l1753"
               class="code sev- "><tt><i>1753</i>         <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l1754"
               class="code sev- "><tt><i>1754</i>             <span class="s1">&#39;profile.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1755"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>1755</i>             <span class="n">profile</span><span class="o">=</span><span class="n">profile_data</span><span class="p">,</span> <span class="c1"># Pass the full profile data, including vocab_settings</span></tt>
            </div>
            <div id="l1756"
               class="code sev- "><tt><i>1756</i>             <span class="n">characters</span><span class="o">=</span><span class="n">characters</span><span class="p">,</span></tt>
            </div>
            <div id="l1757"
               class="code sev- "><tt><i>1757</i>             <span class="n">premade_characters</span><span class="o">=</span><span class="n">premade_character_templates</span><span class="p">,</span></tt>
            </div>
            <div id="l1758"
               class="code sev- "><tt><i>1758</i>             <span class="n">has_premium</span><span class="o">=</span><span class="n">profile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_premium&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l1759"
               class="code sev- "><tt><i>1759</i>         <span class="p">)</span></tt>
            </div>
            <div id="l1760"
               class="code sev- "><tt><i>1760</i> &nbsp;</tt>
            </div>
            <div id="l1761"
               class="code sev- "><tt><i>1761</i> <span class="c1"># --- Character Creation Route ---</span></tt>
            </div>
            <div id="l1762"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>1762</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/create_character&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l1763"
               class="code sev- "><tt><i>1763</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l1764"
               class="code sev- "><tt><i>1764</i> <span class="k">def</span><span class="w"> </span><span class="nf">character_creation_view</span><span class="p">():</span></tt>
            </div>
            <div id="l1765"
               class="code sev- "><tt><i>1765</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l1766"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>1766</i>     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entering character_creation_view. Method: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1767"
               class="code sev- "><tt><i>1767</i> &nbsp;</tt>
            </div>
            <div id="l1768"
               class="code sev- "><tt><i>1768</i>     <span class="c1"># --- POST Request Handling ---</span></tt>
            </div>
            <div id="l1769"
               class="code sev- "><tt><i>1769</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1770"
               class="code sev- "><tt><i>1770</i>         <span class="n">creation_stage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;creation_stage&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1771"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>1771</i>         <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;POST request received. creation_stage = </span><span class="si">{</span><span class="n">creation_stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1772"
               class="code sev- "><tt><i>1772</i> &nbsp;</tt>
            </div>
            <div id="l1773"
               class="code sev- "><tt><i>1773</i>         <span class="c1"># --- Stage 1: Submit Details for AI Review ---</span></tt>
            </div>
            <div id="l1774"
               class="code sev- "><tt><i>1774</i>         <span class="k">if</span> <span class="n">creation_stage</span> <span class="o">==</span> <span class="s1">&#39;submit_details&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1775"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>1775</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> submitting custom character details for AI review.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1776"
               class="code sev- "><tt><i>1776</i>             <span class="c1"># Retrieve all fields from the form</span></tt>
            </div>
            <div id="l1777"
               class="code sev- "><tt><i>1777</i>             <span class="n">char_details</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1778"
               class="code sev- "><tt><i>1778</i>                 <span class="n">k</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l1779"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

               </ul><tt><i>1779</i>                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;boon&#39;</span><span class="p">,</span> <span class="s1">&#39;backstory&#39;</span><span class="p">,</span> <span class="s1">&#39;starting_quest&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l1780"
               class="code sev- "><tt><i>1780</i>             <span class="p">}</span></tt>
            </div>
            <div id="l1781"
               class="code sev- "><tt><i>1781</i> &nbsp;</tt>
            </div>
            <div id="l1782"
               class="code sev- "><tt><i>1782</i>             <span class="c1"># Validate required fields</span></tt>
            </div>
            <div id="l1783"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>1783</i>             <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;boon&#39;</span><span class="p">,</span> <span class="s1">&#39;backstory&#39;</span><span class="p">,</span> <span class="s1">&#39;starting_quest&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l1784"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>1784</i>             <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">char_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span></tt>
            </div>
            <div id="l1785"
               class="code sev- "><tt><i>1785</i>             <span class="k">if</span> <span class="n">missing</span><span class="p">:</span></tt>
            </div>
            <div id="l1786"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>1786</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please fill out all character detail fields (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2"> missing).&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1787"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1787</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validation failed, re-rendering template with errors.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1788"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>1788</i>                 <span class="c1"># Render as if initial stage (reviewing=False, no recommendations)</span></tt>
            </div>
            <div id="l1789"
               class="code sev- "><tt><i>1789</i>                 <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l1790"
               class="code sev- "><tt><i>1790</i>                     <span class="s1">&#39;character_creation.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1791"
               class="code sev- "><tt><i>1791</i>                     <span class="n">race_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1792"
               class="code sev- "><tt><i>1792</i>                     <span class="n">class_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1793"
               class="code sev- "><tt><i>1793</i>                     <span class="n">philosophy_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1794"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1794</i>                     <span class="n">char_details</span><span class="o">=</span><span class="n">char_details</span><span class="p">,</span> <span class="c1"># Pass back entered details</span></tt>
            </div>
            <div id="l1795"
               class="code sev- "><tt><i>1795</i>                     <span class="n">ai_recommendations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span></tt>
            </div>
            <div id="l1796"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1796</i>                     <span class="n">reviewing</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Ensure fields are editable</span></tt>
            </div>
            <div id="l1797"
               class="code sev- "><tt><i>1797</i>                 <span class="p">)</span></tt>
            </div>
            <div id="l1798"
               class="code sev- "><tt><i>1798</i> &nbsp;</tt>
            </div>
            <div id="l1799"
               class="code sev- "><tt><i>1799</i>             <span class="c1"># Store details and get AI review</span></tt>
            </div>
            <div id="l1800"
               class="code sev- "><tt><i>1800</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">]</span> <span class="o">=</span> <span class="n">char_details</span></tt>
            </div>
            <div id="l1801"
               class="code sev- "><tt><i>1801</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1802"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>1802</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored char_details in session: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1803"
               class="code sev- "><tt><i>1803</i>             <span class="n">review_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;character_sheet_data&quot;</span><span class="p">:</span> <span class="n">char_details</span><span class="p">}</span></tt>
            </div>
            <div id="l1804"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1804</i>             <span class="n">ai_response</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;REVIEW_CHARACTER_SHEET&quot;</span><span class="p">,</span> <span class="n">review_context</span><span class="p">)</span></tt>
            </div>
            <div id="l1805"
               class="code sev- "><tt><i>1805</i> &nbsp;</tt>
            </div>
            <div id="l1806"
               class="code sev- "><tt><i>1806</i>             <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1807"
               class="code sev- "><tt><i>1807</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ai_response</span><span class="p">:</span></tt>
            </div>
            <div id="l1808"
               class="code sev- "><tt><i>1808</i>                 <span class="n">recommendations</span> <span class="o">=</span> <span class="n">ai_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recommendations&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l1809"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>1809</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI review returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span><span class="si">}</span><span class="s2"> recommendations.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1810"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>1810</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;AI has reviewed your character concept. See suggestions below.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1811"
               class="code sev- "><tt><i>1811</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1812"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (138 > 79 characters)</li>

               </ul><tt><i>1812</i>                 <span class="n">error_reason</span> <span class="o">=</span> <span class="n">ai_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;AI communication failure&#39;</span></tt>
            </div>
            <div id="l1813"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1813</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI character review failed. Reason: </span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1814"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>1814</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI couldn&#39;t review your concept (</span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">). You can finalize, edit, or start over.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1815"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1815</i>                 <span class="n">recommendations</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Indicate review failure</span></tt>
            </div>
            <div id="l1816"
               class="code sev- "><tt><i>1816</i> &nbsp;</tt>
            </div>
            <div id="l1817"
               class="code sev- "><tt><i>1817</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span></tt>
            </div>
            <div id="l1818"
               class="code sev- "><tt><i>1818</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1819"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>1819</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored ai_recommendations in session: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1820"
               class="code sev- "><tt><i>1820</i> &nbsp;</tt>
            </div>
            <div id="l1821"
               class="code sev- "><tt><i>1821</i>             <span class="c1"># Render page in review mode (reviewing=True)</span></tt>
            </div>
            <div id="l1822"
               class="code sev- "><tt><i>1822</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rendering template for review stage.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1823"
               class="code sev- "><tt><i>1823</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l1824"
               class="code sev- "><tt><i>1824</i>                 <span class="s1">&#39;character_creation.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1825"
               class="code sev- "><tt><i>1825</i>                 <span class="n">race_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1826"
               class="code sev- "><tt><i>1826</i>                 <span class="n">class_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1827"
               class="code sev- "><tt><i>1827</i>                 <span class="n">philosophy_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1828"
               class="code sev- "><tt><i>1828</i>                 <span class="n">char_details</span><span class="o">=</span><span class="n">char_details</span><span class="p">,</span></tt>
            </div>
            <div id="l1829"
               class="code sev- "><tt><i>1829</i>                 <span class="n">ai_recommendations</span><span class="o">=</span><span class="n">recommendations</span><span class="p">,</span></tt>
            </div>
            <div id="l1830"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1830</i>                 <span class="n">reviewing</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Now in review mode</span></tt>
            </div>
            <div id="l1831"
               class="code sev- "><tt><i>1831</i>             <span class="p">)</span></tt>
            </div>
            <div id="l1832"
               class="code sev- "><tt><i>1832</i> &nbsp;</tt>
            </div>
            <div id="l1833"
               class="code sev- "><tt><i>1833</i>         <span class="c1"># --- Stage 0: Handle Restart Request ---</span></tt>
            </div>
            <div id="l1834"
               class="code sev- "><tt><i>1834</i>         <span class="k">elif</span> <span class="n">creation_stage</span> <span class="o">==</span> <span class="s1">&#39;restart&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1835"
               class="code sev- "><tt><i>1835</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> restarting character creation.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1836"
               class="code sev- "><tt><i>1836</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing session data for restart.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1837"
               class="code sev- "><tt><i>1837</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1838"
               class="code sev- "><tt><i>1838</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1839"
               class="code sev- "><tt><i>1839</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1840"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (149 > 79 characters)</li>

               </ul><tt><i>1840</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session after clearing: details=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">)</span><span class="si">}</span><span class="s2">, recs=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1841"
               class="code sev- "><tt><i>1841</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1842"
               class="code sev- "><tt><i>1842</i> &nbsp;</tt>
            </div>
            <div id="l1843"
               class="code sev- "><tt><i>1843</i>         <span class="c1"># --- Stage 1.5: Handle Edit Request ---</span></tt>
            </div>
            <div id="l1844"
               class="code sev- "><tt><i>1844</i>         <span class="k">elif</span> <span class="n">creation_stage</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1845"
               class="code sev- "><tt><i>1845</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> editing character after review.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1846"
               class="code sev- "><tt><i>1846</i>             <span class="c1"># Keep char_details in session, but clear recommendations</span></tt>
            </div>
            <div id="l1847"
               class="code sev- "><tt><i>1847</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1848"
               class="code sev- "><tt><i>1848</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1849"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (163 > 79 characters)</li>

               </ul><tt><i>1849</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session after clearing recs for edit: details=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">)</span><span class="si">}</span><span class="s2">, recs=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1850"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>1850</i>             <span class="c1"># Redirect back to the GET handler, which will now render editable fields</span></tt>
            </div>
            <div id="l1851"
               class="code sev- "><tt><i>1851</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1852"
               class="code sev- "><tt><i>1852</i> &nbsp;</tt>
            </div>
            <div id="l1853"
               class="code sev- "><tt><i>1853</i>         <span class="c1"># --- Stage 2: Finalize Character Creation ---</span></tt>
            </div>
            <div id="l1854"
               class="code sev- "><tt><i>1854</i>         <span class="k">elif</span> <span class="n">creation_stage</span> <span class="o">==</span> <span class="s1">&#39;finalize&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l1855"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1855</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempting to finalize custom character.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1856"
               class="code sev- "><tt><i>1856</i>             <span class="n">final_details</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">)</span></tt>
            </div>
            <div id="l1857"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1857</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved final_details from session: </span><span class="si">{</span><span class="n">final_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1858"
               class="code sev- "><tt><i>1858</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">final_details</span><span class="p">:</span></tt>
            </div>
            <div id="l1859"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>1859</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Character details were lost. Please start over.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1860"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>1860</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finalization error: Session data missing.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1861"
               class="code sev- "><tt><i>1861</i>                 <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1862"
               class="code sev- "><tt><i>1862</i>                 <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1863"
               class="code sev- "><tt><i>1863</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1864"
               class="code sev- "><tt><i>1864</i> &nbsp;</tt>
            </div>
            <div id="l1865"
               class="code sev- "><tt><i>1865</i>             <span class="c1"># --- Create new character data structure ---</span></tt>
            </div>
            <div id="l1866"
               class="code sev- "><tt><i>1866</i>             <span class="n">new_char_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_custom_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l1867"
               class="code sev- "><tt><i>1867</i>             <span class="n">final_char_data</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l1868"
               class="code sev- "><tt><i>1868</i>                 <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">new_char_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1869"
               class="code sev- "><tt><i>1869</i>                 <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span></tt>
            </div>
            <div id="l1870"
               class="code sev- "><tt><i>1870</i>                 <span class="s1">&#39;current_location&#39;</span><span class="p">:</span> <span class="n">STARTING_LOCATION</span><span class="p">,</span></tt>
            </div>
            <div id="l1871"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1871</i>                 <span class="s1">&#39;learned_vocab&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="c1"># Initialize as set</span></tt>
            </div>
            <div id="l1872"
               class="code sev- "><tt><i>1872</i>                 <span class="s1">&#39;report_summaries&#39;</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1873"
               class="code sev- "><tt><i>1873</i>                 <span class="s1">&#39;turn_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span></tt>
            </div>
            <div id="l1874"
               class="code sev- "><tt><i>1874</i>                 <span class="n">SESSION_EOC_PROMPTED</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span></tt>
            </div>
            <div id="l1875"
               class="code sev- "><tt><i>1875</i>                 <span class="n">FS_CONVERSATION</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1876"
               class="code sev- "><tt><i>1876</i>                 <span class="n">FS_CHAPTER_INPUTS</span><span class="p">:</span> <span class="p">[],</span></tt>
            </div>
            <div id="l1877"
               class="code sev- "><tt><i>1877</i>                 <span class="n">FS_QUEST_FLAGS</span><span class="p">:</span> <span class="p">{},</span></tt>
            </div>
            <div id="l1878"
               class="code sev- "><tt><i>1878</i>                 <span class="n">FS_INVENTORY</span><span class="p">:</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1879"
               class="code sev- "><tt><i>1879</i>             <span class="p">}</span></tt>
            </div>
            <div id="l1880"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1880</i>             <span class="n">final_char_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">final_details</span><span class="p">)</span> <span class="c1"># Add the form details</span></tt>
            </div>
            <div id="l1881"
               class="code sev- "><tt><i>1881</i> &nbsp;</tt>
            </div>
            <div id="l1882"
               class="code sev- "><tt><i>1882</i>             <span class="c1"># --- Validate required fields ---</span></tt>
            </div>
            <div id="l1883"
               class="code sev- "><tt><i>1883</i>             <span class="n">race_name</span> <span class="o">=</span> <span class="n">final_char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1884"
               class="code sev- "><tt><i>1884</i>             <span class="n">class_name</span> <span class="o">=</span> <span class="n">final_char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1885"
               class="code sev- "><tt><i>1885</i>             <span class="n">philosophy_name</span> <span class="o">=</span> <span class="n">final_char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1886"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>1886</i>             <span class="n">start_goal</span> <span class="o">=</span> <span class="n">final_char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starting_quest&#39;</span><span class="p">,</span> <span class="s1">&#39;Find purpose&#39;</span><span class="p">)</span> <span class="c1"># Use form input</span></tt>
            </div>
            <div id="l1887"
               class="code sev- "><tt><i>1887</i> &nbsp;</tt>
            </div>
            <div id="l1888"
               class="code sev- "><tt><i>1888</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">race_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">class_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">philosophy_name</span><span class="p">:</span></tt>
            </div>
            <div id="l1889"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>1889</i>                  <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required character detail (Race/Class/Philosophy). Please start over.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1890"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (147 > 79 characters)</li>

               </ul><tt><i>1890</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing essential name(s) finalizing character for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: R=</span><span class="si">{</span><span class="n">race_name</span><span class="si">}</span><span class="s2">, C=</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">philosophy_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1891"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1891</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1892"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1892</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1893"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1893</i>                  <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1894"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1894</i>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1895"
               class="code sev- "><tt><i>1895</i> &nbsp;</tt>
            </div>
            <div id="l1896"
               class="code sev- "><tt><i>1896</i>             <span class="c1"># --- Calculate derived fields ---</span></tt>
            </div>
            <div id="l1897"
               class="code sev- "><tt><i>1897</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l1898"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1898</i>                 <span class="n">race_abilities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">race_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,</span> <span class="p">[]))</span></tt>
            </div>
            <div id="l1899"
               class="code sev- "><tt><i>1899</i>                 <span class="n">class_ability</span> <span class="o">=</span> <span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1900"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>1900</i>                 <span class="n">phil_ability</span> <span class="o">=</span> <span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">philosophy_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ability&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1901"
               class="code sev- "><tt><i>1901</i>                 <span class="n">all_abilities</span> <span class="o">=</span> <span class="n">race_abilities</span></tt>
            </div>
            <div id="l1902"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

               </ul><tt><i>1902</i>                 <span class="k">if</span> <span class="n">class_ability</span><span class="p">:</span> <span class="n">all_abilities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_ability</span><span class="p">)</span></tt>
            </div>
            <div id="l1903"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

               </ul><tt><i>1903</i>                 <span class="k">if</span> <span class="n">phil_ability</span><span class="p">:</span> <span class="n">all_abilities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phil_ability</span><span class="p">)</span></tt>
            </div>
            <div id="l1904"
               class="code sev- "><tt><i>1904</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;abilities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_abilities</span><span class="p">))</span></tt>
            </div>
            <div id="l1905"
               class="code sev- "><tt><i>1905</i> &nbsp;</tt>
            </div>
            <div id="l1906"
               class="code sev- "><tt><i>1906</i>                 <span class="n">class_focus</span> <span class="o">=</span> <span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;focus&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l1907"
               class="code sev- "><tt><i>1907</i>                 <span class="n">aspects</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_focus</span><span class="p">]</span> <span class="k">if</span> <span class="n">class_focus</span> <span class="k">else</span> <span class="p">[]</span></tt>
            </div>
            <div id="l1908"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1908</i>                 <span class="k">if</span> <span class="s2">&quot;Artistic Shell&quot;</span> <span class="ow">in</span> <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;abilities&#39;</span><span class="p">]:</span> <span class="n">aspects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Shell Design: Undefined&quot;</span><span class="p">)</span> <span class="c1"># Example</span></tt>
            </div>
            <div id="l1909"
               class="code sev- "><tt><i>1909</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;aspects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aspects</span></tt>
            </div>
            <div id="l1910"
               class="code sev- "><tt><i>1910</i> &nbsp;</tt>
            </div>
            <div id="l1911"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>1911</i>                 <span class="n">race_mod</span> <span class="o">=</span> <span class="n">RACE_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">race_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_point_mod&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l1912"
               class="code sev- "><tt><i>1912</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;fate_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_FATE_POINTS</span> <span class="o">+</span> <span class="n">race_mod</span></tt>
            </div>
            <div id="l1913"
               class="code sev- "><tt><i>1913</i> &nbsp;</tt>
            </div>
            <div id="l1914"
               class="code sev- "><tt><i>1914</i>                 <span class="c1"># Create simple starting quest based on user input</span></tt>
            </div>
            <div id="l1915"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1915</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Q_CH1_</span><span class="si">{</span><span class="n">new_char_id</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Unique ID</span></tt>
            </div>
            <div id="l1916"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1916</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Chapter 1: </span><span class="si">{</span><span class="n">start_goal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span> <span class="c1"># Title from goal</span></tt>
            </div>
            <div id="l1917"
               class="code sev- "><tt><i>1917</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STEP_01&quot;</span></tt>
            </div>
            <div id="l1918"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>1918</i>                 <span class="n">final_char_data</span><span class="p">[</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_goal</span> <span class="c1"># Step desc from goal</span></tt>
            </div>
            <div id="l1919"
               class="code sev- "><tt><i>1919</i> &nbsp;</tt>
            </div>
            <div id="l1920"
               class="code sev- "><tt><i>1920</i>             <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1921"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>1921</i>                  <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal data error finding details for </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Please check selections.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1922"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>1922</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KeyError finalizing character for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1923"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1923</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1924"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1924</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1925"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1925</i>                  <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1926"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1926</i>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1927"
               class="code sev- "><tt><i>1927</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l1928"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

               </ul><tt><i>1928</i>                  <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred calculating character stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Please start over.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1929"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>1929</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating derived fields for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l1930"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1930</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1931"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1931</i>                  <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1932"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1932</i>                  <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1933"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>1933</i>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1934"
               class="code sev- "><tt><i>1934</i> &nbsp;</tt>
            </div>
            <div id="l1935"
               class="code sev- "><tt><i>1935</i>             <span class="c1"># --- Save the new character ---</span></tt>
            </div>
            <div id="l1936"
               class="code sev- "><tt><i>1936</i>             <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to save finalized character data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1937"
               class="code sev- "><tt><i>1937</i>             <span class="n">saved_id</span> <span class="o">=</span> <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">final_char_data</span><span class="p">)</span></tt>
            </div>
            <div id="l1938"
               class="code sev- "><tt><i>1938</i>             <span class="k">if</span> <span class="n">saved_id</span><span class="p">:</span></tt>
            </div>
            <div id="l1939"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>1939</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Character saved successfully with ID: </span><span class="si">{</span><span class="n">saved_id</span><span class="si">}</span><span class="s2">. Clearing session.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1940"
               class="code sev- "><tt><i>1940</i>                 <span class="c1"># Clear creation data from session</span></tt>
            </div>
            <div id="l1941"
               class="code sev- "><tt><i>1941</i>                 <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1942"
               class="code sev- "><tt><i>1942</i>                 <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1943"
               class="code sev- "><tt><i>1943</i>                 <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1944"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

               </ul><tt><i>1944</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom character &#39;</span><span class="si">{</span><span class="n">final_char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; created successfully!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1945"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1945</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span> <span class="c1"># Go back to profile after creation</span></tt>
            </div>
            <div id="l1946"
               class="code sev- "><tt><i>1946</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1947"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>1947</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Failed to save the finalized character. Please try again.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1948"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>1948</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;save_character_data returned None during finalization.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1949"
               class="code sev- "><tt><i>1949</i>                 <span class="c1"># Stay on creation page with current details</span></tt>
            </div>
            <div id="l1950"
               class="code sev- "><tt><i>1950</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1951"
               class="code sev- "><tt><i>1951</i> &nbsp;</tt>
            </div>
            <div id="l1952"
               class="code sev- "><tt><i>1952</i>         <span class="c1"># --- Invalid Stage ---</span></tt>
            </div>
            <div id="l1953"
               class="code sev- "><tt><i>1953</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1954"
               class="code sev- "><tt><i>1954</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Invalid character creation request.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1955"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>1955</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid creation_stage &#39;</span><span class="si">{</span><span class="n">creation_stage</span><span class="si">}</span><span class="s2">&#39; received.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1956"
               class="code sev- "><tt><i>1956</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1957"
               class="code sev- "><tt><i>1957</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1958"
               class="code sev- "><tt><i>1958</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1959"
               class="code sev- "><tt><i>1959</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;character_creation_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l1960"
               class="code sev- "><tt><i>1960</i> &nbsp;</tt>
            </div>
            <div id="l1961"
               class="code sev- "><tt><i>1961</i>     <span class="c1"># --- GET Request Handling ---</span></tt>
            </div>
            <div id="l1962"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1962</i>     <span class="k">else</span><span class="p">:</span> <span class="c1"># request.method == &#39;GET&#39;</span></tt>
            </div>
            <div id="l1963"
               class="code sev- "><tt><i>1963</i>         <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;GET request: Checking session for existing data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1964"
               class="code sev- "><tt><i>1964</i>         <span class="n">char_details_from_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">)</span></tt>
            </div>
            <div id="l1965"
               class="code sev- "><tt><i>1965</i>         <span class="n">recommendations_from_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">)</span></tt>
            </div>
            <div id="l1966"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>1966</i>         <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Session values: details=</span><span class="si">{</span><span class="n">char_details_from_session</span><span class="si">}</span><span class="s2">, recs=</span><span class="si">{</span><span class="n">recommendations_from_session</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1967"
               class="code sev- "><tt><i>1967</i> &nbsp;</tt>
            </div>
            <div id="l1968"
               class="code sev- "><tt><i>1968</i>         <span class="c1"># Determine if we are in the &#39;review&#39; stage (locked fields)</span></tt>
            </div>
            <div id="l1969"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>1969</i>         <span class="n">is_reviewing_stage</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">char_details_from_session</span> <span class="ow">and</span> <span class="n">recommendations_from_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1970"
               class="code sev- "><tt><i>1970</i> &nbsp;</tt>
            </div>
            <div id="l1971"
               class="code sev- "><tt><i>1971</i>         <span class="k">if</span> <span class="n">char_details_from_session</span><span class="p">:</span></tt>
            </div>
            <div id="l1972"
               class="code sev- "><tt><i>1972</i>             <span class="c1"># We have details, could be review stage or edit stage</span></tt>
            </div>
            <div id="l1973"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>1973</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rendering creation page. Reviewing=</span><span class="si">{</span><span class="n">is_reviewing_stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1974"
               class="code sev- "><tt><i>1974</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l1975"
               class="code sev- "><tt><i>1975</i>                 <span class="s1">&#39;character_creation.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1976"
               class="code sev- "><tt><i>1976</i>                 <span class="n">race_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1977"
               class="code sev- "><tt><i>1977</i>                 <span class="n">class_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1978"
               class="code sev- "><tt><i>1978</i>                 <span class="n">philosophy_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1979"
               class="code sev- "><tt><i>1979</i>                 <span class="n">char_details</span><span class="o">=</span><span class="n">char_details_from_session</span><span class="p">,</span></tt>
            </div>
            <div id="l1980"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>1980</i>                 <span class="n">ai_recommendations</span><span class="o">=</span><span class="n">recommendations_from_session</span><span class="p">,</span> <span class="c1"># Pass recommendations if they exist</span></tt>
            </div>
            <div id="l1981"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1981</i>                 <span class="n">reviewing</span><span class="o">=</span><span class="n">is_reviewing_stage</span> <span class="c1"># Pass the flag to template</span></tt>
            </div>
            <div id="l1982"
               class="code sev- "><tt><i>1982</i>             <span class="p">)</span></tt>
            </div>
            <div id="l1983"
               class="code sev- "><tt><i>1983</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l1984"
               class="code sev- "><tt><i>1984</i>             <span class="c1"># No details in session, must be the initial empty form</span></tt>
            </div>
            <div id="l1985"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>1985</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying initial character creation form.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l1986"
               class="code sev- "><tt><i>1986</i>             <span class="c1"># Ensure session is clear just in case</span></tt>
            </div>
            <div id="l1987"
               class="code sev- "><tt><i>1987</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_NEW_CHAR_DETAILS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1988"
               class="code sev- "><tt><i>1988</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_AI_RECOMMENDATIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l1989"
               class="code sev- "><tt><i>1989</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l1990"
               class="code sev- "><tt><i>1990</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l1991"
               class="code sev- "><tt><i>1991</i>                 <span class="s1">&#39;character_creation.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l1992"
               class="code sev- "><tt><i>1992</i>                 <span class="n">race_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">RACE_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1993"
               class="code sev- "><tt><i>1993</i>                 <span class="n">class_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CLASS_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1994"
               class="code sev- "><tt><i>1994</i>                 <span class="n">philosophy_options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">PHILOSOPHY_DATA</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span></tt>
            </div>
            <div id="l1995"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1995</i>                 <span class="n">char_details</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># Empty initial details</span></tt>
            </div>
            <div id="l1996"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1996</i>                 <span class="n">ai_recommendations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># No recommendations</span></tt>
            </div>
            <div id="l1997"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>1997</i>                 <span class="n">reviewing</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Not reviewing</span></tt>
            </div>
            <div id="l1998"
               class="code sev- "><tt><i>1998</i>             <span class="p">)</span></tt>
            </div>
            <div id="l1999"
               class="code sev- "><tt><i>1999</i> &nbsp;</tt>
            </div>
            <div id="l2000"
               class="code sev- "><tt><i>2000</i> <span class="c1"># --- AI Vocab Generation Route ---</span></tt>
            </div>
            <div id="l2001"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>2001</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/generate_vocab_list&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2002"
               class="code sev- "><tt><i>2002</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2003"
               class="code sev- "><tt><i>2003</i> <span class="k">def</span><span class="w"> </span><span class="nf">generate_vocab_list</span><span class="p">():</span></tt>
            </div>
            <div id="l2004"
               class="code sev- "><tt><i>2004</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2005"
               class="code sev- "><tt><i>2005</i>     <span class="c1"># --- Premium Access Check ---</span></tt>
            </div>
            <div id="l2006"
               class="code sev- "><tt><i>2006</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">check_premium_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span></tt>
            </div>
            <div id="l2007"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2007</i>         <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-premium user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempted AI vocabulary generation.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2008"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

               </ul><tt><i>2008</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI vocabulary generation is a premium feature.&quot;</span><span class="p">}),</span> <span class="mi">403</span></tt>
            </div>
            <div id="l2009"
               class="code sev- "><tt><i>2009</i> &nbsp;</tt>
            </div>
            <div id="l2010"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2010</i>     <span class="n">target_word</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_word&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l2011"
               class="code sev- "><tt><i>2011</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">target_word</span><span class="p">:</span></tt>
            </div>
            <div id="l2012"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2012</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Please provide a target word.&quot;</span><span class="p">}),</span> <span class="mi">400</span></tt>
            </div>
            <div id="l2013"
               class="code sev- "><tt><i>2013</i> &nbsp;</tt>
            </div>
            <div id="l2014"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>2014</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> requesting AI vocabulary list generation for target word: &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2015"
               class="code sev- "><tt><i>2015</i>     <span class="n">ai_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;target_word&quot;</span><span class="p">:</span> <span class="n">target_word</span><span class="p">}</span></tt>
            </div>
            <div id="l2016"
               class="code sev- "><tt><i>2016</i>     <span class="n">ai_response</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;GENERATE_CONTEXTUAL_VOCAB&quot;</span><span class="p">,</span> <span class="n">ai_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2017"
               class="code sev- "><tt><i>2017</i> &nbsp;</tt>
            </div>
            <div id="l2018"
               class="code sev- "><tt><i>2018</i>     <span class="c1"># --- Process AI Response ---</span></tt>
            </div>
            <div id="l2019"
               class="code sev- "><tt><i>2019</i>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ai_response</span><span class="p">:</span></tt>
            </div>
            <div id="l2020"
               class="code sev- "><tt><i>2020</i>         <span class="n">target_info</span> <span class="o">=</span> <span class="n">ai_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target_word_info&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2021"
               class="code sev- "><tt><i>2021</i>         <span class="n">related_words</span> <span class="o">=</span> <span class="n">ai_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;related_words&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2022"
               class="code sev- "><tt><i>2022</i>         <span class="c1"># --- Validate response structure ---</span></tt>
            </div>
            <div id="l2023"
               class="code sev- "><tt><i>2023</i>         <span class="n">is_valid_format</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l2024"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (123 > 79 characters)</li>

               </ul><tt><i>2024</i>             <span class="n">target_info</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">)</span> <span class="ow">and</span></tt>
            </div>
            <div id="l2025"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2025</i>             <span class="n">related_words</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">related_words</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">25</span> <span class="ow">and</span></tt>
            </div>
            <div id="l2026"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2026</i>             <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;definition&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">related_words</span><span class="p">)</span></tt>
            </div>
            <div id="l2027"
               class="code sev- "><tt><i>2027</i>         <span class="p">)</span></tt>
            </div>
            <div id="l2028"
               class="code sev- "><tt><i>2028</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_format</span><span class="p">:</span></tt>
            </div>
            <div id="l2029"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (164 > 79 characters)</li>

               </ul><tt><i>2029</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI vocabulary generation for &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39; returned incomplete or invalid data structure for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">ai_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2030"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (129 > 79 characters)</li>

               </ul><tt><i>2030</i>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AI failed to generate the vocabulary list in the expected format.&quot;</span><span class="p">}),</span> <span class="mi">500</span></tt>
            </div>
            <div id="l2031"
               class="code sev- "><tt><i>2031</i> &nbsp;</tt>
            </div>
            <div id="l2032"
               class="code sev- "><tt><i>2032</i>         <span class="c1"># --- Save the generated list to Firestore ---</span></tt>
            </div>
            <div id="l2033"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>2033</i>         <span class="n">word_list_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;word&quot;</span><span class="p">:</span> <span class="n">target_info</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">],</span><span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">target_info</span><span class="p">[</span><span class="s1">&#39;definition&#39;</span><span class="p">]}]</span> <span class="o">+</span> <span class="n">related_words</span></tt>
            </div>
            <div id="l2034"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2034</i>         <span class="n">list_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ai_</span><span class="si">{</span><span class="n">target_word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2035"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2035</i>         <span class="n">list_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39; Context&quot;</span> <span class="c1"># Create a descriptive name</span></tt>
            </div>
            <div id="l2036"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2036</i>         <span class="n">list_color</span> <span class="o">=</span> <span class="n">DEFAULT_VOCAB_LIST_COLOR</span> <span class="c1"># Use default color</span></tt>
            </div>
            <div id="l2037"
               class="code sev- "><tt><i>2037</i>         <span class="n">firestore_data</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2038"
               class="code sev- "><tt><i>2038</i>             <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">list_name</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">list_color</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">:</span> <span class="n">word_list_data</span><span class="p">,</span></tt>
            </div>
            <div id="l2039"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2039</i>             <span class="s2">&quot;is_ai_generated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">firestore</span><span class="o">.</span><span class="n">SERVER_TIMESTAMP</span><span class="p">,</span> <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="c1"># Activate by default</span></tt>
            </div>
            <div id="l2040"
               class="code sev- "><tt><i>2040</i>         <span class="p">}</span></tt>
            </div>
            <div id="l2041"
               class="code sev- "><tt><i>2041</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2042"
               class="code sev- "><tt><i>2042</i>             <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2043"
               class="code sev- "><tt><i>2043</i>             <span class="n">vocab_lists_ref</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;custom_vocab_lists&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2044"
               class="code sev- "><tt><i>2044</i>             <span class="n">vocab_lists_ref</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">list_id</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">firestore_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2045"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>2045</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved AI generated vocabulary list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2046"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2046</i>             <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI vocabulary list based on &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39; created successfully!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2047"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E201
                     </span>
                     Whitespace after '{'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (156 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E202
                     </span>
                     Whitespace before '}'</li>

               </ul><tt><i>2047</i>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Vocabulary list for &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39; created!&quot;</span><span class="p">,</span> <span class="s2">&quot;list_id&quot;</span><span class="p">:</span> <span class="n">list_id</span><span class="p">,</span> <span class="s2">&quot;list_name&quot;</span><span class="p">:</span> <span class="n">list_name</span> <span class="p">}),</span> <span class="mi">200</span></tt>
            </div>
            <div id="l2048"
               class="code sev- "><tt><i>2048</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2049"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (122 > 79 characters)</li>

               </ul><tt><i>2049</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save generated AI vocabulary list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2050"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (125 > 79 characters)</li>

               </ul><tt><i>2050</i>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to save the generated vocabulary list to your profile.&quot;</span><span class="p">}),</span> <span class="mi">500</span></tt>
            </div>
            <div id="l2051"
               class="code sev- "><tt><i>2051</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2052"
               class="code sev- "><tt><i>2052</i>         <span class="c1"># Handle AI error during generation</span></tt>
            </div>
            <div id="l2053"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (132 > 79 characters)</li>

               </ul><tt><i>2053</i>         <span class="n">error_reason</span> <span class="o">=</span> <span class="n">ai_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span><span class="s1">&#39;Unknown AI error&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;AI communication failure&#39;</span></tt>
            </div>
            <div id="l2054"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (129 > 79 characters)</li>

               </ul><tt><i>2054</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI vocabulary generation failed for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, target word &#39;</span><span class="si">{</span><span class="n">target_word</span><span class="si">}</span><span class="s2">&#39;. Reason: </span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2055"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (119 > 79 characters)</li>

               </ul><tt><i>2055</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;AI Storyteller could not generate the list: </span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">500</span></tt>
            </div>
            <div id="l2056"
               class="code sev- "><tt><i>2056</i> &nbsp;</tt>
            </div>
            <div id="l2057"
               class="code sev- "><tt><i>2057</i> &nbsp;</tt>
            </div>
            <div id="l2058"
               class="code sev- "><tt><i>2058</i> <span class="c1"># --- Vocab List Management Routes ---</span></tt>
            </div>
            <div id="l2059"
               class="code sev- "><tt><i>2059</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/toggle_vocab_list/&lt;list_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2060"
               class="code sev- "><tt><i>2060</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2061"
               class="code sev- "><tt><i>2061</i> <span class="k">def</span><span class="w"> </span><span class="nf">toggle_vocab_list</span><span class="p">(</span><span class="n">list_id</span><span class="p">):</span></tt>
            </div>
            <div id="l2062"
               class="code sev- "><tt><i>2062</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2063"
               class="code sev- "><tt><i>2063</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">list_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2064"
               class="code sev- "><tt><i>2064</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;List ID missing.&quot;</span><span class="p">}),</span> <span class="mi">400</span></tt>
            </div>
            <div id="l2065"
               class="code sev- "><tt><i>2065</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2066"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>2066</i>         <span class="n">list_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;custom_vocab_lists&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">list_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2067"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2067</i>         <span class="n">list_doc</span> <span class="o">=</span> <span class="n">list_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;is_active&#39;</span><span class="p">])</span> <span class="c1"># Only fetch the field we need</span></tt>
            </div>
            <div id="l2068"
               class="code sev- "><tt><i>2068</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l2069"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>2069</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt to toggle non-existent vocab list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2070"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2070</i>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Vocabulary list not found.&quot;</span><span class="p">}),</span> <span class="mi">404</span></tt>
            </div>
            <div id="l2071"
               class="code sev- "><tt><i>2071</i>         <span class="n">current_status</span> <span class="o">=</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2072"
               class="code sev- "><tt><i>2072</i>         <span class="n">new_status</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">current_status</span></tt>
            </div>
            <div id="l2073"
               class="code sev- "><tt><i>2073</i>         <span class="n">list_ref</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_active&#39;</span><span class="p">:</span> <span class="n">new_status</span><span class="p">})</span></tt>
            </div>
            <div id="l2074"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>2074</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Toggled vocab list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="s1">&#39;active&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">new_status</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;inactive&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2075"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2075</i>         <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary list status updated.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="c1"># User feedback</span></tt>
            </div>
            <div id="l2076"
               class="code sev- "><tt><i>2076</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;new_status&quot;</span><span class="p">:</span> <span class="n">new_status</span><span class="p">}),</span> <span class="mi">200</span></tt>
            </div>
            <div id="l2077"
               class="code sev- "><tt><i>2077</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2078"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>2078</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error toggling vocabulary list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2079"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>2079</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to update vocabulary list status.&quot;</span><span class="p">}),</span> <span class="mi">500</span></tt>
            </div>
            <div id="l2080"
               class="code sev- "><tt><i>2080</i> &nbsp;</tt>
            </div>
            <div id="l2081"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>2081</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete_vocab_list/&lt;list_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2082"
               class="code sev- "><tt><i>2082</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2083"
               class="code sev- "><tt><i>2083</i> <span class="k">def</span><span class="w"> </span><span class="nf">delete_vocab_list</span><span class="p">(</span><span class="n">list_id</span><span class="p">):</span></tt>
            </div>
            <div id="l2084"
               class="code sev- "><tt><i>2084</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2085"
               class="code sev- "><tt><i>2085</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">list_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2086"
               class="code sev- "><tt><i>2086</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;List ID missing.&quot;</span><span class="p">}),</span> <span class="mi">400</span></tt>
            </div>
            <div id="l2087"
               class="code sev- "><tt><i>2087</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2088"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (120 > 79 characters)</li>

               </ul><tt><i>2088</i>         <span class="n">list_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;custom_vocab_lists&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">list_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2089"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2089</i>         <span class="n">list_doc</span> <span class="o">=</span> <span class="n">list_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="c1"># Get name for logging/feedback</span></tt>
            </div>
            <div id="l2090"
               class="code sev- "><tt><i>2090</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l2091"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>2091</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt to delete non-existent vocab list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2092"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2092</i>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Vocabulary list not found.&quot;</span><span class="p">}),</span> <span class="mi">404</span></tt>
            </div>
            <div id="l2093"
               class="code sev- "><tt><i>2093</i>         <span class="n">list_name</span> <span class="o">=</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown List&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2094"
               class="code sev- "><tt><i>2094</i>         <span class="n">list_ref</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></tt>
            </div>
            <div id="l2095"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2095</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted vocabulary list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">list_name</span><span class="si">}</span><span class="s2">&#39;) for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2096"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2096</i>         <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary list &#39;</span><span class="si">{</span><span class="n">list_name</span><span class="si">}</span><span class="s2">&#39; deleted.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="c1"># User feedback</span></tt>
            </div>
            <div id="l2097"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2097</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;List &#39;</span><span class="si">{</span><span class="n">list_name</span><span class="si">}</span><span class="s2">&#39; deleted.&quot;</span><span class="p">}),</span> <span class="mi">200</span></tt>
            </div>
            <div id="l2098"
               class="code sev- "><tt><i>2098</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2099"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>2099</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting vocabulary list </span><span class="si">{</span><span class="n">list_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2100"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2100</i>         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to delete vocabulary list.&quot;</span><span class="p">}),</span> <span class="mi">500</span></tt>
            </div>
            <div id="l2101"
               class="code sev- "><tt><i>2101</i> &nbsp;</tt>
            </div>
            <div id="l2102"
               class="code sev- "><tt><i>2102</i> &nbsp;</tt>
            </div>
            <div id="l2103"
               class="code sev- "><tt><i>2103</i> <span class="c1"># --- &lt;&lt;&lt; REVISED &gt;&gt;&gt; Main Game View Route ---</span></tt>
            </div>
            <div id="l2104"
               class="code sev- "><tt><i>2104</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/game&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2105"
               class="code sev- "><tt><i>2105</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2106"
               class="code sev- "><tt><i>2106</i> <span class="k">def</span><span class="w"> </span><span class="nf">game_view</span><span class="p">():</span></tt>
            </div>
            <div id="l2107"
               class="code sev- "><tt><i>2107</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2108"
               class="code sev- "><tt><i>2108</i>     <span class="n">char_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">)</span></tt>
            </div>
            <div id="l2109"
               class="code sev- "><tt><i>2109</i> &nbsp;</tt>
            </div>
            <div id="l2110"
               class="code sev- "><tt><i>2110</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2111"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2111</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No character is currently loaded. Please select one from your profile.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2112"
               class="code sev- "><tt><i>2112</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2113"
               class="code sev- "><tt><i>2113</i> &nbsp;</tt>
            </div>
            <div id="l2114"
               class="code sev- "><tt><i>2114</i>     <span class="c1"># Load character data fresh on each interaction for consistency</span></tt>
            </div>
            <div id="l2115"
               class="code sev- "><tt><i>2115</i>     <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2116"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2116</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span> <span class="c1"># Handle case where character fails to load</span></tt>
            </div>
            <div id="l2117"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2117</i>         <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Clear invalid character ID from session</span></tt>
            </div>
            <div id="l2118"
               class="code sev- "><tt><i>2118</i>         <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2119"
               class="code sev- "><tt><i>2119</i>         <span class="c1"># load_character_data should have flashed an error</span></tt>
            </div>
            <div id="l2120"
               class="code sev- "><tt><i>2120</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2121"
               class="code sev- "><tt><i>2121</i> &nbsp;</tt>
            </div>
            <div id="l2122"
               class="code sev- "><tt><i>2122</i>     <span class="c1"># --- Sync Session State with Loaded Character Data ---</span></tt>
            </div>
            <div id="l2123"
               class="code sev- "><tt><i>2123</i>     <span class="c1"># Ensure session reflects persistent data, especially logs</span></tt>
            </div>
            <div id="l2124"
               class="code sev- "><tt><i>2124</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2125"
               class="code sev- "><tt><i>2125</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2126"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2126</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_location&#39;</span><span class="p">,</span> <span class="n">STARTING_LOCATION</span><span class="p">)</span></tt>
            </div>
            <div id="l2127"
               class="code sev- "><tt><i>2127</i>     <span class="c1"># Ensure temporary session states are also loaded or defaulted</span></tt>
            </div>
            <div id="l2128"
               class="code sev- "><tt><i>2128</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2129"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>2129</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2130"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2130</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2131"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2131</i>     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2132"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2132</i>     <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Mark session as modified after sync</span></tt>
            </div>
            <div id="l2133"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2133</i>     <span class="n">curr_loc</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LOCATION</span><span class="p">]</span> <span class="c1"># Use local variable for current location</span></tt>
            </div>
            <div id="l2134"
               class="code sev- "><tt><i>2134</i> &nbsp;</tt>
            </div>
            <div id="l2135"
               class="code sev- "><tt><i>2135</i>     <span class="c1"># --- POST Request Handling (Player Action) ---</span></tt>
            </div>
            <div id="l2136"
               class="code sev- "><tt><i>2136</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2137"
               class="code sev- "><tt><i>2137</i>         <span class="n">p_input</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_input&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></tt>
            </div>
            <div id="l2138"
               class="code sev- "><tt><i>2138</i>         <span class="n">conv_log</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2139"
               class="code sev- "><tt><i>2139</i>         <span class="n">chapter_inputs_log</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2140"
               class="code sev- "><tt><i>2140</i>         <span class="n">eoc_prompted</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2141"
               class="code sev- "><tt><i>2141</i>         <span class="n">side_quest_active</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2142"
               class="code sev- "><tt><i>2142</i> &nbsp;</tt>
            </div>
            <div id="l2143"
               class="code sev- "><tt><i>2143</i>         <span class="c1"># --- Input Validation ---</span></tt>
            </div>
            <div id="l2144"
               class="code sev- "><tt><i>2144</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">p_input</span><span class="p">:</span></tt>
            </div>
            <div id="l2145"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2145</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span> <span class="c1"># Ignore empty input silently</span></tt>
            </div>
            <div id="l2146"
               class="code sev- "><tt><i>2146</i>         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_INPUT_LENGTH</span><span class="p">:</span></tt>
            </div>
            <div id="l2147"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>2147</i>             <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Input too long (Max </span><span class="si">{</span><span class="n">MAX_INPUT_LENGTH</span><span class="si">}</span><span class="s2">). Be concise.&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2148"
               class="code sev- "><tt><i>2148</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span></tt>
            </div>
            <div id="l2149"
               class="code sev- "><tt><i>2149</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2150"
               class="code sev- "><tt><i>2150</i>             <span class="c1"># Update persistent log too</span></tt>
            </div>
            <div id="l2151"
               class="code sev- "><tt><i>2151</i>             <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l2152"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2152</i>             <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span> <span class="c1"># Save after adding system message</span></tt>
            </div>
            <div id="l2153"
               class="code sev- "><tt><i>2153</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2154"
               class="code sev- "><tt><i>2154</i> &nbsp;</tt>
            </div>
            <div id="l2155"
               class="code sev- "><tt><i>2155</i>         <span class="c1"># --- Handle EOC Prompt Response ---</span></tt>
            </div>
            <div id="l2156"
               class="code sev- "><tt><i>2156</i>         <span class="k">if</span> <span class="n">eoc_prompted</span><span class="p">:</span></tt>
            </div>
            <div id="l2157"
               class="code sev- "><tt><i>2157</i>             <span class="n">clean_input</span> <span class="o">=</span> <span class="n">p_input</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></tt>
            </div>
            <div id="l2158"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2158</i>             <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Reset flag regardless of answer</span></tt>
            </div>
            <div id="l2159"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2159</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Reset session flag too</span></tt>
            </div>
            <div id="l2160"
               class="code sev- "><tt><i>2160</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2161"
               class="code sev- "><tt><i>2161</i> &nbsp;</tt>
            </div>
            <div id="l2162"
               class="code sev- "><tt><i>2162</i>             <span class="k">if</span> <span class="n">clean_input</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2163"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2163</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> accepted AI-suggested EOC for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2164"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2164</i>                 <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset turn count for EOC</span></tt>
            </div>
            <div id="l2165"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2165</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;START&#39;</span> <span class="c1"># Set session state to start EOC</span></tt>
            </div>
            <div id="l2166"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2166</i>                 <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span> <span class="c1"># Save reset flag/turn count</span></tt>
            </div>
            <div id="l2167"
               class="code sev- "><tt><i>2167</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2168"
               class="code sev- "><tt><i>2168</i>             <span class="k">elif</span> <span class="n">clean_input</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2169"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2169</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> declined AI-suggested EOC for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2170"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2170</i>                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span> <span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Okay, continuing the adventure!&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2171"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2171</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span> <span class="c1"># Update session log</span></tt>
            </div>
            <div id="l2172"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2172</i>                 <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span> <span class="c1"># Update persistent log</span></tt>
            </div>
            <div id="l2173"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2173</i>                 <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span> <span class="c1"># Save reset flag &amp; message</span></tt>
            </div>
            <div id="l2174"
               class="code sev- "><tt><i>2174</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2175"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2175</i>             <span class="k">else</span><span class="p">:</span> <span class="c1"># Ambiguous response</span></tt>
            </div>
            <div id="l2176"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2176</i>                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span> <span class="s2">&quot;Player&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">})</span> <span class="c1"># Log their input</span></tt>
            </div>
            <div id="l2177"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (100 > 79 characters)</li>

               </ul><tt><i>2177</i>                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span> <span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Please respond with &#39;yes&#39; or &#39;no&#39;.&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2178"
               class="code sev- "><tt><i>2178</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span></tt>
            </div>
            <div id="l2179"
               class="code sev- "><tt><i>2179</i>                 <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l2180"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>2180</i>                 <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Re-prompt by setting flag back</span></tt>
            </div>
            <div id="l2181"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2181</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Re-prompt by setting flag back</span></tt>
            </div>
            <div id="l2182"
               class="code sev- "><tt><i>2182</i>                 <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2183"
               class="code sev- "><tt><i>2183</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2184"
               class="code sev- "><tt><i>2184</i> &nbsp;</tt>
            </div>
            <div id="l2185"
               class="code sev- "><tt><i>2185</i>         <span class="c1"># --- Handle Player Side Quest Input ---</span></tt>
            </div>
            <div id="l2186"
               class="code sev- "><tt><i>2186</i>         <span class="k">if</span> <span class="n">side_quest_active</span><span class="p">:</span></tt>
            </div>
            <div id="l2187"
               class="code sev- "><tt><i>2187</i>             <span class="n">side_quest_desc</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">)</span></tt>
            </div>
            <div id="l2188"
               class="code sev- "><tt><i>2188</i>             <span class="n">side_quest_turns</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2189"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2189</i>             <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;Player&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">})</span></tt>
            </div>
            <div id="l2190"
               class="code sev- "><tt><i>2190</i> &nbsp;</tt>
            </div>
            <div id="l2191"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2191</i>             <span class="k">if</span> <span class="n">side_quest_desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Player defining task</span></tt>
            </div>
            <div id="l2192"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2192</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> proposing side quest: </span><span class="si">{</span><span class="n">p_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2193"
               class="code sev- "><tt><i>2193</i>                 <span class="n">ai_context_sideq</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;player_sidequest_idea&#39;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">}</span></tt>
            </div>
            <div id="l2194"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E201
                     </span>
                     Whitespace after '{'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (144 > 79 characters)</li>

               </ul><tt><i>2194</i>                 <span class="n">ai_context_sideq</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="n">k</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;current_location&#39;</span><span class="p">]})</span></tt>
            </div>
            <div id="l2195"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2195</i>                 <span class="n">ai_resp_json</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;PROCESS_PLAYER_SIDEQUEST_IDEA&quot;</span><span class="p">,</span> <span class="n">ai_context_sideq</span><span class="p">)</span></tt>
            </div>
            <div id="l2196"
               class="code sev- "><tt><i>2196</i> &nbsp;</tt>
            </div>
            <div id="l2197"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2197</i>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_resp_json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;side_quest_objective&#39;</span> <span class="ow">in</span> <span class="n">ai_resp_json</span><span class="p">:</span></tt>
            </div>
            <div id="l2198"
               class="code sev- "><tt><i>2198</i>                     <span class="n">new_desc</span> <span class="o">=</span> <span class="n">ai_resp_json</span><span class="p">[</span><span class="s1">&#39;side_quest_objective&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l2199"
               class="code sev- "><tt><i>2199</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_desc</span></tt>
            </div>
            <div id="l2200"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2200</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Start turn count</span></tt>
            </div>
            <div id="l2201"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>2201</i>                     <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Task: </span><span class="si">{</span><span class="n">new_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2202"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2202</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> starting side quest: </span><span class="si">{</span><span class="n">new_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2203"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2203</i>                 <span class="k">else</span><span class="p">:</span> <span class="c1"># Failed processing</span></tt>
            </div>
            <div id="l2204"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (156 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2204</i>                     <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Let&#39;s try simpler. What would you like to observe or interact with briefly?&quot;</span><span class="p">})</span> <span class="c1"># Ask again</span></tt>
            </div>
            <div id="l2205"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>2205</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process side quest idea for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">ai_resp_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2206"
               class="code sev- "><tt><i>2206</i> &nbsp;</tt>
            </div>
            <div id="l2207"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2207</i>             <span class="k">else</span><span class="p">:</span> <span class="c1"># Player performing task</span></tt>
            </div>
            <div id="l2208"
               class="code sev- "><tt><i>2208</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">]</span> <span class="o">=</span> <span class="n">side_quest_turns</span> <span class="o">+</span> <span class="mi">1</span></tt>
            </div>
            <div id="l2209"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>2209</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> side quest &#39;</span><span class="si">{</span><span class="n">side_quest_desc</span><span class="si">}</span><span class="s2">&#39; (Turn </span><span class="si">{</span><span class="n">side_quest_turns</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2210"
               class="code sev- "><tt><i>2210</i>                 <span class="c1"># Use INTERPRET_COMMAND for side quest actions</span></tt>
            </div>
            <div id="l2211"
               class="code sev- "><tt><i>2211</i>                 <span class="n">ai_context_action</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2212"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>2212</i>                     <span class="s1">&#39;player_name&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span> <span class="s1">&#39;player_race&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2213"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>2213</i>                     <span class="s1">&#39;player_class&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span> <span class="s1">&#39;player_philosophy&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2214"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (119 > 79 characters)</li>

               </ul><tt><i>2214</i>                     <span class="s1">&#39;player_abilities&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,[]),</span> <span class="s1">&#39;player_fate_points&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span></tt>
            </div>
            <div id="l2215"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2215</i>                     <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">curr_loc</span><span class="p">,</span> <span class="s1">&#39;location_data&#39;</span><span class="p">:</span> <span class="n">world_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{}),</span></tt>
            </div>
            <div id="l2216"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2216</i>                     <span class="s1">&#39;thetopia_location_lore&#39;</span><span class="p">:</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{}),</span></tt>
            </div>
            <div id="l2217"
               class="code sev- "><tt><i>2217</i>                     <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">,</span></tt>
            </div>
            <div id="l2218"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>2218</i>                     <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="s1">&#39;(Side Quest)&#39;</span><span class="p">,</span> <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="n">side_quest_desc</span></tt>
            </div>
            <div id="l2219"
               class="code sev- "><tt><i>2219</i>                 <span class="p">}</span></tt>
            </div>
            <div id="l2220"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2220</i>                 <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INTERPRET_COMMAND&quot;</span><span class="p">,</span> <span class="n">ai_context_action</span><span class="p">)</span></tt>
            </div>
            <div id="l2221"
               class="code sev- "><tt><i>2221</i>                 <span class="k">if</span> <span class="n">ai_resp</span><span class="p">:</span></tt>
            </div>
            <div id="l2222"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2222</i>                     <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">ai_resp</span><span class="p">})</span></tt>
            </div>
            <div id="l2223"
               class="code sev- "><tt><i>2223</i> &nbsp;</tt>
            </div>
            <div id="l2224"
               class="code sev- "><tt><i>2224</i>                 <span class="c1"># Check if side quest should end (e.g., after 3 turns)</span></tt>
            </div>
            <div id="l2225"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2225</i>                 <span class="c1"># Consider adding an AI check EVALUATE_SIDEQUEST_COMPLETION later if needed</span></tt>
            </div>
            <div id="l2226"
               class="code sev- "><tt><i>2226</i>                 <span class="n">side_quest_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span></tt>
            </div>
            <div id="l2227"
               class="code sev- "><tt><i>2227</i>                 <span class="k">if</span> <span class="n">side_quest_done</span><span class="p">:</span></tt>
            </div>
            <div id="l2228"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (138 > 79 characters)</li>

               </ul><tt><i>2228</i>                      <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Finished with that detour. Now, let&#39;s reflect on the main chapter...&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2229"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2229</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> completed side quest: </span><span class="si">{</span><span class="n">side_quest_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2230"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2230</i>                      <span class="c1"># Clear side quest state from session</span></tt>
            </div>
            <div id="l2231"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2231</i>                      <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2232"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2232</i>                      <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2233"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2233</i>                      <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2234"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2234</i>                      <span class="c1"># Start EOC flow</span></tt>
            </div>
            <div id="l2235"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2235</i>                      <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;START&#39;</span></tt>
            </div>
            <div id="l2236"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2236</i>                      <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset main turn count for EOC</span></tt>
            </div>
            <div id="l2237"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2237</i>                      <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span> <span class="c1"># Save log</span></tt>
            </div>
            <div id="l2238"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2238</i>                      <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2239"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2239</i>                      <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2240"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>2240</i>                      <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span> <span class="c1"># Go straight to EOC</span></tt>
            </div>
            <div id="l2241"
               class="code sev- "><tt><i>2241</i> &nbsp;</tt>
            </div>
            <div id="l2242"
               class="code sev- "><tt><i>2242</i>             <span class="c1"># Save and redirect if side quest not finished</span></tt>
            </div>
            <div id="l2243"
               class="code sev- "><tt><i>2243</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l2244"
               class="code sev- "><tt><i>2244</i>             <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span></tt>
            </div>
            <div id="l2245"
               class="code sev- "><tt><i>2245</i>             <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2246"
               class="code sev- "><tt><i>2246</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2247"
               class="code sev- "><tt><i>2247</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2248"
               class="code sev- "><tt><i>2248</i> &nbsp;</tt>
            </div>
            <div id="l2249"
               class="code sev- "><tt><i>2249</i>         <span class="c1"># --- Process Normal Game Command ---</span></tt>
            </div>
            <div id="l2250"
               class="code sev- "><tt><i>2250</i>         <span class="c1"># Log player input</span></tt>
            </div>
            <div id="l2251"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2251</i>         <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;Player&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">})</span></tt>
            </div>
            <div id="l2252"
               class="code sev- "><tt><i>2252</i>         <span class="n">chapter_inputs_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_input</span><span class="p">)</span></tt>
            </div>
            <div id="l2253"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2253</i>         <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">chapter_inputs_log</span> <span class="c1"># Update session log</span></tt>
            </div>
            <div id="l2254"
               class="code sev- "><tt><i>2254</i>         <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turn_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></tt>
            </div>
            <div id="l2255"
               class="code sev- "><tt><i>2255</i>         <span class="n">turn_num</span> <span class="o">=</span> <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l2256"
               class="code sev- "><tt><i>2256</i> &nbsp;</tt>
            </div>
            <div id="l2257"
               class="code sev- "><tt><i>2257</i>         <span class="c1"># --- Vocabulary XP Calculation ---</span></tt>
            </div>
            <div id="l2258"
               class="code sev- "><tt><i>2258</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2259"
               class="code sev- "><tt><i>2259</i>             <span class="c1"># Ensure learned_vocab exists and is a set</span></tt>
            </div>
            <div id="l2260"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2260</i>             <span class="k">if</span> <span class="s1">&#39;learned_vocab&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">):</span></tt>
            </div>
            <div id="l2261"
               class="code sev- "><tt><i>2261</i>                 <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></tt>
            </div>
            <div id="l2262"
               class="code sev- "><tt><i>2262</i>             <span class="c1"># Calculate XP and update learned words</span></tt>
            </div>
            <div id="l2263"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2263</i>             <span class="n">player_xp_gain</span><span class="p">,</span> <span class="n">new_awl_words</span> <span class="o">=</span> <span class="n">calculate_xp</span><span class="p">(</span><span class="n">p_input</span><span class="p">,</span> <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2264"
               class="code sev- "><tt><i>2264</i>             <span class="k">if</span> <span class="n">new_awl_words</span><span class="p">:</span></tt>
            </div>
            <div id="l2265"
               class="code sev- "><tt><i>2265</i>                 <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_awl_words</span><span class="p">)</span></tt>
            </div>
            <div id="l2266"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

               </ul><tt><i>2266</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> learned new AWL words: </span><span class="si">{</span><span class="n">new_awl_words</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2267"
               class="code sev- "><tt><i>2267</i>             <span class="c1"># Update player profile XP in Firestore if gain &gt; 0</span></tt>
            </div>
            <div id="l2268"
               class="code sev- "><tt><i>2268</i>             <span class="k">if</span> <span class="n">player_xp_gain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></tt>
            </div>
            <div id="l2269"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2269</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> gained </span><span class="si">{</span><span class="n">player_xp_gain</span><span class="si">}</span><span class="s2"> Player XP this turn.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2270"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2270</i>                  <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2271"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2271</i>                      <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span></tt>
            </div>
            <div id="l2272"
               class="code sev- "><tt><i>2272</i>                          <span class="s1">&#39;total_player_xp&#39;</span><span class="p">:</span> <span class="n">firestore</span><span class="o">.</span><span class="n">Increment</span><span class="p">(</span><span class="n">player_xp_gain</span><span class="p">)</span></tt>
            </div>
            <div id="l2273"
               class="code sev- "><tt><i>2273</i>                      <span class="p">})</span></tt>
            </div>
            <div id="l2274"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2274</i>                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">xp_err</span><span class="p">:</span></tt>
            </div>
            <div id="l2275"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>2275</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update Player XP in Firestore for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">xp_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2276"
               class="code sev- "><tt><i>2276</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">vocab_err</span><span class="p">:</span></tt>
            </div>
            <div id="l2277"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>2277</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during vocabulary XP calculation: </span><span class="si">{</span><span class="n">vocab_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2278"
               class="code sev- "><tt><i>2278</i> &nbsp;</tt>
            </div>
            <div id="l2279"
               class="code sev- "><tt><i>2279</i>         <span class="c1"># --- Build AI Context ---</span></tt>
            </div>
            <div id="l2280"
               class="code sev- "><tt><i>2280</i>         <span class="c1"># Combine relevant player, location, and quest data</span></tt>
            </div>
            <div id="l2281"
               class="code sev- "><tt><i>2281</i>         <span class="n">ai_context</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2282"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2282</i>             <span class="s1">&#39;player_name&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2283"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2283</i>             <span class="s1">&#39;player_race&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2284"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2284</i>             <span class="s1">&#39;player_class&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2285"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2285</i>             <span class="s1">&#39;player_philosophy&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2286"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2286</i>             <span class="s1">&#39;player_abilities&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,[]),</span></tt>
            </div>
            <div id="l2287"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2287</i>             <span class="s1">&#39;player_aspects&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aspects&#39;</span><span class="p">,[]),</span> <span class="c1"># Include aspects</span></tt>
            </div>
            <div id="l2288"
               class="code sev- "><tt><i>2288</i>             <span class="s1">&#39;player_fate_points&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span></tt>
            </div>
            <div id="l2289"
               class="code sev- "><tt><i>2289</i>             <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">curr_loc</span><span class="p">,</span></tt>
            </div>
            <div id="l2290"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2290</i>             <span class="s1">&#39;location_data&#39;</span><span class="p">:</span> <span class="n">world_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{}),</span> <span class="c1"># Exits, etc.</span></tt>
            </div>
            <div id="l2291"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2291</i>             <span class="s1">&#39;thetopia_location_lore&#39;</span><span class="p">:</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{}),</span> <span class="c1"># Desc, NPCs</span></tt>
            </div>
            <div id="l2292"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2292</i>             <span class="s1">&#39;thetopia_general_lore&#39;</span><span class="p">:</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setting&#39;</span><span class="p">,{}),</span> <span class="c1"># World context</span></tt>
            </div>
            <div id="l2293"
               class="code sev- "><tt><i>2293</i>             <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">,</span></tt>
            </div>
            <div id="l2294"
               class="code sev- "><tt><i>2294</i>             <span class="s1">&#39;current_quest_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2295"
               class="code sev- "><tt><i>2295</i>             <span class="s1">&#39;current_step_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2296"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2296</i>             <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2297"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2297</i>             <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2298"
               class="code sev- "><tt><i>2298</i>         <span class="p">}</span></tt>
            </div>
            <div id="l2299"
               class="code sev- "><tt><i>2299</i> &nbsp;</tt>
            </div>
            <div id="l2300"
               class="code sev- "><tt><i>2300</i>         <span class="c1"># --- Command Processing ---</span></tt>
            </div>
            <div id="l2301"
               class="code sev- "><tt><i>2301</i>         <span class="n">parts</span> <span class="o">=</span> <span class="n">p_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l2302"
               class="code sev- "><tt><i>2302</i>         <span class="n">verb</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l2303"
               class="code sev- "><tt><i>2303</i>         <span class="n">target</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l2304"
               class="code sev- "><tt><i>2304</i>         <span class="n">ai_resp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l2305"
               class="code sev- "><tt><i>2305</i>         <span class="n">needs_desc_after_move</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2306"
               class="code sev- "><tt><i>2306</i>         <span class="n">chapter_ended</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2307"
               class="code sev- "><tt><i>2307</i>         <span class="n">step_completed_this_turn</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2308"
               class="code sev- "><tt><i>2308</i> &nbsp;</tt>
            </div>
            <div id="l2309"
               class="code sev- "><tt><i>2309</i>         <span class="c1"># Movement</span></tt>
            </div>
            <div id="l2310"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 13 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>2310</i>         <span class="k">if</span> <span class="n">verb</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;go&quot;</span><span class="p">,</span><span class="s2">&quot;move&quot;</span><span class="p">,</span><span class="s2">&quot;n&quot;</span><span class="p">,</span><span class="s2">&quot;s&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">,</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;north&quot;</span><span class="p">,</span><span class="s2">&quot;south&quot;</span><span class="p">,</span><span class="s2">&quot;east&quot;</span><span class="p">,</span><span class="s2">&quot;west&quot;</span><span class="p">,</span><span class="s2">&quot;up&quot;</span><span class="p">,</span><span class="s2">&quot;down&quot;</span><span class="p">]:</span></tt>
            </div>
            <div id="l2311"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2311</i>             <span class="n">direction</span> <span class="o">=</span> <span class="n">target</span> <span class="k">if</span> <span class="n">verb</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;go&quot;</span><span class="p">,</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">verb</span></tt>
            </div>
            <div id="l2312"
               class="code sev- "><tt><i>2312</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span></tt>
            </div>
            <div id="l2313"
               class="code sev- "><tt><i>2313</i>                 <span class="n">ai_resp</span> <span class="o">=</span> <span class="s2">&quot;Which direction would you like to go?&quot;</span></tt>
            </div>
            <div id="l2314"
               class="code sev- "><tt><i>2314</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2315"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

               </ul><tt><i>2315</i>                 <span class="n">exits</span> <span class="o">=</span> <span class="n">world_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exits&quot;</span><span class="p">,{})</span></tt>
            </div>
            <div id="l2316"
               class="code sev- "><tt><i>2316</i>                 <span class="c1"># Normalize direction</span></tt>
            </div>
            <div id="l2317"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2317</i>                 <span class="n">norm_d</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Take first word</span></tt>
            </div>
            <div id="l2318"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 6 places)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 5 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2318</i>                 <span class="n">d_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="s1">&#39;north&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="s1">&#39;south&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">:</span><span class="s1">&#39;east&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="s1">&#39;west&#39;</span><span class="p">,</span><span class="s1">&#39;u&#39;</span><span class="p">:</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="s1">&#39;down&#39;</span><span class="p">}</span></tt>
            </div>
            <div id="l2319"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2319</i>                 <span class="n">final_d</span> <span class="o">=</span> <span class="n">d_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">norm_d</span><span class="p">,</span> <span class="n">norm_d</span><span class="p">)</span> <span class="c1"># Map abbreviations</span></tt>
            </div>
            <div id="l2320"
               class="code sev- "><tt><i>2320</i>                 <span class="c1"># Check if exit exists</span></tt>
            </div>
            <div id="l2321"
               class="code sev- "><tt><i>2321</i>                 <span class="k">if</span> <span class="n">final_d</span> <span class="ow">in</span> <span class="n">exits</span><span class="p">:</span></tt>
            </div>
            <div id="l2322"
               class="code sev- "><tt><i>2322</i>                     <span class="n">new_loc</span> <span class="o">=</span> <span class="n">exits</span><span class="p">[</span><span class="n">final_d</span><span class="p">]</span></tt>
            </div>
            <div id="l2323"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2323</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_loc</span> <span class="c1"># Update character data</span></tt>
            </div>
            <div id="l2324"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2324</i>                     <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_loc</span> <span class="c1"># Update session</span></tt>
            </div>
            <div id="l2325"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2325</i>                     <span class="n">curr_loc</span> <span class="o">=</span> <span class="n">new_loc</span> <span class="c1"># Update local variable for this request</span></tt>
            </div>
            <div id="l2326"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2326</i>                     <span class="n">ai_resp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You move </span><span class="si">{</span><span class="n">final_d</span><span class="si">}</span><span class="s2">...&quot;</span> <span class="c1"># Simple confirmation</span></tt>
            </div>
            <div id="l2327"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2327</i>                     <span class="n">needs_desc_after_move</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Flag to get description later</span></tt>
            </div>
            <div id="l2328"
               class="code sev- "><tt><i>2328</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2329"
               class="code sev- "><tt><i>2329</i>                     <span class="c1"># Invalid direction, ask AI to explain</span></tt>
            </div>
            <div id="l2330"
               class="code sev- "><tt><i>2330</i>                     <span class="n">ctx_move</span> <span class="o">=</span> <span class="n">ai_context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l2331"
               class="code sev- "><tt><i>2331</i>                     <span class="n">ctx_move</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_d</span></tt>
            </div>
            <div id="l2332"
               class="code sev- "><tt><i>2332</i>                     <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INVALID_DIRECTION&quot;</span><span class="p">,</span> <span class="n">ctx_move</span><span class="p">)</span></tt>
            </div>
            <div id="l2333"
               class="code sev- "><tt><i>2333</i> &nbsp;</tt>
            </div>
            <div id="l2334"
               class="code sev- "><tt><i>2334</i>         <span class="c1"># Ability Use</span></tt>
            </div>
            <div id="l2335"
               class="code sev- "><tt><i>2335</i>         <span class="k">elif</span> <span class="n">verb</span> <span class="o">==</span> <span class="s2">&quot;use&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l2336"
               class="code sev- "><tt><i>2336</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span></tt>
            </div>
            <div id="l2337"
               class="code sev- "><tt><i>2337</i>                 <span class="n">ai_resp</span> <span class="o">=</span> <span class="s2">&quot;Use what ability?&quot;</span></tt>
            </div>
            <div id="l2338"
               class="code sev- "><tt><i>2338</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2339"
               class="code sev- "><tt><i>2339</i>                 <span class="n">abil_input</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></tt>
            </div>
            <div id="l2340"
               class="code sev- "><tt><i>2340</i>                 <span class="c1"># Normalize ability name (handle case variations)</span></tt>
            </div>
            <div id="l2341"
               class="code sev- "><tt><i>2341</i>                 <span class="n">norm_abil</span> <span class="o">=</span> <span class="n">ABILITY_NAME_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">abil_input</span><span class="p">)</span> <span class="ow">or</span> \</tt>
            </div>
            <div id="l2342"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E127
                     </span>
                     Continuation line over-indented for visual indent</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

               </ul><tt><i>2342</i>                             <span class="nb">next</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ABILITY_NAME_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">abil_input</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \</tt>
            </div>
            <div id="l2343"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E127
                     </span>
                     Continuation line over-indented for visual indent</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2343</i>                             <span class="n">abil_input</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="c1"># Fallback to capitalized input</span></tt>
            </div>
            <div id="l2344"
               class="code sev- "><tt><i>2344</i>                 <span class="c1"># Check if player has the ability</span></tt>
            </div>
            <div id="l2345"
               class="code sev- "><tt><i>2345</i>                 <span class="k">if</span> <span class="n">norm_abil</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;abilities&#39;</span><span class="p">,</span> <span class="p">[]):</span></tt>
            </div>
            <div id="l2346"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2346</i>                     <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Your character does not have the ability &#39;</span><span class="si">{</span><span class="n">norm_abil</span><span class="si">}</span><span class="s2">&#39;.&quot;</span></tt>
            </div>
            <div id="l2347"
               class="code sev- "><tt><i>2347</i>                     <span class="n">ctx_abil</span> <span class="o">=</span> <span class="n">ai_context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l2348"
               class="code sev- "><tt><i>2348</i>                     <span class="n">ctx_abil</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="n">norm_abil</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">})</span></tt>
            </div>
            <div id="l2349"
               class="code sev- "><tt><i>2349</i>                     <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INVALID_ABILITY&quot;</span><span class="p">,</span> <span class="n">ctx_abil</span><span class="p">)</span></tt>
            </div>
            <div id="l2350"
               class="code sev- "><tt><i>2350</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2351"
               class="code sev- "><tt><i>2351</i>                     <span class="c1"># Valid ability, ask AI to process</span></tt>
            </div>
            <div id="l2352"
               class="code sev- "><tt><i>2352</i>                     <span class="n">ctx_abil</span> <span class="o">=</span> <span class="n">ai_context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l2353"
               class="code sev- "><tt><i>2353</i>                     <span class="n">ctx_abil</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ability&quot;</span><span class="p">:</span> <span class="n">norm_abil</span><span class="p">})</span></tt>
            </div>
            <div id="l2354"
               class="code sev- "><tt><i>2354</i>                     <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;PROCESS_ABILITY_USE&quot;</span><span class="p">,</span> <span class="n">ctx_abil</span><span class="p">)</span></tt>
            </div>
            <div id="l2355"
               class="code sev- "><tt><i>2355</i> &nbsp;</tt>
            </div>
            <div id="l2356"
               class="code sev- "><tt><i>2356</i>         <span class="c1"># Look</span></tt>
            </div>
            <div id="l2357"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2357</i>         <span class="k">elif</span> <span class="n">verb</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;look&quot;</span><span class="p">,</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;examine&quot;</span><span class="p">]:</span></tt>
            </div>
            <div id="l2358"
               class="code sev- "><tt><i>2358</i>             <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;GET_DESCRIPTION&quot;</span><span class="p">,</span> <span class="n">ai_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2359"
               class="code sev- "><tt><i>2359</i> &nbsp;</tt>
            </div>
            <div id="l2360"
               class="code sev- "><tt><i>2360</i>         <span class="c1"># Journal Shortcuts</span></tt>
            </div>
            <div id="l2361"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

               </ul><tt><i>2361</i>         <span class="k">elif</span> <span class="n">verb</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sheet&quot;</span><span class="p">,</span><span class="s2">&quot;char&quot;</span><span class="p">,</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;inventory&quot;</span><span class="p">,</span> <span class="s2">&quot;inv&quot;</span><span class="p">]:</span></tt>
            </div>
            <div id="l2362"
               class="code sev- "><tt><i>2362</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;journal_char_quest&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2363"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 6 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2363</i>         <span class="k">elif</span> <span class="n">verb</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">,</span><span class="s2">&quot;quest&quot;</span><span class="p">,</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;vocab&quot;</span><span class="p">,</span><span class="s2">&quot;words&quot;</span><span class="p">,</span><span class="s2">&quot;report&quot;</span><span class="p">,</span><span class="s2">&quot;reports&quot;</span><span class="p">]:</span></tt>
            </div>
            <div id="l2364"
               class="code sev- "><tt><i>2364</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;journal_vocab_report&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2365"
               class="code sev- "><tt><i>2365</i> &nbsp;</tt>
            </div>
            <div id="l2366"
               class="code sev- "><tt><i>2366</i>         <span class="c1"># Default Interpretation (any other input)</span></tt>
            </div>
            <div id="l2367"
               class="code sev- "><tt><i>2367</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2368"
               class="code sev- "><tt><i>2368</i>             <span class="n">ai_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INTERPRET_COMMAND&quot;</span><span class="p">,</span> <span class="n">ai_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2369"
               class="code sev- "><tt><i>2369</i> &nbsp;</tt>
            </div>
            <div id="l2370"
               class="code sev- "><tt><i>2370</i>         <span class="c1"># Log AI response if generated</span></tt>
            </div>
            <div id="l2371"
               class="code sev- "><tt><i>2371</i>         <span class="k">if</span> <span class="n">ai_resp</span><span class="p">:</span></tt>
            </div>
            <div id="l2372"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2372</i>             <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">ai_resp</span><span class="p">})</span></tt>
            </div>
            <div id="l2373"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>2373</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai_resp</span> <span class="c1"># Store last output for potential AI check</span></tt>
            </div>
            <div id="l2374"
               class="code sev- "><tt><i>2374</i> &nbsp;</tt>
            </div>
            <div id="l2375"
               class="code sev- "><tt><i>2375</i>         <span class="c1"># --- Quest Step Completion Check ---</span></tt>
            </div>
            <div id="l2376"
               class="code sev- "><tt><i>2376</i>         <span class="n">q_id</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2377"
               class="code sev- "><tt><i>2377</i>         <span class="n">s_id</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2378"
               class="code sev- "><tt><i>2378</i>         <span class="n">step_done</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2379"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2379</i>         <span class="k">if</span> <span class="n">q_id</span> <span class="ow">and</span> <span class="n">s_id</span><span class="p">:</span> <span class="c1"># Only check if on a quest step</span></tt>
            </div>
            <div id="l2380"
               class="code sev- "><tt><i>2380</i>             <span class="n">current_step_data</span> <span class="o">=</span> <span class="n">get_quest_step</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="n">s_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2381"
               class="code sev- "><tt><i>2381</i>             <span class="k">if</span> <span class="n">current_step_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2382"
               class="code sev- "><tt><i>2382</i>                 <span class="c1"># Check simple state/inventory triggers first</span></tt>
            </div>
            <div id="l2383"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2383</i>                 <span class="n">is_complete_without_ai</span><span class="p">,</span> <span class="n">ai_check_criteria</span> <span class="o">=</span> <span class="n">check_step_completion</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="n">current_step_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2384"
               class="code sev- "><tt><i>2384</i>                 <span class="k">if</span> <span class="n">is_complete_without_ai</span><span class="p">:</span></tt>
            </div>
            <div id="l2385"
               class="code sev- "><tt><i>2385</i>                     <span class="n">step_done</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2386"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2386</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> of quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2"> completed via state/inventory check.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2387"
               class="code sev- "><tt><i>2387</i>                 <span class="k">elif</span> <span class="n">ai_check_criteria</span><span class="p">:</span></tt>
            </div>
            <div id="l2388"
               class="code sev- "><tt><i>2388</i>                     <span class="c1"># If simple checks fail but AI check is needed, call AI</span></tt>
            </div>
            <div id="l2389"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>2389</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing AI Check for step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2">. Criteria: &#39;</span><span class="si">{</span><span class="n">ai_check_criteria</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2390"
               class="code sev- "><tt><i>2390</i>                     <span class="n">ai_eval_context</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2391"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2391</i>                         <span class="s1">&#39;step_description&#39;</span><span class="p">:</span> <span class="n">current_step_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2392"
               class="code sev- "><tt><i>2392</i>                         <span class="s1">&#39;player_action&#39;</span><span class="p">:</span> <span class="n">p_input</span><span class="p">,</span></tt>
            </div>
            <div id="l2393"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2393</i>                         <span class="s1">&#39;ai_outcome&#39;</span><span class="p">:</span> <span class="n">ai_resp</span> <span class="ow">or</span> <span class="s2">&quot;(No AI response this turn)&quot;</span><span class="p">,</span> <span class="c1"># Use last AI response</span></tt>
            </div>
            <div id="l2394"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2394</i>                         <span class="s1">&#39;ai_check_criteria&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;if the action fulfilled: &#39;</span><span class="si">{</span><span class="n">ai_check_criteria</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="c1"># Add context for AI</span></tt>
            </div>
            <div id="l2395"
               class="code sev- "><tt><i>2395</i>                         <span class="c1"># Pass basic player/location info for context</span></tt>
            </div>
            <div id="l2396"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2396</i>                         <span class="s1">&#39;player_name&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2397"
               class="code sev- "><tt><i>2397</i>                         <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">curr_loc</span></tt>
            </div>
            <div id="l2398"
               class="code sev- "><tt><i>2398</i>                     <span class="p">}</span></tt>
            </div>
            <div id="l2399"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2399</i>                     <span class="n">ai_eval_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;EVALUATE_STEP_COMPLETION&quot;</span><span class="p">,</span> <span class="n">ai_eval_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2400"
               class="code sev- "><tt><i>2400</i>                     <span class="c1"># Check if AI responded YES</span></tt>
            </div>
            <div id="l2401"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2401</i>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai_eval_resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ai_eval_resp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2402"
               class="code sev- "><tt><i>2402</i>                         <span class="n">step_done</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2403"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2403</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> of quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2"> completed via AI Check evaluating TRUE.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2404"
               class="code sev- "><tt><i>2404</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2405"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>2405</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Check for step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> evaluated FALSE or Error. AI Response: &#39;</span><span class="si">{</span><span class="n">ai_eval_resp</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2406"
               class="code sev- "><tt><i>2406</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2407"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2407</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find step data for current step: </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2408"
               class="code sev- "><tt><i>2408</i> &nbsp;</tt>
            </div>
            <div id="l2409"
               class="code sev- "><tt><i>2409</i>         <span class="c1"># --- Process Step Completion ---</span></tt>
            </div>
            <div id="l2410"
               class="code sev- "><tt><i>2410</i>         <span class="k">if</span> <span class="n">step_done</span><span class="p">:</span></tt>
            </div>
            <div id="l2411"
               class="code sev- "><tt><i>2411</i>             <span class="n">step_completed_this_turn</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2412"
               class="code sev- "><tt><i>2412</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing step completion for: </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2413"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2413</i>             <span class="n">step_data</span> <span class="o">=</span> <span class="n">get_quest_step</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="n">s_id</span><span class="p">)</span> <span class="c1"># Re-fetch step data</span></tt>
            </div>
            <div id="l2414"
               class="code sev- "><tt><i>2414</i>             <span class="k">if</span> <span class="n">step_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2415"
               class="code sev- "><tt><i>2415</i>                 <span class="c1"># Add system message for completion</span></tt>
            </div>
            <div id="l2416"
               class="code sev- "><tt><i>2416</i>                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span></tt>
            </div>
            <div id="l2417"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2417</i>                     <span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l2418"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2418</i>                     <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Objective Complete: &#39;</span><span class="si">{</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span><span class="s1">&#39;Objective Details Missing&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;!&quot;</span></tt>
            </div>
            <div id="l2419"
               class="code sev- "><tt><i>2419</i>                 <span class="p">})</span></tt>
            </div>
            <div id="l2420"
               class="code sev- "><tt><i>2420</i>                 <span class="c1"># Apply step reward</span></tt>
            </div>
            <div id="l2421"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>2421</i>                 <span class="n">reward_msg</span> <span class="o">=</span> <span class="n">apply_reward</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="n">step_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step_reward&quot;</span><span class="p">),</span> <span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2422"
               class="code sev- "><tt><i>2422</i>                 <span class="k">if</span> <span class="n">reward_msg</span><span class="p">:</span></tt>
            </div>
            <div id="l2423"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2423</i>                     <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">reward_msg</span><span class="p">})</span></tt>
            </div>
            <div id="l2424"
               class="code sev- "><tt><i>2424</i> &nbsp;</tt>
            </div>
            <div id="l2425"
               class="code sev- "><tt><i>2425</i>                 <span class="c1"># Determine next step or chapter end</span></tt>
            </div>
            <div id="l2426"
               class="code sev- "><tt><i>2426</i>                 <span class="n">next_s_id</span> <span class="o">=</span> <span class="n">step_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_step&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2427"
               class="code sev- "><tt><i>2427</i>                 <span class="n">step_was_major</span> <span class="o">=</span> <span class="n">step_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_major_plot_point&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2428"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2428</i>                 <span class="n">step_was_final</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_s_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># It&#39;s final if no next_step defined</span></tt>
            </div>
            <div id="l2429"
               class="code sev- "><tt><i>2429</i>                 <span class="n">inputs_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chapter_inputs_log</span><span class="p">)</span></tt>
            </div>
            <div id="l2430"
               class="code sev- "><tt><i>2430</i> &nbsp;</tt>
            </div>
            <div id="l2431"
               class="code sev- "><tt><i>2431</i>                 <span class="c1"># Check if this step triggers End-of-Chapter</span></tt>
            </div>
            <div id="l2432"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>2432</i>                 <span class="n">trigger_eoc_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_was_major</span> <span class="ow">or</span> <span class="n">step_was_final</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inputs_count</span> <span class="o">&gt;=</span> <span class="n">MIN_INPUTS_FOR_EOC</span></tt>
            </div>
            <div id="l2433"
               class="code sev- "><tt><i>2433</i> &nbsp;</tt>
            </div>
            <div id="l2434"
               class="code sev- "><tt><i>2434</i>                 <span class="k">if</span> <span class="n">trigger_eoc_condition</span><span class="p">:</span></tt>
            </div>
            <div id="l2435"
               class="code sev- "><tt><i>2435</i>                     <span class="k">if</span> <span class="n">step_was_major</span><span class="p">:</span></tt>
            </div>
            <div id="l2436"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>2436</i>                         <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;A significant moment in your journey...&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2437"
               class="code sev- "><tt><i>2437</i>                     <span class="k">if</span> <span class="n">step_was_final</span><span class="p">:</span></tt>
            </div>
            <div id="l2438"
               class="code sev- "><tt><i>2438</i>                         <span class="c1"># Apply final quest reward if this was the last step</span></tt>
            </div>
            <div id="l2439"
               class="code sev- "><tt><i>2439</i>                         <span class="n">quest_data</span> <span class="o">=</span> <span class="n">get_quest</span><span class="p">(</span><span class="n">q_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2440"
               class="code sev- "><tt><i>2440</i>                         <span class="k">if</span> <span class="n">quest_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2441"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>2441</i>                             <span class="n">final_reward_msg</span> <span class="o">=</span> <span class="n">apply_reward</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="n">quest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completion_reward&quot;</span><span class="p">),</span> <span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2442"
               class="code sev- "><tt><i>2442</i>                             <span class="k">if</span> <span class="n">final_reward_msg</span><span class="p">:</span></tt>
            </div>
            <div id="l2443"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2443</i>                                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">final_reward_msg</span><span class="p">})</span></tt>
            </div>
            <div id="l2444"
               class="code sev- "><tt><i>2444</i>                         <span class="c1"># Mark quest completed in flags</span></tt>
            </div>
            <div id="l2445"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2445</i>                         <span class="n">p_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})[</span><span class="sa">f</span><span class="s2">&quot;quest_</span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2446"
               class="code sev- "><tt><i>2446</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2"> marked as completed.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2447"
               class="code sev- "><tt><i>2447</i> &nbsp;</tt>
            </div>
            <div id="l2448"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2448</i>                     <span class="c1"># Clear current quest info and reset turn count for EOC flow</span></tt>
            </div>
            <div id="l2449"
               class="code sev- "><tt><i>2449</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l2450"
               class="code sev- "><tt><i>2450</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l2451"
               class="code sev- "><tt><i>2451</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l2452"
               class="code sev- "><tt><i>2452</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l2453"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2453</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset turns for EOC</span></tt>
            </div>
            <div id="l2454"
               class="code sev- "><tt><i>2454</i>                     <span class="n">chapter_ended</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2455"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2455</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chapter end triggered by completing step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> of quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2456"
               class="code sev- "><tt><i>2456</i> &nbsp;</tt>
            </div>
            <div id="l2457"
               class="code sev- "><tt><i>2457</i>                 <span class="k">elif</span> <span class="n">next_s_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2458"
               class="code sev- "><tt><i>2458</i>                     <span class="c1"># Advance to the next step in the quest</span></tt>
            </div>
            <div id="l2459"
               class="code sev- "><tt><i>2459</i>                     <span class="n">next_step_info</span> <span class="o">=</span> <span class="n">get_quest_step</span><span class="p">(</span><span class="n">q_id</span><span class="p">,</span> <span class="n">next_s_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2460"
               class="code sev- "><tt><i>2460</i>                     <span class="k">if</span> <span class="n">next_step_info</span><span class="p">:</span></tt>
            </div>
            <div id="l2461"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2461</i>                         <span class="n">next_desc</span> <span class="o">=</span> <span class="n">next_step_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Continue your quest.&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2462"
               class="code sev- "><tt><i>2462</i>                         <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_s_id</span></tt>
            </div>
            <div id="l2463"
               class="code sev- "><tt><i>2463</i>                         <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_desc</span></tt>
            </div>
            <div id="l2464"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>2464</i>                         <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;New Objective: </span><span class="si">{</span><span class="n">next_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2465"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2465</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Advanced to step </span><span class="si">{</span><span class="n">next_s_id</span><span class="si">}</span><span class="s2"> in quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2466"
               class="code sev- "><tt><i>2466</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2467"
               class="code sev- "><tt><i>2467</i>                         <span class="c1"># Error: Next step defined but not found</span></tt>
            </div>
            <div id="l2468"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (115 > 79 characters)</li>

               </ul><tt><i>2468</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find data for next step </span><span class="si">{</span><span class="n">next_s_id</span><span class="si">}</span><span class="s2"> in quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">. Ending quest.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2469"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E702
                     </span>
                     Multiple statements on one line (semicolon)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2469</i>                         <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># End quest</span></tt>
            </div>
            <div id="l2470"
               class="code sev- "><tt><i>2470</i> &nbsp;</tt>
            </div>
            <div id="l2471"
               class="code sev- "><tt><i>2471</i>                 <span class="k">elif</span> <span class="n">step_was_final</span><span class="p">:</span></tt>
            </div>
            <div id="l2472"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2472</i>                     <span class="c1"># Final step completed, but didn&#39;t trigger EOC (e.g., too few inputs)</span></tt>
            </div>
            <div id="l2473"
               class="code sev- "><tt><i>2473</i>                     <span class="n">quest_data</span> <span class="o">=</span> <span class="n">get_quest</span><span class="p">(</span><span class="n">q_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2474"
               class="code sev- "><tt><i>2474</i>                     <span class="k">if</span> <span class="n">quest_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2475"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>2475</i>                         <span class="n">final_reward_msg</span> <span class="o">=</span> <span class="n">apply_reward</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="n">quest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completion_reward&quot;</span><span class="p">),</span> <span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2476"
               class="code sev- "><tt><i>2476</i>                         <span class="k">if</span> <span class="n">final_reward_msg</span><span class="p">:</span></tt>
            </div>
            <div id="l2477"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2477</i>                             <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">final_reward_msg</span><span class="p">})</span></tt>
            </div>
            <div id="l2478"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2478</i>                     <span class="n">p_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})[</span><span class="sa">f</span><span class="s2">&quot;quest_</span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2479"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (146 > 79 characters)</li>

               </ul><tt><i>2479</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> completed for quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">, but EOC not triggered (Inputs: </span><span class="si">{</span><span class="n">inputs_count</span><span class="si">}</span><span class="s2">). Quest ended.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2480"
               class="code sev- "><tt><i>2480</i>                     <span class="c1"># Clear quest info as it&#39;s finished</span></tt>
            </div>
            <div id="l2481"
               class="code sev- "><tt><i>2481</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l2482"
               class="code sev- "><tt><i>2482</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l2483"
               class="code sev- "><tt><i>2483</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l2484"
               class="code sev- "><tt><i>2484</i>                     <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l2485"
               class="code sev- "><tt><i>2485</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2486"
               class="code sev- "><tt><i>2486</i>                 <span class="c1"># Should not happen if step_done is True</span></tt>
            </div>
            <div id="l2487"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (107 > 79 characters)</li>

               </ul><tt><i>2487</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRITICAL: Cannot find step data for completed step </span><span class="si">{</span><span class="n">s_id</span><span class="si">}</span><span class="s2"> in quest </span><span class="si">{</span><span class="n">q_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2488"
               class="code sev- "><tt><i>2488</i> &nbsp;</tt>
            </div>
            <div id="l2489"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2489</i>         <span class="c1"># --- Get New Location Description (if moved and chapter didn&#39;t end) ---</span></tt>
            </div>
            <div id="l2490"
               class="code sev- "><tt><i>2490</i>         <span class="k">if</span> <span class="n">needs_desc_after_move</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">chapter_ended</span><span class="p">:</span></tt>
            </div>
            <div id="l2491"
               class="code sev- "><tt><i>2491</i>             <span class="c1"># Build context specifically for GET_DESCRIPTION</span></tt>
            </div>
            <div id="l2492"
               class="code sev- "><tt><i>2492</i>             <span class="n">desc_ctx</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2493"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2493</i>                 <span class="s1">&#39;player_name&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2494"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2494</i>                 <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">curr_loc</span><span class="p">,</span> <span class="c1"># Use the updated location</span></tt>
            </div>
            <div id="l2495"
               class="code sev- "><tt><i>2495</i>                 <span class="s1">&#39;location_data&#39;</span><span class="p">:</span> <span class="n">world_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,</span> <span class="p">{}),</span></tt>
            </div>
            <div id="l2496"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2496</i>                 <span class="s1">&#39;thetopia_location_lore&#39;</span><span class="p">:</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,</span> <span class="p">{}),</span></tt>
            </div>
            <div id="l2497"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2497</i>                 <span class="s1">&#39;player_race&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2498"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2498</i>                 <span class="s1">&#39;player_class&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2499"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2499</i>                 <span class="s1">&#39;player_philosophy&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2500"
               class="code sev- "><tt><i>2500</i>                 <span class="s1">&#39;player_fate_points&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fate_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span></tt>
            </div>
            <div id="l2501"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E131
                     </span>
                     Continuation line unaligned for hanging indent</li>

               </ul><tt><i>2501</i>                  <span class="c1"># Pass current quest info even after moving</span></tt>
            </div>
            <div id="l2502"
               class="code sev- "><tt><i>2502</i>                 <span class="s1">&#39;current_quest_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2503"
               class="code sev- "><tt><i>2503</i>                 <span class="s1">&#39;current_step_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2504"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2504</i>                 <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2505"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2505</i>                 <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2506"
               class="code sev- "><tt><i>2506</i>             <span class="p">}</span></tt>
            </div>
            <div id="l2507"
               class="code sev- "><tt><i>2507</i>             <span class="n">desc_txt</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;GET_DESCRIPTION&quot;</span><span class="p">,</span> <span class="n">desc_ctx</span><span class="p">)</span></tt>
            </div>
            <div id="l2508"
               class="code sev- "><tt><i>2508</i>             <span class="k">if</span> <span class="n">desc_txt</span><span class="p">:</span></tt>
            </div>
            <div id="l2509"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2509</i>                 <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">desc_txt</span><span class="p">})</span></tt>
            </div>
            <div id="l2510"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2510</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_txt</span> <span class="c1"># Update last AI output</span></tt>
            </div>
            <div id="l2511"
               class="code sev- "><tt><i>2511</i> &nbsp;</tt>
            </div>
            <div id="l2512"
               class="code sev- "><tt><i>2512</i>         <span class="c1"># --- AI Check for EOC Suggestion (if conditions met) ---</span></tt>
            </div>
            <div id="l2513"
               class="code sev- "><tt><i>2513</i>         <span class="n">should_check_eoc</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l2514"
               class="code sev- "><tt><i>2514</i>             <span class="ow">not</span> <span class="n">chapter_ended</span> <span class="ow">and</span></tt>
            </div>
            <div id="l2515"
               class="code sev- "><tt><i>2515</i>             <span class="n">turn_num</span> <span class="o">&gt;=</span> <span class="n">EOC_CHECK_START_TURN</span> <span class="ow">and</span></tt>
            </div>
            <div id="l2516"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>2516</i>             <span class="n">turn_num</span> <span class="o">%</span> <span class="n">EOC_CHECK_INTERVAL</span> <span class="o">==</span> <span class="p">(</span><span class="n">EOC_CHECK_START_TURN</span> <span class="o">%</span> <span class="n">EOC_CHECK_INTERVAL</span><span class="p">)</span> <span class="ow">and</span></tt>
            </div>
            <div id="l2517"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2517</i>             <span class="ow">not</span> <span class="n">step_completed_this_turn</span> <span class="c1"># Don&#39;t suggest EOC on the same turn a step was completed</span></tt>
            </div>
            <div id="l2518"
               class="code sev- "><tt><i>2518</i>         <span class="p">)</span></tt>
            </div>
            <div id="l2519"
               class="code sev- "><tt><i>2519</i>         <span class="k">if</span> <span class="n">should_check_eoc</span><span class="p">:</span></tt>
            </div>
            <div id="l2520"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2520</i>             <span class="n">eoc_check_context</span> <span class="o">=</span> <span class="n">ai_context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Use the main context from this turn</span></tt>
            </div>
            <div id="l2521"
               class="code sev- "><tt><i>2521</i>             <span class="n">eoc_check_context</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">turn_num</span></tt>
            </div>
            <div id="l2522"
               class="code sev- "><tt><i>2522</i>             <span class="n">eoc_check_context</span><span class="p">[</span><span class="s1">&#39;inputs_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chapter_inputs_log</span><span class="p">)</span></tt>
            </div>
            <div id="l2523"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2523</i>             <span class="c1"># Build conversation summary from recent messages (including this turn)</span></tt>
            </div>
            <div id="l2524"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2524</i>             <span class="n">recent_conv_log</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="p">[])[:]</span> <span class="c1"># Copy log before this turn</span></tt>
            </div>
            <div id="l2525"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2525</i>             <span class="n">recent_conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;Player&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="n">p_input</span><span class="p">})</span> <span class="c1"># Add player input</span></tt>
            </div>
            <div id="l2526"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E701
                     </span>
                     Multiple statements on one line (colon)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2526</i>             <span class="k">if</span> <span class="n">ai_resp</span><span class="p">:</span> <span class="n">recent_conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="n">ai_resp</span><span class="p">})</span> <span class="c1"># Add AI output</span></tt>
            </div>
            <div id="l2527"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2527</i>             <span class="c1"># Add any system messages added *this turn* (step complete, rewards)</span></tt>
            </div>
            <div id="l2528"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (148 > 79 characters)</li>

               </ul><tt><i>2528</i>             <span class="n">system_msgs_this_turn</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">conv_log</span> <span class="k">if</span> <span class="n">msg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speaker&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l2529"
               class="code sev- "><tt><i>2529</i>             <span class="n">recent_conv_log</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">system_msgs_this_turn</span><span class="p">)</span></tt>
            </div>
            <div id="l2530"
               class="code sev- "><tt><i>2530</i>             <span class="c1"># Create summary string (last ~6 messages)</span></tt>
            </div>
            <div id="l2531"
               class="code sev- "><tt><i>2531</i>             <span class="n">eoc_check_context</span><span class="p">[</span><span class="s1">&#39;conversation_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span></tt>
            </div>
            <div id="l2532"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2532</i>                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;speaker&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Truncate long messages</span></tt>
            </div>
            <div id="l2533"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2533</i>                 <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">recent_conv_log</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="c1"># Take last 6 entries</span></tt>
            </div>
            <div id="l2534"
               class="code sev- "><tt><i>2534</i>             <span class="p">])</span></tt>
            </div>
            <div id="l2535"
               class="code sev- "><tt><i>2535</i> &nbsp;</tt>
            </div>
            <div id="l2536"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2536</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking AI EOC suggestion for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> turn </span><span class="si">{</span><span class="n">turn_num</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2537"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2537</i>             <span class="n">eoc_suggestion</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;CHECK_CHAPTER_PROGRESS&quot;</span><span class="p">,</span> <span class="n">eoc_check_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2538"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2538</i>             <span class="n">suggestion</span> <span class="o">=</span> <span class="n">eoc_suggestion</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eoc_suggestion</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></tt>
            </div>
            <div id="l2539"
               class="code sev- "><tt><i>2539</i> &nbsp;</tt>
            </div>
            <div id="l2540"
               class="code sev- "><tt><i>2540</i>             <span class="k">if</span> <span class="n">suggestion</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2541"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>2541</i>                  <span class="c1"># Prompt player to confirm EOC</span></tt>
            </div>
            <div id="l2542"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (162 > 79 characters)</li>

               </ul><tt><i>2542</i>                  <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="s2">&quot;This feels like a good place to pause and reflect on this chapter. Shall we conclude it? (yes/no)&quot;</span><span class="p">})</span></tt>
            </div>
            <div id="l2543"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2543</i>                  <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set persistent flag</span></tt>
            </div>
            <div id="l2544"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2544</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set session flag</span></tt>
            </div>
            <div id="l2545"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2545</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI suggested EOC for </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Player prompted.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2546"
               class="code sev- "><tt><i>2546</i>             <span class="k">elif</span> <span class="n">suggestion</span> <span class="o">==</span> <span class="s1">&#39;SUGGEST_TASK&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2547"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>2547</i>                  <span class="c1"># Initiate side quest flow</span></tt>
            </div>
            <div id="l2548"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>2548</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI suggested player side quest for </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2549"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E201
                     </span>
                     Whitespace after '{'</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (142 > 79 characters)</li>

               </ul><tt><i>2549</i>                  <span class="n">side_quest_init_ctx</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;race_name&#39;</span><span class="p">,</span> <span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;current_location&#39;</span><span class="p">]}</span></tt>
            </div>
            <div id="l2550"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2550</i>                  <span class="n">init_resp</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INITIATE_PLAYER_SIDEQUEST&quot;</span><span class="p">,</span> <span class="n">side_quest_init_ctx</span><span class="p">)</span></tt>
            </div>
            <div id="l2551"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>

               </ul><tt><i>2551</i>                  <span class="n">conv_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span><span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">init_resp</span><span class="p">})</span></tt>
            </div>
            <div id="l2552"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2552</i>                  <span class="c1"># Set side quest state in session</span></tt>
            </div>
            <div id="l2553"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2553</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2554"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2554</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Desc will be set by player response</span></tt>
            </div>
            <div id="l2555"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2555</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_SIDE_QUEST_TURNS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></tt>
            </div>
            <div id="l2556"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2556</i>                  <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Ensure EOC prompt is off</span></tt>
            </div>
            <div id="l2557"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2557</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2558"
               class="code sev- "><tt><i>2558</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2559"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>2559</i>                  <span class="c1"># No suggestion or explicit NO</span></tt>
            </div>
            <div id="l2560"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>2560</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI EOC check result: &#39;</span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Continuing chapter.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2561"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2561</i>                  <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Ensure EOC prompt is off</span></tt>
            </div>
            <div id="l2562"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2562</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2563"
               class="code sev- "><tt><i>2563</i> &nbsp;</tt>
            </div>
            <div id="l2564"
               class="code sev- "><tt><i>2564</i> &nbsp;</tt>
            </div>
            <div id="l2565"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E303
                     </span>
                     Too many blank lines (2)</li>

               </ul><tt><i>2565</i>         <span class="c1"># --- Save Final State for this Turn ---</span></tt>
            </div>
            <div id="l2566"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>2566</i>         <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span> <span class="c1"># Update session log</span></tt>
            </div>
            <div id="l2567"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2567</i>         <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="c1"># Update data to be saved</span></tt>
            </div>
            <div id="l2568"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2568</i>         <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">]</span> <span class="c1"># Update data to be saved</span></tt>
            </div>
            <div id="l2569"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2569</i>         <span class="n">p_data</span><span class="p">[</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_PROMPTED</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># Sync EOC prompt status</span></tt>
            </div>
            <div id="l2570"
               class="code sev- "><tt><i>2570</i>         <span class="c1"># Ensure flags and inventory are updated in p_data before save</span></tt>
            </div>
            <div id="l2571"
               class="code sev- "><tt><i>2571</i>         <span class="n">p_data</span><span class="p">[</span><span class="n">FS_QUEST_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l2572"
               class="code sev- "><tt><i>2572</i>         <span class="n">p_data</span><span class="p">[</span><span class="n">FS_INVENTORY</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2573"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2573</i>         <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Mark session as modified</span></tt>
            </div>
            <div id="l2574"
               class="code sev- "><tt><i>2574</i> &nbsp;</tt>
            </div>
            <div id="l2575"
               class="code sev- "><tt><i>2575</i>         <span class="c1"># Save character data</span></tt>
            </div>
            <div id="l2576"
               class="code sev- "><tt><i>2576</i>         <span class="n">saved_id</span> <span class="o">=</span> <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2577"
               class="code sev- "><tt><i>2577</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2578"
               class="code sev- "><tt><i>2578</i>             <span class="c1"># Critical save error, redirect to profile</span></tt>
            </div>
            <div id="l2579"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2579</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;CRITICAL ERROR: Failed to save your progress! Please reload your character.&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2580"
               class="code sev- "><tt><i>2580</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2581"
               class="code sev- "><tt><i>2581</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2582"
               class="code sev- "><tt><i>2582</i> &nbsp;</tt>
            </div>
            <div id="l2583"
               class="code sev- "><tt><i>2583</i>         <span class="c1"># --- Redirect ---</span></tt>
            </div>
            <div id="l2584"
               class="code sev- "><tt><i>2584</i>         <span class="k">if</span> <span class="n">chapter_ended</span><span class="p">:</span></tt>
            </div>
            <div id="l2585"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2585</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;START&#39;</span> <span class="c1"># Set state for EOC route</span></tt>
            </div>
            <div id="l2586"
               class="code sev- "><tt><i>2586</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2587"
               class="code sev- "><tt><i>2587</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2588"
               class="code sev- "><tt><i>2588</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2589"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2589</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span> <span class="c1"># Continue in game view</span></tt>
            </div>
            <div id="l2590"
               class="code sev- "><tt><i>2590</i> &nbsp;</tt>
            </div>
            <div id="l2591"
               class="code sev- "><tt><i>2591</i>     <span class="c1"># --- &lt;&lt;&lt; REVISED &gt;&gt;&gt; GET Request Handling (Display Game View) ---</span></tt>
            </div>
            <div id="l2592"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2592</i>     <span class="k">else</span><span class="p">:</span> <span class="c1"># request.method == &#39;GET&#39;</span></tt>
            </div>
            <div id="l2593"
               class="code sev- "><tt><i>2593</i>         <span class="c1"># --- &lt;&lt;&lt; NEW: Introduction Logic &gt;&gt;&gt; ---</span></tt>
            </div>
            <div id="l2594"
               class="code sev- "><tt><i>2594</i>         <span class="n">player_has_seen_intro</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2595"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2595</i>         <span class="n">show_intro_this_time</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Flag to indicate if intro is displayed *this* time</span></tt>
            </div>
            <div id="l2596"
               class="code sev- "><tt><i>2596</i> &nbsp;</tt>
            </div>
            <div id="l2597"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2597</i>         <span class="c1"># Heuristic: Is this the character&#39;s first turn ever? (0 turns, empty log)</span></tt>
            </div>
            <div id="l2598"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2598</i>         <span class="n">first_character_turn</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turn_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CONVERSATION</span><span class="p">))</span></tt>
            </div>
            <div id="l2599"
               class="code sev- "><tt><i>2599</i> &nbsp;</tt>
            </div>
            <div id="l2600"
               class="code sev- "><tt><i>2600</i>         <span class="c1"># Check the PLAYER&#39;S intro status in Firestore</span></tt>
            </div>
            <div id="l2601"
               class="code sev- "><tt><i>2601</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2602"
               class="code sev- "><tt><i>2602</i>             <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2603"
               class="code sev- "><tt><i>2603</i>             <span class="c1"># Only fetch the intro flag field</span></tt>
            </div>
            <div id="l2604"
               class="code sev- "><tt><i>2604</i>             <span class="n">profile_doc</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="p">])</span></tt>
            </div>
            <div id="l2605"
               class="code sev- "><tt><i>2605</i>             <span class="k">if</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l2606"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2606</i>                 <span class="n">player_has_seen_intro</span> <span class="o">=</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l2607"
               class="code sev- "><tt><i>2607</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2608"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2608</i>                 <span class="c1"># Profile doc missing for logged-in user? Should not happen after signup.</span></tt>
            </div>
            <div id="l2609"
               class="code sev- "><tt><i>2609</i>                 <span class="c1"># Assume intro needed if profile somehow missing.</span></tt>
            </div>
            <div id="l2610"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (139 > 79 characters)</li>

               </ul><tt><i>2610</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player profile document not found for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> when checking intro status. Assuming intro needed.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2611"
               class="code sev- "><tt><i>2611</i>                 <span class="n">player_has_seen_intro</span> <span class="o">=</span> <span class="kc">False</span></tt>
            </div>
            <div id="l2612"
               class="code sev- "><tt><i>2612</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2613"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

               </ul><tt><i>2613</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch </span><span class="si">{</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2614"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2614</i>             <span class="c1"># If DB read fails, assume they HAVE seen intro to avoid repeated display on error</span></tt>
            </div>
            <div id="l2615"
               class="code sev- "><tt><i>2615</i>             <span class="n">player_has_seen_intro</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2616"
               class="code sev- "><tt><i>2616</i> &nbsp;</tt>
            </div>
            <div id="l2617"
               class="code sev- "><tt><i>2617</i>         <span class="c1"># Determine if intro should be shown this time</span></tt>
            </div>
            <div id="l2618"
               class="code sev- "><tt><i>2618</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">player_has_seen_intro</span><span class="p">:</span></tt>
            </div>
            <div id="l2619"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2619</i>             <span class="n">show_intro_this_time</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Mark that we are showing it now</span></tt>
            </div>
            <div id="l2620"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>2620</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying introduction for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> (char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2621"
               class="code sev- "><tt><i>2621</i> &nbsp;</tt>
            </div>
            <div id="l2622"
               class="code sev- "><tt><i>2622</i>             <span class="c1"># &lt;&lt;&lt; REVISED Intro Script Text &gt;&gt;&gt;</span></tt>
            </div>
            <div id="l2623"
               class="code sev- "><tt><i>2623</i>             <span class="n">intro_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l2624"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (288 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        W291
                     </span>
                     Trailing whitespace</li>

               </ul><tt><i>2624</i> <span class="s2">Welcome to your Daydream! You are a new player located on Dumpster Planet, responsible for containing all of the wasted ideas from human daydreams. The games governing AI is named The Great Recycler and is responsible for cleaning up Daydream by elevating ideas from trash to treasure. </span></tt>
            </div>
            <div id="l2625"
               class="code sev- "><tt><i>2625</i> &nbsp;</tt>
            </div>
            <div id="l2626"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (142 > 79 characters)</li>

               </ul><tt><i>2626</i> <span class="s2">Your journey begins in Thetopia, a pocket of stability amidst the chaotic Dumpster Planet  a realm made from forgotten ideas and lost dreams.</span></tt>
            </div>
            <div id="l2627"
               class="code sev- "><tt><i>2627</i> &nbsp;</tt>
            </div>
            <div id="l2628"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (393 > 79 characters)</li>

               </ul><tt><i>2628</i> <span class="s2">Here, your greatest tool is your imagination! The more descriptive and detailed you are in your actions and narration, the richer your adventure will become, and the more the story will evolve based on *your* writing. Don&#39;t be afraid to write detailed descriptions and express your character&#39;s thoughts and feelings. This helps me understand your intent and bring the world to life around you.</span></tt>
            </div>
            <div id="l2629"
               class="code sev- "><tt><i>2629</i> &nbsp;</tt>
            </div>
            <div id="l2630"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (390 > 79 characters)</li>

               </ul><tt><i>2630</i> <span class="s2">Our adventure is structured around quests, which form chapters in your story. Each chapter is inspired by a stage of the classic Hero&#39;s Journey, giving our quest a unique theme. As you complete chapters, we&#39;ll pause to reflect. I&#39;ll help analyze your writing and comprehension, not for a grade, but to help you grow stronger in your storytelling skills. The goal is to improve through play!</span></tt>
            </div>
            <div id="l2631"
               class="code sev- "><tt><i>2631</i> &nbsp;</tt>
            </div>
            <div id="l2632"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>2632</i> <span class="s2">Do you have any questions before we begin, or are you ready to dive into your first quest in Thetopia?</span></tt>
            </div>
            <div id="l2633"
               class="code sev- "><tt><i>2633</i> <span class="s2">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l2634"
               class="code sev- "><tt><i>2634</i>             <span class="c1"># Get current session log</span></tt>
            </div>
            <div id="l2635"
               class="code sev- "><tt><i>2635</i>             <span class="n">conv_log_for_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2636"
               class="code sev- "><tt><i>2636</i> &nbsp;</tt>
            </div>
            <div id="l2637"
               class="code sev- "><tt><i>2637</i>             <span class="c1"># Prepend intro text *only if* it&#39;s not already the first message</span></tt>
            </div>
            <div id="l2638"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>2638</i>             <span class="c1"># (This prevents duplication if user refreshes the page immediately after intro)</span></tt>
            </div>
            <div id="l2639"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>2639</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">conv_log_for_session</span> <span class="ow">or</span> <span class="n">conv_log_for_session</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">intro_text</span><span class="p">:</span></tt>
            </div>
            <div id="l2640"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2640</i>                  <span class="n">conv_log_for_session</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span> <span class="s2">&quot;Storyteller&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">intro_text</span><span class="p">})</span></tt>
            </div>
            <div id="l2641"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2641</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log_for_session</span></tt>
            </div>
            <div id="l2642"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2642</i>                  <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2643"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2643</i>                  <span class="c1"># Also update the persistent log in p_data immediately</span></tt>
            </div>
            <div id="l2644"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2644</i>                  <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log_for_session</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l2645"
               class="code sev- "><tt><i>2645</i> &nbsp;</tt>
            </div>
            <div id="l2646"
               class="code sev- "><tt><i>2646</i>             <span class="c1"># Update Firestore flag for the USER asynchronously</span></tt>
            </div>
            <div id="l2647"
               class="code sev- "><tt><i>2647</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2648"
               class="code sev- "><tt><i>2648</i>                 <span class="c1"># Use set with merge=True to safely update or add the field</span></tt>
            </div>
            <div id="l2649"
               class="code sev- "><tt><i>2649</i>                 <span class="n">profile_ref</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2650"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2650</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated </span><span class="si">{</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="si">}</span><span class="s2"> to True for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2651"
               class="code sev- "><tt><i>2651</i>                 <span class="c1"># Save p_data if we added the intro text to its log</span></tt>
            </div>
            <div id="l2652"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2652</i>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">conv_log_for_session</span> <span class="ow">or</span> <span class="n">conv_log_for_session</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">intro_text</span><span class="p">:</span></tt>
            </div>
            <div id="l2653"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

               </ul><tt><i>2653</i>                      <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2654"
               class="code sev- "><tt><i>2654</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2655"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2655</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update </span><span class="si">{</span><span class="n">FS_PLAYER_HAS_SEEN_INTRO</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2656"
               class="code sev- "><tt><i>2656</i>                 <span class="c1"># Log error, but continue; intro was shown in session anyway</span></tt>
            </div>
            <div id="l2657"
               class="code sev- "><tt><i>2657</i> &nbsp;</tt>
            </div>
            <div id="l2658"
               class="code sev- "><tt><i>2658</i>         <span class="c1"># --- &lt;&lt;&lt; END Introduction Logic &gt;&gt;&gt; ---</span></tt>
            </div>
            <div id="l2659"
               class="code sev- "><tt><i>2659</i> &nbsp;</tt>
            </div>
            <div id="l2660"
               class="code sev- "><tt><i>2660</i>         <span class="c1"># --- Fetch Data for Display ---</span></tt>
            </div>
            <div id="l2661"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>2661</i>         <span class="n">conv_log_from_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Get potentially updated log</span></tt>
            </div>
            <div id="l2662"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2662</i>         <span class="n">vocab_info</span> <span class="o">=</span> <span class="n">get_active_vocab_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="c1"># Gets settings (inc. colors) and vocab</span></tt>
            </div>
            <div id="l2663"
               class="code sev- "><tt><i>2663</i>         <span class="n">active_vocab</span> <span class="o">=</span> <span class="n">vocab_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vocab&quot;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l2664"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2664</i>         <span class="n">vocab_settings</span> <span class="o">=</span> <span class="n">vocab_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># Extract settings dict</span></tt>
            </div>
            <div id="l2665"
               class="code sev- "><tt><i>2665</i> &nbsp;</tt>
            </div>
            <div id="l2666"
               class="code sev- "><tt><i>2666</i>         <span class="c1"># --- Determine if Initial AI Setup Call is Needed ---</span></tt>
            </div>
            <div id="l2667"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2667</i>         <span class="c1"># Needs setup ONLY if it&#39;s the first turn AND intro wasn&#39;t shown this time</span></tt>
            </div>
            <div id="l2668"
               class="code sev- "><tt><i>2668</i>         <span class="n">needs_initial_setup</span> <span class="o">=</span> <span class="n">first_character_turn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">show_intro_this_time</span></tt>
            </div>
            <div id="l2669"
               class="code sev- "><tt><i>2669</i> &nbsp;</tt>
            </div>
            <div id="l2670"
               class="code sev- "><tt><i>2670</i>         <span class="k">if</span> <span class="n">needs_initial_setup</span><span class="p">:</span></tt>
            </div>
            <div id="l2671"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (119 > 79 characters)</li>

               </ul><tt><i>2671</i>              <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running INITIAL_SETUP AI for new character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> (Turn 0, Intro not shown this load).&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2672"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2672</i>              <span class="c1"># Build context for INITIAL_SETUP</span></tt>
            </div>
            <div id="l2673"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2673</i>              <span class="n">ai_context</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2674"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2674</i>                  <span class="s1">&#39;player_name&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2675"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2675</i>                  <span class="s1">&#39;player_race&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;race_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2676"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2676</i>                  <span class="s1">&#39;player_class&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2677"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2677</i>                  <span class="s1">&#39;player_philosophy&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;philosophy_name&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2678"
               class="code sev- "><tt><i>2678</i>                  <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">curr_loc</span><span class="p">,</span></tt>
            </div>
            <div id="l2679"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>2679</i>                  <span class="s1">&#39;thetopia_location_lore&#39;</span><span class="p">:</span> <span class="n">thetopia_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locations&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_loc</span><span class="p">,{}),</span></tt>
            </div>
            <div id="l2680"
               class="code sev- "><tt><i>2680</i>                  <span class="s1">&#39;current_quest_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2681"
               class="code sev- "><tt><i>2681</i>                  <span class="s1">&#39;current_step_id&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2682"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2682</i>                  <span class="s1">&#39;current_quest_title&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2683"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (86 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2683</i>                  <span class="s1">&#39;current_step_description&#39;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2684"
               class="code sev- "><tt><i>2684</i>              <span class="p">}</span></tt>
            </div>
            <div id="l2685"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2685</i>              <span class="n">initial_ai_response</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;INITIAL_SETUP&quot;</span><span class="p">,</span> <span class="n">ai_context</span><span class="p">)</span></tt>
            </div>
            <div id="l2686"
               class="code sev- "><tt><i>2686</i> &nbsp;</tt>
            </div>
            <div id="l2687"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2687</i>              <span class="k">if</span> <span class="n">initial_ai_response</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_ai_response</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l2688"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>2688</i>                  <span class="c1"># Check if this exact message is already the last one (avoid double add on reload)</span></tt>
            </div>
            <div id="l2689"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

               </ul><tt><i>2689</i>                  <span class="k">if</span> <span class="ow">not</span> <span class="n">conv_log_from_session</span> <span class="ow">or</span> <span class="n">conv_log_from_session</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">initial_ai_response</span><span class="p">:</span></tt>
            </div>
            <div id="l2690"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>2690</i>                       <span class="n">conv_log_from_session</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;speaker&quot;</span><span class="p">:</span> <span class="s2">&quot;AI&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">initial_ai_response</span><span class="p">})</span></tt>
            </div>
            <div id="l2691"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>2691</i>                       <span class="n">session</span><span class="p">[</span><span class="n">SESSION_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log_from_session</span> <span class="c1"># Update session log</span></tt>
            </div>
            <div id="l2692"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2692</i>                       <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2693"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

               </ul><tt><i>2693</i>                       <span class="c1"># Also update the persistent log in p_data</span></tt>
            </div>
            <div id="l2694"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>2694</i>                       <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_log_from_session</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_CONVO_LINES</span><span class="p">:]</span></tt>
            </div>
            <div id="l2695"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2695</i>                       <span class="c1"># Save character data immediately after adding initial setup message</span></tt>
            </div>
            <div id="l2696"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2696</i>                       <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span></tt>
            </div>
            <div id="l2697"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2697</i>              <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2698"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (133 > 79 characters)</li>

               </ul><tt><i>2698</i>                   <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INITIAL_SETUP failed or returned non-string for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">initial_ai_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2699"
               class="code sev- "><tt><i>2699</i> &nbsp;</tt>
            </div>
            <div id="l2700"
               class="code sev- "><tt><i>2700</i>         <span class="c1"># --- Process Conversation Log for Display (Apply Highlighting) ---</span></tt>
            </div>
            <div id="l2701"
               class="code sev- "><tt><i>2701</i>         <span class="n">display_log</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l2702"
               class="code sev- "><tt><i>2702</i>         <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">conv_log_from_session</span><span class="p">:</span></tt>
            </div>
            <div id="l2703"
               class="code sev- "><tt><i>2703</i>             <span class="n">processed_message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l2704"
               class="code sev- "><tt><i>2704</i>             <span class="n">text_to_process</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2705"
               class="code sev- "><tt><i>2705</i>             <span class="n">speaker</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speaker&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2706"
               class="code sev- "><tt><i>2706</i>             <span class="c1"># Apply highlighting to AI and Storyteller messages</span></tt>
            </div>
            <div id="l2707"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2707</i>             <span class="k">if</span> <span class="n">speaker</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AI&#39;</span><span class="p">,</span> <span class="s1">&#39;Storyteller&#39;</span><span class="p">]:</span> <span class="c1"># &lt;&lt;&lt; REVISED: Include Storyteller &gt;&gt;&gt;</span></tt>
            </div>
            <div id="l2708"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

               </ul><tt><i>2708</i>                  <span class="n">text_with_vocab</span> <span class="o">=</span> <span class="n">apply_vocab_highlighting_python</span><span class="p">(</span><span class="n">text_to_process</span><span class="p">,</span> <span class="n">active_vocab</span><span class="p">,</span> <span class="n">vocab_settings</span><span class="p">)</span></tt>
            </div>
            <div id="l2709"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2709</i>                  <span class="n">text_with_all_highlights</span> <span class="o">=</span> <span class="n">apply_lore_highlighting_python</span><span class="p">(</span><span class="n">text_with_vocab</span><span class="p">,</span> <span class="n">lore_vocabulary</span><span class="p">)</span></tt>
            </div>
            <div id="l2710"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>2710</i>                  <span class="n">processed_message</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_with_all_highlights</span> <span class="c1"># Use safe HTML</span></tt>
            </div>
            <div id="l2711"
               class="code sev- "><tt><i>2711</i>             <span class="k">elif</span> <span class="n">speaker</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2712"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2712</i>                  <span class="c1"># Allow basic HTML like line breaks in system messages if needed</span></tt>
            </div>
            <div id="l2713"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2713</i>                  <span class="n">processed_message</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_to_process</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2714"
               class="code sev- "><tt><i>2714</i>             <span class="c1"># Player messages remain plain text (no |safe filter needed)</span></tt>
            </div>
            <div id="l2715"
               class="code sev- "><tt><i>2715</i>             <span class="n">display_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_message</span><span class="p">)</span></tt>
            </div>
            <div id="l2716"
               class="code sev- "><tt><i>2716</i> &nbsp;</tt>
            </div>
            <div id="l2717"
               class="code sev- "><tt><i>2717</i>         <span class="c1"># --- Prepare Character Data for Template ---</span></tt>
            </div>
            <div id="l2718"
               class="code sev- "><tt><i>2718</i>         <span class="n">template_data</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></tt>
            </div>
            <div id="l2719"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2719</i>         <span class="n">template_data</span><span class="p">[</span><span class="s1">&#39;current_location_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_loc</span> <span class="c1"># Add location name</span></tt>
            </div>
            <div id="l2720"
               class="code sev- "><tt><i>2720</i>         <span class="c1"># Remove large/internal fields not needed directly in template display</span></tt>
            </div>
            <div id="l2721"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (107 > 79 characters)</li>

               </ul><tt><i>2721</i>         <span class="n">fields_to_pop</span> <span class="o">=</span> <span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="s1">&#39;learned_vocab&#39;</span><span class="p">,</span> <span class="n">FS_QUEST_FLAGS</span><span class="p">,</span> <span class="n">FS_INVENTORY</span><span class="p">]</span></tt>
            </div>
            <div id="l2722"
               class="code sev- "><tt><i>2722</i>         <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_pop</span><span class="p">:</span></tt>
            </div>
            <div id="l2723"
               class="code sev- "><tt><i>2723</i>             <span class="n">template_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2724"
               class="code sev- "><tt><i>2724</i> &nbsp;</tt>
            </div>
            <div id="l2725"
               class="code sev- "><tt><i>2725</i>         <span class="c1"># --- Prepare Lore Data for JavaScript Highlighting ---</span></tt>
            </div>
            <div id="l2726"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2726</i>         <span class="n">lore_data_for_json</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Initialize empty dict</span></tt>
            </div>
            <div id="l2727"
               class="code sev- "><tt><i>2727</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2728"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>2728</i>             <span class="n">current_lore</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thetopia_lore&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># Safely access global</span></tt>
            </div>
            <div id="l2729"
               class="code sev- "><tt><i>2729</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_lore</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span></tt>
            </div>
            <div id="l2730"
               class="code sev- "><tt><i>2730</i>                 <span class="c1"># Include relevant top-level keys for JS lookups</span></tt>
            </div>
            <div id="l2731"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (114 > 79 characters)</li>

               </ul><tt><i>2731</i>                 <span class="n">keys_to_include</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;locations&#39;</span><span class="p">,</span> <span class="s1">&#39;npcs&#39;</span><span class="p">,</span> <span class="s1">&#39;races&#39;</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophies&#39;</span><span class="p">,</span> <span class="s1">&#39;concepts&#39;</span><span class="p">,</span> <span class="s1">&#39;setting&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l2732"
               class="code sev- "><tt><i>2732</i>                 <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_include</span><span class="p">:</span></tt>
            </div>
            <div id="l2733"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2733</i>                     <span class="n">lore_data_for_json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_lore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># Get each section safely</span></tt>
            </div>
            <div id="l2734"
               class="code sev- "><tt><i>2734</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2735"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (140 > 79 characters)</li>

               </ul><tt><i>2735</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global &#39;thetopia_lore&#39; variable is not a dictionary (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">current_lore</span><span class="p">)</span><span class="si">}</span><span class="s2">). Sending empty lore data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2736"
               class="code sev- "><tt><i>2736</i>             <span class="c1"># Convert to JSON string for embedding in HTML</span></tt>
            </div>
            <div id="l2737"
               class="code sev- "><tt><i>2737</i>             <span class="n">thetopia_lore_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">lore_data_for_json</span><span class="p">)</span></tt>
            </div>
            <div id="l2738"
               class="code sev- "><tt><i>2738</i>         <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span></tt>
            </div>
            <div id="l2739"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>2739</i>              <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NameError accessing &#39;thetopia_lore&#39; globally. Sending empty lore data.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2740"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2740</i>              <span class="n">thetopia_lore_json</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span> <span class="c1"># Fallback empty JSON</span></tt>
            </div>
            <div id="l2741"
               class="code sev- "><tt><i>2741</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">json_err</span><span class="p">:</span></tt>
            </div>
            <div id="l2742"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2742</i>              <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to serialize lore data to JSON: </span><span class="si">{</span><span class="n">json_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2743"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2743</i>              <span class="n">thetopia_lore_json</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span> <span class="c1"># Fallback empty JSON</span></tt>
            </div>
            <div id="l2744"
               class="code sev- "><tt><i>2744</i> &nbsp;</tt>
            </div>
            <div id="l2745"
               class="code sev- "><tt><i>2745</i>         <span class="c1"># --- Render Template ---</span></tt>
            </div>
            <div id="l2746"
               class="code sev- "><tt><i>2746</i>         <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2747"
               class="code sev- "><tt><i>2747</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l2748"
               class="code sev- "><tt><i>2748</i>                  <span class="s1">&#39;game_view.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l2749"
               class="code sev- "><tt><i>2749</i>                  <span class="n">conversation</span><span class="o">=</span><span class="n">display_log</span><span class="p">,</span></tt>
            </div>
            <div id="l2750"
               class="code sev- "><tt><i>2750</i>                  <span class="n">character_data</span><span class="o">=</span><span class="n">template_data</span><span class="p">,</span></tt>
            </div>
            <div id="l2751"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2751</i>                  <span class="n">thetopia_lore_data</span><span class="o">=</span><span class="n">thetopia_lore_json</span> <span class="c1"># Pass JSON string</span></tt>
            </div>
            <div id="l2752"
               class="code sev- "><tt><i>2752</i>              <span class="p">)</span></tt>
            </div>
            <div id="l2753"
               class="code sev- "><tt><i>2753</i>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">render_err</span><span class="p">:</span></tt>
            </div>
            <div id="l2754"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E114
                     </span>
                     Indentation is not a multiple of 4 (comment)</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented (comment)</li>

               </ul><tt><i>2754</i>              <span class="c1"># Handle potential template rendering errors</span></tt>
            </div>
            <div id="l2755"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (104 > 79 characters)</li>

               </ul><tt><i>2755</i>              <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template rendering error in game_view GET: </span><span class="si">{</span><span class="n">render_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2756"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

               </ul><tt><i>2756</i>              <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Critical error displaying game. Please reload your character.&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2757"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2757</i>              <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2758"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2758</i>              <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2759"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2759</i>              <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2760"
               class="code sev- "><tt><i>2760</i> &nbsp;</tt>
            </div>
            <div id="l2761"
               class="code sev- "><tt><i>2761</i> <span class="c1"># --- Vocab/Report Journal ---</span></tt>
            </div>
            <div id="l2762"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>2762</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/journal/vocab&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2763"
               class="code sev- "><tt><i>2763</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2764"
               class="code sev- "><tt><i>2764</i> <span class="k">def</span><span class="w"> </span><span class="nf">journal_vocab_report</span><span class="p">():</span></tt>
            </div>
            <div id="l2765"
               class="code sev- "><tt><i>2765</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2766"
               class="code sev- "><tt><i>2766</i>     <span class="n">char_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">)</span></tt>
            </div>
            <div id="l2767"
               class="code sev- "><tt><i>2767</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2768"
               class="code sev- "><tt><i>2768</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No character loaded.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2769"
               class="code sev- "><tt><i>2769</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2770"
               class="code sev- "><tt><i>2770</i> &nbsp;</tt>
            </div>
            <div id="l2771"
               class="code sev- "><tt><i>2771</i>     <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2772"
               class="code sev- "><tt><i>2772</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2773"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2773</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span> <span class="c1"># Redirect if char load fails</span></tt>
            </div>
            <div id="l2774"
               class="code sev- "><tt><i>2774</i> &nbsp;</tt>
            </div>
            <div id="l2775"
               class="code sev- "><tt><i>2775</i>     <span class="c1"># --- Prepare Vocabulary Data ---</span></tt>
            </div>
            <div id="l2776"
               class="code sev- "><tt><i>2776</i>     <span class="n">active_vocab_data</span> <span class="o">=</span> <span class="n">get_active_vocab_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2777"
               class="code sev- "><tt><i>2777</i>     <span class="n">combined_vocab</span> <span class="o">=</span> <span class="n">active_vocab_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vocab&quot;</span><span class="p">,</span> <span class="p">{})</span></tt>
            </div>
            <div id="l2778"
               class="code sev- "><tt><i>2778</i>     <span class="n">awl_words</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l2779"
               class="code sev- "><tt><i>2779</i>     <span class="n">ai_words_by_list</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l2780"
               class="code sev- "><tt><i>2780</i>     <span class="c1"># Sort vocab by word for display</span></tt>
            </div>
            <div id="l2781"
               class="code sev- "><tt><i>2781</i>     <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span></tt>
            </div>
            <div id="l2782"
               class="code sev- "><tt><i>2782</i>         <span class="n">source</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2783"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (132 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2783</i>         <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;word&quot;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span> <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;definition&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">),</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)}</span> <span class="c1"># Placeholder color</span></tt>
            </div>
            <div id="l2784"
               class="code sev- "><tt><i>2784</i>         <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;AWL&quot;</span><span class="p">:</span></tt>
            </div>
            <div id="l2785"
               class="code sev- "><tt><i>2785</i>             <span class="n">awl_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></tt>
            </div>
            <div id="l2786"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2786</i>         <span class="k">else</span><span class="p">:</span> <span class="c1"># Group AI words by their list name (source)</span></tt>
            </div>
            <div id="l2787"
               class="code sev- "><tt><i>2787</i>             <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ai_words_by_list</span><span class="p">:</span></tt>
            </div>
            <div id="l2788"
               class="code sev- "><tt><i>2788</i>                 <span class="n">ai_words_by_list</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l2789"
               class="code sev- "><tt><i>2789</i>             <span class="n">ai_words_by_list</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></tt>
            </div>
            <div id="l2790"
               class="code sev- "><tt><i>2790</i> &nbsp;</tt>
            </div>
            <div id="l2791"
               class="code sev- "><tt><i>2791</i>     <span class="c1"># --- Fetch Metadata for AI Lists (for management UI) ---</span></tt>
            </div>
            <div id="l2792"
               class="code sev- "><tt><i>2792</i>     <span class="n">ai_lists_metadata</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l2793"
               class="code sev- "><tt><i>2793</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2794"
               class="code sev- "><tt><i>2794</i>         <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2795"
               class="code sev- "><tt><i>2795</i>         <span class="c1"># Query only AI-generated lists</span></tt>
            </div>
            <div id="l2796"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (135 > 79 characters)</li>

               </ul><tt><i>2796</i>         <span class="n">ai_lists_query</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;custom_vocab_lists&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">FieldFilter</span><span class="p">(</span><span class="s1">&#39;is_ai_generated&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">stream</span><span class="p">()</span></tt>
            </div>
            <div id="l2797"
               class="code sev- "><tt><i>2797</i>         <span class="k">for</span> <span class="n">list_doc</span> <span class="ow">in</span> <span class="n">ai_lists_query</span><span class="p">:</span></tt>
            </div>
            <div id="l2798"
               class="code sev- "><tt><i>2798</i>             <span class="n">list_data</span> <span class="o">=</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l2799"
               class="code sev- "><tt><i>2799</i>             <span class="n">ai_lists_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">({</span></tt>
            </div>
            <div id="l2800"
               class="code sev- "><tt><i>2800</i>                 <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">list_doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span></tt>
            </div>
            <div id="l2801"
               class="code sev- "><tt><i>2801</i>                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unnamed AI List&quot;</span><span class="p">),</span></tt>
            </div>
            <div id="l2802"
               class="code sev- "><tt><i>2802</i>                 <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">DEFAULT_VOCAB_LIST_COLOR</span><span class="p">),</span></tt>
            </div>
            <div id="l2803"
               class="code sev- "><tt><i>2803</i>                 <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_active&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span></tt>
            </div>
            <div id="l2804"
               class="code sev- "><tt><i>2804</i>                 <span class="s2">&quot;word_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;words&quot;</span><span class="p">,</span> <span class="p">[])),</span></tt>
            </div>
            <div id="l2805"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2805</i>                 <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">list_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span> <span class="c1"># For sorting</span></tt>
            </div>
            <div id="l2806"
               class="code sev- "><tt><i>2806</i>             <span class="p">})</span></tt>
            </div>
            <div id="l2807"
               class="code sev- "><tt><i>2807</i>         <span class="c1"># Sort lists by creation date, newest first (handle missing timestamp)</span></tt>
            </div>
            <div id="l2808"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (111 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2808</i>         <span class="n">ai_lists_metadata</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Use 0 as fallback for sort</span></tt>
            </div>
            <div id="l2809"
               class="code sev- "><tt><i>2809</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2810"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2810</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch AI vocabulary list metadata for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2811"
               class="code sev- "><tt><i>2811</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Error loading vocabulary list details.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2812"
               class="code sev- "><tt><i>2812</i> &nbsp;</tt>
            </div>
            <div id="l2813"
               class="code sev- "><tt><i>2813</i>     <span class="c1"># --- Prepare Report Summaries ---</span></tt>
            </div>
            <div id="l2814"
               class="code sev- "><tt><i>2814</i>     <span class="n">report_summaries</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2815"
               class="code sev- "><tt><i>2815</i>     <span class="c1"># Sort reports by chapter number</span></tt>
            </div>
            <div id="l2816"
               class="code sev- "><tt><i>2816</i>     <span class="n">report_summaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chapter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></tt>
            </div>
            <div id="l2817"
               class="code sev- "><tt><i>2817</i> &nbsp;</tt>
            </div>
            <div id="l2818"
               class="code sev- "><tt><i>2818</i>     <span class="c1"># Render the template</span></tt>
            </div>
            <div id="l2819"
               class="code sev- "><tt><i>2819</i>     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l2820"
               class="code sev- "><tt><i>2820</i>         <span class="s1">&#39;journal_vocab_report.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l2821"
               class="code sev- "><tt><i>2821</i>         <span class="n">awl_words</span><span class="o">=</span><span class="n">awl_words</span><span class="p">,</span></tt>
            </div>
            <div id="l2822"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2822</i>         <span class="n">ai_word_lists</span><span class="o">=</span><span class="n">ai_words_by_list</span><span class="p">,</span> <span class="c1"># Pass dict grouped by list name</span></tt>
            </div>
            <div id="l2823"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2823</i>         <span class="n">ai_lists_metadata</span><span class="o">=</span><span class="n">ai_lists_metadata</span><span class="p">,</span> <span class="c1"># Pass list metadata for management</span></tt>
            </div>
            <div id="l2824"
               class="code sev- "><tt><i>2824</i>         <span class="n">report_summaries</span><span class="o">=</span><span class="n">report_summaries</span><span class="p">,</span></tt>
            </div>
            <div id="l2825"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2825</i>         <span class="n">premium_active</span><span class="o">=</span><span class="n">check_premium_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="c1"># Pass premium status for UI elements</span></tt>
            </div>
            <div id="l2826"
               class="code sev- "><tt><i>2826</i>     <span class="p">)</span></tt>
            </div>
            <div id="l2827"
               class="code sev- "><tt><i>2827</i> &nbsp;</tt>
            </div>
            <div id="l2828"
               class="code sev- "><tt><i>2828</i> <span class="c1"># --- Character/Quest Journal ---</span></tt>
            </div>
            <div id="l2829"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>

               </ul><tt><i>2829</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/journal/character&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2830"
               class="code sev- "><tt><i>2830</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2831"
               class="code sev- "><tt><i>2831</i> <span class="k">def</span><span class="w"> </span><span class="nf">journal_char_quest</span><span class="p">():</span></tt>
            </div>
            <div id="l2832"
               class="code sev- "><tt><i>2832</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2833"
               class="code sev- "><tt><i>2833</i>     <span class="n">char_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">)</span></tt>
            </div>
            <div id="l2834"
               class="code sev- "><tt><i>2834</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2835"
               class="code sev- "><tt><i>2835</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No character loaded.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2836"
               class="code sev- "><tt><i>2836</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2837"
               class="code sev- "><tt><i>2837</i> &nbsp;</tt>
            </div>
            <div id="l2838"
               class="code sev- "><tt><i>2838</i>     <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2839"
               class="code sev- "><tt><i>2839</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2840"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2840</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span> <span class="c1"># Redirect if char load fails</span></tt>
            </div>
            <div id="l2841"
               class="code sev- "><tt><i>2841</i> &nbsp;</tt>
            </div>
            <div id="l2842"
               class="code sev- "><tt><i>2842</i>     <span class="c1"># --- Prepare Character Sheet Data ---</span></tt>
            </div>
            <div id="l2843"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2843</i>     <span class="n">sheet_data</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Work with a copy</span></tt>
            </div>
            <div id="l2844"
               class="code sev- "><tt><i>2844</i>     <span class="c1"># Remove large/internal fields not needed for direct display</span></tt>
            </div>
            <div id="l2845"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2845</i>     <span class="n">fields_to_pop</span> <span class="o">=</span> <span class="p">[</span><span class="n">FS_CONVERSATION</span><span class="p">,</span> <span class="n">FS_CHAPTER_INPUTS</span><span class="p">,</span> <span class="n">FS_QUEST_FLAGS</span><span class="p">]</span> <span class="c1"># Keep FS_INVENTORY now!</span></tt>
            </div>
            <div id="l2846"
               class="code sev- "><tt><i>2846</i>     <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_pop</span><span class="p">:</span></tt>
            </div>
            <div id="l2847"
               class="code sev- "><tt><i>2847</i>         <span class="n">sheet_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2848"
               class="code sev- "><tt><i>2848</i>     <span class="c1"># Convert learned vocab set back to list for display</span></tt>
            </div>
            <div id="l2849"
               class="code sev- "><tt><i>2849</i>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sheet_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">),</span> <span class="nb">set</span><span class="p">):</span></tt>
            </div>
            <div id="l2850"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2850</i>          <span class="n">sheet_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sheet_data</span><span class="p">[</span><span class="s1">&#39;learned_vocab&#39;</span><span class="p">]))</span></tt>
            </div>
            <div id="l2851"
               class="code sev- "><tt><i>2851</i> &nbsp;</tt>
            </div>
            <div id="l2852"
               class="code sev- "><tt><i>2852</i>     <span class="c1"># --- Prepare Quest Log Data ---</span></tt>
            </div>
            <div id="l2853"
               class="code sev- "><tt><i>2853</i>     <span class="n">quest_log</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l2854"
               class="code sev- "><tt><i>2854</i>         <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">,</span> <span class="s1">&#39;No active quest&#39;</span><span class="p">),</span></tt>
            </div>
            <div id="l2855"
               class="code sev- "><tt><i>2855</i>         <span class="s2">&quot;step_desc&quot;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l2856"
               class="code sev- "><tt><i>2856</i>     <span class="p">}</span></tt>
            </div>
            <div id="l2857"
               class="code sev- "><tt><i>2857</i>     <span class="c1"># Handle cases where title might be missing but ID exists (should be rare)</span></tt>
            </div>
            <div id="l2858"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2858</i>     <span class="k">if</span> <span class="n">quest_log</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No active quest&#39;</span> <span class="ow">and</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">):</span></tt>
            </div>
            <div id="l2859"
               class="code sev- "><tt><i>2859</i>         <span class="n">qd</span> <span class="o">=</span> <span class="n">get_quest</span><span class="p">(</span><span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2860"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>2860</i>         <span class="n">quest_log</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Quest&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">qd</span> <span class="k">else</span> <span class="s1">&#39;Unknown Quest&#39;</span></tt>
            </div>
            <div id="l2861"
               class="code sev- "><tt><i>2861</i> &nbsp;</tt>
            </div>
            <div id="l2862"
               class="code sev- "><tt><i>2862</i>     <span class="c1"># --- Prepare Inventory Data ---</span></tt>
            </div>
            <div id="l2863"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2863</i>     <span class="n">inventory_list</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_INVENTORY</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># Get inventory list</span></tt>
            </div>
            <div id="l2864"
               class="code sev- "><tt><i>2864</i> &nbsp;</tt>
            </div>
            <div id="l2865"
               class="code sev- "><tt><i>2865</i>     <span class="c1"># Render the template, passing character sheet, quest log, and inventory</span></tt>
            </div>
            <div id="l2866"
               class="code sev- "><tt><i>2866</i>     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span></tt>
            </div>
            <div id="l2867"
               class="code sev- "><tt><i>2867</i>         <span class="s1">&#39;journal_char_quest.html&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l2868"
               class="code sev- "><tt><i>2868</i>         <span class="n">character_sheet</span><span class="o">=</span><span class="n">sheet_data</span><span class="p">,</span></tt>
            </div>
            <div id="l2869"
               class="code sev- "><tt><i>2869</i>         <span class="n">quest_log</span><span class="o">=</span><span class="n">quest_log</span><span class="p">,</span></tt>
            </div>
            <div id="l2870"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2870</i>         <span class="n">inventory</span><span class="o">=</span><span class="n">inventory_list</span> <span class="c1"># Pass the inventory list</span></tt>
            </div>
            <div id="l2871"
               class="code sev- "><tt><i>2871</i>     <span class="p">)</span></tt>
            </div>
            <div id="l2872"
               class="code sev- "><tt><i>2872</i> &nbsp;</tt>
            </div>
            <div id="l2873"
               class="code sev- "><tt><i>2873</i> &nbsp;</tt>
            </div>
            <div id="l2874"
               class="code sev- "><tt><i>2874</i> <span class="c1"># --- End-of-Chapter Route ---</span></tt>
            </div>
            <div id="l2875"
               class="code sev- "><tt><i>2875</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/end_of_chapter&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2876"
               class="code sev- "><tt><i>2876</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l2877"
               class="code sev- "><tt><i>2877</i> <span class="k">def</span><span class="w"> </span><span class="nf">end_of_chapter</span><span class="p">():</span></tt>
            </div>
            <div id="l2878"
               class="code sev- "><tt><i>2878</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l2879"
               class="code sev- "><tt><i>2879</i>     <span class="n">char_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">)</span></tt>
            </div>
            <div id="l2880"
               class="code sev- "><tt><i>2880</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l2881"
               class="code sev- "><tt><i>2881</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;No character loaded to process end of chapter.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2882"
               class="code sev- "><tt><i>2882</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2883"
               class="code sev- "><tt><i>2883</i> &nbsp;</tt>
            </div>
            <div id="l2884"
               class="code sev- "><tt><i>2884</i>     <span class="n">p_data</span> <span class="o">=</span> <span class="n">load_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2885"
               class="code sev- "><tt><i>2885</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">p_data</span><span class="p">:</span></tt>
            </div>
            <div id="l2886"
               class="code sev- "><tt><i>2886</i>         <span class="c1"># If character fails to load during EOC, clear session and redirect</span></tt>
            </div>
            <div id="l2887"
               class="code sev- "><tt><i>2887</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Failed to load character data for end of chapter.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2888"
               class="code sev- "><tt><i>2888</i>         <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l2889"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2889</i>         <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Clear EOC state too</span></tt>
            </div>
            <div id="l2890"
               class="code sev- "><tt><i>2890</i>         <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l2891"
               class="code sev- "><tt><i>2891</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2892"
               class="code sev- "><tt><i>2892</i> &nbsp;</tt>
            </div>
            <div id="l2893"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>2893</i>     <span class="n">eoc_state</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="s1">&#39;START&#39;</span><span class="p">)</span> <span class="c1"># Get current EOC state from session</span></tt>
            </div>
            <div id="l2894"
               class="code sev- "><tt><i>2894</i> &nbsp;</tt>
            </div>
            <div id="l2895"
               class="code sev- "><tt><i>2895</i>     <span class="c1"># --- POST Request Handling ---</span></tt>
            </div>
            <div id="l2896"
               class="code sev- "><tt><i>2896</i>     <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2897"
               class="code sev- "><tt><i>2897</i>         <span class="c1"># --- State: Submitted Comprehension Answers ---</span></tt>
            </div>
            <div id="l2898"
               class="code sev- "><tt><i>2898</i>         <span class="k">if</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;AWAIT_COMP_ANSWERS&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l2899"
               class="code sev- "><tt><i>2899</i>             <span class="n">questions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2900"
               class="code sev- "><tt><i>2900</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span></tt>
            </div>
            <div id="l2901"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2901</i>                  <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Error: Comprehension questions missing from session.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2902"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (127 > 79 characters)</li>

               </ul><tt><i>2902</i>                  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EOC state AWAIT_COMP_ANSWERS but no questions in session for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2903"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E702
                     </span>
                     Multiple statements on one line (semicolon)</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>2903</i>                  <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;START&#39;</span><span class="p">;</span> <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Reset state</span></tt>
            </div>
            <div id="l2904"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>2904</i>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l2905"
               class="code sev- "><tt><i>2905</i> &nbsp;</tt>
            </div>
            <div id="l2906"
               class="code sev- "><tt><i>2906</i>             <span class="c1"># Collect answers from form</span></tt>
            </div>
            <div id="l2907"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (105 > 79 characters)</li>

               </ul><tt><i>2907</i>             <span class="n">answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;comp_answer_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">))]</span></tt>
            </div>
            <div id="l2908"
               class="code sev- "><tt><i>2908</i>             <span class="c1"># Basic validation: ensure all questions were answered</span></tt>
            </div>
            <div id="l2909"
               class="code sev- "><tt><i>2909</i>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">answers</span><span class="p">):</span></tt>
            </div>
            <div id="l2910"
               class="code sev- "><tt><i>2910</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Please answer all comprehension questions.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2911"
               class="code sev- "><tt><i>2911</i>                 <span class="c1"># Re-render comprehension check page with existing questions</span></tt>
            </div>
            <div id="l2912"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2912</i>                 <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;comprehension_check.html&#39;</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="p">)</span></tt>
            </div>
            <div id="l2913"
               class="code sev- "><tt><i>2913</i> &nbsp;</tt>
            </div>
            <div id="l2914"
               class="code sev- "><tt><i>2914</i>             <span class="c1"># --- AI Comprehension Evaluation ---</span></tt>
            </div>
            <div id="l2915"
               class="code sev- "><tt><i>2915</i>             <span class="n">eval_ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;questions&#39;</span><span class="p">:</span> <span class="n">questions</span><span class="p">,</span> <span class="s1">&#39;answers&#39;</span><span class="p">:</span> <span class="n">answers</span><span class="p">}</span></tt>
            </div>
            <div id="l2916"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2916</i>             <span class="n">comp_res</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;EVALUATE_CHAPTER_COMPREHENSION&quot;</span><span class="p">,</span> <span class="n">eval_ctx</span><span class="p">)</span></tt>
            </div>
            <div id="l2917"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2917</i>             <span class="n">comp_score</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Default score</span></tt>
            </div>
            <div id="l2918"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (88 > 79 characters)</li>

               </ul><tt><i>2918</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;overall_comprehension_score&#39;</span> <span class="ow">in</span> <span class="n">comp_res</span><span class="p">:</span></tt>
            </div>
            <div id="l2919"
               class="code sev- "><tt><i>2919</i>                 <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2920"
               class="code sev- "><tt><i>2920</i>                     <span class="n">comp_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">comp_res</span><span class="p">[</span><span class="s1">&#39;overall_comprehension_score&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2921"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2921</i>                     <span class="n">comp_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">comp_score</span><span class="p">))</span> <span class="c1"># Clamp score</span></tt>
            </div>
            <div id="l2922"
               class="code sev- "><tt><i>2922</i>                 <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span></tt>
            </div>
            <div id="l2923"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (161 > 79 characters)</li>

               </ul><tt><i>2923</i>                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid comprehension score format from AI: </span><span class="si">{</span><span class="n">comp_res</span><span class="p">[</span><span class="s1">&#39;overall_comprehension_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2924"
               class="code sev- "><tt><i>2924</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2925"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (97 > 79 characters)</li>

               </ul><tt><i>2925</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;The AI storyteller had trouble evaluating your comprehension.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2926"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (124 > 79 characters)</li>

               </ul><tt><i>2926</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comprehension evaluation failed for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">comp_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2927"
               class="code sev- "><tt><i>2927</i> &nbsp;</tt>
            </div>
            <div id="l2928"
               class="code sev- "><tt><i>2928</i>             <span class="c1"># --- AI Writing Analysis ---</span></tt>
            </div>
            <div id="l2929"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2929</i>             <span class="n">chapter_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">,[]))</span></tt>
            </div>
            <div id="l2930"
               class="code sev- "><tt><i>2930</i>             <span class="k">if</span> <span class="ow">not</span> <span class="n">chapter_text</span><span class="p">:</span></tt>
            </div>
            <div id="l2931"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>2931</i>                 <span class="n">chapter_text</span> <span class="o">=</span> <span class="s2">&quot;(No player inputs recorded for this chapter)&quot;</span> <span class="c1"># Handle empty</span></tt>
            </div>
            <div id="l2932"
               class="code sev- "><tt><i>2932</i>             <span class="n">anal_ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chapter_player_text&#39;</span><span class="p">:</span> <span class="n">chapter_text</span><span class="p">}</span></tt>
            </div>
            <div id="l2933"
               class="code sev- "><tt><i>2933</i>             <span class="n">anal_res</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;ANALYZE_PLAYER_WRITING&quot;</span><span class="p">,</span> <span class="n">anal_ctx</span><span class="p">)</span></tt>
            </div>
            <div id="l2934"
               class="code sev- "><tt><i>2934</i>             <span class="c1"># Use empty dict if analysis fails, prevents errors later</span></tt>
            </div>
            <div id="l2935"
               class="code sev- "><tt><i>2935</i>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anal_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">anal_res</span><span class="p">:</span></tt>
            </div>
            <div id="l2936"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (108 > 79 characters)</li>

               </ul><tt><i>2936</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;The AI storyteller couldn&#39;t analyze your writing style for this chapter.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2937"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (116 > 79 characters)</li>

               </ul><tt><i>2937</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing analysis failed for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">anal_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2938"
               class="code sev- "><tt><i>2938</i>                 <span class="n">anal_res</span> <span class="o">=</span> <span class="p">{}</span></tt>
            </div>
            <div id="l2939"
               class="code sev- "><tt><i>2939</i> &nbsp;</tt>
            </div>
            <div id="l2940"
               class="code sev- "><tt><i>2940</i>             <span class="c1"># --- Calculate Player XP ---</span></tt>
            </div>
            <div id="l2941"
               class="code sev- "><tt><i>2941</i>             <span class="n">xp_gained</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l2942"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2942</i>                 <span class="mi">5</span> <span class="c1"># Base completion XP</span></tt>
            </div>
            <div id="l2943"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 3 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2943</i>                 <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_length_category&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2944"
               class="code sev- "><tt><i>2944</i>                 <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_words_used&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">*</span> <span class="mi">2</span></tt>
            </div>
            <div id="l2945"
               class="code sev- "><tt><i>2945</i>                 <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relevance_coherence_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></tt>
            </div>
            <div id="l2946"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 3 places)</li>

               </ul><tt><i>2946</i>                 <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style_rating&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2947"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 3 places)</li>

               </ul><tt><i>2947</i>                 <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thinking_rating&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2948"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':' (in 3 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>2948</i>                 <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;descriptive_language_rating&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2949"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2949</i>                 <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">comp_score</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Bonus for comprehension &gt; 5</span></tt>
            </div>
            <div id="l2950"
               class="code sev- "><tt><i>2950</i>             <span class="p">)</span></tt>
            </div>
            <div id="l2951"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2951</i>             <span class="n">xp_gained</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xp_gained</span><span class="p">)</span> <span class="c1"># Ensure XP is not negative</span></tt>
            </div>
            <div id="l2952"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>2952</i>             <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chapter Complete! You earned </span><span class="si">{</span><span class="n">xp_gained</span><span class="si">}</span><span class="s2"> Player XP!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2953"
               class="code sev- "><tt><i>2953</i> &nbsp;</tt>
            </div>
            <div id="l2954"
               class="code sev- "><tt><i>2954</i>             <span class="c1"># --- Update Player Profile XP/Level ---</span></tt>
            </div>
            <div id="l2955"
               class="code sev- "><tt><i>2955</i>             <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l2956"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>2956</i>                 <span class="n">profile_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;player_profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></tt>
            </div>
            <div id="l2957"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>2957</i>                 <span class="n">profile_ref</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">:</span> <span class="n">firestore</span><span class="o">.</span><span class="n">Increment</span><span class="p">(</span><span class="n">xp_gained</span><span class="p">)})</span></tt>
            </div>
            <div id="l2958"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

               </ul><tt><i>2958</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player XP +</span><span class="si">{</span><span class="n">xp_gained</span><span class="si">}</span><span class="s2"> updated in Firestore for user: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2959"
               class="code sev- "><tt><i>2959</i>                 <span class="c1"># Check for level up</span></tt>
            </div>
            <div id="l2960"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>2960</i>                 <span class="n">profile_doc</span> <span class="o">=</span> <span class="n">profile_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">,</span> <span class="s1">&#39;player_level&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l2961"
               class="code sev- "><tt><i>2961</i>                 <span class="k">if</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l2962"
               class="code sev- "><tt><i>2962</i>                     <span class="n">profile_data</span> <span class="o">=</span> <span class="n">profile_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></tt>
            </div>
            <div id="l2963"
               class="code sev- "><tt><i>2963</i>                     <span class="n">current_xp</span> <span class="o">=</span> <span class="n">profile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_player_xp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l2964"
               class="code sev- "><tt><i>2964</i>                     <span class="n">current_level</span> <span class="o">=</span> <span class="n">profile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;player_level&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l2965"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2965</i>                     <span class="n">xp_for_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_level</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># Example XP threshold</span></tt>
            </div>
            <div id="l2966"
               class="code sev- "><tt><i>2966</i>                     <span class="k">if</span> <span class="n">current_xp</span> <span class="o">&gt;=</span> <span class="n">xp_for_next</span><span class="p">:</span></tt>
            </div>
            <div id="l2967"
               class="code sev- "><tt><i>2967</i>                         <span class="n">new_level</span> <span class="o">=</span> <span class="n">current_level</span> <span class="o">+</span> <span class="mi">1</span></tt>
            </div>
            <div id="l2968"
               class="code sev- "><tt><i>2968</i>                         <span class="n">profile_ref</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;player_level&#39;</span><span class="p">:</span> <span class="n">new_level</span><span class="p">})</span></tt>
            </div>
            <div id="l2969"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (102 > 79 characters)</li>

               </ul><tt><i>2969</i>                         <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Congratulations! You&#39;ve reached Player Level </span><span class="si">{</span><span class="n">new_level</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2970"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>2970</i>                         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Player </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> leveled up to </span><span class="si">{</span><span class="n">new_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2971"
               class="code sev- "><tt><i>2971</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l2972"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (121 > 79 characters)</li>

               </ul><tt><i>2972</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not retrieve profile data after XP update for level check. User: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2973"
               class="code sev- "><tt><i>2973</i>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l2974"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

               </ul><tt><i>2974</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update player XP/Level in Firestore for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l2975"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (90 > 79 characters)</li>

               </ul><tt><i>2975</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Could not update your Player XP due to a server error.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l2976"
               class="code sev- "><tt><i>2976</i> &nbsp;</tt>
            </div>
            <div id="l2977"
               class="code sev- "><tt><i>2977</i>             <span class="c1"># --- Generate Report Summary ---</span></tt>
            </div>
            <div id="l2978"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>2978</i>             <span class="n">summary_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;**Chapter Complete!**</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2979"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2979</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;* **Comprehension Score:** </span><span class="si">{</span><span class="n">comp_score</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> / 10</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2980"
               class="code sev- "><tt><i>2980</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;* **Player XP Gained:** +</span><span class="si">{</span><span class="n">xp_gained</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2981"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>2981</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;* **Writing Analysis:**</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2982"
               class="code sev- "><tt><i>2982</i>             <span class="n">awl_used</span> <span class="o">=</span> <span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awl_words_used&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2983"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (118 > 79 characters)</li>

               </ul><tt><i>2983</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * AWL Words Used (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">awl_used</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">awl_used</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">awl_used</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2984"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (113 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2984</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * Relevance &amp; Coherence: </span><span class="si">{</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relevance_coherence_score&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> / 5</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2985"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2985</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * Style Complexity: </span><span class="si">{</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style_rating&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2986"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (95 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2986</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * Critical Thinking: </span><span class="si">{</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thinking_rating&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2987"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (96 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2987</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * Average Length: </span><span class="si">{</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_length_category&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2988"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (110 > 79 characters)</li>

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

               </ul><tt><i>2988</i>             <span class="n">summary_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * Descriptive Language: </span><span class="si">{</span><span class="n">anal_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;descriptive_language_rating&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l2989"
               class="code sev- "><tt><i>2989</i> &nbsp;</tt>
            </div>
            <div id="l2990"
               class="code sev- "><tt><i>2990</i>             <span class="c1"># --- Update Character Data (Save summary, clear inputs) ---</span></tt>
            </div>
            <div id="l2991"
               class="code sev- "><tt><i>2991</i>             <span class="n">summaries</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">,</span> <span class="p">[])</span></tt>
            </div>
            <div id="l2992"
               class="code sev- "><tt><i>2992</i>             <span class="n">current_chapter_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></tt>
            </div>
            <div id="l2993"
               class="code sev- "><tt><i>2993</i>             <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span></tt>
            </div>
            <div id="l2994"
               class="code sev- "><tt><i>2994</i>                 <span class="s2">&quot;chapter&quot;</span><span class="p">:</span> <span class="n">current_chapter_num</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary_text</span><span class="p">,</span></tt>
            </div>
            <div id="l2995"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>2995</i>                 <span class="s2">&quot;comprehension_score&quot;</span><span class="p">:</span> <span class="n">comp_score</span><span class="p">,</span> <span class="s2">&quot;player_xp_gained&quot;</span><span class="p">:</span> <span class="n">xp_gained</span><span class="p">,</span></tt>
            </div>
            <div id="l2996"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2996</i>                 <span class="s2">&quot;analysis_raw&quot;</span><span class="p">:</span> <span class="n">anal_res</span> <span class="c1"># Store raw analysis</span></tt>
            </div>
            <div id="l2997"
               class="code sev- "><tt><i>2997</i>             <span class="p">})</span></tt>
            </div>
            <div id="l2998"
               class="code sev- "><tt><i>2998</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span></tt>
            </div>
            <div id="l2999"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>2999</i>             <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Clear chapter inputs</span></tt>
            </div>
            <div id="l3000"
               class="code sev- "><tt><i>3000</i> &nbsp;</tt>
            </div>
            <div id="l3001"
               class="code sev- "><tt><i>3001</i>             <span class="c1"># --- Update Session and Save ---</span></tt>
            </div>
            <div id="l3002"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>3002</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_SUMMARY</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_text</span> <span class="c1"># Store summary for display</span></tt>
            </div>
            <div id="l3003"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>3003</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AWAIT_REPORT_ACK&#39;</span> <span class="c1"># Move to next state</span></tt>
            </div>
            <div id="l3004"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (89 > 79 characters)</li>

               </ul><tt><i>3004</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Clear chapter inputs from session</span></tt>
            </div>
            <div id="l3005"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>3005</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Clear questions from session</span></tt>
            </div>
            <div id="l3006"
               class="code sev- "><tt><i>3006</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3007"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3007</i>             <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span> <span class="c1"># Save updated character data</span></tt>
            </div>
            <div id="l3008"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (80 > 79 characters)</li>

               </ul><tt><i>3008</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span> <span class="c1"># Redirect to show report</span></tt>
            </div>
            <div id="l3009"
               class="code sev- "><tt><i>3009</i> &nbsp;</tt>
            </div>
            <div id="l3010"
               class="code sev- "><tt><i>3010</i>         <span class="c1"># --- State: Acknowledged Report, Generate Next Quest ---</span></tt>
            </div>
            <div id="l3011"
               class="code sev- "><tt><i>3011</i>         <span class="k">elif</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;AWAIT_REPORT_ACK&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3012"
               class="code sev- "><tt><i>3012</i>             <span class="n">current_chapter_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">,</span> <span class="p">[]))</span></tt>
            </div>
            <div id="l3013"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (146 > 79 characters)</li>

               </ul><tt><i>3013</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> acknowledged EOC report for character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">, chapter </span><span class="si">{</span><span class="n">current_chapter_num</span><span class="si">}</span><span class="s2">. Generating next quest.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3014"
               class="code sev- "><tt><i>3014</i> &nbsp;</tt>
            </div>
            <div id="l3015"
               class="code sev- "><tt><i>3015</i>             <span class="c1"># --- Determine Next Hero&#39;s Journey Stage ---</span></tt>
            </div>
            <div id="l3016"
               class="code sev- "><tt><i>3016</i>             <span class="n">stage_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_chapter_num</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">HERO_JOURNEY_STAGES</span><span class="p">)</span></tt>
            </div>
            <div id="l3017"
               class="code sev- "><tt><i>3017</i>             <span class="n">next_stage</span> <span class="o">=</span> <span class="n">HERO_JOURNEY_STAGES</span><span class="p">[</span><span class="n">stage_index</span><span class="p">]</span></tt>
            </div>
            <div id="l3018"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (124 > 79 characters)</li>

               </ul><tt><i>3018</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Hero&#39;s Journey Stage &#39;</span><span class="si">{</span><span class="n">next_stage</span><span class="si">}</span><span class="s2">&#39; for Chapter </span><span class="si">{</span><span class="n">current_chapter_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> quest generation.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3019"
               class="code sev- "><tt><i>3019</i> &nbsp;</tt>
            </div>
            <div id="l3020"
               class="code sev- "><tt><i>3020</i>             <span class="c1"># --- AI Quest Generation ---</span></tt>
            </div>
            <div id="l3021"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>3021</i>             <span class="n">next_q_id</span><span class="p">,</span> <span class="n">next_q_title</span><span class="p">,</span> <span class="n">next_s_id</span><span class="p">,</span> <span class="n">next_s_desc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></tt>
            </div>
            <div id="l3022"
               class="code sev- "><tt><i>3022</i>             <span class="n">q_gen_ctx</span> <span class="o">=</span> <span class="p">{</span></tt>
            </div>
            <div id="l3023"
               class="code sev- "><tt><i>3023</i>                  <span class="s2">&quot;character_data&quot;</span><span class="p">:</span> <span class="n">p_data</span><span class="p">,</span></tt>
            </div>
            <div id="l3024"
               class="code sev- "><tt><i>3024</i>                  <span class="s2">&quot;chapter_summaries&quot;</span><span class="p">:</span> <span class="n">p_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_summaries&#39;</span><span class="p">,</span> <span class="p">[]),</span></tt>
            </div>
            <div id="l3025"
               class="code sev- "><tt><i>3025</i>                  <span class="s2">&quot;next_hero_journey_stage&quot;</span><span class="p">:</span> <span class="n">next_stage</span></tt>
            </div>
            <div id="l3026"
               class="code sev- "><tt><i>3026</i>             <span class="p">}</span></tt>
            </div>
            <div id="l3027"
               class="code sev- "><tt><i>3027</i>             <span class="n">q_gen_res</span> <span class="o">=</span> <span class="n">get_ai_response</span><span class="p">(</span><span class="s2">&quot;GENERATE_NEXT_QUEST&quot;</span><span class="p">,</span> <span class="n">q_gen_ctx</span><span class="p">)</span></tt>
            </div>
            <div id="l3028"
               class="code sev- "><tt><i>3028</i> &nbsp;</tt>
            </div>
            <div id="l3029"
               class="code sev- "><tt><i>3029</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q_gen_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">q_gen_res</span><span class="p">:</span></tt>
            </div>
            <div id="l3030"
               class="code sev- "><tt><i>3030</i>                 <span class="n">next_q_id</span> <span class="o">=</span> <span class="n">q_gen_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quest_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3031"
               class="code sev- "><tt><i>3031</i>                 <span class="n">next_q_title</span> <span class="o">=</span> <span class="n">q_gen_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3032"
               class="code sev- "><tt><i>3032</i>                 <span class="n">next_s_id</span> <span class="o">=</span> <span class="n">q_gen_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starting_step_id&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3033"
               class="code sev- "><tt><i>3033</i>                 <span class="n">next_s_desc</span> <span class="o">=</span> <span class="n">q_gen_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starting_step_description&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3034"
               class="code sev- "><tt><i>3034</i>                 <span class="c1"># Validate generated parts</span></tt>
            </div>
            <div id="l3035"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (82 > 79 characters)</li>

               </ul><tt><i>3035</i>                 <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">next_q_id</span> <span class="ow">and</span> <span class="n">next_s_id</span> <span class="ow">and</span> <span class="n">next_q_title</span> <span class="ow">and</span> <span class="n">next_s_desc</span><span class="p">):</span></tt>
            </div>
            <div id="l3036"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (117 > 79 characters)</li>

               </ul><tt><i>3036</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI quest generation returned incomplete data for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q_gen_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3037"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (128 > 79 characters)</li>

               </ul><tt><i>3037</i>                      <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;The AI storyteller couldn&#39;t generate a specific new quest objective. Feel free to explore!&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3038"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (140 > 79 characters)</li>

               </ul><tt><i>3038</i>                      <span class="n">next_q_id</span><span class="p">,</span> <span class="n">next_q_title</span><span class="p">,</span> <span class="n">next_s_id</span><span class="p">,</span> <span class="n">next_s_desc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Explore Thetopia&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Forge your own path or seek rumors.&quot;</span></tt>
            </div>
            <div id="l3039"
               class="code sev- "><tt><i>3039</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l3040"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (112 > 79 characters)</li>

               </ul><tt><i>3040</i>                      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI generated next quest for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">next_q_id</span><span class="si">}</span><span class="s2"> - &#39;</span><span class="si">{</span><span class="n">next_q_title</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3041"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>3041</i>                      <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New objective received: </span><span class="si">{</span><span class="n">next_q_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span> <span class="c1"># Inform player</span></tt>
            </div>
            <div id="l3042"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3042</i>             <span class="k">else</span><span class="p">:</span> <span class="c1"># Handle AI error</span></tt>
            </div>
            <div id="l3043"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (136 > 79 characters)</li>

               </ul><tt><i>3043</i>                 <span class="n">error_reason</span> <span class="o">=</span> <span class="n">q_gen_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span><span class="s1">&#39;Unknown AI error&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q_gen_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;AI communication failure&#39;</span></tt>
            </div>
            <div id="l3044"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (103 > 79 characters)</li>

               </ul><tt><i>3044</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI quest generation failed for char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Reason: </span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3045"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (130 > 79 characters)</li>

               </ul><tt><i>3045</i>                 <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The AI storyteller had trouble determining your next quest (</span><span class="si">{</span><span class="n">error_reason</span><span class="si">}</span><span class="s2">). Time to explore!&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3046"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (135 > 79 characters)</li>

               </ul><tt><i>3046</i>                 <span class="n">next_q_id</span><span class="p">,</span> <span class="n">next_q_title</span><span class="p">,</span> <span class="n">next_s_id</span><span class="p">,</span> <span class="n">next_s_desc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Explore Thetopia&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Forge your own path or seek rumors.&quot;</span></tt>
            </div>
            <div id="l3047"
               class="code sev- "><tt><i>3047</i> &nbsp;</tt>
            </div>
            <div id="l3048"
               class="code sev- "><tt><i>3048</i>             <span class="c1"># --- Update Character Data with New Quest ---</span></tt>
            </div>
            <div id="l3049"
               class="code sev- "><tt><i>3049</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_q_id</span></tt>
            </div>
            <div id="l3050"
               class="code sev- "><tt><i>3050</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_s_id</span></tt>
            </div>
            <div id="l3051"
               class="code sev- "><tt><i>3051</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_quest_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_q_title</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l3052"
               class="code sev- "><tt><i>3052</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;current_step_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_s_desc</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l3053"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3053</i>             <span class="n">p_data</span><span class="p">[</span><span class="n">FS_CHAPTER_INPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Ensure clear for new chapter start</span></tt>
            </div>
            <div id="l3054"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3054</i>             <span class="n">p_data</span><span class="p">[</span><span class="s1">&#39;turn_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Reset turn count for new chapter</span></tt>
            </div>
            <div id="l3055"
               class="code sev- "><tt><i>3055</i> &nbsp;</tt>
            </div>
            <div id="l3056"
               class="code sev- "><tt><i>3056</i>             <span class="c1"># --- Clear EOC Session State ---</span></tt>
            </div>
            <div id="l3057"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>3057</i>             <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="n">SESSION_EOC_SUMMARY</span><span class="p">]:</span></tt>
            </div>
            <div id="l3058"
               class="code sev- "><tt><i>3058</i>                 <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l3059"
               class="code sev- "><tt><i>3059</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3060"
               class="code sev- "><tt><i>3060</i> &nbsp;</tt>
            </div>
            <div id="l3061"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3061</i>             <span class="n">save_character_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">p_data</span><span class="p">)</span> <span class="c1"># Save final character state</span></tt>
            </div>
            <div id="l3062"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3062</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span> <span class="c1"># Redirect back to the game</span></tt>
            </div>
            <div id="l3063"
               class="code sev- "><tt><i>3063</i> &nbsp;</tt>
            </div>
            <div id="l3064"
               class="code sev- "><tt><i>3064</i>         <span class="c1"># --- Invalid EOC state in POST ---</span></tt>
            </div>
            <div id="l3065"
               class="code sev- "><tt><i>3065</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l3066"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>3066</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An unexpected error occurred during chapter conclusion.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3067"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (135 > 79 characters)</li>

               </ul><tt><i>3067</i>             <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected EOC state &#39;</span><span class="si">{</span><span class="n">eoc_state</span><span class="si">}</span><span class="s2">&#39; encountered in POST for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Resetting EOC.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3068"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E702
                     </span>
                     Multiple statements on one line (semicolon) (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (130 > 79 characters)</li>

               </ul><tt><i>3068</i>             <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l3069"
               class="code sev- "><tt><i>3069</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3070"
               class="code sev- "><tt><i>3070</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3071"
               class="code sev- "><tt><i>3071</i> &nbsp;</tt>
            </div>
            <div id="l3072"
               class="code sev- "><tt><i>3072</i>     <span class="c1"># --- GET Request Handling ---</span></tt>
            </div>
            <div id="l3073"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3073</i>     <span class="k">else</span><span class="p">:</span> <span class="c1"># request.method == &#39;GET&#39;</span></tt>
            </div>
            <div id="l3074"
               class="code sev- "><tt><i>3074</i>         <span class="c1"># --- State: Start EOC Flow -&gt; Show Comprehension Check ---</span></tt>
            </div>
            <div id="l3075"
               class="code sev- "><tt><i>3075</i>         <span class="k">if</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;START&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3076"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3076</i>             <span class="n">questions</span> <span class="o">=</span> <span class="p">[</span> <span class="c1"># Example questions</span></tt>
            </div>
            <div id="l3077"
               class="code sev- "><tt><i>3077</i>                  <span class="s2">&quot;What was your main objective or focus in this chapter?&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l3078"
               class="code sev- "><tt><i>3078</i>                  <span class="s2">&quot;Describe a key interaction or challenge you faced.&quot;</span><span class="p">,</span></tt>
            </div>
            <div id="l3079"
               class="code sev- "><tt><i>3079</i>                  <span class="s2">&quot;How did your character approach the situations encountered?&quot;</span></tt>
            </div>
            <div id="l3080"
               class="code sev- "><tt><i>3080</i>             <span class="p">]</span></tt>
            </div>
            <div id="l3081"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>3081</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions</span> <span class="c1"># Store questions in session</span></tt>
            </div>
            <div id="l3082"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3082</i>             <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AWAIT_COMP_ANSWERS&#39;</span> <span class="c1"># Update state</span></tt>
            </div>
            <div id="l3083"
               class="code sev- "><tt><i>3083</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3084"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>3084</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initiating EOC comprehension check for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3085"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (83 > 79 characters)</li>

               </ul><tt><i>3085</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;comprehension_check.html&#39;</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="p">)</span></tt>
            </div>
            <div id="l3086"
               class="code sev- "><tt><i>3086</i> &nbsp;</tt>
            </div>
            <div id="l3087"
               class="code sev- "><tt><i>3087</i>         <span class="c1"># --- State: Awaiting Answers -&gt; Re-display Comprehension Check ---</span></tt>
            </div>
            <div id="l3088"
               class="code sev- "><tt><i>3088</i>         <span class="k">elif</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;AWAIT_COMP_ANSWERS&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3089"
               class="code sev- "><tt><i>3089</i>             <span class="n">questions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">)</span></tt>
            </div>
            <div id="l3090"
               class="code sev- "><tt><i>3090</i>             <span class="k">if</span> <span class="n">questions</span><span class="p">:</span></tt>
            </div>
            <div id="l3091"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (106 > 79 characters)</li>

               </ul><tt><i>3091</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Re-displaying EOC comprehension check for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3092"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (87 > 79 characters)</li>

               </ul><tt><i>3092</i>                 <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;comprehension_check.html&#39;</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="p">)</span></tt>
            </div>
            <div id="l3093"
               class="code sev- "><tt><i>3093</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l3094"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>3094</i>                 <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Error: Comprehension questions lost. Restarting chapter conclusion.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3095"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (130 > 79 characters)</li>

               </ul><tt><i>3095</i>                 <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EOC state AWAIT_COMP_ANSWERS but no questions in session (GET). User: </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3096"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E702
                     </span>
                     Multiple statements on one line (semicolon)</li>

               </ul><tt><i>3096</i>                 <span class="n">session</span><span class="p">[</span><span class="n">SESSION_EOC_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;START&#39;</span><span class="p">;</span> <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3097"
               class="code sev- "><tt><i>3097</i>                 <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;end_of_chapter&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3098"
               class="code sev- "><tt><i>3098</i> &nbsp;</tt>
            </div>
            <div id="l3099"
               class="code sev- "><tt><i>3099</i>         <span class="c1"># --- State: Awaiting Report Ack -&gt; Display Report Summary ---</span></tt>
            </div>
            <div id="l3100"
               class="code sev- "><tt><i>3100</i>         <span class="k">elif</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;AWAIT_REPORT_ACK&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3101"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (98 > 79 characters)</li>

               </ul><tt><i>3101</i>             <span class="n">summary</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="s2">&quot;Report summary is currently unavailable.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3102"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (94 > 79 characters)</li>

               </ul><tt><i>3102</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displaying EOC report summary for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3103"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>3103</i>             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;report_summary.html&#39;</span><span class="p">,</span> <span class="n">report_summary</span><span class="o">=</span><span class="n">summary</span><span class="p">)</span></tt>
            </div>
            <div id="l3104"
               class="code sev- "><tt><i>3104</i> &nbsp;</tt>
            </div>
            <div id="l3105"
               class="code sev- "><tt><i>3105</i>         <span class="c1"># --- State: Complete (Should not be reachable via GET) ---</span></tt>
            </div>
            <div id="l3106"
               class="code sev- "><tt><i>3106</i>         <span class="k">elif</span> <span class="n">eoc_state</span> <span class="o">==</span> <span class="s1">&#39;COMPLETE&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3107"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (109 > 79 characters)</li>

               </ul><tt><i>3107</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EOC state was &#39;COMPLETE&#39; on GET request for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, redirecting to game.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3108"
               class="code sev- "><tt><i>3108</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;game_view&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3109"
               class="code sev- "><tt><i>3109</i> &nbsp;</tt>
            </div>
            <div id="l3110"
               class="code sev- "><tt><i>3110</i>         <span class="c1"># --- Invalid EOC state in GET ---</span></tt>
            </div>
            <div id="l3111"
               class="code sev- "><tt><i>3111</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l3112"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E117
                     </span>
                     Over-indented</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>3112</i>              <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An unexpected state was encountered during chapter conclusion.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3113"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (131 > 79 characters)</li>

               </ul><tt><i>3113</i>              <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected EOC state &#39;</span><span class="si">{</span><span class="n">eoc_state</span><span class="si">}</span><span class="s2">&#39; encountered in GET for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, char </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">. Resetting.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3114"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

                  <li>
                     <span class="count sev-2">
                        E702
                     </span>
                     Multiple statements on one line (semicolon) (in 2 places)</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (131 > 79 characters)</li>

               </ul><tt><i>3114</i>              <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_STATE</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_QUESTIONS</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SESSION_EOC_SUMMARY</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l3115"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>3115</i>              <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3116"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E111
                     </span>
                     Indentation is not a multiple of 4</li>

               </ul><tt><i>3116</i>              <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3117"
               class="code sev- "><tt><i>3117</i> &nbsp;</tt>
            </div>
            <div id="l3118"
               class="code sev- "><tt><i>3118</i> &nbsp;</tt>
            </div>
            <div id="l3119"
               class="code sev- "><tt><i>3119</i> <span class="c1"># --- Root Route ---</span></tt>
            </div>
            <div id="l3120"
               class="code sev- "><tt><i>3120</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3121"
               class="code sev- "><tt><i>3121</i> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span></tt>
            </div>
            <div id="l3122"
               class="code sev- "><tt><i>3122</i>     <span class="c1"># Redirect logged-in users to profile, others to login</span></tt>
            </div>
            <div id="l3123"
               class="code sev- "><tt><i>3123</i>     <span class="k">if</span> <span class="n">SESSION_USER_ID</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span></tt>
            </div>
            <div id="l3124"
               class="code sev- "><tt><i>3124</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3125"
               class="code sev- "><tt><i>3125</i>     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l3126"
               class="code sev- "><tt><i>3126</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3127"
               class="code sev- "><tt><i>3127</i> &nbsp;</tt>
            </div>
            <div id="l3128"
               class="code sev- "><tt><i>3128</i> &nbsp;</tt>
            </div>
            <div id="l3129"
               class="code sev- "><tt><i>3129</i> <span class="c1"># --- Delete Character Route ---</span></tt>
            </div>
            <div id="l3130"
               class="code sev- "><tt><i>3130</i> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete_character/&lt;char_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span></tt>
            </div>
            <div id="l3131"
               class="code sev- "><tt><i>3131</i> <span class="nd">@login_required</span></tt>
            </div>
            <div id="l3132"
               class="code sev- "><tt><i>3132</i> <span class="k">def</span><span class="w"> </span><span class="nf">delete_character</span><span class="p">(</span><span class="n">char_id</span><span class="p">):</span></tt>
            </div>
            <div id="l3133"
               class="code sev- "><tt><i>3133</i>     <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">SESSION_USER_ID</span><span class="p">]</span></tt>
            </div>
            <div id="l3134"
               class="code sev- "><tt><i>3134</i>     <span class="k">if</span> <span class="ow">not</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l3135"
               class="code sev- "><tt><i>3135</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Invalid request: Missing character ID.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3136"
               class="code sev- "><tt><i>3136</i>         <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3137"
               class="code sev- "><tt><i>3137</i> &nbsp;</tt>
            </div>
            <div id="l3138"
               class="code sev- "><tt><i>3138</i>     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> attempting to delete character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3139"
               class="code sev- "><tt><i>3139</i>     <span class="k">try</span><span class="p">:</span></tt>
            </div>
            <div id="l3140"
               class="code sev- "><tt><i>3140</i>         <span class="n">char_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">&#39;characters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">char_id</span><span class="p">)</span></tt>
            </div>
            <div id="l3141"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3141</i>         <span class="n">char_doc</span> <span class="o">=</span> <span class="n">char_ref</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="c1"># Fetch only needed fields</span></tt>
            </div>
            <div id="l3142"
               class="code sev- "><tt><i>3142</i>         <span class="k">if</span> <span class="ow">not</span> <span class="n">char_doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span></tt>
            </div>
            <div id="l3143"
               class="code sev- "><tt><i>3143</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Character not found.&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3144"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>3144</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt to delete non-existent character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> by user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3145"
               class="code sev- "><tt><i>3145</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3146"
               class="code sev- "><tt><i>3146</i> &nbsp;</tt>
            </div>
            <div id="l3147"
               class="code sev- "><tt><i>3147</i>         <span class="c1"># --- Ownership Check ---</span></tt>
            </div>
            <div id="l3148"
               class="code sev- "><tt><i>3148</i>         <span class="k">if</span> <span class="n">char_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span></tt>
            </div>
            <div id="l3149"
               class="code sev- "><tt><i>3149</i>             <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Permission denied to delete this character.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3150"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (119 > 79 characters)</li>

               </ul><tt><i>3150</i>             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SECURITY ALERT: User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> denied deletion of character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> (owner mismatch).&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3151"
               class="code sev- "><tt><i>3151</i>             <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span></tt>
            </div>
            <div id="l3152"
               class="code sev- "><tt><i>3152</i> &nbsp;</tt>
            </div>
            <div id="l3153"
               class="code sev- "><tt><i>3153</i>         <span class="c1"># Proceed with deletion</span></tt>
            </div>
            <div id="l3154"
               class="code sev- "><tt><i>3154</i>         <span class="n">char_name</span> <span class="o">=</span> <span class="n">char_doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown Character&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l3155"
               class="code sev- "><tt><i>3155</i>         <span class="n">char_ref</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></tt>
            </div>
            <div id="l3156"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (101 > 79 characters)</li>

               </ul><tt><i>3156</i>         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deleted character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">char_name</span><span class="si">}</span><span class="s2">&#39;) for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3157"
               class="code sev- "><tt><i>3157</i>         <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Character &#39;</span><span class="si">{</span><span class="n">char_name</span><span class="si">}</span><span class="s2">&#39; deleted successfully.&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3158"
               class="code sev- "><tt><i>3158</i> &nbsp;</tt>
            </div>
            <div id="l3159"
               class="code sev- "><tt><i>3159</i>         <span class="c1"># --- Clear Deleted Character from Session if Active ---</span></tt>
            </div>
            <div id="l3160"
               class="code sev- "><tt><i>3160</i>         <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_CHARACTER_ID</span><span class="p">)</span> <span class="o">==</span> <span class="n">char_id</span><span class="p">:</span></tt>
            </div>
            <div id="l3161"
               class="code sev- "><tt><i>3161</i>             <span class="n">keys_to_clear</span> <span class="o">=</span> <span class="p">[</span></tt>
            </div>
            <div id="l3162"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>3162</i>                  <span class="n">SESSION_CHARACTER_ID</span><span class="p">,</span> <span class="n">SESSION_CONVERSATION</span><span class="p">,</span> <span class="n">SESSION_CHAPTER_INPUTS</span><span class="p">,</span></tt>
            </div>
            <div id="l3163"
               class="code sev- "><tt><i>3163</i>                  <span class="n">SESSION_LOCATION</span><span class="p">,</span> <span class="n">SESSION_LAST_AI_OUTPUT</span><span class="p">,</span> <span class="n">SESSION_EOC_STATE</span><span class="p">,</span></tt>
            </div>
            <div id="l3164"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (93 > 79 characters)</li>

               </ul><tt><i>3164</i>                  <span class="n">SESSION_SIDE_QUEST_ACTIVE</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_DESC</span><span class="p">,</span> <span class="n">SESSION_SIDE_QUEST_TURNS</span></tt>
            </div>
            <div id="l3165"
               class="code sev- "><tt><i>3165</i>             <span class="p">]</span></tt>
            </div>
            <div id="l3166"
               class="code sev- "><tt><i>3166</i>             <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_clear</span><span class="p">:</span></tt>
            </div>
            <div id="l3167"
               class="code sev- "><tt><i>3167</i>                 <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></tt>
            </div>
            <div id="l3168"
               class="code sev- "><tt><i>3168</i>             <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></tt>
            </div>
            <div id="l3169"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>3169</i>             <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleared deleted character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> from active session.&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3170"
               class="code sev- "><tt><i>3170</i> &nbsp;</tt>
            </div>
            <div id="l3171"
               class="code sev- "><tt><i>3171</i>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span></tt>
            </div>
            <div id="l3172"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (99 > 79 characters)</li>

               </ul><tt><i>3172</i>         <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting character </span><span class="si">{</span><span class="n">char_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l3173"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (81 > 79 characters)</li>

               </ul><tt><i>3173</i>         <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An error occurred while trying to delete the character.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3174"
               class="code sev- "><tt><i>3174</i> &nbsp;</tt>
            </div>
            <div id="l3175"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3175</i>     <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span> <span class="c1"># Redirect back to profile page</span></tt>
            </div>
            <div id="l3176"
               class="code sev- "><tt><i>3176</i> &nbsp;</tt>
            </div>
            <div id="l3177"
               class="code sev- "><tt><i>3177</i> &nbsp;</tt>
            </div>
            <div id="l3178"
               class="code sev- "><tt><i>3178</i> <span class="c1"># --- Run App ---</span></tt>
            </div>
            <div id="l3179"
               class="code sev- "><tt><i>3179</i> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l3180"
               class="code sev- "><tt><i>3180</i>     <span class="c1"># Configuration for running the Flask app</span></tt>
            </div>
            <div id="l3181"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3181</i>     <span class="n">host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_RUN_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">)</span> <span class="c1"># Default host</span></tt>
            </div>
            <div id="l3182"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

               </ul><tt><i>3182</i>     <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_RUN_PORT&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">))</span> <span class="c1"># Default port</span></tt>
            </div>
            <div id="l3183"
               class="code sev- "><tt><i>3183</i>     <span class="c1"># Enable debug mode based on environment variable</span></tt>
            </div>
            <div id="l3184"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (85 > 79 characters)</li>

               </ul><tt><i>3184</i>     <span class="n">debug_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l3185"
               class="code sev- "><tt><i>3185</i> &nbsp;</tt>
            </div>
            <div id="l3186"
               class="code sev- "><tt><i>3186</i>     <span class="c1"># Print server start information</span></tt>
            </div>
            <div id="l3187"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

                  <li>
                     <span class="count sev-2">
                        E261
                     </span>
                     At least two spaces before inline comment</li>

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (84 > 79 characters)</li>

               </ul><tt><i>3187</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Starting Daydream Server V5.3 ---&quot;</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt; Updated version number &gt;&gt;&gt;</span></tt>
            </div>
            <div id="l3188"
               class="code sev- "><tt><i>3188</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Mode: </span><span class="si">{</span><span class="s1">&#39;Debug (with reloader)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">debug_mode</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Production&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3189"
               class="code sev- "><tt><i>3189</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Host: </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3190"
               class="code sev- "><tt><i>3190</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Port: </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3191"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (92 > 79 characters)</li>

               </ul><tt><i>3191</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Firebase Project: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;daydream-455317&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3192"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        E501
                     </span>
                     Line too long (91 > 79 characters)</li>

               </ul><tt><i>3192</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Vertex AI Location: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_LOCATION&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;us-central1&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3193"
               class="code sev-1  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-1">
                        F541
                     </span>
                     F-string is missing placeholders</li>

               </ul><tt><i>3193</i>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-----------------------------------&quot;</span><span class="p">)</span></tt>
            </div>
            <div id="l3194"
               class="code sev- "><tt><i>3194</i> &nbsp;</tt>
            </div>
            <div id="l3195"
               class="code sev- "><tt><i>3195</i>     <span class="c1"># Run the Flask development server</span></tt>
            </div>
            <div id="l3196"
               class="code sev-2  le">
               <ul class="violations">

                  <li>
                     <span class="count sev-2">
                        W292
                     </span>
                     No newline at end of file</li>

               </ul><tt><i>3196</i>     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">)</span></tt>
            </div>

         </div>
      </div>
   </body>
</html>